<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - MedQuiz HNU</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://upload-widget.cloudinary.com/latest/global/all.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .header h1 { color: #667eea; font-size: 2.5em; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2.5em; color: #667eea; font-weight: bold; }
        .section { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-tab { padding: 10px 20px; background: #eee; border: none; border-radius: 25px; cursor: pointer; }
        .nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .folders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .folder-card { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .folder-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .quiz-card { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .quiz-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .file-card { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .file-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .folder-icon { font-size: 3em; margin-bottom: 10px; }
        .edit-btn, .delete-btn { position: absolute; top: 10px; background: white; border: none; cursor: pointer; font-size: 1.1em; padding: 8px; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        .edit-btn { right: 50px; color: #667eea; }
        .delete-btn { right: 10px; color: #f44336; }
        .btn { padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 1em; margin: 5px; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-warning { background: #ff9800; color: white; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; }
        .upload-area { border: 3px dashed #667eea; border-radius: 15px; padding: 40px; text-align: center; background: #f8f9fa; cursor: pointer; margin-bottom: 20px; transition: all 0.3s; }
        .upload-area:hover { background: #e3f2fd; border-color: #764ba2; }
        .file-input { display: none; }
        .paste-area { width: 100%; height: 200px; padding: 15px; border: 2px solid #667eea; border-radius: 10px; font-family: monospace; resize: vertical; }
        .question-preview { background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-right: 4px solid #667eea; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer; }
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #667eea; color: white; }
        .breadcrumb { background: #f5f5f5; border-radius: 10px; padding: 15px 20px; margin-bottom: 20px; }
        .breadcrumb a { color: #667eea; text-decoration: none; cursor: pointer; font-weight: bold; }
        .action-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; padding: 15px; background: #f0f4ff; border-radius: 10px; }
        .empty-state { text-align: center; padding: 50px; color: #666; }
        .login-screen { max-width: 500px; margin: 100px auto; }
        #upload-progress { margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; display: none; }
    </style>
<base target="_blank">
<base target="_blank">
</head>
<body>
    <!-- Login -->
    <div id="login-screen" class="container">
        <div class="section login-screen">
            <div class="header"><h1>‚öôÔ∏è Admin Panel</h1><p>MedQuiz HNU</p></div>
            <div class="form-group"><label>Password</label><input type="password" id="admin-password" placeholder="Enter password"></div>
            <button class="btn btn-primary" onclick="adminLogin()" style="width: 100%;">Login</button>
            <div style="text-align: center; margin-top: 20px;"><a href="index.html" class="btn btn-secondary">üè† Student View</a></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="container hidden">
        <div class="header">
            <h1>‚öôÔ∏è Admin Panel</h1>
            <div style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
                <a href="index.html" class="btn btn-secondary">üè† Student View</a>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number" id="total-students">0</div><div class="stat-label">Students</div></div>
            <div class="stat-card"><div class="stat-number" id="total-quizzes">0</div><div class="stat-label">Quizzes</div></div>
            <div class="stat-card"><div class="stat-number" id="total-questions">0</div><div class="stat-label">Questions</div></div>
            <div class="stat-card"><div class="stat-number" id="total-files">0</div><div class="stat-label">Files</div></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('content')">üìÅ Content</button>
            <button class="nav-tab" onclick="showTab('students')">üë• Students</button>
            <button class="nav-tab" onclick="showTab('notifications')">üîî Notifications</button>
        </div>

        <!-- Content Tab -->
        <div id="content-tab" class="section">
            <div id="content-breadcrumb" class="breadcrumb"><a onclick="loadHome()">üè† Home</a></div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openModal('folder-modal')">üìÅ New Folder</button>
                <button class="btn btn-success" onclick="openModal('quiz-modal')">üìù New Quiz</button>
                <button class="btn btn-warning" onclick="openCloudinaryUpload()">üìé Upload File</button>
            </div>
            <div id="content-area"></div>
        </div>

        <!-- Students Tab -->
        <div id="students-tab" class="section hidden">
            <h2>Students</h2>
            <div id="students-list"></div>
        </div>

        <!-- Notifications Tab -->
        <div id="notifications-tab" class="section hidden">
            <h2>Send Notification</h2>
            <div class="form-group"><label>Message</label><input type="text" id="notif-msg" placeholder="Message"></div>
            <div class="form-group"><label>Duration</label><select id="notif-dur"><option value="1">1 Day</option><option value="7">1 Week</option><option value="30">1 Month</option></select></div>
            <button class="btn btn-primary" onclick="sendNotification()">Send</button>
            <h3 style="margin-top: 20px;">Active</h3>
            <div id="active-notifications"></div>
        </div>
    </div>

    <!-- Folder Modal -->
    <div id="folder-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('folder-modal')">&times;</button>
            <h2>New Folder</h2>
            <p style="color: #666;">Location: <span id="folder-loc">Home</span></p>
            <div class="form-group"><label>Name</label><input type="text" id="folder-name" placeholder="Folder name"></div>
            <button class="btn btn-primary" onclick="createFolder()">Create</button>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('quiz-modal')">&times;</button>
            <h2>New Quiz</h2>
            <p style="color: #666;">Location: <span id="quiz-loc">Home</span></p>
            <div class="form-group"><label>Title</label><input type="text" id="quiz-title" placeholder="Quiz title"></div>
            <div class="form-group"><label>Questions (Format: Question, A), B), C), D), Correct: X, Explanation)</label><textarea class="paste-area" id="quiz-text" placeholder="Question: What is...?&#10;A) Option 1&#10;B) Option 2&#10;C) Option 3&#10;D) Option 4&#10;Correct: B&#10;Explanation: Because..."></textarea></div>
            <button class="btn btn-primary" onclick="parseQuiz()">Parse</button>
            <div id="quiz-preview" class="hidden">
                <h3>Preview (<span id="preview-count">0</span>)</h3>
                <div id="preview-list"></div>
                <button class="btn btn-success" onclick="saveQuiz()">Save Quiz</button>
            </div>
        </div>
    </div>

    <!-- Edit Folder Modal -->
    <div id="edit-folder-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('edit-folder-modal')">&times;</button>
            <h2>Edit Folder</h2>
            <div class="form-group"><label>New Name</label><input type="text" id="edit-folder-name"></div>
            <button class="btn btn-primary" onclick="updateFolder()">Update</button>
        </div>
    </div>

    <!-- Edit Quiz Modal -->
    <div id="edit-quiz-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <button class="close-btn" onclick="closeModal('edit-quiz-modal')">&times;</button>
            <h2>Edit Quiz</h2>
            <div class="form-group"><label>Title</label><input type="text" id="edit-quiz-title"></div>
            <div id="edit-questions"></div>
            <button class="btn btn-primary" onclick="addQuestion()">+ Add Question</button>
            <button class="btn btn-success" onclick="updateQuiz()">Save</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB001YxSS9iQ6PArK1VHf0lIlpLyP1Rqew",
            authDomain: "medquiz-hnu.firebaseapp.com",
            projectId: "medquiz-hnu",
            storageBucket: "medquiz-hnu.firebasestorage.app",
            messagingSenderId: "862221476635",
            appId: "1:862221476635:web:369ca0e1f3b22b3eac29be"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const ADMIN_PASS = 'jana';
        let currentPath = [];
        let currentQuestions = [];
        let editingQuizId = null;
        let editingFolderId = null;

        // Cloudinary Configuration
        const CLOUDINARY_CLOUD_NAME = 'dtr331m22';
        const CLOUDINARY_UPLOAD_PRESET = 'medquiz_unsigned';

        window.onload = function() {
            console.log('Admin page loaded');
            console.log('Firebase initialized:', firebase.apps.length > 0);
            if (localStorage.getItem('admin_logged_in') === 'true') showPanel();
        };

        function adminLogin() {
            const pass = document.getElementById('admin-password').value;
            if (pass === ADMIN_PASS) {
                localStorage.setItem('admin_logged_in', 'true');
                showPanel();
            } else alert('Wrong password!');
        }

        function logout() {
            localStorage.removeItem('admin_logged_in');
            location.reload();
        }

        function showPanel() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            loadStats();
            loadHome();
        }

        function loadStats() {
            db.collection('users').get().then(s => { document.getElementById('total-students').textContent = s.size; });
            db.collection('quizzes').get().then(s => { document.getElementById('total-quizzes').textContent = s.size; });
            db.collectionGroup('questions').get().then(s => { document.getElementById('total-questions').textContent = s.size; });
            db.collection('files').get().then(s => { document.getElementById('total-files').textContent = s.size; });
        }

        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#content-tab, #students-tab, #notifications-tab').forEach(t => t.classList.add('hidden'));
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.remove('hidden');
            if (tab === 'students') loadStudents();
            if (tab === 'notifications') loadNotifications();
        }

        function loadHome() {
            currentPath = [];
            updateBreadcrumb();
            loadFolderContent(null);
        }

        function openFolder(id, name) {
            currentPath.push({ id: id, name: name });
            updateBreadcrumb();
            loadFolderContent(id);
        }

        function loadFolderContent(folderId) {
            Promise.all([
                db.collection('folders').where('parentId', '==', folderId).get(),
                db.collection('quizzes').where('folderId', '==', folderId).get(),
                db.collection('files').where('folderId', '==', folderId).get()
            ]).then(([folders, quizzes, files]) => {
                let html = '<div class="folders-grid">';
                let hasContent = false;

                folders.forEach(doc => {
                    hasContent = true;
                    const f = doc.data();
                    html += `<div class="folder-card"><button class="edit-btn" onclick="event.stopPropagation(); editFolder('${doc.id}', '${f.name}')">‚úèÔ∏è</button><button class="delete-btn" onclick="event.stopPropagation(); deleteFolder('${doc.id}')">üóëÔ∏è</button><div class="folder-icon" onclick="openFolder('${doc.id}', '${f.name}')">üìÅ</div><div class="folder-name" onclick="openFolder('${doc.id}', '${f.name}')">${f.name}</div></div>`;
                });

                quizzes.forEach(doc => {
                    hasContent = true;
                    const q = doc.data();
                    html += `<div class="quiz-card"><button class="edit-btn" onclick="event.stopPropagation(); editQuiz('${doc.id}')">‚úèÔ∏è</button><button class="delete-btn" onclick="event.stopPropagation(); deleteQuiz('${doc.id}')">üóëÔ∏è</button><div class="folder-icon">üìù</div><div class="folder-name">${q.title}</div><div style="color: #666; font-size: 0.9em;">${q.questionCount || 0} questions</div></div>`;
                });

                files.forEach(doc => {
                    hasContent = true;
                    const f = doc.data();
                    const icon = f.name.endsWith('.pdf') ? 'üìÑ' : f.name.endsWith('.ppt') ? 'üìä' : 'üìù';
                    html += `<div class="file-card"><button class="delete-btn" onclick="event.stopPropagation(); deleteFile('${doc.id}', '${f.publicId || ''}')">üóëÔ∏è</button><div class="folder-icon">${icon}</div><div class="folder-name">${f.name}</div><div style="color: #666; font-size: 0.9em;">${(f.size/1024).toFixed(1)} KB</div></div>`;
                });

                if (!hasContent) html += '<div class="empty-state" style="grid-column: 1/-1;"><h3>Empty</h3><p>Add folders, quizzes, or files</p></div>';
                html += '</div>';
                document.getElementById('content-area').innerHTML = html;
            });
        }

        function updateBreadcrumb() {
            let html = '<a onclick="loadHome()">üè† Home</a>';
            currentPath.forEach((item, i) => {
                html += ' / ';
                if (i === currentPath.length - 1) html += `<strong>${item.name}</strong>`;
                else html += `<a onclick="navigateTo(${i})">${item.name}</a>`;
            });
            document.getElementById('content-breadcrumb').innerHTML = html;
            const loc = currentPath.length > 0 ? currentPath[currentPath.length - 1].name : 'Home';
            document.getElementById('folder-loc').textContent = loc;
            document.getElementById('quiz-loc').textContent = loc;
        }

        function navigateTo(index) {
            currentPath = currentPath.slice(0, index + 1);
            updateBreadcrumb();
            loadFolderContent(currentPath[currentPath.length - 1].id);
        }

        function createFolder() {
            const name = document.getElementById('folder-name').value.trim();
            if (!name) return alert('Enter folder name');
            const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            db.collection('folders').add({ name: name, parentId: parentId, createdAt: new Date() }).then(() => {
                closeModal('folder-modal');
                document.getElementById('folder-name').value = '';
                loadFolderContent(parentId);
            });
        }

        function editFolder(id, name) {
            editingFolderId = id;
            document.getElementById('edit-folder-name').value = name;
            openModal('edit-folder-modal');
        }

        function updateFolder() {
            const name = document.getElementById('edit-folder-name').value.trim();
            if (!name) return;
            db.collection('folders').doc(editingFolderId).update({ name }).then(() => {
                closeModal('edit-folder-modal');
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(parentId);
            });
        }

        function deleteFolder(id) {
            if (!confirm('Delete folder and all contents?')) return;
            db.collection('folders').where('parentId', '==', id).get().then(snap => {
                snap.forEach(d => deleteFolder(d.id));
            });
            db.collection('quizzes').where('folderId', '==', id).get().then(snap => {
                snap.forEach(d => deleteQuiz(d.id));
            });
            db.collection('files').where('folderId', '==', id).get().then(snap => {
                snap.forEach(d => deleteFile(d.id, d.data().publicId));
            });
            db.collection('folders').doc(id).delete();
            setTimeout(() => {
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(parentId);
            }, 500);
        }

        function parseQuiz() {
            const text = document.getElementById('quiz-text').value;
            if (!text.trim()) return alert('Enter questions');
            currentQuestions = [];
            const blocks = text.split(/\n\s*\n|(?=Question:)/i).filter(b => b.trim());
            blocks.forEach(block => {
                const lines = block.split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length < 6) return;
                const qLine = lines.find(l => l.match(/^Question:/i)) || lines[0];
                const question = qLine.replace(/^Question:/i, '').trim();
                const options = [];
                lines.forEach(l => {
                    const m = l.match(/^([A-D])[).]\s*(.+)/i);
                    if (m && options.length < 4) options.push(m[2].trim());
                });
                if (options.length !== 4) return;
                let correct = 0;
                const cLine = lines.find(l => l.match(/^Correct:/i));
                if (cLine) {
                    const cm = cLine.match(/^Correct:\s*([A-D])/i);
                    if (cm) correct = cm[1].toUpperCase().charCodeAt(0) - 65;
                }
                let exp = '';
                const eLine = lines.find(l => l.match(/^Explanation:/i));
                if (eLine) exp = eLine.replace(/^Explanation:/i, '').trim();
                currentQuestions.push({ question, options, correctAnswer: correct, explanation: exp });
            });
            if (currentQuestions.length === 0) return alert('No valid questions');
            document.getElementById('quiz-preview').classList.remove('hidden');
            document.getElementById('preview-count').textContent = currentQuestions.length;
            document.getElementById('preview-list').innerHTML = currentQuestions.map((q, i) => `<div class="question-preview"><strong>Q${i+1}:</strong> ${q.question}<br>${q.options.map((o, j) => `<span style="${j===q.correctAnswer?'color:green;font-weight:bold':''}">${String.fromCharCode(65+j)}) ${o}</span>`).join('<br>')}</div>`).join('');
        }

        function saveQuiz() {
            const title = document.getElementById('quiz-title').value.trim();
            if (!title) return alert('Enter title');
            if (currentQuestions.length === 0) return alert('No questions');
            const folderId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            db.collection('quizzes').add({ title: title, folderId: folderId, questionCount: currentQuestions.length, createdAt: new Date() }).then(docRef => {
                let saved = 0;
                currentQuestions.forEach((q, i) => {
                    db.collection('quizzes').doc(docRef.id).collection('questions').add({ ...q, order: i }).then(() => {
                        saved++;
                        if (saved === currentQuestions.length) {
                            closeModal('quiz-modal');
                            document.getElementById('quiz-title').value = '';
                            document.getElementById('quiz-text').value = '';
                            document.getElementById('quiz-preview').classList.add('hidden');
                            currentQuestions = [];
                            loadFolderContent(folderId);
                            loadStats();
                            alert('Quiz saved!');
                        }
                    });
                });
            });
        }

        function editQuiz(id) {
            editingQuizId = id;
            db.collection('quizzes').doc(id).get().then(doc => {
                const q = doc.data();
                document.getElementById('edit-quiz-title').value = q.title;
                db.collection('quizzes').doc(id).collection('questions').orderBy('order').get().then(snap => {
                    currentQuestions = [];
                    let html = '';
                    snap.forEach((d, i) => {
                        const qu = d.data();
                        currentQuestions.push({ id: d.id, ...qu });
                        html += `<div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 10px;"><h4>Q${i+1}</h4><input type="text" id="q-${d.id}" value="${qu.question}" style="width: 100%; margin-bottom: 10px; padding: 8px;">${qu.options.map((o, j) => `<input type="text" id="opt-${d.id}-${j}" value="${o}" style="width: 100%; margin: 5px 0; padding: 8px;">`).join('')}<label>Correct:</label><select id="cor-${d.id}">${[0,1,2,3].map(j => `<option value="${j}" ${j===qu.correctAnswer?'selected':''}>${String.fromCharCode(65+j)}</option>`).join('')}</select><input type="text" id="exp-${d.id}" value="${qu.explanation || ''}" placeholder="Explanation" style="width: 100%; margin-top: 10px; padding: 8px;"><button class="btn btn-danger" style="margin-top: 10px;" onclick="deleteQuestion('${d.id}')">Delete</button></div>`;
                    });
                    document.getElementById('edit-questions').innerHTML = html;
                    openModal('edit-quiz-modal');
                });
            });
        }

        function addQuestion() {
            const tempId = 'temp_' + Date.now();
            const newQ = { id: tempId, question: '', options: ['', '', '', ''], correctAnswer: 0, explanation: '' };
            currentQuestions.push(newQ);
            const html = `<div id="div-${tempId}" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 10px;"><h4>Q${currentQuestions.length}</h4><input type="text" id="q-${tempId}" placeholder="Question" style="width: 100%; margin-bottom: 10px; padding: 8px;"><input type="text" id="opt-${tempId}-0" placeholder="A" style="width: 100%; margin: 5px 0; padding: 8px;"><input type="text" id="opt-${tempId}-1" placeholder="B" style="width: 100%; margin: 5px 0; padding: 8px;"><input type="text" id="opt-${tempId}-2" placeholder="C" style="width: 100%; margin: 5px 0; padding: 8px;"><input type="text" id="opt-${tempId}-3" placeholder="D" style="width: 100%; margin: 5px 0; padding: 8px;"><label>Correct:</label><select id="cor-${tempId}"><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option></select><input type="text" id="exp-${tempId}" placeholder="Explanation" style="width: 100%; margin-top: 10px; padding: 8px;"><button class="btn btn-danger" style="margin-top: 10px;" onclick="deleteQuestion('${tempId}')">Delete</button></div>`;
            document.getElementById('edit-questions').insertAdjacentHTML('beforeend', html);
        }

        function deleteQuestion(qid) {
            if (!qid.startsWith('temp_')) db.collection('quizzes').doc(editingQuizId).collection('questions').doc(qid).delete();
            document.getElementById(`div-${qid}`)?.remove();
            currentQuestions = currentQuestions.filter(q => q.id !== qid);
        }

        function updateQuiz() {
            const title = document.getElementById('edit-quiz-title').value.trim();
            if (!title) return alert('Enter title');
            db.collection('quizzes').doc(editingQuizId).update({ title });
            currentQuestions.forEach((q, i) => {
                const data = { question: document.getElementById(`q-${q.id}`).value, options: [0,1,2,3].map(j => document.getElementById(`opt-${q.id}-${j}`).value), correctAnswer: parseInt(document.getElementById(`cor-${q.id}`).value), explanation: document.getElementById(`exp-${q.id}`).value, order: i };
                if (q.id.startsWith('temp_')) db.collection('quizzes').doc(editingQuizId).collection('questions').add(data);
                else db.collection('quizzes').doc(editingQuizId).collection('questions').doc(q.id).update(data);
            });
            db.collection('quizzes').doc(editingQuizId).update({ questionCount: currentQuestions.length });
            closeModal('edit-quiz-modal');
            const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            loadFolderContent(parentId);
            loadStats();
        }

        function deleteQuiz(id) {
            if (!confirm('Delete quiz?')) return;
            db.collection('quizzes').doc(id).collection('questions').get().then(snap => {
                const batch = db.batch();
                snap.forEach(d => batch.delete(d.ref));
                return batch.commit();
            }).then(() => db.collection('quizzes').doc(id).delete()).then(() => {
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(parentId);
                loadStats();
            });
        }

        // CLOUDINARY FILE UPLOAD
        function openCloudinaryUpload() {
            const folderId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;

            // Check if cloudinary is loaded
            if (typeof cloudinary === 'undefined') {
                alert('Cloudinary widget not loaded. Please refresh the page.');
                return;
            }

            const widget = cloudinary.createUploadWidget({
                cloudName: CLOUDINARY_CLOUD_NAME,
                uploadPreset: CLOUDINARY_UPLOAD_PRESET,
                sources: ['local', 'url'],
                multiple: false,
                maxFiles: 1,
                resourceType: 'auto',
                clientAllowedFormats: ['pdf', 'ppt', 'pptx', 'doc', 'docx', 'txt'],
                maxFileSize: 10000000,
                showPoweredBy: false,
                language: 'en'
            }, (error, result) => {
                if (error) {
                    console.error('Cloudinary upload error:', error);
                    alert('Upload failed: ' + (error.message || error.statusText || 'Unknown error'));
                    return;
                }

                if (result && result.event === 'success') {
                    console.log('Upload successful:', result.info);

                    const fileData = {
                        name: result.info.original_filename + (result.info.format ? '.' + result.info.format : ''),
                        type: result.info.resource_type + '/' + (result.info.format || 'unknown'),
                        size: result.info.bytes,
                        url: result.info.secure_url,
                        publicId: result.info.public_id,
                        folderId: folderId,
                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    db.collection('files').add(fileData).then((docRef) => {
                        console.log('File saved to Firestore:', docRef.id);
                        loadFolderContent(folderId);
                        loadStats();
                        alert('File uploaded successfully!');
                    }).catch(err => {
                        console.error('Error saving to Firestore:', err);
                        alert('Error saving file info: ' + err.message);
                    });
                }
            });

            widget.open();
        }

        function deleteFile(id, publicId) {
            if (!confirm('Delete file?')) return;
            db.collection('files').doc(id).delete().then(() => {
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(parentId);
                loadStats();
            });
        }

        function loadStudents() {
            db.collection('users').get().then(snap => {
                let html = '<table><tr><th>Username</th><th>Quizzes</th><th>Avg</th></tr>';
                snap.forEach(doc => {
                    const u = doc.data();
                    const h = u.history || [];
                    const avg = h.length > 0 ? Math.round(h.reduce((a,b) => a + b.percent, 0) / h.length) : 0;
                    html += `<tr><td>${u.username}</td><td>${h.length}</td><td>${avg}%</td></tr>`;
                });
                html += '</table>';
                document.getElementById('students-list').innerHTML = html;
            });
        }

        function sendNotification() {
            const msg = document.getElementById('notif-msg').value.trim();
            const dur = parseInt(document.getElementById('notif-dur').value);
            if (!msg) return alert('Enter message');
            const exp = new Date(); exp.setDate(exp.getDate() + dur);
            db.collection('notifications').add({ message: msg, expiry: exp, active: true, createdAt: new Date() }).then(() => {
                document.getElementById('notif-msg').value = '';
                loadNotifications();
            });
        }

        function loadNotifications() {
            db.collection('notifications').where('active', '==', true).get().then(snap => {
                let html = '';
                snap.forEach(doc => {
                    const n = doc.data();
                    const d = n.expiry.toDate ? n.expiry.toDate().toLocaleDateString() : new Date(n.expiry).toLocaleDateString();
                    html += `<div style="padding: 15px; background: #e3f2fd; border-radius: 10px; margin-bottom: 10px;">${n.message}<br><small>Expires: ${d}</small><button class="btn btn-danger btn-small" style="float: right;" onclick="db.collection('notifications').doc('${doc.id}').update({active: false}); loadNotifications();">Delete</button></div>`;
                });
                document.getElementById('active-notifications').innerHTML = html || '<p>No active notifications</p>';
            });
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onclick = function(e) { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; };
    </script>
</body>
</html>
