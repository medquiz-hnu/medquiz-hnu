<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - MedQuiz HNU</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .header h1 { color: #667eea; font-size: 2.5em; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .stat-number { font-size: 2.5em; color: #667eea; font-weight: bold; }
        .stat-label { color: #666; margin-top: 5px; }
        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 10px 20px;
            background: #eee;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .folder-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            border: 2px solid transparent;
        }
        .folder-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .quiz-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            border: 2px solid transparent;
        }
        .quiz-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .folder-icon { font-size: 3em; margin-bottom: 10px; }
        .edit-btn, .delete-btn {
            position: absolute;
            top: 10px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            padding: 8px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .edit-btn { right: 50px; color: #667eea; }
        .delete-btn { right: 10px; color: #f44336; }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-small { padding: 8px 15px; font-size: 0.9em; }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
        }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .upload-area:hover { background: #e3f2fd; border-color: #764ba2; }
        .file-input { display: none; }
        .paste-area {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-family: monospace;
            resize: vertical;
        }
        .preview-section {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
        }
        .question-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-right: 4px solid #667eea;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
        }
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #667eea; color: white; }
        .breadcrumb {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        .breadcrumb a { color: #667eea; text-decoration: none; cursor: pointer; font-weight: bold; }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 10px;
        }
        .empty-state { text-align: center; padding: 50px; color: #666; }
        .login-screen { max-width: 500px; margin: 100px auto; }
    </style>
<base target="_blank">
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="container">
        <div class="section login-screen">
            <div class="header">
                <h1>‚öôÔ∏è Admin Panel</h1>
                <p>MedQuiz HNU Administration</p>
            </div>
            <div class="form-group">
                <label>Admin Password</label>
                <input type="password" id="admin-password" placeholder="Enter admin password">
            </div>
            <button class="btn btn-primary" onclick="adminLogin()" style="width: 100%;">Login</button>
            <div style="text-align: center; margin-top: 20px;">
                <a href="index.html" class="btn btn-secondary">üè† Back to Student View</a>
            </div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="admin-panel" class="container hidden">
        <div class="header">
            <h1>‚öôÔ∏è Admin Panel - MedQuiz HNU</h1>
            <p>Manage Content, Students, and Analytics</p>
            <div style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
                <a href="index.html" class="btn btn-secondary">üè† Student View</a>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number" id="total-students">0</div><div class="stat-label">Total Students</div></div>
            <div class="stat-card"><div class="stat-number" id="total-quizzes">0</div><div class="stat-label">Total Quizzes</div></div>
            <div class="stat-card"><div class="stat-number" id="total-questions">0</div><div class="stat-label">Total Questions</div></div>
            <div class="stat-card"><div class="stat-number" id="active-today">0</div><div class="stat-label">Active Today</div></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('content')">üìÅ Content</button>
            <button class="nav-tab" onclick="showTab('students')">üë• Students</button>
            <button class="nav-tab" onclick="showTab('notifications')">üîî Notifications</button>
            <button class="nav-tab" onclick="showTab('files')">üìé Files</button>
        </div>

        <!-- Content Tab -->
        <div id="content-tab" class="section">
            <div id="content-breadcrumb" class="breadcrumb"><a onclick="loadContentHome()">üè† Home</a></div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openModal('folder-modal')">üìÅ New Folder</button>
                <button class="btn btn-success" onclick="openModal('quiz-modal')">üìù New Quiz</button>
                <button class="btn btn-warning" onclick="openModal('file-modal')">üìé Upload File</button>
            </div>
            <div id="content-area"></div>
        </div>

        <!-- Students Tab -->
        <div id="students-tab" class="section hidden">
            <h2>Student Analytics</h2>
            <input type="text" class="search-box" placeholder="üîç Search students..." onkeyup="searchStudents()">
            <div id="students-list"></div>
        </div>

        <!-- Notifications Tab -->
        <div id="notifications-tab" class="section hidden">
            <h2>Send Notification</h2>
            <div class="notification-form">
                <div class="form-group">
                    <label>Message</label>
                    <input type="text" id="notif-message" placeholder="Enter notification message">
                </div>
                <div class="form-group">
                    <label>Target</label>
                    <select id="notif-target"><option value="">All Students</option></select>
                </div>
                <div class="form-group">
                    <label>Duration</label>
                    <select id="notif-duration">
                        <option value="1">1 Day</option>
                        <option value="3">3 Days</option>
                        <option value="7">1 Week</option>
                        <option value="30">1 Month</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="sendNotification()">Send Notification</button>
            </div>
            <h3>Active Notifications</h3>
            <div id="active-notifications"></div>
        </div>

        <!-- Files Tab -->
        <div id="files-tab" class="section hidden">
            <h2>File Manager</h2>
            <div id="files-list"></div>
        </div>
    </div>

    <!-- Folder Modal -->
    <div id="folder-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('folder-modal')">&times;</button>
            <h2>Add New Folder</h2>
            <p style="color: #666; margin-bottom: 15px;">Current location: <span id="folder-location">Home</span></p>
            <div class="form-group">
                <label>Folder Name</label>
                <input type="text" id="folder-name" placeholder="e.g., Year 1, Semester 1, Anatomy">
            </div>
            <button class="btn btn-primary" onclick="createFolder()">Create Folder</button>
        </div>
    </div>

    <!-- Edit Folder Modal -->
    <div id="edit-folder-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('edit-folder-modal')">&times;</button>
            <h2>Edit Folder</h2>
            <div class="form-group">
                <label>New Name</label>
                <input type="text" id="edit-folder-name">
            </div>
            <button class="btn btn-primary" onclick="updateFolder()">Update</button>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('quiz-modal')">&times;</button>
            <h2>Add New Quiz</h2>
            <p style="color: #666; margin-bottom: 15px;">Current location: <span id="quiz-location">Home</span></p>
            <div class="form-group">
                <label>Quiz Title</label>
                <input type="text" id="quiz-title" placeholder="e.g., Quiz 1: Cell Biology">
            </div>
            <div class="nav-tabs" style="margin: 20px 0;">
                <button class="nav-tab active" onclick="showQuizTab('paste')">üìù Paste Text</button>
            </div>
            <div id="quiz-paste-tab">
                <textarea class="paste-area" id="quiz-paste" placeholder="Paste questions here...

Format:
Question: What is the capital of Egypt?
A) Alexandria
B) Cairo
C) Luxor
D) Aswan
Correct: B
Explanation: Cairo is the capital.

Question: Next question..."></textarea>
                <button class="btn btn-primary" onclick="parsePastedText()">Parse Questions</button>
            </div>
            <div id="quiz-preview" class="preview-section hidden">
                <h3>Preview (<span id="preview-count">0</span> questions)</h3>
                <div id="preview-list"></div>
                <button class="btn btn-success" onclick="saveQuiz()">‚úÖ Save Quiz</button>
            </div>
        </div>
    </div>

    <!-- Edit Quiz Modal -->
    <div id="edit-quiz-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <button class="close-btn" onclick="closeModal('edit-quiz-modal')">&times;</button>
            <h2>Edit Quiz</h2>
            <div class="form-group">
                <label>Quiz Title</label>
                <input type="text" id="edit-quiz-title">
            </div>
            <div id="edit-questions-list"></div>
            <button class="btn btn-primary" onclick="addQuestionField()">+ Add Question</button>
            <button class="btn btn-success" onclick="updateQuiz()">üíæ Save Changes</button>
        </div>
    </div>

    <!-- File Modal -->
    <div id="file-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('file-modal')">&times;</button>
            <h2>Upload File</h2>
            <p style="color: #666; margin-bottom: 15px;">Current location: <span id="file-location">Home</span></p>
            <div class="upload-area" onclick="document.getElementById('modal-file-upload').click()">
                <div style="font-size: 3em;">üìé</div>
                <h3>Click to Upload</h3>
                <p>PDF, PPT, Word files</p>
                <input type="file" id="modal-file-upload" class="file-input" accept=".pdf,.ppt,.pptx,.doc,.docx" onchange="handleModalFileUpload(event)">
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="student-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <button class="close-btn" onclick="closeModal('student-modal')">&times;</button>
            <h2>Student Details</h2>
            <div id="student-details"></div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB001YxSS9iQ6PArK1VHf0lIlpLyP1Rqew",
            authDomain: "medquiz-hnu.firebaseapp.com",
            projectId: "medquiz-hnu",
            storageBucket: "medquiz-hnu.firebasestorage.app",
            messagingSenderId: "862221476635",
            appId: "1:862221476635:web:369ca0e1f3b22b3eac29be",
            measurementId: "G-4T9XPB89N7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        const ADMIN_PASSWORD = 'jana';
        let currentPath = [];
        let currentQuestions = [];
        let editingQuizId = null;
        let editingFolderId = null;

        window.onload = function() {
            if (localStorage.getItem('admin_logged_in') === 'true') {
                showAdminPanel();
            }
        };

        function adminLogin() {
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('admin_logged_in', 'true');
                showAdminPanel();
            } else {
                alert('Incorrect password!');
            }
        }

        function logout() {
            localStorage.removeItem('admin_logged_in');
            location.reload();
        }

        function showAdminPanel() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            loadStats();
            loadContentHome();
            loadStudents();
            loadNotifications();
            loadFiles();
        }

        function loadStats() {
            db.collection('users').get().then(snap => { document.getElementById('total-students').textContent = snap.size; });
            db.collection('quizzes').get().then(snap => { document.getElementById('total-quizzes').textContent = snap.size; });
            db.collectionGroup('questions').get().then(snap => { document.getElementById('total-questions').textContent = snap.size; });
            const today = new Date(); today.setHours(0, 0, 0, 0);
            db.collection('users').where('lastActive', '>=', today).get().then(snap => { document.getElementById('active-today').textContent = snap.size; });
        }

        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#content-tab, #students-tab, #notifications-tab, #files-tab').forEach(t => t.classList.add('hidden'));
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.remove('hidden');
        }

        // Content Management
        function loadContentHome() {
            currentPath = [];
            updateContentBreadcrumb();
            loadFolderContent(null);
        }

        function openContentFolder(folderId, folderName) {
            currentPath.push({ id: folderId, name: folderName, type: 'folder' });
            updateContentBreadcrumb();
            loadFolderContent(folderId);
        }

        function loadFolderContent(folderId) {
            db.collection('folders').where('parentId', '==', folderId).get().then(foldersSnap => {
                db.collection('quizzes').where('folderId', '==', folderId).get().then(quizzesSnap => {
                    renderContentArea(foldersSnap, quizzesSnap);
                });
            });
        }

        function renderContentArea(foldersSnap, quizzesSnap) {
            let html = '<div class="folders-grid">';
            let hasContent = false;
            foldersSnap.forEach(doc => {
                hasContent = true;
                const folder = doc.data();
                html += `<div class="folder-card" data-id="${doc.id}" data-type="folder"><button class="edit-btn" onclick="event.stopPropagation(); editFolder('${doc.id}', '${folder.name}')">‚úèÔ∏è</button><button class="delete-btn" onclick="event.stopPropagation(); deleteFolder('${doc.id}')">üóëÔ∏è</button><div class="folder-icon" onclick="openContentFolder('${doc.id}', '${folder.name}')">üìÅ</div><div class="folder-name" onclick="openContentFolder('${doc.id}', '${folder.name}')">${folder.name}</div></div>`;
            });
            quizzesSnap.forEach(doc => {
                hasContent = true;
                const quiz = doc.data();
                html += `<div class="quiz-card" data-id="${doc.id}" data-type="quiz"><button class="edit-btn" onclick="event.stopPropagation(); editQuiz('${doc.id}')">‚úèÔ∏è</button><button class="delete-btn" onclick="event.stopPropagation(); deleteQuiz('${doc.id}')">üóëÔ∏è</button><div class="folder-icon">üìù</div><div class="folder-name">${quiz.title}</div><div style="color: #666; font-size: 0.9em;">${quiz.questionCount || 0} questions</div></div>`;
            });
            if (!hasContent) html += `<div class="empty-state" style="grid-column: 1/-1;"><div style="font-size: 4em; margin-bottom: 20px;">üìÇ</div><h3>This folder is empty</h3><p>Create folders, quizzes, or upload files</p></div>`;
            html += '</div>';
            document.getElementById('content-area').innerHTML = html;
        }

        function updateContentBreadcrumb() {
            let html = '<a onclick="loadContentHome()">üè† Home</a>';
            currentPath.forEach((item, index) => {
                html += ' / ';
                if (index === currentPath.length - 1) html += `<strong>${item.name}</strong>`;
                else html += `<a onclick="navigateToPath(${index})">${item.name}</a>`;
            });
            document.getElementById('content-breadcrumb').innerHTML = html;
            const currentLocation = currentPath.length > 0 ? currentPath[currentPath.length - 1].name : 'Home';
            document.getElementById('folder-location').textContent = currentLocation;
            document.getElementById('quiz-location').textContent = currentLocation;
            document.getElementById('file-location').textContent = currentLocation;
        }

        function navigateToPath(index) {
            currentPath = currentPath.slice(0, index + 1);
            updateContentBreadcrumb();
            const currentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            loadFolderContent(currentId);
        }

        // Folder CRUD
        function createFolder() {
            const name = document.getElementById('folder-name').value.trim();
            if (!name) return alert('Please enter folder name');
            const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            db.collection('folders').add({ name: name, parentId: parentId, createdAt: new Date() }).then(() => {
                closeModal('folder-modal');
                document.getElementById('folder-name').value = '';
                const currentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(currentId);
            });
        }

        function editFolder(id, name) {
            editingFolderId = id;
            document.getElementById('edit-folder-name').value = name;
            openModal('edit-folder-modal');
        }

        function updateFolder() {
            const name = document.getElementById('edit-folder-name').value.trim();
            if (!name) return;
            db.collection('folders').doc(editingFolderId).update({ name }).then(() => {
                closeModal('edit-folder-modal');
                const currentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(currentId);
            });
        }

        function deleteFolder(id) {
            if (!confirm('Delete this folder and ALL contents?')) return;
            deleteFolderRecursive(id).then(() => {
                const currentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(currentId);
                loadStats();
            });
        }

        function deleteFolderRecursive(folderId) {
            return new Promise((resolve) => {
                db.collection('folders').where('parentId', '==', folderId).get().then(snap => {
                    const promises = [];
                    snap.forEach(doc => { promises.push(deleteFolderRecursive(doc.id)); });
                    return Promise.all(promises);
                }).then(() => {
                    return db.collection('quizzes').where('folderId', '==', folderId).get();
                }).then(snap => {
                    const promises = [];
                    snap.forEach(doc => { promises.push(deleteQuizAndQuestions(doc.id)); });
                    return Promise.all(promises);
                }).then(() => {
                    return db.collection('folders').doc(folderId).delete();
                }).then(() => { resolve(); });
            });
        }

        // Quiz CRUD
        function showQuizTab(tab) {
            document.querySelectorAll('#quiz-modal .nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        function parsePastedText() {
            const text = document.getElementById('quiz-paste').value;
            if (!text.trim()) return alert('Please paste some text');
            currentQuestions = [];
            const blocks = text.split(/\n\s*\n|(?=Question:)/i).filter(b => b.trim());
            blocks.forEach(block => {
                const lines = block.split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length < 6) return;
                let questionLine = lines.find(l => l.match(/^Question:/i));
                if (!questionLine) questionLine = lines[0];
                const question = questionLine.replace(/^Question:/i, '').trim();
                const options = [];
                for (let i = 0; i < lines.length; i++) {
                    const match = lines[i].match(/^([A-D])[).]\s*(.+)/i);
                    if (match && options.length < 4) options.push(match[2].trim());
                }
                if (options.length !== 4) return;
                let correctIndex = 0;
                const correctLine = lines.find(l => l.match(/^Correct:/i));
                if (correctLine) {
                    const correctMatch = correctLine.match(/^Correct:\s*([A-D])/i);
                    if (correctMatch) correctIndex = correctMatch[1].toUpperCase().charCodeAt(0) - 65;
                }
                let explanation = '';
                const expLine = lines.find(l => l.match(/^Explanation:/i));
                if (expLine) explanation = expLine.replace(/^Explanation:/i, '').trim();
                currentQuestions.push({ question: question, options: options, correctAnswer: correctIndex, explanation: explanation });
            });
            if (currentQuestions.length === 0) { alert('No valid questions found'); return; }
            showQuizPreview();
        }

        function showQuizPreview() {
            document.getElementById('quiz-preview').classList.remove('hidden');
            document.getElementById('preview-count').textContent = currentQuestions.length;
            document.getElementById('preview-list').innerHTML = currentQuestions.map((q, i) => `<div class="question-preview"><strong>Q${i+1}:</strong> ${q.question}<br>${q.options.map((opt, idx) => `<span style="${idx === q.correctAnswer ? 'color: #4caf50; font-weight: bold;' : ''}">${String.fromCharCode(65+idx)}) ${opt}</span>`).join('<br>')}${q.explanation ? `<br><small style="color: #666;">Explanation: ${q.explanation}</small>` : ''}</div>`).join('');
        }

        function saveQuiz() {
            const title = document.getElementById('quiz-title').value.trim();
            if (!title) return alert('Please enter quiz title');
            if (currentQuestions.length === 0) return alert('No questions to save');
            const folderId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            db.collection('quizzes').add({ title: title, folderId: folderId, questionCount: currentQuestions.length, createdAt: new Date() }).then(docRef => {
                let saved = 0;
                currentQuestions.forEach((q, index) => {
                    db.collection('quizzes').doc(docRef.id).collection('questions').add({ ...q, order: index, createdAt: new Date() }).then(() => {
                        saved++;
                        if (saved === currentQuestions.length) {
                            closeModal('quiz-modal');
                            document.getElementById('quiz-title').value = '';
                            document.getElementById('quiz-paste').value = '';
                            document.getElementById('quiz-preview').classList.add('hidden');
                            currentQuestions = [];
                            const currentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                            loadFolderContent(currentId);
                            loadStats();
                            alert('Quiz saved successfully!');
                        }
                    });
                });
            });
        }

        function editQuiz(id) {
            editingQuizId = id;
            db.collection('quizzes').doc(id).get().then(doc => {
                const quiz = doc.data();
                document.getElementById('edit-quiz-title').value = quiz.title;
                db.collection('quizzes').doc(id).collection('questions').orderBy('order').get().then(qSnap => {
                    currentQuestions = [];
                    let html = '';
                    qSnap.forEach((qDoc, index) => {
                        const q = qDoc.data();
                        currentQuestions.push({ id: qDoc.id, ...q });
                        html += renderQuestionEditField(qDoc.id, index, q);
                    });
                    document.getElementById('edit-questions-list').innerHTML = html;
                    openModal('edit-quiz-modal');
                });
            });
        }

        function renderQuestionEditField(qid, index, q) {
            return `<div class="question-preview" id="edit-q-${qid}" style="margin-bottom: 15px; border: 2px solid #e0e0e0; padding: 15px;"><h4>Question ${index + 1}</h4><div class="form-group"><input type="text" id="edit-q-text-${qid}" value="${q.question}" placeholder="Question text" style="width: 100%; margin-bottom: 10px;"><div style="display: grid; gap: 10px; margin: 10px 0;">${q.options.map((opt, i) => `<div style="display: flex; align-items: center; gap: 10px;"><span style="font-weight: bold; color: ${i === q.correctAnswer ? '#4caf50' : '#666'};">${String.fromCharCode(65+i)})</span><input type="text" id="edit-opt-${qid}-${i}" value="${opt}" style="flex: 1;"></div>`).join('')}</div><div style="margin-top: 10px;"><label>Correct Answer: </label><select id="edit-correct-${qid}" style="padding: 5px;">${[0,1,2,3].map(i => `<option value="${i}" ${i === q.correctAnswer ? 'selected' : ''}>${String.fromCharCode(65+i)}</option>`).join('')}</select></div><div style="margin-top: 10px;"><input type="text" id="edit-exp-${qid}" value="${q.explanation || ''}" placeholder="Explanation (optional)" style="width: 100%;"></div><button class="btn btn-danger btn-small" style="margin-top: 10px;" onclick="deleteQuestion('${qid}')">üóëÔ∏è Delete Question</button></div></div>`;
        }

        function addQuestionField() {
            const tempId = 'temp_' + Date.now();
            const newQ = { question: '', options: ['', '', '', ''], correctAnswer: 0, explanation: '' };
            currentQuestions.push({ id: tempId, ...newQ });
            const html = renderQuestionEditField(tempId, currentQuestions.length - 1, newQ);
            document.getElementById('edit-questions-list').insertAdjacentHTML('beforeend', html);
        }

        function updateQuiz() {
            const title = document.getElementById('edit-quiz-title').value.trim();
            if (!title) return alert('Please enter quiz title');
            db.collection('quizzes').doc(editingQuizId).update({ title });
            const updatePromises = [];
            currentQuestions.forEach((q, index) => {
                const questionData = { question: document.getElementById(`edit-q-text-${q.id}`).value, options: [0,1,2,3].map(i => document.getElementById(`edit-opt-${q.id}-${i}`).value), correctAnswer: parseInt(document.getElementById(`edit-correct-${q.id}`).value), explanation: document.getElementById(`edit-exp-${q.id}`).value, order: index };
                if (q.id.startsWith('temp_')) { questionData.createdAt = new Date(); updatePromises.push(db.collection('quizzes').doc(editingQuizId).collection('questions').add(questionData)); }
                else { updatePromises.push(db.collection('quizzes').doc(editingQuizId).collection('questions').doc(q.id).update(questionData)); }
            });
            Promise.all(updatePromises).then(() => { return db.collection('quizzes').doc(editingQuizId).update({ questionCount: currentQuestions.length }); }).then(() => {
                closeModal('edit-quiz-modal');
                const currentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(currentId);
                loadStats();
                alert('Quiz updated successfully!');
            });
        }

        function deleteQuestion(qid) {
            if (!confirm('Delete this question?')) return;
            if (!qid.startsWith('temp_')) { db.collection('quizzes').doc(editingQuizId).collection('questions').doc(qid).delete(); }
            document.getElementById(`edit-q-${qid}`).remove();
            currentQuestions = currentQuestions.filter(q => q.id !== qid);
        }

        function deleteQuiz(id) {
            if (!confirm('Delete this quiz?')) return;
            deleteQuizAndQuestions(id).then(() => {
                const currentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(currentId);
                loadStats();
            });
        }

        function deleteQuizAndQuestions(quizId) {
            return new Promise((resolve) => {
                db.collection('quizzes').doc(quizId).collection('questions').get().then(snap => {
                    const batch = db.batch();
                    snap.forEach(doc => { batch.delete(doc.ref); });
                    return batch.commit();
                }).then(() => { return db.collection('quizzes').doc(quizId).delete(); }).then(() => { resolve(); });
            });
        }

        // File Upload
        function handleModalFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            uploadFile(file);
            closeModal('file-modal');
        }

        function uploadFile(file) {
            const folderId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            const storageRef = storage.ref('files/' + Date.now() + '_' + file.name);
            const uploadTask = storageRef.put(file);
            uploadTask.on('state_changed', null, (error) => { alert('Error uploading: ' + file.name); }, () => {
                uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                    db.collection('files').add({ name: file.name, type: file.type, size: file.size, url: downloadURL, folderId: folderId, uploadedAt: new Date() }).then(() => {
                        const currentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                        loadFolderContent(currentId);
                        loadFiles();
                    });
                });
            });
        }

        function loadFiles() {
            db.collection('files').orderBy('uploadedAt', 'desc').get().then(snapshot => {
                let html = '<div class="file-list">';
                snapshot.forEach(doc => {
                    const file = doc.data();
                    const icon = file.name.endsWith('.pdf') ? 'üìÑ' : file.name.endsWith('.ppt') || file.name.endsWith('.pptx') ? 'üìä' : file.name.endsWith('.doc') || file.name.endsWith('.docx') ? 'üìù' : 'üìé';
                    html += `<div class="file-item"><div><div style="font-size: 1.5em;">${icon}</div><strong>${file.name}</strong><br><small>${(file.size / 1024).toFixed(2)} KB</small></div><div><a href="${file.url}" target="_blank" class="btn btn-primary btn-small">View</a><a href="${file.url}" class="btn btn-secondary btn-small" download>Download</a><button class="btn btn-danger btn-small" onclick="deleteFile('${doc.id}')">Delete</button></div></div>`;
                });
                html += '</div>';
                document.getElementById('files-list').innerHTML = html || '<p>No files uploaded yet</p>';
            });
        }

        function deleteFile(id) {
            if (!confirm('Delete this file?')) return;
            db.collection('files').doc(id).get().then(doc => {
                if (doc.exists) {
                    const fileData = doc.data();
                    storage.refFromURL(fileData.url).delete().catch(err => console.log('Storage error:', err));
                    db.collection('files').doc(id).delete().then(() => { loadFiles(); loadStats(); });
                }
            });
        }

        // Students
        function loadStudents() {
            db.collection('users').get().then(snapshot => {
                renderStudents(snapshot.docs);
                const select = document.getElementById('notif-target');
                select.innerHTML = '<option value="">All Students</option>';
                snapshot.forEach(doc => { select.innerHTML += `<option value="${doc.id}">${doc.data().username}</option>`; });
            });
        }

        function renderStudents(docs) {
            let html = '<table><tr><th>Username</th><th>Quizzes</th><th>Avg Score</th><th>Actions</th></tr>';
            docs.forEach(doc => {
                const user = doc.data();
                const history = user.history || [];
                const avg = history.length > 0 ? Math.round(history.reduce((a, b) => a + b.percent, 0) / history.length) : 0;
                html += `<tr><td>${user.username}</td><td>${history.length}</td><td>${avg}%</td><td><button class="btn btn-primary btn-small" onclick="viewStudent('${doc.id}')">View</button></td></tr>`;
            });
            html += '</table>';
            document.getElementById('students-list').innerHTML = html;
        }

        function searchStudents() {
            const query = document.querySelector('#students-tab .search-box').value.toLowerCase();
            db.collection('users').get().then(snapshot => {
                renderStudents(snapshot.docs.filter(d => d.data().username.toLowerCase().includes(query)));
            });
        }

        function viewStudent(id) {
            db.collection('users').doc(id).get().then(doc => {
                const user = doc.data();
                const history = user.history || [];
                let html = `<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px;"><h3>${user.username}</h3><p><strong>Total Quizzes:</strong> ${history.length}</p><p><strong>Average Score:</strong> ${history.length > 0 ? Math.round(history.reduce((a,b) => a + b.percent, 0) / history.length) : 0}%</p></div>`;
                if (history.length > 0) {
                    html += '<h4>Quiz History:</h4><table><tr><th>Quiz</th><th>Score</th><th>Date</th></tr>';
                    history.slice().reverse().forEach(h => { const date = h.date.toDate ? h.date.toDate().toLocaleDateString() : new Date(h.date).toLocaleDateString(); html += `<tr><td>${h.quizName}</td><td>${h.score}/${h.total} (${h.percent}%)</td><td>${date}</td></tr>`; });
                    html += '</table>';
                }
                document.getElementById('student-details').innerHTML = html;
                openModal('student-modal');
            });
        }

        // Notifications
        function sendNotification() {
            const message = document.getElementById('notif-message').value.trim();
            const target = document.getElementById('notif-target').value;
            const duration = parseInt(document.getElementById('notif-duration').value);
            if (!message) return alert('Please enter message');
            const expiry = new Date(); expiry.setDate(expiry.getDate() + duration);
            const notifData = { message: message, createdAt: new Date(), expiry: expiry, active: true };
            if (target) notifData.targetUser = target;
            db.collection('notifications').add(notifData).then(() => { alert('Notification sent!'); document.getElementById('notif-message').value = ''; loadNotifications(); });
        }

        function loadNotifications() {
            db.collection('notifications').where('active', '==', true).orderBy('createdAt', 'desc').get().then(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const notif = doc.data();
                    const expiry = notif.expiry.toDate ? notif.expiry.toDate().toLocaleDateString() : new Date(notif.expiry).toLocaleDateString();
                    const target = notif.targetUser ? ` (To: ${notif.targetUser})` : ' (To: All)';
                    html += `<div style="padding: 15px; background: #e3f2fd; border-radius: 10px; margin-bottom: 10px;"><strong>${notif.message}</strong>${target}<br><small>Expires: ${expiry}</small><button class="btn btn-danger btn-small" style="float: right;" onclick="deleteNotification('${doc.id}')">Delete</button></div>`;
                });
                document.getElementById('active-notifications').innerHTML = html || '<p>No active notifications</p>';
            });
        }

        function deleteNotification(id) { db.collection('notifications').doc(id).update({ active: false }); loadNotifications(); }

        // Modal Helpers
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onclick = function(event) { if (event.target.classList.contains('modal')) event.target.style.display = 'none'; };
    </script>
</body>
</html>
