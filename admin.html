<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - MedQuiz HNU</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #1a1a2e; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .header h1 { color: #667eea; font-size: 2.5em; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2.5em; color: #667eea; font-weight: bold; }
        .section { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-tab { padding: 10px 20px; background: #eee; border: none; border-radius: 25px; cursor: pointer; }
        .nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .folders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .folder-card { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .folder-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .quiz-card { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .quiz-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .file-card { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .file-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .folder-icon { font-size: 3em; margin-bottom: 10px; }
        .edit-btn, .delete-btn { position: absolute; top: 10px; background: white; border: none; cursor: pointer; font-size: 1.1em; padding: 8px; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        .edit-btn { right: 50px; color: #667eea; }
        .delete-btn { right: 10px; color: #f44336; }
        .btn { padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 1em; margin: 5px; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-warning { background: #ff9800; color: white; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; }
        .upload-area { border: 3px dashed #667eea; border-radius: 15px; padding: 40px; text-align: center; background: #f8f9fa; cursor: pointer; margin-bottom: 20px; transition: all 0.3s; }
        .upload-area:hover { background: #e3f2fd; border-color: #764ba2; }
        .file-input { display: none; }
        .paste-area { width: 100%; height: 200px; padding: 15px; border: 2px solid #667eea; border-radius: 10px; font-family: monospace; resize: vertical; }
        .question-preview { background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-right: 4px solid #667eea; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; }
        #manage-options-modal { z-index: 1100; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer; }
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #667eea; color: white; }
        .breadcrumb { background: #f5f5f5; border-radius: 10px; padding: 15px 20px; margin-bottom: 20px; }
        .breadcrumb a { color: #667eea; text-decoration: none; cursor: pointer; font-weight: bold; }
        .action-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; padding: 15px; background: #f0f4ff; border-radius: 10px; }
        .empty-state { text-align: center; padding: 50px; color: #444; }
        .login-screen { max-width: 500px; margin: 100px auto; }
        #upload-progress { margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; display: none; }
        .drive-btn { background: #4285f4; color: white; padding: 15px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 1.1em; margin: 10px 0; }
        .drive-btn:hover { background: #3367d6; }
        .link-input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; margin: 10px 0; }
        .quiz-method-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .quiz-tab { padding: 10px 20px; background: #eee; border: none; border-radius: 25px; cursor: pointer; font-size: 0.95em; transition: all 0.3s; }
        .quiz-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .quiz-tab:hover:not(.active) { background: #ddd; }
        .quiz-tab-content { transition: opacity 0.3s ease; }

        .custom-dialog-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;
        }
        .custom-dialog-overlay.active { display: flex; }
        .custom-dialog {
            background: white; border-radius: 20px; padding: 35px; max-width: 420px; width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;
            animation: dialogPop 0.3s ease;
        }
        @keyframes dialogPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .custom-dialog-icon { font-size: 3em; margin-bottom: 15px; }
        .custom-dialog-title { font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 10px; }
        .custom-dialog-msg { font-size: 1em; color: #444; margin-bottom: 25px; line-height: 1.5; }
        .custom-dialog-buttons { display: flex; gap: 12px; justify-content: center; }
        .custom-dialog-btn {
            padding: 12px 30px; border: none; border-radius: 12px; font-size: 1em;
            font-weight: bold; cursor: pointer; transition: all 0.2s; min-width: 110px;
        }
        .custom-dialog-btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .custom-dialog-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .custom-dialog-btn.danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; }
        .custom-dialog-btn.danger:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,107,107,0.4); }
        .custom-dialog-btn.cancel { background: #f0f0f0; color: #444; }
        .custom-dialog-btn.cancel:hover { background: #e0e0e0; }
        .custom-dialog-btn.success { background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; }
        .custom-dialog-btn.success:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76,175,80,0.4); }

        .move-folder-item { padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }

        .drag-handle { cursor: grab; font-size: 1.3em; color: #777; user-select: none; padding: 4px; position: relative; z-index: 11; }
        .drag-handle:active { cursor: grabbing; }
        .folder-card .drag-handle, .quiz-card .drag-handle, .file-card .drag-handle { position: absolute; top: 48px; left: 12px; }
        .dragging { opacity: 0.4; transform: scale(0.95); }
        .drag-over { border: 3px dashed #667eea !important; background: rgba(102,126,234,0.08) !important; }
        .drag-question.dragging { opacity: 0.4; }
        .drag-question.drag-over { border-color: #667eea !important; box-shadow: 0 0 15px rgba(102,126,234,0.3); }
        .move-folder-item:hover { border-color: #667eea; background: #f0f4ff; }

        body.admin-dark { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        body.admin-dark .header, body.admin-dark .section, body.admin-dark .stat-card { background: #1e293b; color: #e2e8f0; }
        body.admin-dark .header h1 { color: #818cf8; }
        body.admin-dark .stat-number { color: #818cf8; }
        body.admin-dark .folder-card { background: linear-gradient(135deg, #334155 0%, #1e293b 100%); color: #e2e8f0; }
        body.admin-dark .quiz-card { background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%); color: #e2e8f0; }
        body.admin-dark .file-card { background: linear-gradient(135deg, #1a3c34 0%, #1e293b 100%); color: #e2e8f0; }
        body.admin-dark .breadcrumb { background: #334155; }
        body.admin-dark .breadcrumb a, body.admin-dark .breadcrumb strong { color: #818cf8; }
        body.admin-dark .action-buttons { background: #334155; }
        body.admin-dark .nav-tab { background: #334155; color: #e2e8f0; }
        body.admin-dark .modal-content { background: #1e293b; color: #e2e8f0; }
        body.admin-dark .form-group label { color: #94a3b8; }
        body.admin-dark .form-group input, body.admin-dark .form-group textarea, body.admin-dark .form-group select { background: #334155; color: #e2e8f0; border-color: #475569; }
        body.admin-dark th { background: #4338ca; }
        body.admin-dark td { border-color: #334155; color: #e2e8f0; }
        body.admin-dark .edit-btn, body.admin-dark .delete-btn { background: #334155; }
        body.admin-dark .drag-handle { color: #64748b; }
        body.admin-dark .empty-state { color: #94a3b8; }
        body.admin-dark .question-preview { background: #334155; color: #e2e8f0; }
        body.admin-dark .custom-dialog { background: #1e293b; }
        body.admin-dark .custom-dialog-title { color: #e2e8f0; }
        body.admin-dark .custom-dialog-msg { color: #94a3b8; }
        body.admin-dark .custom-dialog-btn.cancel { background: #334155; color: #e2e8f0; }
        body.admin-dark #admin-search-input, body.admin-dark #admin-sort-select { background: #334155; color: #e2e8f0; border-color: #475569; }
        body.admin-dark #admin-search-results { background: #1e293b !important; border: 1px solid #334155; }
        body.admin-dark #admin-search-results div { color: #e2e8f0; }
        body.admin-dark #admin-search-results div:hover { background: #334155 !important; }
        body.admin-dark #admin-search-clear { background: #475569 !important; color: #cbd5e1 !important; }
        body.admin-dark .move-folder-item { border-color: #475569; color: #e2e8f0; }
        body.admin-dark .move-folder-item:hover { background: #334155; }
        body.admin-dark .paste-area { background: #334155; color: #e2e8f0; border-color: #475569; }
        body.admin-dark .link-input { background: #334155; color: #e2e8f0; border-color: #475569; }
        .notif-form-box { background: #f8f9ff; border-radius: 15px; padding: 25px; margin-bottom: 25px; border: 1px solid #e0e6ff; }
        .notif-form-title { margin: 0 0 15px 0; color: #333; }
        .notif-label { font-weight: 600; color: #333; margin-bottom: 6px; display: block; }
        .notif-duration-label { font-size: 0.85em; color: #555; margin-top: 5px; }
        .notif-colon { font-size: 1.5em; color: #667eea; font-weight: bold; }
        .notif-active-title { color: #333; margin-bottom: 15px; }
        .notif-selected-count, #notif-selected-count { color: #667eea; }
        .notif-target-btn { padding: 8px 18px; border-radius: 20px; border: 2px solid #667eea; background: white; color: #667eea; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .notif-target-btn.active { background: #667eea; color: white; }
        .notif-card { background: #e3f2fd; }
        .notif-card.notif-expired { background: #fef3c7; }
        .notif-card-msg { color: #1a1a2e; }
        .notif-card-details { color: #555; }
        body.admin-dark .notif-form-box { background: #252d3d; border-color: #475569; }
        body.admin-dark .notif-form-title { color: #e2e8f0; }
        body.admin-dark .notif-label { color: #cbd5e1; }
        body.admin-dark .notif-duration-label { color: #94a3b8; }
        body.admin-dark .notif-colon { color: #818cf8; }
        body.admin-dark .notif-active-title { color: #818cf8; }
        body.admin-dark #notifications-tab h2 { color: #818cf8; }
        body.admin-dark #notif-selected-count { color: #818cf8; }
        body.admin-dark #notif-msg { background: #1e293b; color: #e2e8f0; border-color: #475569; }
        body.admin-dark .notif-target-btn { border-color: #818cf8; }
        body.admin-dark .notif-target-btn:not(.active) { background: #1e293b; color: #818cf8; }
        body.admin-dark .notif-target-btn.active { background: #818cf8; color: white; border-color: #818cf8; }
        body.admin-dark #notif-single-user { background: #1e293b; color: #e2e8f0; border-color: #475569; }
        body.admin-dark #notif-user-search { background: #1e293b; color: #e2e8f0; border-color: #475569; }
        body.admin-dark #notif-users-checkboxes { background: #1e293b; border-color: #475569; }
        body.admin-dark #notif-users-checkboxes span { color: #e2e8f0 !important; }
        body.admin-dark #notif-users-checkboxes div { border-color: #475569 !important; }
        body.admin-dark #notif-days, body.admin-dark #notif-hours, body.admin-dark #notif-minutes { background: #1e293b; color: #e2e8f0; border-color: #475569; }
        body.admin-dark .notif-card { background: #1e3a5f; }
        body.admin-dark .notif-card.notif-expired { background: #44381a; }
        body.admin-dark .notif-card-msg { color: #e2e8f0; }
        body.admin-dark .notif-card-details { color: #94a3b8; }
        body.admin-dark #active-notifications p { color: #64748b; }

        /* Responsive - Mobile */
        @media (max-width: 480px) {
            body { padding: 8px; }
            .header { padding: 15px; border-radius: 15px; }
            .header h1 { font-size: 1.5em; }
            .section { padding: 15px; border-radius: 15px; }
            .btn { padding: 10px 18px; font-size: 0.9em; }
            .nav-tabs { gap: 5px; }
            .nav-tab { padding: 8px 12px; font-size: 0.85em; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-card { padding: 15px; border-radius: 12px; }
            .stat-number { font-size: 1.8em; }
            .folders-grid { grid-template-columns: 1fr; gap: 12px; }
            .folder-card, .quiz-card, .file-card { padding: 15px; border-radius: 12px; }
            .folder-icon { font-size: 2em; margin-bottom: 5px; }
            .edit-btn, .delete-btn { width: 30px; height: 30px; font-size: 0.9em; padding: 5px; }
            .edit-btn { right: 42px; }
            .delete-btn { right: 8px; }
            .folder-card .drag-handle, .quiz-card .drag-handle, .file-card .drag-handle { top: 40px; left: 8px; font-size: 1.1em; }
            .action-buttons { padding: 10px; gap: 8px; }
            .action-buttons .btn { padding: 8px 14px; font-size: 0.85em; }
            .breadcrumb { padding: 10px 15px; font-size: 0.9em; }
            .upload-area { padding: 20px; }
            .paste-area { height: 150px; }
            .modal-content { width: 95% !important; padding: 20px !important; border-radius: 15px !important; max-height: 85vh !important; }
            .custom-dialog { padding: 20px; max-width: 90%; }
            .custom-dialog-icon { font-size: 2.2em; }
            .custom-dialog-title { font-size: 1.1em; }
            .custom-dialog-btn { padding: 10px 20px; font-size: 0.9em; min-width: 90px; }
            .login-screen { margin: 30px auto; }
            .form-group input, .form-group textarea, .form-group select { padding: 10px; font-size: 0.95em; }
            .quiz-method-tabs { gap: 5px; }
            .quiz-tab { padding: 8px 14px; font-size: 0.85em; }
            .question-preview { padding: 12px; }
            .notif-form-box { padding: 15px; }
            table { display: block; overflow-x: auto; white-space: nowrap; }
            th, td { padding: 8px 10px; font-size: 0.85em; }
            .empty-state { padding: 25px; }
            #admin-search-input, #admin-sort-select { font-size: 0.9em; }
        }

        /* Responsive - Tablet */
        @media (min-width: 481px) and (max-width: 1024px) {
            body { padding: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 2em; }
            .section { padding: 20px; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .folders-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
            .folder-card, .quiz-card, .file-card { padding: 20px; }
            .modal-content { width: 90% !important; }
            .login-screen { margin: 50px auto; }
            .upload-area { padding: 30px; }
            .nav-tab { padding: 8px 16px; font-size: 0.9em; }
        }
    </style>
<base target="_blank">
</head>
<body>
    <!-- Login -->
    <div id="login-screen" class="container">
        <div class="section login-screen">
            <div class="header"><h1>‚öôÔ∏è Admin Panel</h1><p>MedQuiz HNU</p></div>
            <div class="form-group"><label>Password</label><input type="password" id="admin-password" placeholder="Enter password"></div>
            <button class="btn btn-primary" onclick="adminLogin()" style="width: 100%;">Login</button>
            <div style="text-align: center; margin-top: 20px;"><a href="index.html" class="btn btn-secondary">üè† Student View</a></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="container hidden">
        <div class="header">
            <h1>‚öôÔ∏è Admin Panel</h1>
            <div style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
                <a href="index.html" class="btn btn-secondary">üè† Student View</a>
                <button class="btn btn-secondary" id="admin-dark-toggle" onclick="toggleAdminDark()">üåô Dark Mode</button>
                <button class="btn" onclick="openModal('theme-modal')" style="background: linear-gradient(135deg, #ff6b6b, #ffd93d, #6bcb77); color: #333; font-weight: bold;">üé® Themes</button>
                <button class="btn" onclick="openModal('openai-settings-modal')" style="background: linear-gradient(135deg, #10b981, #059669); color: white; font-weight: bold;">üîë AI Settings</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number" id="total-students">0</div><div class="stat-label">Total Users</div></div>
            <div class="stat-card"><div class="stat-number" id="online-users">0</div><div class="stat-label">Online Now</div></div>
            <div class="stat-card"><div class="stat-number" id="today-users">0</div><div class="stat-label">Today's Users</div></div>
            <div class="stat-card"><div class="stat-number" id="total-quizzes">0</div><div class="stat-label">Quizzes</div></div>
            <div class="stat-card"><div class="stat-number" id="total-questions">0</div><div class="stat-label">Total Questions</div></div>
            <div class="stat-card"><div class="stat-number" id="total-folders">0</div><div class="stat-label">Folders</div></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('content', event)">üìÅ Content</button>
            <button class="nav-tab" onclick="showTab('students', event)">üë• Students</button>
            <button class="nav-tab" onclick="showTab('notifications', event)">üîî Notifications</button>
        </div>

        <!-- Content Tab -->
        <div id="content-tab" class="section">
            <div id="content-breadcrumb" class="breadcrumb"><a onclick="loadHome()">üè† Home</a></div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                <div style="flex: 1; min-width: 200px; position: relative;">
                    <div style="position: relative;">
                        <input type="text" id="admin-search-input" placeholder="Search folders, quizzes, files..." oninput="adminHandleSearch()" onfocus="if(this.value.trim().length>=2) document.getElementById('admin-search-results').style.display='block'" style="width: 100%; padding: 12px 20px 12px 45px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 1em; outline: none; transition: border 0.3s; box-sizing: border-box;">
                        <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 1.2em;">üîç</span>
                        <button id="admin-search-clear" onclick="adminClearSearch()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: #eee; border: none; border-radius: 50%; width: 26px; height: 26px; font-size: 0.85em; cursor: pointer; display: none; align-items: center; justify-content: center; color: #666;">‚úï</button>
                    </div>
                    <div id="admin-search-results" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); margin-top: 5px; max-height: 400px; overflow-y: auto; z-index: 500;"></div>
                </div>
                <select id="admin-sort-select" onchange="applySortAndRender()" style="padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 1em; cursor: pointer;">
                    <option value="custom">Custom Order (Drag)</option>
                    <option value="name-asc">Name A-Z</option>
                    <option value="name-desc">Name Z-A</option>
                    <option value="date-new">Newest First</option>
                    <option value="date-old">Oldest First</option>
                </select>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openModal('folder-modal')">üìÅ New Folder</button>
                <button class="btn btn-warning" onclick="openModal('file-modal')">üìé Upload File</button>
                <button class="btn btn-success" onclick="openQuizModal()">üìù New Quiz</button>
                <button class="btn" onclick="openModal('link-modal')" style="background: linear-gradient(135deg, #00b4d8, #0077b6); color: white;">üîó Add Link</button>
                <button class="btn btn-danger" onclick="cleanupOrphans()" style="margin-left: auto;">üßπ Cleanup Orphans</button>
            </div>
            <div id="content-area"></div>
        </div>

        <!-- Students Tab -->
        <div id="students-tab" class="section hidden">
            <h2>Students</h2>
            <div id="students-list"></div>
        </div>

        <!-- Notifications Tab -->
        <div id="notifications-tab" class="section hidden">
            <h2 style="color: #667eea; margin-bottom: 20px;">üîî Notifications</h2>

            <div class="notif-form-box">
                <h3 class="notif-form-title">New Notification</h3>

                <div class="form-group">
                    <label class="notif-label">Message</label>
                    <textarea id="notif-msg" placeholder="Type your notification message here..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; resize: vertical; box-sizing: border-box;"></textarea>
                </div>

                <div class="form-group">
                    <label class="notif-label">Send To</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn notif-target-btn active" onclick="setNotifTarget('all')" id="notif-target-all">üì¢ All Users</button>
                        <button class="btn notif-target-btn" onclick="setNotifTarget('one')" id="notif-target-one">üë§ One User</button>
                        <button class="btn notif-target-btn" onclick="setNotifTarget('selected')" id="notif-target-selected">üë• Selected Users</button>
                    </div>

                    <div id="notif-one-user" style="display: none; margin-top: 10px;">
                        <select id="notif-single-user" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em;">
                            <option value="">-- Select User --</option>
                        </select>
                    </div>

                    <div id="notif-selected-users" style="display: none; margin-top: 10px;">
                        <input type="text" id="notif-user-search" placeholder="Search users..." oninput="filterNotifUsers()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; margin-bottom: 10px; box-sizing: border-box;">
                        <div id="notif-users-checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 10px; padding: 10px;"></div>
                        <div id="notif-selected-count" style="margin-top: 8px; font-size: 0.9em; font-weight: 600;">0 users selected</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="notif-label">Duration</label>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <input type="number" id="notif-days" min="0" value="0" style="width: 80px; text-align: center; font-size: 1.2em; padding: 10px; border: 2px solid #ddd; border-radius: 10px;">
                            <div class="notif-duration-label">Days</div>
                        </div>
                        <div class="notif-colon">:</div>
                        <div style="text-align: center;">
                            <input type="number" id="notif-hours" min="0" max="23" value="0" style="width: 80px; text-align: center; font-size: 1.2em; padding: 10px; border: 2px solid #ddd; border-radius: 10px;">
                            <div class="notif-duration-label">Hours</div>
                        </div>
                        <div class="notif-colon">:</div>
                        <div style="text-align: center;">
                            <input type="number" id="notif-minutes" min="0" max="59" value="0" style="width: 80px; text-align: center; font-size: 1.2em; padding: 10px; border: 2px solid #ddd; border-radius: 10px;">
                            <div class="notif-duration-label">Minutes</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="sendNotification()" style="padding: 12px 30px; font-size: 1em; border-radius: 10px; margin-top: 10px;">üöÄ Send Notification</button>
            </div>

            <h3 class="notif-active-title">üìã Active Notifications</h3>
            <div id="active-notifications"></div>
        </div>
    </div>

    <!-- Folder Modal -->
    <div id="folder-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close-btn" onclick="closeModal('folder-modal')">&times;</button>
            <h2 style="color: #667eea;">üìÅ New Folder</h2>
            <p style="color: #444; margin-bottom: 20px;">Location: <span id="folder-loc">Home</span></p>

            <div style="background: #f0f4ff; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #667eea;">üìã Folder Name Builder</h3>

                <div class="form-group">
                    <label>Module (Batch)</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="folder-module-select" onchange="updateFolderName()" style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                            <option value="">-- Select Module --</option>
                        </select>
                        <input type="text" id="folder-module-custom" placeholder="Or type custom" oninput="updateFolderName()" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                    </div>
                </div>

                <div class="form-group">
                    <label>Subject</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="folder-subject-select" onchange="updateFolderName()" style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                            <option value="">-- Select Subject --</option>
                        </select>
                        <input type="text" id="folder-subject-custom" placeholder="Or type custom" oninput="updateFolderName()" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                    </div>
                </div>

                <div class="form-group">
                    <label>Lecture / Type</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="folder-lecture-select" onchange="updateFolderName()" style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                            <option value="">-- Select Lecture --</option>
                        </select>
                        <input type="text" id="folder-lecture-custom" placeholder="Or type custom" oninput="updateFolderName()" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid #4caf50;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <label style="color: #4caf50; font-weight: bold;">Final Folder Name:</label>
                        <button type="button" onclick="document.getElementById('folder-name').value=''; document.getElementById('folder-name').readOnly=false; document.getElementById('folder-name').focus();" style="background: #ff5252; color: white; border: none; padding: 4px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em;">‚úèÔ∏è Manual</button>
                    </div>
                    <input type="text" id="folder-name" readonly style="width: 100%; padding: 12px; border: none; font-size: 1.2em; font-weight: bold; color: #333; background: transparent;">
                </div>

            </div>

            <button class="btn btn-primary" onclick="createFolder()" style="width: 100%; padding: 15px; font-size: 1.1em;">üìÅ Create Folder</button>
        </div>
    </div>

    <!-- Quiz Modal (Unified) -->
    <div id="quiz-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="close-btn" onclick="closeQuizModal()">&times;</button>
            <h2>üìù New Quiz</h2>
            <p style="color: #444;">Location: <span id="quiz-loc">Home</span></p>

            <!-- Quiz Name Builder -->
            <div style="background: #f0f4ff; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #667eea;">üìã Quiz Name Builder</h3>

                <!-- Module Selection -->
                <div class="form-group">
                    <label>Module (Batch)</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <select id="quiz-module-select" onchange="updateQuizTitle()" style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                            <option value="">-- Select Module --</option>
                        </select>
                        <input type="text" id="quiz-module-custom" placeholder="Or type custom" oninput="updateQuizTitle()" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                    </div>
                </div>

                <!-- Subject Selection -->
                <div class="form-group">
                    <label>Subject</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <select id="quiz-subject-select" onchange="updateQuizTitle()" style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                            <option value="">-- Select Subject --</option>
                        </select>
                        <input type="text" id="quiz-subject-custom" placeholder="Or type custom" oninput="updateQuizTitle()" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                    </div>
                </div>

                <!-- Lecture Number -->
                <div class="form-group">
                    <label>Lecture Number</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <select id="quiz-lecture-select" onchange="updateQuizTitle()" style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                            <option value="">-- Select Lecture --</option>
                        </select>
                        <input type="text" id="quiz-lecture-custom" placeholder="Or type custom (e.g., Midterm, Final)" oninput="updateQuizTitle()" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                    </div>
                </div>

                <!-- Final Title Display -->
                <div class="form-group" style="margin-top: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid #4caf50;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <label style="color: #4caf50; font-weight: bold;">Final Quiz Title:</label>
                        <button type="button" onclick="document.getElementById('quiz-title').value=''; document.getElementById('quiz-title').readOnly=false; document.getElementById('quiz-title').focus();" style="background: #ff5252; color: white; border: none; padding: 4px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em;">‚úèÔ∏è Manual</button>
                    </div>
                    <input type="text" id="quiz-title" readonly style="width: 100%; padding: 12px; border: none; font-size: 1.2em; font-weight: bold; color: #333; background: transparent;">
                </div>

                <!-- Manage Options Buttons -->
                <div style="margin-top: 15px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button type="button" onclick="showManageOptions()" style="background: #eee; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; color: #667eea;">
                        ‚öôÔ∏è Manage Options (Add/Remove)
                    </button>
                </div>
            </div>

            <!-- Quiz Method Tabs -->
            <div class="quiz-method-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="quiz-tab active" id="tab-btn-file" onclick="switchQuizTab('file')">üìÑ Upload Text File</button>
                <button class="quiz-tab" id="tab-btn-paste" onclick="switchQuizTab('paste')">üìã Copy & Paste</button>
                <button class="quiz-tab" id="tab-btn-ai" onclick="switchQuizTab('ai')">ü§ñ AI Generator</button>
            </div>

            <!-- Tab 1: Upload Text File -->
            <div id="quiz-tab-file" class="quiz-tab-content">
                <div id="txt-upload-area" style="border: 3px dashed #667eea; border-radius: 15px; padding: 40px; text-align: center; background: #f8f9fa; cursor: pointer; margin-bottom: 20px; transition: all 0.3s;" onclick="document.getElementById('txt-file-input').click()">
                    <div style="font-size: 3em; margin-bottom: 10px;">üìÑ</div>
                    <p style="font-size: 1.1em; color: #667eea; font-weight: bold;">Click to upload text file</p>
                    <p style="color: #444; font-size: 0.9em;">Text files (.txt) only</p>
                    <input type="file" id="txt-file-input" accept=".txt" style="display:none;" onchange="uploadQuizTextFile(this)">
                </div>
                <div id="txt-file-info" style="display:none; padding: 15px; background: #e8f5e9; border-radius: 10px; margin-bottom: 20px;">
                    <span id="txt-file-name" style="font-weight: bold; color: #2e7d32;"></span>
                    <button onclick="clearTxtFile()" style="float: right; background: none; border: none; cursor: pointer; color: #f44336; font-size: 1.2em;">‚úï</button>
                </div>
            </div>

            <!-- Tab 2: Copy & Paste -->
            <div id="quiz-tab-paste" class="quiz-tab-content" style="display: none;">
                <div class="form-group"><label>Questions (Format: Question, A), B), C), D), Correct: X, Explanation, WrongA/B/C/D)</label><textarea class="paste-area" id="quiz-text" placeholder="Question: What is...?&#10;A) Option 1&#10;B) Option 2&#10;C) Option 3&#10;D) Option 4&#10;Correct: B&#10;Explanation: Because...&#10;WrongA: Why A is wrong...&#10;WrongC: Why C is wrong...&#10;WrongD: Why D is wrong..."></textarea></div>
                <button class="btn btn-primary" onclick="parseQuiz()">Parse</button>
            </div>

            <!-- Tab 3: AI Generator -->
            <div id="quiz-tab-ai" class="quiz-tab-content" style="display: none;">
                <div id="ai-step-1">
                    <div id="ai-upload-area" style="border: 3px dashed #00b4d8; border-radius: 15px; padding: 40px; text-align: center; background: #f0f9ff; cursor: pointer; margin-bottom: 20px; transition: all 0.3s;" onclick="document.getElementById('ai-file-input').click()">
                        <div style="font-size: 3em; margin-bottom: 10px;">üìÇ</div>
                        <p style="font-size: 1.1em; color: #0077b6; font-weight: bold;">Click to upload file</p>
                        <p style="color: #444; font-size: 0.9em;">PDF, Word (.docx), PowerPoint (.pptx)</p>
                        <input type="file" id="ai-file-input" accept=".pdf,.docx,.pptx" style="display:none;" onchange="aiFileSelected(this)">
                    </div>
                    <div id="ai-file-info" style="display:none; padding: 15px; background: #e8f5e9; border-radius: 10px; margin-bottom: 20px;">
                        <span id="ai-file-name" style="font-weight: bold; color: #2e7d32;"></span>
                        <button onclick="clearAiFile()" style="float: right; background: none; border: none; cursor: pointer; color: #f44336; font-size: 1.2em;">‚úï</button>
                    </div>

                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Number of Questions</label>
                            <input type="number" id="ai-num-questions" value="10" min="3" max="50" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1.1em;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Questions Language</label>
                            <select id="ai-language" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1.1em;">
                                <option value="English">English</option>
                                <option value="Arabic">Arabic</option>
                            </select>
                        </div>
                    </div>

                    <button onclick="generateAiQuestions()" id="ai-generate-btn" class="btn" style="width: 100%; padding: 15px; font-size: 1.1em; background: linear-gradient(135deg, #00b4d8, #0077b6); color: white; border: none; border-radius: 25px; cursor: pointer;">
                        ü§ñ Generate Questions
                    </button>

                    <div id="ai-loading" style="display:none; text-align: center; padding: 30px;">
                        <div style="font-size: 2em; margin-bottom: 15px; animation: spin 1s linear infinite;">‚öôÔ∏è</div>
                        <p id="ai-loading-text" style="color: #0077b6; font-weight: bold;">AI is generating questions...</p>
                        <p id="ai-loading-sub" style="color: #444; font-size: 0.9em;">This may take 15-30 seconds</p>
                        <style>@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>
                    </div>

                    <div id="ai-error" style="display:none; padding: 15px; background: #ffebee; border-radius: 10px; color: #c62828; margin-top: 15px;"></div>
                </div>

                <div id="ai-step-2" style="display:none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h3 style="color: #0077b6;">Preview (<span id="ai-preview-count">0</span> questions)</h3>
                        <div>
                            <button onclick="regenerateAiQuestions()" class="btn btn-secondary" style="font-size: 0.85em;">üîÑ Regenerate</button>
                            <button onclick="backToAiStep1()" class="btn btn-secondary" style="font-size: 0.85em;">‚Üê Back</button>
                        </div>
                    </div>

                    <div id="ai-preview-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;"></div>

                    <div style="background: #f0f4ff; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: #667eea;">Save as Quiz</h3>
                        <div class="form-group">
                            <label>Quiz Title (or use the name builder above)</label>
                            <input type="text" id="ai-quiz-title" placeholder="Enter quiz title or leave empty to use name builder" style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                        </div>
                        <p style="color: #444; font-size: 0.9em;">Location: <strong id="ai-quiz-loc">Home</strong></p>
                    </div>

                    <button onclick="saveAiQuiz()" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 1.1em;">
                        ‚úÖ Confirm & Save Quiz
                    </button>
                </div>
            </div>

            <!-- Shared Preview for File Upload & Paste tabs -->
            <div id="quiz-preview" class="hidden">
                <h3>Preview (<span id="preview-count">0</span>)</h3>
                <div id="preview-list"></div>
                <button class="btn btn-success" onclick="saveQuiz()">Save Quiz</button>
            </div>
        </div>
    </div>

    <!-- Manage Options Modal -->
    <div id="manage-options-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-btn" onclick="closeModal('manage-options-modal')">&times;</button>
            <h2>‚öôÔ∏è Manage Quiz Options</h2>

            <div style="margin: 20px 0;">
                <h3 style="color: #667eea;">Modules</h3>
                <div id="modules-list" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-module" placeholder="Add new module" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px;">
                    <button onclick="addOption('module')" class="btn btn-primary">Add</button>
                </div>
            </div>

            <div style="margin: 20px 0;">
                <h3 style="color: #667eea;">Subjects</h3>
                <div id="subjects-list" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-subject" placeholder="Add new subject" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px;">
                    <button onclick="addOption('subject')" class="btn btn-primary">Add</button>
                </div>
            </div>

            <div style="margin: 20px 0;">
                <h3 style="color: #ff9800;">Lectures</h3>
                <div id="lectures-list" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-lecture" placeholder="Add new lecture (e.g. Lecture 21)" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px;">
                    <button onclick="addOption('lecture')" class="btn btn-primary">Add</button>
                </div>
            </div>

            <div style="margin: 20px 0;">
                <h3 style="color: #9c27b0;">File Types</h3>
                <div id="fileTypes-list" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-fileType" placeholder="Add new file type" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px;">
                    <button onclick="addOption('fileType')" class="btn btn-primary">Add</button>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 10px;">
                <small>üí° Changes are saved automatically and will be available for all future quizzes.</small>
            </div>
        </div>
    </div>

    <!-- Manage Sheets Modal -->
    <div id="manage-sheets-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close-btn" onclick="closeModal('manage-sheets-modal')">&times;</button>
            <h2>üìä Manage Question Sheets</h2>
            <p style="color: #444; margin-bottom: 20px;">Create and manage reusable question templates</p>

            <!-- Create New Sheet -->
            <div style="background: #f0f4ff; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">‚ûï Create New Sheet</h3>
                <div class="form-group">
                    <label>Sheet Name</label>
                    <input type="text" id="sheet-name" placeholder="e.g., Cardiology MCQs" style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                </div>
                <div class="form-group">
                    <label>Questions (Same format as quiz)</label>
                    <textarea id="sheet-questions" class="paste-area" placeholder="Question: What is...?&#10;A) Option 1&#10;B) Option 2&#10;C) Option 3&#10;D) Option 4&#10;Correct: B&#10;Explanation: Because...&#10;WrongA: Why A is wrong...&#10;WrongC: Why C is wrong...&#10;WrongD: Why D is wrong...&#10;&#10;Question: Next question..." style="height: 150px;"></textarea>
                </div>
                <button onclick="saveSheet()" class="btn btn-primary" style="width: 100%;">üíæ Save Sheet</button>
            </div>

            <!-- Saved Sheets List -->
            <div>
                <h3 style="color: #667eea; margin-bottom: 15px;">üìã Saved Sheets</h3>
                <div id="sheets-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- Sheets will be loaded here -->
                </div>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                <small>üí° Click "Use Sheet" to auto-fill the questions in the quiz builder. Sheets are saved locally.</small>
            </div>
        </div>
    </div>

    <!-- File Modal - Google Drive Link -->
    <div id="file-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <button class="close-btn" onclick="closeModal('file-modal')">&times;</button>
            <h2>üìé Add File Link</h2>
            <p style="color: #444;">Location: <span id="file-loc">Home</span></p>

            <!-- File Name Builder -->
            <div style="background: #f0f4ff; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #667eea;">üìã File Name Builder</h3>

                <!-- Module Selection -->
                <div class="form-group">
                    <label>Module (Batch)</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <select id="file-module-select" onchange="updateFileName()" style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                            <option value="">-- Select Module --</option>
                        </select>
                        <input type="text" id="file-module-custom" placeholder="Or type custom" oninput="updateFileName()" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                    </div>
                </div>

                <!-- Subject Selection -->
                <div class="form-group">
                    <label>Subject</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <select id="file-subject-select" onchange="updateFileName()" style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                            <option value="">-- Select Subject --</option>
                        </select>
                        <input type="text" id="file-subject-custom" placeholder="Or type custom" oninput="updateFileName()" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                    </div>
                </div>

                <!-- Lecture Number -->
                <div class="form-group">
                    <label>Lecture Number / Type</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <select id="file-lecture-select" onchange="updateFileName()" style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                            <option value="">-- Select Lecture --</option>
                        </select>
                        <input type="text" id="file-lecture-custom" placeholder="Or type custom" oninput="updateFileName()" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                    </div>
                </div>

                <!-- File Type -->
                <div class="form-group">
                    <label>File Type</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <select id="file-type-select" onchange="updateFileName()" style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em;">
                            <option value="">-- Select Type --</option>
                        </select>
                        <input type="text" id="file-type-custom" placeholder="Or type custom" oninput="updateFileName()" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                    </div>
                </div>

                <!-- Final File Name Display -->
                <div class="form-group" style="margin-top: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid #4caf50;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <label style="color: #4caf50; font-weight: bold;">Final File Name:</label>
                        <button type="button" onclick="document.getElementById('file-name').value=''; document.getElementById('file-name').readOnly=false; document.getElementById('file-name').focus();" style="background: #ff5252; color: white; border: none; padding: 4px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em;">‚úèÔ∏è Manual</button>
                    </div>
                    <input type="text" id="file-name" readonly style="width: 100%; padding: 12px; border: none; font-size: 1.2em; font-weight: bold; color: #333; background: transparent;">
                </div>

                <!-- Manage Options Button -->
                <div style="margin-top: 15px; text-align: center;">
                    <button type="button" onclick="showManageOptionsFromFile()" style="background: #e3f2fd; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; color: #1976d2; font-size: 1em;">
                        ‚öôÔ∏è Manage Options (Add/Remove Modules & Subjects)
                    </button>
                </div>
            </div>

            <!-- Google Drive Instructions -->
            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="color: #1976d2; margin-bottom: 10px;">üìñ How to add a file:</h4>
                <ol style="text-align: left; margin: 10px 0; padding-left: 20px; color: #333;">
                    <li>Upload your file to <strong>Google Drive</strong></li>
                    <li>Right-click the file ‚Üí <strong>Share</strong> ‚Üí <strong>Copy link</strong></li>
                    <li>Change access to <strong>"Anyone with the link"</strong></li>
                    <li>Paste the link below</li>
                </ol>
            </div>

            <div class="form-group">
                <label>Google Drive Link</label>
                <input type="text" id="file-url" placeholder="https://drive.google.com/file/d/..." class="link-input" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
            </div>

            <button class="btn btn-success" onclick="saveFileLink()" style="width: 100%; padding: 15px; font-size: 1.1em;">üíæ Save File</button>
        </div>
    </div>

    <!-- Edit Folder Modal -->
    <div id="edit-folder-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('edit-folder-modal')">&times;</button>
            <h2>Edit Folder</h2>
            <div class="form-group"><label>New Name</label><input type="text" id="edit-folder-name"></div>
            <button class="btn btn-primary" onclick="updateFolder()">Update</button>
        </div>
    </div>

    <!-- Edit File Modal -->
    <div id="edit-file-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="close-btn" onclick="closeModal('edit-file-modal')">&times;</button>
            <h2 style="color: #667eea;">üìé Edit File</h2>
            <div class="form-group"><label>File Name</label><input type="text" id="edit-file-name" style="width:100%; padding:12px; border:2px solid #667eea; border-radius:10px; font-size:1em;"></div>
            <div class="form-group"><label>Google Drive Link</label><input type="text" id="edit-file-url" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:10px; font-size:1em;"></div>
            <button class="btn btn-primary" onclick="updateFile()" style="width:100%; padding:15px; font-size:1.1em;">üíæ Save Changes</button>
        </div>
    </div>

    <!-- Move Item Modal -->
    <div id="move-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="close-btn" onclick="closeModal('move-modal')">&times;</button>
            <h2 style="color: #667eea;">üìÇ Move To...</h2>
            <p style="color: #444; margin-bottom: 15px;">Moving: <strong id="move-item-name"></strong></p>
            <div id="move-folder-list" style="max-height: 400px; overflow-y: auto;"></div>
            <button class="btn btn-secondary" onclick="selectMoveTarget(null)" style="width:100%; margin-top:10px; padding:12px;">üè† Move to Home (Root)</button>
        </div>
    </div>

    <!-- Theme Modal -->
    <div id="theme-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="close-btn" onclick="closeModal('theme-modal')">&times;</button>
            <h2 style="color: #667eea;">üé® Select Theme</h2>
            <p style="color: #444; margin-bottom: 20px;">Choose a theme for the student page</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div onclick="setTheme('default')" style="padding: 25px; border-radius: 15px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #667eea, #764ba2); color: white; transition: transform 0.2s; border: 3px solid transparent;" class="theme-option" data-theme="default">
                    <div style="font-size: 2em; margin-bottom: 10px;">üéì</div>
                    <div style="font-weight: bold;">Default</div>
                </div>
                <div onclick="setTheme('ramadan')" style="padding: 25px; border-radius: 15px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #1a472a, #2d1b69); color: #d4af37; transition: transform 0.2s; border: 3px solid transparent;" class="theme-option" data-theme="ramadan">
                    <div style="font-size: 2em; margin-bottom: 10px;">üåô</div>
                    <div style="font-weight: bold;">Ramadan</div>
                </div>
                <div onclick="setTheme('christmas')" style="padding: 25px; border-radius: 15px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #1b4332, #8b0000); color: #ffd700; transition: transform 0.2s; border: 3px solid transparent;" class="theme-option" data-theme="christmas">
                    <div style="font-size: 2em; margin-bottom: 10px;">üéÑ</div>
                    <div style="font-weight: bold;">Christmas</div>
                </div>
                <div onclick="setTheme('eid')" style="padding: 25px; border-radius: 15px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #1a237e, #4a148c); color: #ffd54f; transition: transform 0.2s; border: 3px solid transparent;" class="theme-option" data-theme="eid">
                    <div style="font-size: 2em; margin-bottom: 10px;">üéâ</div>
                    <div style="font-weight: bold;">Eid</div>
                </div>
            </div>
            <div id="current-theme-label" style="text-align: center; margin-top: 20px; padding: 10px; background: #f0f4ff; border-radius: 10px; color: #667eea; font-weight: bold;"></div>
        </div>
    </div>

    <!-- OpenAI Settings Modal -->
    <div id="openai-settings-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="close-btn" onclick="closeModal('openai-settings-modal')">&times;</button>
            <h2 style="color: #10b981;">üîë AI Settings</h2>
            <p style="color: #444; margin-bottom: 20px;">Set your OpenAI API key and proxy URL for AI question generation. These are stored locally in your browser.</p>
            <div class="form-group">
                <label>OpenAI API Key</label>
                <input type="password" id="openai-api-key-input" placeholder="sk-..." style="width: 100%; padding: 12px; border: 2px solid #10b981; border-radius: 10px; font-size: 1em;">
            </div>
            <div class="form-group">
                <label>Proxy URL (Cloudflare Worker URL)</label>
                <input type="text" id="openai-proxy-url-input" placeholder="https://your-worker.workers.dev" style="width: 100%; padding: 12px; border: 2px solid #0ea5e9; border-radius: 10px; font-size: 1em;">
                <small style="color: #888; display: block; margin-top: 5px;">Required for GitHub Pages hosting. Leave empty if using Replit/Render.</small>
            </div>
            <button class="btn btn-success" onclick="saveOpenAiKey()" style="width: 100%; padding: 15px; font-size: 1.1em;">üíæ Save Settings</button>
            <div id="openai-key-status" style="text-align: center; margin-top: 15px; padding: 10px; border-radius: 10px; display: none;"></div>
        </div>
    </div>

    <!-- Link Modal -->
    <div id="link-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-btn" onclick="closeModal('link-modal')">&times;</button>
            <h2 style="color: #0077b6;">üîó Add External Link</h2>
            <p style="color: #444;">Location: <span id="link-loc">Home</span></p>
            <div class="form-group">
                <label>Link Name</label>
                <input type="text" id="link-name" placeholder="e.g., Anatomy Lecture 1 - YouTube" style="width: 100%; padding: 12px; border: 2px solid #00b4d8; border-radius: 10px; font-size: 1em;">
            </div>
            <div class="form-group">
                <label>URL</label>
                <input type="text" id="link-url" placeholder="https://youtube.com/watch?v=..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
            </div>
            <button class="btn btn-success" onclick="saveLink()" style="width: 100%; padding: 15px; font-size: 1.1em;">üîó Save Link</button>
        </div>
    </div>

    <!-- Edit Quiz Modal -->
    <div id="edit-quiz-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <button class="close-btn" onclick="closeModal('edit-quiz-modal')">&times;</button>
            <h2 style="color: #667eea; margin-bottom: 5px;">‚úèÔ∏è Edit Quiz</h2>
            <div class="form-group" style="margin-bottom: 25px;">
                <label style="font-weight: bold; color: #333;">Quiz Title</label>
                <input type="text" id="edit-quiz-title" style="width: 100%; padding: 14px; border: 2px solid #667eea; border-radius: 12px; font-size: 1.1em; font-weight: bold;">
            </div>
            <div id="edit-questions"></div>
            <div style="display: flex; gap: 15px; margin-top: 20px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="addQuestion()" style="padding: 14px 30px; font-size: 1.05em;">+ Add Question</button>
                <button class="btn btn-success" onclick="updateQuiz()" style="padding: 14px 30px; font-size: 1.05em;">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB001YxSS9iQ6PArK1VHf0lIlpLyP1Rqew",
            authDomain: "medquiz-hnu.firebaseapp.com",
            projectId: "medquiz-hnu",
            storageBucket: "medquiz-hnu.firebasestorage.app",
            messagingSenderId: "862221476635",
            appId: "1:862221476635:web:369ca0e1f3b22b3eac29be"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentPath = [];
        let currentQuestions = [];
        let editingQuizId = null;
        let editingFolderId = null;
        let editingFileId = null;
        let moveItemId = null;
        let moveItemType = null;
        let cachedFolders = [];
        let cachedQuizzes = [];
        let cachedFiles = [];
        let editQuizOriginalState = '';

        window.onload = function() {
            console.log('Admin page loaded');
            if (localStorage.getItem('admin_dark') === 'true') {
                document.body.classList.add('admin-dark');
                const btn = document.getElementById('admin-dark-toggle');
                if (btn) btn.textContent = '‚òÄÔ∏è Light Mode';
            }
            if (localStorage.getItem('admin_logged_in') === 'true') showPanel();
            loadOpenAiKey();
        };

        function adminLogin() {
            const pass = document.getElementById('admin-password').value;
            if (!pass) return showAlert('Enter password', 'warning');
            if (pass === 'jana0727') {
                localStorage.setItem('admin_logged_in', 'true');
                showPanel();
            } else {
                showAlert('Wrong password!', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('admin_logged_in');
            location.reload();
        }

        function showPanel() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            loadStats();
            loadHome();
        }

        function loadStats() {
            // Total users
            db.collection('users').get().then(s => { 
                document.getElementById('total-students').textContent = s.size; 
            });

            // Online users (active in last 5 minutes)
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
            db.collection('users').where('lastActive', '>=', fiveMinutesAgo).get().then(s => {
                document.getElementById('online-users').textContent = s.size;
            }).catch(() => {
                document.getElementById('online-users').textContent = '0';
            });

            // Today's users
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            db.collection('users').where('lastActive', '>=', today).get().then(s => {
                document.getElementById('today-users').textContent = s.size;
            }).catch(() => {
                document.getElementById('today-users').textContent = '0';
            });

            // Total quizzes + total questions
            db.collection('quizzes').get().then(s => { 
                document.getElementById('total-quizzes').textContent = s.size;
                let totalQ = 0;
                s.forEach(doc => { totalQ += doc.data().questionCount || 0; });
                document.getElementById('total-questions').textContent = totalQ;
            });

            // Total folders
            db.collection('folders').get().then(s => {
                document.getElementById('total-folders').textContent = s.size;
            });
        }


        function showTab(tab, e) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#content-tab, #students-tab, #notifications-tab').forEach(t => t.classList.add('hidden'));
            if (e && e.target) { e.target.classList.add('active'); }
            document.getElementById(tab + '-tab').classList.remove('hidden');
            if (tab === 'students') loadStudents();
            if (tab === 'notifications') loadNotifications();
        }

        function loadHome() {
            currentPath = [];
            updateBreadcrumb();
            loadFolderContent(null);
        }

        function openFolder(id, name) {
            currentPath.push({ id: id, name: name });
            updateBreadcrumb();
            loadFolderContent(id);
        }

        let cachedLinks = [];
        function loadFolderContent(folderId) {
            Promise.all([
                db.collection('folders').where('parentId', '==', folderId).get(),
                db.collection('quizzes').where('folderId', '==', folderId).get(),
                db.collection('files').where('folderId', '==', folderId).get(),
                db.collection('links').where('folderId', '==', folderId).get()
            ]).then(([folders, quizzes, files, links]) => {
                cachedFolders = [];
                cachedQuizzes = [];
                cachedFiles = [];
                cachedLinks = [];
                folders.forEach(doc => { cachedFolders.push({ id: doc.id, ...doc.data() }); });
                quizzes.forEach(doc => { cachedQuizzes.push({ id: doc.id, ...doc.data() }); });
                files.forEach(doc => { cachedFiles.push({ id: doc.id, ...doc.data() }); });
                links.forEach(doc => { cachedLinks.push({ id: doc.id, ...doc.data() }); });
                document.getElementById('admin-search-input').value = '';
                renderContentArea();
            });
        }

        function renderContentArea() {
            const search = (document.getElementById('admin-search-input').value || '').toLowerCase().trim();
            const sort = document.getElementById('admin-sort-select').value;

            let allItems = [];
            cachedFolders.filter(f => !search || f.name.toLowerCase().includes(search)).forEach(f => allItems.push({ ...f, _type: 'folder' }));
            cachedQuizzes.filter(q => !search || (q.title || '').toLowerCase().includes(search)).forEach(q => allItems.push({ ...q, _type: 'quiz' }));
            cachedFiles.filter(f => !search || f.name.toLowerCase().includes(search)).forEach(f => allItems.push({ ...f, _type: 'file' }));
            cachedLinks.filter(l => !search || l.name.toLowerCase().includes(search)).forEach(l => allItems.push({ ...l, _type: 'link' }));

            const sortFn = (a, b) => {
                const nameA = (a.name || a.title || '').toLowerCase();
                const nameB = (b.name || b.title || '').toLowerCase();
                if (sort === 'name-asc') return nameA.localeCompare(nameB);
                if (sort === 'name-desc') return nameB.localeCompare(nameA);
                if (sort === 'date-new' || sort === 'date-old') {
                    const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                    const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                    return sort === 'date-new' ? dateB - dateA : dateA - dateB;
                }
                const orderA = a.displayOrder !== undefined ? a.displayOrder : 9999;
                const orderB = b.displayOrder !== undefined ? b.displayOrder : 9999;
                if (orderA !== orderB) return orderA - orderB;
                return nameA.localeCompare(nameB);
            };
            allItems.sort(sortFn);

            let html = '<div class="folders-grid">';

            if (allItems.length === 0) {
                html += '<div class="empty-state" style="grid-column: 1/-1;"><h3>Empty</h3><p>Add folders, quizzes, or files</p></div>';
            }

            allItems.forEach((item, idx) => {
                const eName = (item.name || item.title || '').replace(/'/g, "\\'");
                if (item._type === 'folder') {
                    html += `<div class="folder-card" draggable="true" data-drag-idx="${idx}" data-drag-id="${item.id}" data-drag-type="${item._type}" ondragstart="onContentDragStart(event)" ondragover="onContentDragOver(event)" ondragleave="onContentDragLeave(event)" ondrop="onContentDrop(event)">
                        <span class="drag-handle" title="Drag to reorder">‚†ø</span>
                        <button class="edit-btn" onclick="event.stopPropagation(); editFolder('${item.id}', '${eName}')" title="Edit">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteFolder('${item.id}')" title="Delete">üóëÔ∏è</button>
                        <button style="position:absolute;top:10px;left:50px;background:white;border:none;cursor:pointer;font-size:1.1em;padding:8px;border-radius:50%;width:35px;height:35px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.2);z-index:10;color:#ff9800;" onclick="event.stopPropagation(); openMoveModal('${item.id}', '${eName}', 'folder')" title="Move">üìÇ</button>
                        <div class="folder-icon" onclick="openFolder('${item.id}', '${eName}')">üìÅ</div>
                        <div class="folder-name" onclick="openFolder('${item.id}', '${eName}')">${item.name}</div>
                    </div>`;
                } else if (item._type === 'quiz') {
                    html += `<div class="quiz-card" draggable="true" data-drag-idx="${idx}" data-drag-id="${item.id}" data-drag-type="${item._type}" ondragstart="onContentDragStart(event)" ondragover="onContentDragOver(event)" ondragleave="onContentDragLeave(event)" ondrop="onContentDrop(event)">
                        <span class="drag-handle" title="Drag to reorder">‚†ø</span>
                        <button class="edit-btn" onclick="event.stopPropagation(); editQuiz('${item.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteQuiz('${item.id}')" title="Delete">üóëÔ∏è</button>
                        <button style="position:absolute;top:10px;left:50px;background:white;border:none;cursor:pointer;font-size:1.1em;padding:8px;border-radius:50%;width:35px;height:35px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.2);z-index:10;color:#ff9800;" onclick="event.stopPropagation(); openMoveModal('${item.id}', '${eName}', 'quiz')" title="Move">üìÇ</button>
                        <div class="folder-icon">üìù</div>
                        <div class="folder-name">${item.title}</div>
                        <div style="color: #444; font-size: 0.9em;">${item.questionCount || 0} questions</div>
                    </div>`;
                } else if (item._type === 'link') {
                    html += `<div class="file-card" style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);" draggable="true" data-drag-idx="${idx}" data-drag-id="${item.id}" data-drag-type="${item._type}" ondragstart="onContentDragStart(event)" ondragover="onContentDragOver(event)" ondragleave="onContentDragLeave(event)" ondrop="onContentDrop(event)">
                        <span class="drag-handle" title="Drag to reorder">‚†ø</span>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteLink('${item.id}')" title="Delete">üóëÔ∏è</button>
                        <div class="folder-icon">üîó</div>
                        <div class="folder-name">${item.name}</div>
                        <div style="color: #444; font-size: 0.9em;"><a href="${item.url}" target="_blank" style="color: #0077b6;">Open Link</a></div>
                    </div>`;
                } else {
                    const icon = item.name.endsWith('.pdf') ? 'üìÑ' : item.name.endsWith('.ppt') ? 'üìä' : 'üìù';
                    html += `<div class="file-card" draggable="true" data-drag-idx="${idx}" data-drag-id="${item.id}" data-drag-type="${item._type}" ondragstart="onContentDragStart(event)" ondragover="onContentDragOver(event)" ondragleave="onContentDragLeave(event)" ondrop="onContentDrop(event)">
                        <span class="drag-handle" title="Drag to reorder">‚†ø</span>
                        <button class="edit-btn" onclick="event.stopPropagation(); editFile('${item.id}', '${eName}', '${(item.url || '').replace(/'/g, "\\'")}')" title="Edit">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteFile('${item.id}')" title="Delete">üóëÔ∏è</button>
                        <button style="position:absolute;top:10px;left:50px;background:white;border:none;cursor:pointer;font-size:1.1em;padding:8px;border-radius:50%;width:35px;height:35px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.2);z-index:10;color:#ff9800;" onclick="event.stopPropagation(); openMoveModal('${item.id}', '${eName}', 'file')" title="Move">üìÇ</button>
                        <div class="folder-icon">${icon}</div>
                        <div class="folder-name">${item.name}</div>
                        <div style="color: #444; font-size: 0.9em;">${item.size ? (item.size/1024).toFixed(1) + ' KB' : 'Google Drive'}</div>
                    </div>`;
                }
            });

            html += '</div>';
            document.getElementById('content-area').innerHTML = html;
        }

        let adminSearchTimeout = null;
        let adminSearchCache = { folders: [], quizzes: [], files: [], links: [] };
        let adminSearchLoaded = false;

        function loadAdminSearchData() {
            if (adminSearchLoaded) return Promise.resolve();
            return Promise.all([
                db.collection('folders').get(),
                db.collection('quizzes').get(),
                db.collection('files').get(),
                db.collection('links').get()
            ]).then(([foldersSnap, quizzesSnap, filesSnap, linksSnap]) => {
                adminSearchCache.folders = [];
                adminSearchCache.quizzes = [];
                adminSearchCache.files = [];
                adminSearchCache.links = [];
                foldersSnap.forEach(doc => adminSearchCache.folders.push({ id: doc.id, ...doc.data() }));
                quizzesSnap.forEach(doc => adminSearchCache.quizzes.push({ id: doc.id, ...doc.data() }));
                filesSnap.forEach(doc => adminSearchCache.files.push({ id: doc.id, ...doc.data() }));
                linksSnap.forEach(doc => adminSearchCache.links.push({ id: doc.id, ...doc.data() }));
                adminSearchLoaded = true;
            });
        }

        function adminHandleSearch() {
            const query = document.getElementById('admin-search-input').value.trim().toLowerCase();
            const clearBtn = document.getElementById('admin-search-clear');
            const resultsDiv = document.getElementById('admin-search-results');

            if (query.length > 0) {
                clearBtn.style.display = 'flex';
            } else {
                clearBtn.style.display = 'none';
                resultsDiv.style.display = 'none';
                renderContentArea();
                return;
            }

            if (query.length < 2) {
                resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Type at least 2 characters...</div>';
                resultsDiv.style.display = 'block';
                return;
            }

            clearTimeout(adminSearchTimeout);
            adminSearchTimeout = setTimeout(() => {
                resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Searching...</div>';
                resultsDiv.style.display = 'block';
                loadAdminSearchData().then(() => adminPerformSearch(query));
            }, 300);
        }

        function adminPerformSearch(query) {
            const resultsDiv = document.getElementById('admin-search-results');
            const isDk = document.body.classList.contains('admin-dark');
            const srBg = isDk ? '#1e293b' : 'white';
            const srHover = isDk ? '#334155' : '#f0f4ff';
            const srBorder = isDk ? '#334155' : '#f5f5f5';
            const srHeadColor = isDk ? '#818cf8' : '#667eea';
            const srTitle = isDk ? '#e2e8f0' : '#333';
            const srSub = isDk ? '#64748b' : '#999';

            let html = '';
            let total = 0;

            const mFolders = adminSearchCache.folders.filter(f => f.name && f.name.toLowerCase().includes(query));
            const mQuizzes = adminSearchCache.quizzes.filter(q => q.title && q.title.toLowerCase().includes(query));
            const mFiles = adminSearchCache.files.filter(f => f.name && f.name.toLowerCase().includes(query));
            const mLinks = adminSearchCache.links.filter(l => l.name && l.name.toLowerCase().includes(query));

            if (mFolders.length > 0) {
                html += `<div style="padding: 10px 20px; font-size: 0.8em; color: ${srHeadColor}; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid ${srBorder};">Folders</div>`;
                mFolders.forEach(f => {
                    total++;
                    html += `<div onclick="adminSearchGoTo('${f.id}', '${f.name.replace(/'/g, "\\'")}', 'folder')" style="padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid ${srBorder}; transition: background 0.2s;" onmouseover="this.style.background='${srHover}'" onmouseout="this.style.background='transparent'">
                        <span style="font-size: 1.5em;">üìÅ</span>
                        <div><div style="font-weight: 600; color: ${srTitle};">${adminHighlight(f.name, query)}</div><div style="font-size: 0.8em; color: ${srSub};">Folder</div></div>
                    </div>`;
                });
            }
            if (mQuizzes.length > 0) {
                html += `<div style="padding: 10px 20px; font-size: 0.8em; color: ${srHeadColor}; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid ${srBorder};">Quizzes</div>`;
                mQuizzes.forEach(q => {
                    total++;
                    html += `<div onclick="adminSearchGoTo('${q.id}', '${(q.title||'').replace(/'/g, "\\'")}', 'quiz')" style="padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid ${srBorder}; transition: background 0.2s;" onmouseover="this.style.background='${srHover}'" onmouseout="this.style.background='transparent'">
                        <span style="font-size: 1.5em;">üìù</span>
                        <div><div style="font-weight: 600; color: ${srTitle};">${adminHighlight(q.title, query)}</div><div style="font-size: 0.8em; color: ${srSub};">${q.questionCount || 0} questions</div></div>
                    </div>`;
                });
            }
            if (mFiles.length > 0) {
                html += `<div style="padding: 10px 20px; font-size: 0.8em; color: ${srHeadColor}; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid ${srBorder};">Files</div>`;
                mFiles.forEach(f => {
                    total++;
                    const icon = f.name.endsWith('.pdf') ? 'üìÑ' : f.name.endsWith('.ppt') ? 'üìä' : 'üìù';
                    html += `<div onclick="adminSearchGoTo('${f.id}', '${f.name.replace(/'/g, "\\'")}', 'file', '${(f.url||'').replace(/'/g, "\\'")}')" style="padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid ${srBorder}; transition: background 0.2s;" onmouseover="this.style.background='${srHover}'" onmouseout="this.style.background='transparent'">
                        <span style="font-size: 1.5em;">${icon}</span>
                        <div><div style="font-weight: 600; color: ${srTitle};">${adminHighlight(f.name, query)}</div><div style="font-size: 0.8em; color: ${srSub};">${f.size ? (f.size/1024).toFixed(1) + ' KB' : 'Google Drive'}</div></div>
                    </div>`;
                });
            }
            if (mLinks.length > 0) {
                html += `<div style="padding: 10px 20px; font-size: 0.8em; color: ${srHeadColor}; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid ${srBorder};">Links</div>`;
                mLinks.forEach(l => {
                    total++;
                    html += `<div onclick="adminClearSearch(); window.open('${(l.url||'').replace(/'/g, "\\'")}', '_blank')" style="padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid ${srBorder}; transition: background 0.2s;" onmouseover="this.style.background='${srHover}'" onmouseout="this.style.background='transparent'">
                        <span style="font-size: 1.5em;">üîó</span>
                        <div><div style="font-weight: 600; color: ${srTitle};">${adminHighlight(l.name, query)}</div><div style="font-size: 0.8em; color: ${srSub};">Link</div></div>
                    </div>`;
                });
            }

            if (total === 0) {
                html = '<div style="padding: 30px; text-align: center; color: #666;"><div style="font-size: 2em; margin-bottom: 10px;">üòï</div>No results found</div>';
            } else {
                html = '<div style="padding: 10px 20px; font-size: 0.85em; color: #666; border-bottom: 1px solid #eee;">' + total + ' result' + (total > 1 ? 's' : '') + ' found</div>' + html;
            }

            resultsDiv.innerHTML = html;
            if (isDk) resultsDiv.style.background = '#1e293b';
            resultsDiv.style.display = 'block';
        }

        function adminHighlight(text, query) {
            if (!text) return '';
            const idx = text.toLowerCase().indexOf(query);
            if (idx === -1) return text;
            return text.substring(0, idx) + '<span style="background: #fff176; padding: 1px 3px; border-radius: 3px;">' + text.substring(idx, idx + query.length) + '</span>' + text.substring(idx + query.length);
        }

        function adminSearchGoTo(id, name, type, url) {
            adminClearSearch();
            if (type === 'folder') {
                currentPath = [{ id: id, name: name }];
                loadFolderContent(id);
            } else if (type === 'quiz') {
                editQuiz(id);
            } else if (type === 'file' && url) {
                window.open(url, '_blank');
            }
        }

        function adminClearSearch() {
            document.getElementById('admin-search-input').value = '';
            document.getElementById('admin-search-results').style.display = 'none';
            document.getElementById('admin-search-clear').style.display = 'none';
            adminSearchLoaded = false;
        }

        document.addEventListener('click', function(e) {
            const searchInput = document.getElementById('admin-search-input');
            const resultsDiv = document.getElementById('admin-search-results');
            if (searchInput && resultsDiv && !searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });

        function adminSearchContent() { renderContentArea(); }
        function applySortAndRender() { renderContentArea(); }

        let contentDragIdx = null;
        function onContentDragStart(e) {
            contentDragIdx = parseInt(e.currentTarget.dataset.dragIdx);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function onContentDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        function onContentDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        function onContentDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const targetIdx = parseInt(e.currentTarget.dataset.dragIdx);
            if (contentDragIdx === null || contentDragIdx === targetIdx) return;

            const allItems = [];
            cachedFolders.forEach(f => allItems.push({ ...f, _type: 'folder' }));
            cachedQuizzes.forEach(q => allItems.push({ ...q, _type: 'quiz' }));
            cachedFiles.forEach(f => allItems.push({ ...f, _type: 'file' }));

            const search = (document.getElementById('admin-search-input').value || '').toLowerCase().trim();
            const sort = document.getElementById('admin-sort-select').value;
            let filtered = allItems.filter(it => {
                const name = (it.name || it.title || '').toLowerCase();
                return !search || name.includes(search);
            });
            const sortFn = (a, b) => {
                const nameA = (a.name || a.title || '').toLowerCase();
                const nameB = (b.name || b.title || '').toLowerCase();
                const orderA = a.displayOrder !== undefined ? a.displayOrder : 9999;
                const orderB = b.displayOrder !== undefined ? b.displayOrder : 9999;
                if (sort === 'name-asc') return nameA.localeCompare(nameB);
                if (sort === 'name-desc') return nameB.localeCompare(nameA);
                if (sort === 'date-new' || sort === 'date-old') {
                    const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                    const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                    return sort === 'date-new' ? dateB - dateA : dateA - dateB;
                }
                if (orderA !== orderB) return orderA - orderB;
                return nameA.localeCompare(nameB);
            };
            filtered.sort(sortFn);

            const draggedItem = filtered[contentDragIdx];
            const targetItem = filtered[targetIdx];
            if (!draggedItem || !targetItem) return;

            const [moved] = filtered.splice(contentDragIdx, 1);
            filtered.splice(targetIdx, 0, moved);

            const batch = db.batch();
            filtered.forEach((item, i) => {
                const col = item._type === 'folder' ? 'folders' : item._type === 'quiz' ? 'quizzes' : 'files';
                batch.update(db.collection(col).doc(item.id), { displayOrder: i });
                if (item._type === 'folder') {
                    const cf = cachedFolders.find(f => f.id === item.id);
                    if (cf) cf.displayOrder = i;
                } else if (item._type === 'quiz') {
                    const cq = cachedQuizzes.find(q => q.id === item.id);
                    if (cq) cq.displayOrder = i;
                } else {
                    const cf2 = cachedFiles.find(f => f.id === item.id);
                    if (cf2) cf2.displayOrder = i;
                }
            });
            batch.commit().then(() => {
                renderContentArea();
            });
            contentDragIdx = null;
        }

        function updateBreadcrumb() {
            let html = '<a onclick="loadHome()">üè† Home</a>';
            currentPath.forEach((item, i) => {
                html += ' / ';
                if (i === currentPath.length - 1) html += `<strong>${item.name}</strong>`;
                else html += `<a onclick="navigateTo(${i})">${item.name}</a>`;
            });
            document.getElementById('content-breadcrumb').innerHTML = html;
            const loc = currentPath.length > 0 ? currentPath[currentPath.length - 1].name : 'Home';
            document.getElementById('folder-loc').textContent = loc;
            document.getElementById('quiz-loc').textContent = loc;
            document.getElementById('file-loc').textContent = loc;
            const aiQuizLoc = document.getElementById('ai-quiz-loc');
            if (aiQuizLoc) aiQuizLoc.textContent = loc;
        }

        function navigateTo(index) {
            currentPath = currentPath.slice(0, index + 1);
            updateBreadcrumb();
            loadFolderContent(currentPath[currentPath.length - 1].id);
        }

        function createFolder() {
            const name = document.getElementById('folder-name').value.trim();
            if (!name) return showAlert('Enter folder name', 'warning');
            const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            db.collection('folders').add({ name: name, parentId: parentId, createdAt: new Date() }).then(() => {
                closeModal('folder-modal');
                document.getElementById('folder-name').value = '';
                loadFolderContent(parentId);
            });
        }

        function editFolder(id, name) {
            editingFolderId = id;
            document.getElementById('edit-folder-name').value = name;
            openModal('edit-folder-modal');
        }

        function updateFolder() {
            const name = document.getElementById('edit-folder-name').value.trim();
            if (!name) return;
            db.collection('folders').doc(editingFolderId).update({ name }).then(() => {
                closeModal('edit-folder-modal');
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(parentId);
            });
        }

        async function deleteFolder(id, skipConfirm) {
            if (!skipConfirm) {
                const ok = await showConfirm('Delete folder and all contents inside it?', 'Delete');
                if (!ok) return;
            }
            const subFolders = await db.collection('folders').where('parentId', '==', id).get();
            for (const d of subFolders.docs) {
                await deleteFolder(d.id, true);
            }
            const quizzes = await db.collection('quizzes').where('folderId', '==', id).get();
            for (const d of quizzes.docs) {
                const questions = await db.collection('quizzes').doc(d.id).collection('questions').get();
                const batch = db.batch();
                questions.forEach(q => batch.delete(q.ref));
                await batch.commit();
                await db.collection('quizzes').doc(d.id).delete();
            }
            const files = await db.collection('files').where('folderId', '==', id).get();
            for (const d of files.docs) {
                await db.collection('files').doc(d.id).delete();
            }
            await db.collection('folders').doc(id).delete();
            if (!skipConfirm) {
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(parentId);
                loadStats();
                showAlert('Folder and all contents deleted', 'success');
            }
        }

        async function cleanupOrphans() {
            const ok = await showConfirm('This will find and delete all quizzes, files, and folders that belong to deleted/missing parent folders. Continue?', 'Cleanup');
            if (!ok) return;
            showAlert('Scanning for orphaned items...', 'info');
            const allFoldersSnap = await db.collection('folders').get();
            const folderIds = new Set();
            allFoldersSnap.forEach(d => folderIds.add(d.id));

            let orphanCount = 0;

            const allQuizzes = await db.collection('quizzes').get();
            for (const d of allQuizzes.docs) {
                const fid = d.data().folderId;
                if (fid && !folderIds.has(fid)) {
                    const questions = await db.collection('quizzes').doc(d.id).collection('questions').get();
                    const batch = db.batch();
                    questions.forEach(q => batch.delete(q.ref));
                    await batch.commit();
                    await db.collection('quizzes').doc(d.id).delete();
                    orphanCount++;
                }
            }

            const allFiles = await db.collection('files').get();
            for (const d of allFiles.docs) {
                const fid = d.data().folderId;
                if (fid && !folderIds.has(fid)) {
                    await db.collection('files').doc(d.id).delete();
                    orphanCount++;
                }
            }

            const allFolders2 = await db.collection('folders').get();
            for (const d of allFolders2.docs) {
                const pid = d.data().parentId;
                if (pid && !folderIds.has(pid)) {
                    await deleteFolder(d.id, true);
                    orphanCount++;
                }
            }

            if (orphanCount > 0) {
                showAlert(`Cleaned up ${orphanCount} orphaned item(s)`, 'success');
            } else {
                showAlert('No orphaned items found. Everything is clean!', 'success');
            }
            const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            loadFolderContent(parentId);
            loadStats();
        }

        // GOOGLE DRIVE FILE LINK
        function saveFileLink() {
            const name = document.getElementById('file-name').value.trim();
            const url = document.getElementById('file-url').value.trim();
            const size = 0;

            if (!name) return showAlert('Enter file name', 'warning');
            if (!url) return showAlert('Enter Google Drive link', 'warning');

            // Convert Google Drive link to direct download/view link
            let directUrl = url;

            // Handle different Google Drive link formats
            const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
            if (fileIdMatch) {
                const fileId = fileIdMatch[1];
                directUrl = `https://drive.google.com/file/d/${fileId}/view`;
            }

            const folderId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;

            const fileData = {
                name: name,
                type: 'application/pdf',
                size: size,
                url: directUrl,
                originalUrl: url,
                folderId: folderId,
                uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('files').add(fileData).then(() => {
                closeModal('file-modal');
                document.getElementById('file-name').value = '';
                document.getElementById('file-url').value = '';
                loadFolderContent(folderId);
                loadStats();
                showAlert('File link saved!', 'success');
            }).catch(err => {
                showAlert('Error: ' + err.message, 'error');
            });
        }

        function saveLink() {
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('link-url').value.trim();
            if (!name) return showAlert('Enter link name', 'warning');
            if (!url) return showAlert('Enter URL', 'warning');
            const folderId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            db.collection('links').add({ name, url, folderId, createdAt: new Date() }).then(() => {
                closeModal('link-modal');
                document.getElementById('link-name').value = '';
                document.getElementById('link-url').value = '';
                loadFolderContent(folderId);
                showAlert('Link saved!', 'success');
            });
        }

        async function deleteLink(id) {
            const ok = await showConfirm('Delete this link?', 'Delete');
            if (!ok) return;
            db.collection('links').doc(id).delete().then(() => {
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(parentId);
                showAlert('Link deleted!', 'success');
            });
        }

        async function deleteFile(id) {
            const ok = await showConfirm('Delete this file?', 'Delete');
            if (!ok) return;
            db.collection('files').doc(id).delete().then(() => {
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(parentId);
                loadStats();
            });
        }

        // EDIT FILE
        function editFile(id, name, url) {
            editingFileId = id;
            document.getElementById('edit-file-name').value = name;
            document.getElementById('edit-file-url').value = url;
            openModal('edit-file-modal');
        }

        function updateFile() {
            const name = document.getElementById('edit-file-name').value.trim();
            const url = document.getElementById('edit-file-url').value.trim();
            if (!name) return showAlert('Enter file name', 'warning');
            db.collection('files').doc(editingFileId).update({ name, url }).then(() => {
                closeModal('edit-file-modal');
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(parentId);
                showAlert('File updated!', 'success');
            });
        }

        // MOVE ITEM
        function openMoveModal(id, name, type) {
            moveItemId = id;
            moveItemType = type;
            document.getElementById('move-item-name').textContent = name;
            openModal('move-modal');
            loadMoveFolders();
        }

        function loadMoveFolders() {
            db.collection('folders').get().then(snap => {
                const allFolders = [];
                snap.forEach(doc => { allFolders.push({ id: doc.id, ...doc.data() }); });
                const excludeIds = new Set();
                if (moveItemType === 'folder') {
                    excludeIds.add(moveItemId);
                    function addChildren(parentId) {
                        allFolders.filter(f => f.parentId === parentId).forEach(f => {
                            excludeIds.add(f.id);
                            addChildren(f.id);
                        });
                    }
                    addChildren(moveItemId);
                }
                let html = '';
                allFolders.forEach(f => {
                    if (excludeIds.has(f.id)) return;
                    html += `<div class="move-folder-item" onclick="selectMoveTarget('${f.id}')">üìÅ ${f.name}</div>`;
                });
                if (!html) html = '<p style="color: #444; text-align: center;">No folders available</p>';
                document.getElementById('move-folder-list').innerHTML = html;
            });
        }

        function selectMoveTarget(targetFolderId) {
            const collection = moveItemType === 'folder' ? 'folders' : moveItemType === 'quiz' ? 'quizzes' : moveItemType === 'link' ? 'links' : 'files';
            const field = moveItemType === 'folder' ? 'parentId' : 'folderId';
            db.collection(collection).doc(moveItemId).update({ [field]: targetFolderId }).then(() => {
                closeModal('move-modal');
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(parentId);
                showAlert('Moved successfully!', 'success');
            });
        }

        // DARK MODE TOGGLE
        function toggleAdminDark() {
            document.body.classList.toggle('admin-dark');
            const isDark = document.body.classList.contains('admin-dark');
            localStorage.setItem('admin_dark', isDark);
            document.getElementById('admin-dark-toggle').textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        }

        function setTheme(theme) {
            db.collection('settings').doc('theme').set({ active: theme }).then(() => {
                showAlert('Theme changed to ' + (theme === 'default' ? 'Default' : theme.charAt(0).toUpperCase() + theme.slice(1)) + '!', 'success');
                loadCurrentTheme();
            });
        }

        function loadCurrentTheme() {
            db.collection('settings').doc('theme').get().then(doc => {
                const active = doc.exists ? (doc.data().active || 'default') : 'default';
                document.getElementById('current-theme-label').textContent = 'Current: ' + (active === 'default' ? 'Default' : active.charAt(0).toUpperCase() + active.slice(1));
                document.querySelectorAll('.theme-option').forEach(el => {
                    el.style.borderColor = el.dataset.theme === active ? '#667eea' : 'transparent';
                    el.style.transform = el.dataset.theme === active ? 'scale(1.05)' : 'scale(1)';
                });
            }).catch(() => {});
        }

        function parseQuiz() {
            const text = document.getElementById('quiz-text').value;
            if (!text.trim()) return showAlert('Enter questions', 'warning');
            currentQuestions = [];
            const blocks = text.split(/\n\s*\n|(?=Question:)/i).filter(b => b.trim());
            blocks.forEach(block => {
                const lines = block.split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length < 6) return;
                const qLine = lines.find(l => l.match(/^Question:/i)) || lines[0];
                const question = qLine.replace(/^Question:/i, '').trim();
                const options = [];
                lines.forEach(l => {
                    const m = l.match(/^([A-D])[).]\s*(.+)/i);
                    if (m && options.length < 4) options.push(m[2].trim());
                });
                if (options.length !== 4) return;
                let correct = 0;
                const cLine = lines.find(l => l.match(/^Correct:/i));
                if (cLine) {
                    const cm = cLine.match(/^Correct:\s*([A-D])/i);
                    if (cm) correct = cm[1].toUpperCase().charCodeAt(0) - 65;
                }
                let exp = '';
                const eLine = lines.find(l => l.match(/^Explanation:/i));
                if (eLine) exp = eLine.replace(/^Explanation:/i, '').trim();
                const wrongExplanations = {};
                lines.forEach(l => {
                    const wm = l.match(/^Wrong([A-D]):\s*(.+)/i);
                    if (wm) {
                        const idx = wm[1].toUpperCase().charCodeAt(0) - 65;
                        wrongExplanations[String(idx)] = wm[2].trim();
                    }
                });
                currentQuestions.push({ question, options, correctAnswer: correct, explanation: exp, wrongExplanations });
            });
            if (currentQuestions.length === 0) return showAlert('No valid questions found', 'warning');
            document.getElementById('quiz-preview').classList.remove('hidden');
            document.getElementById('preview-count').textContent = currentQuestions.length;
            document.getElementById('preview-list').innerHTML = currentQuestions.map((q, i) => `<div class="question-preview"><strong>Q${i+1}:</strong> ${q.question}<br>${q.options.map((o, j) => `<span style="${j===q.correctAnswer?'color:green;font-weight:bold':''}">${String.fromCharCode(65+j)}) ${o}</span>`).join('<br>')}<br><br><em style="color: #444;">üí° Explanation: ${q.explanation || 'None'}</em></div>`).join('');
        }

        function saveQuiz() {
            const title = document.getElementById('quiz-title').value.trim();
            if (!title) return showAlert('Enter title', 'warning');
            if (currentQuestions.length === 0) return showAlert('No questions', 'warning');
            const folderId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            const module = document.getElementById('quiz-module-select').value || document.getElementById('quiz-module-custom').value.trim();
            const subject = document.getElementById('quiz-subject-select').value || document.getElementById('quiz-subject-custom').value.trim();
            const tags = [module, subject].filter(t => t);
            db.collection('quizzes').add({ title: title, folderId: folderId, questionCount: currentQuestions.length, createdAt: new Date(), tags: tags }).then(docRef => {
                let saved = 0;
                currentQuestions.forEach((q, i) => {
                    db.collection('quizzes').doc(docRef.id).collection('questions').add({ ...q, order: i }).then(() => {
                        saved++;
                        if (saved === currentQuestions.length) {
                            closeModal('quiz-modal');
                            document.getElementById('quiz-title').value = '';
                            document.getElementById('quiz-text').value = '';
                            document.getElementById('quiz-preview').classList.add('hidden');
                            currentQuestions = [];
                            loadFolderContent(folderId);
                            loadStats();
                            showAlert('Quiz saved!', 'success');
                        }
                    });
                });
            });
        }

        function buildQuestionCard(qid, num, qu) {
            const labels = ['A', 'B', 'C', 'D'];
            const wrongExp = qu.wrongExplanations || {};
            let optionsHtml = '';
            qu.options.forEach((o, j) => {
                const isCorrect = j === qu.correctAnswer;
                const circleColor = isCorrect ? '#4caf50' : '#ef4444';
                const borderColor = isCorrect ? '#4caf50' : '#fca5a5';
                optionsHtml += `<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <span style="background: ${circleColor}; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9em; flex-shrink: 0;">${labels[j]}</span>
                    <input type="text" id="opt-${qid}-${j}" value="${o.replace(/"/g, '&quot;')}" style="flex: 1; padding: 10px; border: 2px solid ${borderColor}; border-radius: 8px; font-size: 0.95em;">
                </div>`;
                if (!isCorrect) {
                    optionsHtml += `<div style="margin-left: 42px; margin-bottom: 10px;">
                        <input type="text" id="wexp-${qid}-${j}" value="${(wrongExp[String(j)] || '').replace(/"/g, '&quot;')}" placeholder="Why ${labels[j]} is wrong..." style="width: 100%; padding: 8px 10px; border: 2px solid #ffcdd2; border-radius: 8px; font-size: 0.85em; color: #c62828; background: #fff5f5;">
                    </div>`;
                }
            });

            return `<div id="div-${qid}" class="drag-question" draggable="true" data-qid="${qid}" ondragstart="onQuestionDragStart(event)" ondragover="onQuestionDragOver(event)" ondragleave="onQuestionDragLeave(event)" ondrop="onQuestionDrop(event)" ondragend="onQuestionDragEnd(event)" style="background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%); border: 2px solid #e0e5ff; border-radius: 15px; padding: 20px; margin-bottom: 15px; position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="drag-handle" title="Drag to reorder">‚†ø</span>
                        <h4 style="color: #667eea; margin: 0; font-size: 1.1em;">Q${num}</h4>
                    </div>
                    <button class="btn btn-danger" style="padding: 6px 15px; font-size: 0.85em; border-radius: 20px;" onclick="deleteQuestion('${qid}')">üóëÔ∏è Delete</button>
                </div>
                <input type="text" id="q-${qid}" value="${qu.question.replace(/"/g, '&quot;')}" placeholder="Enter question..." style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em; margin-bottom: 15px; font-weight: 500;">
                <div style="margin-bottom: 12px;">
                    <label style="font-weight: bold; color: #333; font-size: 0.9em; margin-bottom: 8px; display: block;">Options & Wrong Explanations:</label>
                    ${optionsHtml}
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-weight: bold; color: #4caf50; white-space: nowrap;">Correct Answer:</label>
                        <select id="cor-${qid}" onchange="refreshEditQuestion('${qid}')" style="padding: 8px 15px; border: 2px solid #4caf50; border-radius: 8px; font-size: 1em; background: #e8f5e9;">
                            ${[0,1,2,3].map(j => `<option value="${j}" ${j===qu.correctAnswer?'selected':''}>${labels[j]}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <label style="font-weight: bold; color: #818cf8; font-size: 0.9em; display: block; margin-bottom: 5px;">üí° Correct Answer Explanation:</label>
                    <input type="text" id="exp-${qid}" value="${(qu.explanation || '').replace(/"/g, '&quot;')}" placeholder="Why the correct answer is right..." style="width: 100%; padding: 10px; border: 2px solid #818cf8; border-radius: 8px; font-size: 0.95em; background: #f0f0ff;">
                </div>
            </div>`;
        }

        function refreshEditQuestion(qid) {
            const q = currentQuestions.find(q => q.id === qid);
            if (!q) return;
            q.question = document.getElementById(`q-${qid}`).value;
            q.options = [0,1,2,3].map(j => document.getElementById(`opt-${qid}-${j}`).value);
            q.correctAnswer = parseInt(document.getElementById(`cor-${qid}`).value);
            q.explanation = document.getElementById(`exp-${qid}`).value;
            const wrongExp = {};
            [0,1,2,3].forEach(j => {
                const el = document.getElementById(`wexp-${qid}-${j}`);
                if (el && el.value.trim()) wrongExp[String(j)] = el.value.trim();
            });
            q.wrongExplanations = wrongExp;
            const num = currentQuestions.indexOf(q) + 1;
            const div = document.getElementById(`div-${qid}`);
            if (div) div.outerHTML = buildQuestionCard(qid, num, q);
        }

        function editQuiz(id) {
            editingQuizId = id;
            db.collection('quizzes').doc(id).get().then(doc => {
                const q = doc.data();
                document.getElementById('edit-quiz-title').value = q.title;
                db.collection('quizzes').doc(id).collection('questions').orderBy('order').get().then(snap => {
                    currentQuestions = [];
                    let html = '';
                    let num = 1;
                    snap.forEach((d) => {
                        const qu = d.data();
                        currentQuestions.push({ id: d.id, ...qu });
                        html += buildQuestionCard(d.id, num, qu);
                        num++;
                    });
                    document.getElementById('edit-questions').innerHTML = html;
                    openModal('edit-quiz-modal');
                    setTimeout(() => { editQuizOriginalState = getEditQuizState(); }, 100);
                });
            });
        }

        function getEditQuizState() {
            const title = document.getElementById('edit-quiz-title').value;
            const qs = currentQuestions.map(q => {
                const qEl = document.getElementById(`q-${q.id}`);
                return qEl ? qEl.value : '';
            });
            return title + '|' + qs.join('|');
        }

        function addQuestion() {
            const tempId = 'temp_' + Date.now();
            const newQ = { id: tempId, question: '', options: ['', '', '', ''], correctAnswer: 0, explanation: '', wrongExplanations: {} };
            currentQuestions.push(newQ);
            const html = buildQuestionCard(tempId, currentQuestions.length, newQ);
            document.getElementById('edit-questions').insertAdjacentHTML('beforeend', html);
        }

        function deleteQuestion(qid) {
            if (!qid.startsWith('temp_')) db.collection('quizzes').doc(editingQuizId).collection('questions').doc(qid).delete();
            document.getElementById(`div-${qid}`)?.remove();
            currentQuestions = currentQuestions.filter(q => q.id !== qid);
            renumberQuestions();
        }

        function renumberQuestions() {
            currentQuestions.forEach((q, i) => {
                const div = document.getElementById(`div-${q.id}`);
                if (div) {
                    const h4 = div.querySelector('h4');
                    if (h4) h4.textContent = 'Q' + (i + 1);
                }
            });
        }

        let questionDragId = null;
        function onQuestionDragStart(e) {
            questionDragId = e.currentTarget.dataset.qid;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function onQuestionDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        function onQuestionDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        function onQuestionDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
        }
        function onQuestionDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const targetQid = e.currentTarget.dataset.qid;
            if (!questionDragId || questionDragId === targetQid) return;
            const fromIdx = currentQuestions.findIndex(q => q.id === questionDragId);
            const toIdx = currentQuestions.findIndex(q => q.id === targetQid);
            if (fromIdx === -1 || toIdx === -1) return;
            const [moved] = currentQuestions.splice(fromIdx, 1);
            currentQuestions.splice(toIdx, 0, moved);
            const container = document.getElementById('edit-questions');
            const cards = Array.from(container.children);
            const draggedCard = cards.find(c => c.dataset.qid === questionDragId);
            const targetCard = cards.find(c => c.dataset.qid === targetQid);
            if (draggedCard && targetCard) {
                if (fromIdx < toIdx) targetCard.after(draggedCard);
                else targetCard.before(draggedCard);
            }
            renumberQuestions();
            questionDragId = null;
        }

        function updateQuiz() {
            const title = document.getElementById('edit-quiz-title').value.trim();
            if (!title) return showAlert('Enter title', 'warning');
            db.collection('quizzes').doc(editingQuizId).update({ title });
            currentQuestions.forEach((q, i) => {
                const correctIdx = parseInt(document.getElementById(`cor-${q.id}`).value);
                const wrongExplanations = {};
                [0,1,2,3].forEach(j => {
                    if (j !== correctIdx) {
                        const el = document.getElementById(`wexp-${q.id}-${j}`);
                        if (el && el.value.trim()) wrongExplanations[String(j)] = el.value.trim();
                    }
                });
                const data = {
                    question: document.getElementById(`q-${q.id}`).value,
                    options: [0,1,2,3].map(j => document.getElementById(`opt-${q.id}-${j}`).value),
                    correctAnswer: correctIdx,
                    explanation: document.getElementById(`exp-${q.id}`).value,
                    wrongExplanations: wrongExplanations,
                    order: i
                };
                if (q.id.startsWith('temp_')) db.collection('quizzes').doc(editingQuizId).collection('questions').add(data);
                else db.collection('quizzes').doc(editingQuizId).collection('questions').doc(q.id).update(data);
            });
            db.collection('quizzes').doc(editingQuizId).update({ questionCount: currentQuestions.length });
            editQuizOriginalState = '';
            document.getElementById('edit-quiz-modal').style.display = 'none';
            const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            loadFolderContent(parentId);
            loadStats();
            showAlert('Quiz saved!', 'success');
        }

        async function deleteQuiz(id) {
            const ok = await showConfirm('Delete this quiz and all its questions?', 'Delete');
            if (!ok) return;
            db.collection('quizzes').doc(id).collection('questions').get().then(snap => {
                const batch = db.batch();
                snap.forEach(d => batch.delete(d.ref));
                return batch.commit();
            }).then(() => db.collection('quizzes').doc(id).delete()).then(() => {
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
                loadFolderContent(parentId);
                loadStats();
            });
        }

        function loadStudents() {
            db.collection('users').get().then(snap => {
                let html = '<table><tr><th>Username</th><th>Quizzes</th><th>Avg</th><th>Action</th></tr>';
                snap.forEach(doc => {
                    const u = doc.data();
                    const h = u.history || [];
                    const avg = h.length > 0 ? Math.round(h.reduce((a,b) => a + b.percent, 0) / h.length) : 0;
                    html += `<tr><td>${u.username}</td><td>${h.length}</td><td>${avg}%</td><td><button class="btn btn-danger" style="padding:4px 12px;font-size:0.8em;" onclick="deleteStudent('${doc.id}', '${u.username}')">üóëÔ∏è</button></td></tr>`;
                });
                html += '</table>';
                document.getElementById('students-list').innerHTML = html;
            });
        }

        async function deleteStudent(id, username) {
            const ok = await showConfirm(`Delete student "${username}" and all their data?`, 'Delete');
            if (!ok) return;
            db.collection('users').doc(id).delete().then(() => {
                loadStudents();
                loadStats();
                showAlert('Student deleted!', 'success');
            });
        }

        let notifTarget = 'all';
        let notifAllUsers = [];

        function setNotifTarget(target) {
            notifTarget = target;
            document.querySelectorAll('.notif-target-btn').forEach(b => {
                b.style.background = '';
                b.style.color = '';
                b.classList.remove('active');
            });
            const btn = document.getElementById('notif-target-' + target);
            btn.classList.add('active');

            document.getElementById('notif-one-user').style.display = target === 'one' ? 'block' : 'none';
            document.getElementById('notif-selected-users').style.display = target === 'selected' ? 'block' : 'none';

            if (target === 'one' || target === 'selected') loadNotifUsers(target);
        }

        function loadNotifUsers(target) {
            db.collection('users').get().then(snap => {
                notifAllUsers = [];
                snap.forEach(doc => {
                    notifAllUsers.push({ id: doc.id, username: doc.data().username });
                });
                notifAllUsers.sort((a, b) => a.username.localeCompare(b.username));

                if (target === 'one') {
                    const sel = document.getElementById('notif-single-user');
                    sel.innerHTML = '<option value="">-- Select User --</option>';
                    notifAllUsers.forEach(u => {
                        sel.innerHTML += `<option value="${u.id}">${u.username}</option>`;
                    });
                } else {
                    renderNotifCheckboxes(notifAllUsers);
                }
            });
        }

        function renderNotifCheckboxes(users) {
            const container = document.getElementById('notif-users-checkboxes');
            container.innerHTML = '';
            users.forEach(u => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 8px 5px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;';
                div.innerHTML = `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; width: 100%; margin: 0;"><input type="checkbox" class="notif-user-cb" value="${u.id}" data-username="${u.username}" onchange="updateNotifSelectedCount()" style="width: 18px; height: 18px; cursor: pointer;"><span style="color: #333;">${u.username}</span></label>`;
                container.appendChild(div);
            });
        }

        function filterNotifUsers() {
            const q = document.getElementById('notif-user-search').value.toLowerCase();
            const filtered = notifAllUsers.filter(u => u.username.toLowerCase().includes(q));
            renderNotifCheckboxes(filtered);
        }

        function updateNotifSelectedCount() {
            const checked = document.querySelectorAll('.notif-user-cb:checked');
            document.getElementById('notif-selected-count').textContent = checked.length + ' user' + (checked.length !== 1 ? 's' : '') + ' selected';
        }

        function sendNotification() {
            const msg = document.getElementById('notif-msg').value.trim();
            const days = parseInt(document.getElementById('notif-days').value) || 0;
            const hours = parseInt(document.getElementById('notif-hours').value) || 0;
            const minutes = parseInt(document.getElementById('notif-minutes').value) || 0;

            if (!msg) return showAlert('Enter a message', 'warning');

            const totalMinutes = (days * 24 * 60) + (hours * 60) + minutes;
            if (totalMinutes <= 0) return showAlert('Please set a valid duration', 'warning');

            let targetType = notifTarget;
            let targetUsers = [];
            let targetLabel = 'All Users';

            if (notifTarget === 'one') {
                const sel = document.getElementById('notif-single-user');
                if (!sel.value) return showAlert('Please select a user', 'warning');
                targetUsers = [sel.value];
                targetLabel = sel.options[sel.selectedIndex].text;
            } else if (notifTarget === 'selected') {
                const checked = document.querySelectorAll('.notif-user-cb:checked');
                if (checked.length === 0) return showAlert('Please select at least one user', 'warning');
                checked.forEach(cb => targetUsers.push(cb.value));
                const names = Array.from(checked).map(cb => cb.dataset.username);
                targetLabel = names.length <= 3 ? names.join(', ') : names.slice(0, 3).join(', ') + ` +${names.length - 3} more`;
            }

            const exp = new Date();
            exp.setMinutes(exp.getMinutes() + totalMinutes);

            let durationText = '';
            if (days > 0) durationText += days + ' day' + (days > 1 ? 's' : '') + ' ';
            if (hours > 0) durationText += hours + ' hour' + (hours > 1 ? 's' : '') + ' ';
            if (minutes > 0) durationText += minutes + ' min' + (minutes > 1 ? 's' : '');

            db.collection('notifications').add({ 
                message: msg, 
                expiry: exp, 
                durationText: durationText.trim(),
                targetType: targetType,
                targetUsers: targetUsers,
                targetLabel: targetLabel,
                active: true, 
                createdAt: new Date() 
            }).then(() => {
                document.getElementById('notif-msg').value = '';
                document.getElementById('notif-days').value = '0';
                document.getElementById('notif-hours').value = '0';
                document.getElementById('notif-minutes').value = '0';
                setNotifTarget('all');
                loadNotifications();
                showAlert('Notification sent to ' + targetLabel + '!', 'success');
            });
        }

        function loadNotifications() {
            db.collection('notifications').where('active', '==', true).get().then(snap => {
                let html = '';
                const now = new Date();
                snap.forEach(doc => {
                    const n = doc.data();
                    const expiry = n.expiry.toDate ? n.expiry.toDate() : new Date(n.expiry);
                    const isExpired = expiry <= now;
                    const d = expiry.toLocaleString();
                    const duration = n.durationText || 'Unknown';
                    const target = n.targetType || 'all';
                    const targetLabel = n.targetLabel || 'All Users';

                    let targetBadge = '';
                    if (target === 'all') targetBadge = '<span style="background: #667eea; color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.8em;">üì¢ All Users</span>';
                    else if (target === 'one') targetBadge = `<span style="background: #f59e0b; color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.8em;">üë§ ${targetLabel}</span>`;
                    else targetBadge = `<span style="background: #10b981; color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.8em;">üë• ${targetLabel}</span>`;

                    const expiredClass = isExpired ? ' notif-expired' : '';
                    const expiredTag = isExpired ? ' <span style="color: #dc2626; font-size: 0.8em;">(Expired)</span>' : '';

                    html += `<div class="notif-card${expiredClass}" style="padding: 18px; border-radius: 12px; margin-bottom: 12px; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px; flex-wrap: wrap;">
                            <div style="flex: 1;">
                                <div class="notif-card-msg" style="font-size: 1.05em; font-weight: 600; margin-bottom: 8px;">${n.message}</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 6px;">
                                    ${targetBadge}
                                </div>
                                <div class="notif-card-details" style="font-size: 0.85em;">‚è±Ô∏è ${duration} &nbsp;|&nbsp; Expires: ${d}${expiredTag}</div>
                            </div>
                            <button class="btn btn-danger" style="padding: 6px 14px; font-size: 0.85em; white-space: nowrap;" onclick="db.collection('notifications').doc('${doc.id}').update({active: false}); loadNotifications();">üóëÔ∏è Delete</button>
                        </div>
                    </div>`;
                });
                document.getElementById('active-notifications').innerHTML = html || '<p style="color: #888; text-align: center; padding: 20px;">No active notifications</p>';
            });
        }

        function getAutoPrefix() {
            if (currentPath.length < 3) return '';
            let prefix = '';
            for (let i = 2; i < currentPath.length; i++) {
                const name = currentPath[i].name;
                if (prefix && name.startsWith(prefix)) {
                    prefix = name;
                } else if (prefix) {
                    prefix = prefix + ' - ' + name;
                } else {
                    prefix = name;
                }
            }
            return prefix;
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
            if (id === 'theme-modal') {
                loadCurrentTheme();
            }
            if (id === 'openai-settings-modal') {
                loadOpenAiKey();
            }
            if (id === 'link-modal') {
                const loc = currentPath.length > 0 ? currentPath[currentPath.length - 1].name : 'Home';
                document.getElementById('link-loc').textContent = loc;
            }
            if (id === 'folder-modal') {
                document.getElementById('folder-module-select').value = '';
                document.getElementById('folder-module-custom').value = '';
                document.getElementById('folder-subject-select').value = '';
                document.getElementById('folder-subject-custom').value = '';
                document.getElementById('folder-lecture-select').value = '';
                document.getElementById('folder-lecture-custom').value = '';
                document.getElementById('folder-name').value = '';
                document.getElementById('folder-name').readOnly = true;
                populateFolderSelects();
                if (currentPath.length >= 3) {
                    document.getElementById('folder-name').value = getAutoPrefix() + ' - ';
                }
            }
            if (id === 'quiz-modal') {
                document.getElementById('quiz-title').readOnly = true;
                if (currentPath.length >= 3) {
                    document.getElementById('quiz-title').value = getAutoPrefix() + ' - ';
                }
            }
            if (id === 'file-modal') {
                document.getElementById('file-name').readOnly = true;
                if (currentPath.length >= 3) {
                    document.getElementById('file-name').value = getAutoPrefix() + ' - ';
                }
            }
        }
        async function closeModal(id) {
            if (id === 'edit-quiz-modal' && editQuizOriginalState) {
                const currentState = getEditQuizState();
                if (currentState !== editQuizOriginalState) {
                    const ok = await showConfirm('You have unsaved changes. Leave without saving?', 'Leave');
                    if (!ok) return;
                }
                editQuizOriginalState = '';
            }
            document.getElementById(id).style.display = 'none';
        }
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'edit-quiz-modal') { closeModal('edit-quiz-modal'); }
                else { e.target.style.display = 'none'; }
            }
        };
    
        // QUIZ NAME BUILDER FUNCTIONS
        let quizOptions = {
            modules: ['HPF', 'H', 'BSC', 'CGBP', 'ALF'],
            subjects: ['Physiology', 'Histology', 'Anatomy', 'Embryology', 'Biochemistry', 'Pathology', 'Pharmacology', 'Microbiology'],
            lectures: ['Lecture 1','Lecture 2','Lecture 3','Lecture 4','Lecture 5','Lecture 6','Lecture 7','Lecture 8','Lecture 9','Lecture 10','Lecture 11','Lecture 12','Lecture 13','Lecture 14','Lecture 15','Lecture 16','Lecture 17','Lecture 18','Lecture 19','Lecture 20','Summary','Review','Midterm','Final','Notes'],
            fileTypes: ['PDF', 'PPT', 'Word', 'Video', 'Sheet']
        };

        function loadQuizOptions() {
            db.collection('settings').doc('quizOptions').get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    quizOptions.modules = data.modules || quizOptions.modules;
                    quizOptions.subjects = data.subjects || quizOptions.subjects;
                    quizOptions.lectures = data.lectures || quizOptions.lectures;
                    quizOptions.fileTypes = data.fileTypes || quizOptions.fileTypes;
                }
                populateSelects();
                populateFileSelects();
                populateFolderSelects();
            }).catch(() => {
                populateSelects();
                populateFileSelects();
                populateFolderSelects();
            });
        }

        function saveQuizOptions() {
            db.collection('settings').doc('quizOptions').set({
                modules: quizOptions.modules,
                subjects: quizOptions.subjects,
                lectures: quizOptions.lectures,
                fileTypes: quizOptions.fileTypes
            });
        }

        function populateFolderSelects() {
            const moduleSelect = document.getElementById('folder-module-select');
            const subjectSelect = document.getElementById('folder-subject-select');
            const lectureSelect = document.getElementById('folder-lecture-select');

            if (moduleSelect) {
                moduleSelect.innerHTML = '<option value="">-- Select Module --</option>' + 
                    quizOptions.modules.map(m => `<option value="${m}">${m}</option>`).join('');
            }
            if (subjectSelect) {
                subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>' + 
                    quizOptions.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            }
            if (lectureSelect) {
                lectureSelect.innerHTML = '<option value="">-- Select Lecture --</option>' + 
                    quizOptions.lectures.map(l => `<option value="${l}">${l}</option>`).join('');
            }
        }

        function updateFolderName() {
            const moduleSelect = document.getElementById('folder-module-select').value;
            const moduleCustom = document.getElementById('folder-module-custom').value.trim();
            const subjectSelect = document.getElementById('folder-subject-select').value;
            const subjectCustom = document.getElementById('folder-subject-custom').value.trim();
            const lectureSelect = document.getElementById('folder-lecture-select').value;
            const lectureCustom = document.getElementById('folder-lecture-custom').value.trim();

            const module = moduleCustom || moduleSelect;
            const subject = subjectCustom || subjectSelect;
            const lecture = lectureCustom || lectureSelect;

            const builderParts = [module, subject, lecture].filter(p => p);
            const builderName = builderParts.join(' - ');
            const prefix = getAutoPrefix();
            if (prefix && builderName) {
                document.getElementById('folder-name').value = prefix + ' - ' + builderName;
            } else {
                document.getElementById('folder-name').value = builderName || (prefix ? prefix + ' - ' : '');
            }
        }

        function showManageOptionsFromFolder() {
            document.getElementById('manage-options-modal').style.display = 'flex';
        }

        // Populate select dropdowns
        function populateSelects() {
            const moduleSelect = document.getElementById('quiz-module-select');
            const subjectSelect = document.getElementById('quiz-subject-select');
            const lectureSelect = document.getElementById('quiz-lecture-select');

            if (moduleSelect) {
                moduleSelect.innerHTML = '<option value="">-- Select Module --</option>' + 
                    quizOptions.modules.map(m => `<option value="${m}">${m}</option>`).join('');
            }
            if (subjectSelect) {
                subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>' + 
                    quizOptions.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            }
            if (lectureSelect && quizOptions.lectures) {
                lectureSelect.innerHTML = '<option value="">-- Select Lecture --</option>' + 
                    quizOptions.lectures.map(l => `<option value="${l}">${l}</option>`).join('');
            }
        }

        // Update quiz title based on selections
        function updateQuizTitle() {
            const moduleSelect = document.getElementById('quiz-module-select').value;
            const moduleCustom = document.getElementById('quiz-module-custom').value.trim();
            const subjectSelect = document.getElementById('quiz-subject-select').value;
            const subjectCustom = document.getElementById('quiz-subject-custom').value.trim();
            const lectureSelect = document.getElementById('quiz-lecture-select').value;
            const lectureCustom = document.getElementById('quiz-lecture-custom').value.trim();

            const module = moduleCustom || moduleSelect;
            const subject = subjectCustom || subjectSelect;
            const lecture = lectureCustom || lectureSelect;

            const builderParts = [module, subject, lecture].filter(p => p);
            const builderName = builderParts.join(' - ');
            const prefix = getAutoPrefix();
            if (prefix && builderName) {
                document.getElementById('quiz-title').value = prefix + ' - ' + builderName;
            } else {
                document.getElementById('quiz-title').value = builderName || (prefix ? prefix + ' - ' : '');
            }
        }

        // Show manage options modal
        function showManageOptions() {
            renderOptionsLists();
            openModal('manage-options-modal');
        }

        // Render options in manage modal
        function renderOptionsLists() {
            const types = [
                { key: 'modules', divId: 'modules-list', bg: '#e3f2fd', type: 'module' },
                { key: 'subjects', divId: 'subjects-list', bg: '#e8f5e9', type: 'subject' },
                { key: 'lectures', divId: 'lectures-list', bg: '#fff3e0', type: 'lecture' },
                { key: 'fileTypes', divId: 'fileTypes-list', bg: '#f3e5f5', type: 'fileType' }
            ];
            types.forEach(t => {
                const div = document.getElementById(t.divId);
                if (div && quizOptions[t.key]) {
                    div.innerHTML = quizOptions[t.key].map((val, i) => 
                        `<span style="background: ${t.bg}; padding: 5px 15px; border-radius: 20px; display: flex; align-items: center; gap: 5px;">
                            ${val} <button onclick="removeOption('${t.type}', ${i})" style="background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
                        </span>`
                    ).join('');
                }
            });
        }

        // Add new option
        function addOption(type) {
            const input = document.getElementById('new-' + type);
            const value = input.value.trim();
            if (!value) return;

            const keyMap = { module: 'modules', subject: 'subjects', lecture: 'lectures', fileType: 'fileTypes' };
            const key = keyMap[type];
            if (key && quizOptions[key] && !quizOptions[key].includes(value)) {
                quizOptions[key].push(value);
            }

            saveQuizOptions();
            renderOptionsLists();
            populateSelects();
            populateFileSelects();
            populateFolderSelects();
            input.value = '';
        }

        // Remove option
        function removeOption(type, index) {
            const keyMap = { module: 'modules', subject: 'subjects', lecture: 'lectures', fileType: 'fileTypes' };
            const key = keyMap[type];
            if (key && quizOptions[key]) {
                quizOptions[key].splice(index, 1);
            }

            saveQuizOptions();
            renderOptionsLists();
            populateSelects();
            populateFileSelects();
            populateFolderSelects();
        }

        // Load options when page loads
        window.addEventListener('load', function() {
            loadQuizOptions();
            populateFileSelects();
            populateFolderSelects();
        });

        // MANAGE SHEETS FUNCTIONS
        let questionSheets = [];

        function loadSheets() {
            const saved = localStorage.getItem('medquiz_sheets');
            if (saved) {
                questionSheets = JSON.parse(saved);
            }
        }

        function saveSheets() {
            localStorage.setItem('medquiz_sheets', JSON.stringify(questionSheets));
        }

        function showManageSheets() {
            renderSheetsList();
            openModal('manage-sheets-modal');
        }

        // Open Manage Options from File Modal
        function showManageOptionsFromFile() {
            renderOptionsLists();
            openModal('manage-options-modal');

            // Add listener to refresh file selects when closing manage options
            const checkClosed = setInterval(() => {
                if (document.getElementById('manage-options-modal').style.display !== 'flex') {
                    clearInterval(checkClosed);
                    populateFileSelects();
                }
            }, 500);
        }

        function saveSheet() {
            const name = document.getElementById('sheet-name').value.trim();
            const questions = document.getElementById('sheet-questions').value.trim();

            if (!name) return showAlert('Please enter a sheet name', 'warning');
            if (!questions) return showAlert('Please enter questions', 'warning');

            const sheet = {
                id: Date.now().toString(),
                name: name,
                questions: questions,
                createdAt: new Date().toLocaleDateString()
            };

            questionSheets.push(sheet);
            saveSheets();

            // Clear inputs
            document.getElementById('sheet-name').value = '';
            document.getElementById('sheet-questions').value = '';

            renderSheetsList();
            showAlert('Sheet saved successfully!', 'success');
        }

        function renderSheetsList() {
            const container = document.getElementById('sheets-list');
            if (!container) return;

            if (questionSheets.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No sheets saved yet</p>';
                return;
            }

            container.innerHTML = questionSheets.map(sheet => `
                <div style="background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #333; font-size: 1.1em;">${sheet.name}</strong>
                        <div style="color: #444; font-size: 0.9em; margin-top: 5px;">
                            üìÖ ${sheet.createdAt} | üìù ${sheet.questions.split('Question:').length - 1} questions
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="useSheet('${sheet.id}')" style="background: #4caf50; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9em;">
                            ‚úì Use
                        </button>
                        <button onclick="deleteSheet('${sheet.id}')" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9em;">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function useSheet(sheetId) {
            const sheet = questionSheets.find(s => s.id === sheetId);
            if (!sheet) return;

            // Fill the quiz questions textarea
            document.getElementById('quiz-text').value = sheet.questions;

            // Close the modal
            closeModal('manage-sheets-modal');

            // If quiz modal is not open, open it
            if (document.getElementById('quiz-modal').style.display !== 'flex') {
                openModal('quiz-modal');
            }

            showAlert(`Sheet "${sheet.name}" loaded! Click "Parse" to preview questions.`, 'success');
        }

        async function deleteSheet(sheetId) {
            const ok = await showConfirm('Delete this sheet?', 'Delete');
            if (!ok) return;

            questionSheets = questionSheets.filter(s => s.id !== sheetId);
            saveSheets();
            renderSheetsList();
        }

        // Load sheets on page load
        window.addEventListener('load', function() {
            loadSheets();
        });

        // FILE NAME BUILDER FUNCTIONS
        function populateFileSelects() {
            const moduleSelect = document.getElementById('file-module-select');
            const subjectSelect = document.getElementById('file-subject-select');
            const lectureSelect = document.getElementById('file-lecture-select');
            const typeSelect = document.getElementById('file-type-select');

            if (moduleSelect && quizOptions.modules) {
                moduleSelect.innerHTML = '<option value="">-- Select Module --</option>' + 
                    quizOptions.modules.map(m => `<option value="${m}">${m}</option>`).join('');
            }
            if (subjectSelect && quizOptions.subjects) {
                subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>' + 
                    quizOptions.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            }
            if (lectureSelect && quizOptions.lectures) {
                lectureSelect.innerHTML = '<option value="">-- Select Lecture --</option>' + 
                    quizOptions.lectures.map(l => `<option value="${l}">${l}</option>`).join('');
            }
            if (typeSelect && quizOptions.fileTypes) {
                typeSelect.innerHTML = '<option value="">-- Select Type --</option>' + 
                    quizOptions.fileTypes.map(t => `<option value="${t}">${t}</option>`).join('');
            }
        }

        function updateFileName() {
            const moduleSelect = document.getElementById('file-module-select').value;
            const moduleCustom = document.getElementById('file-module-custom').value.trim();
            const subjectSelect = document.getElementById('file-subject-select').value;
            const subjectCustom = document.getElementById('file-subject-custom').value.trim();
            const lectureSelect = document.getElementById('file-lecture-select').value;
            const lectureCustom = document.getElementById('file-lecture-custom').value.trim();
            const typeSelect = document.getElementById('file-type-select').value;
            const typeCustom = document.getElementById('file-type-custom').value.trim();

            const module = moduleCustom || moduleSelect;
            const subject = subjectCustom || subjectSelect;
            const lecture = lectureCustom || lectureSelect;
            const type = typeCustom || typeSelect;

            const builderParts = [module, subject, lecture, type].filter(p => p);
            const builderName = builderParts.join(' - ');
            const prefix = getAutoPrefix();
            if (prefix && builderName) {
                document.getElementById('file-name').value = prefix + ' - ' + builderName;
            } else {
                document.getElementById('file-name').value = builderName || (prefix ? prefix + ' - ' : '');
            }
        }

        let aiGeneratedQuestions = [];
        let aiSelectedFile = null;

        function aiFileSelected(input) {
            if (input.files.length > 0) {
                aiSelectedFile = input.files[0];
                document.getElementById('ai-file-info').style.display = 'block';
                document.getElementById('ai-file-name').textContent = 'üìÑ ' + aiSelectedFile.name + ' (' + (aiSelectedFile.size / 1024).toFixed(1) + ' KB)';
            }
        }

        function clearAiFile() {
            aiSelectedFile = null;
            document.getElementById('ai-file-input').value = '';
            document.getElementById('ai-file-info').style.display = 'none';
        }

        function openQuizModal() {
            switchQuizTab('file');
            document.getElementById('quiz-preview').classList.add('hidden');
            document.getElementById('ai-step-1').style.display = 'block';
            document.getElementById('ai-step-2').style.display = 'none';
            document.getElementById('ai-error').style.display = 'none';
            document.getElementById('ai-loading').style.display = 'none';
            document.getElementById('ai-generate-btn').style.display = 'block';
            openModal('quiz-modal');
        }

        function closeQuizModal() {
            closeModal('quiz-modal');
            document.getElementById('ai-step-1').style.display = 'block';
            document.getElementById('ai-step-2').style.display = 'none';
            document.getElementById('ai-error').style.display = 'none';
            document.getElementById('ai-loading').style.display = 'none';
            document.getElementById('ai-generate-btn').style.display = 'block';
            document.getElementById('quiz-preview').classList.add('hidden');
        }

        function closeAiModal() {
            closeQuizModal();
        }

        function switchQuizTab(tab) {
            document.querySelectorAll('.quiz-tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.quiz-tab').forEach(el => el.classList.remove('active'));
            document.getElementById('quiz-tab-' + tab).style.display = 'block';
            document.getElementById('tab-btn-' + tab).classList.add('active');
            if (tab !== 'ai') {
                document.getElementById('quiz-preview').classList.add('hidden');
            }
        }

        function uploadQuizTextFile(input) {
            if (input.files.length > 0) {
                const file = input.files[0];
                document.getElementById('txt-file-info').style.display = 'block';
                document.getElementById('txt-file-name').textContent = 'üìÑ ' + file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)';
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('quiz-text').value = e.target.result;
                    parseQuiz();
                };
                reader.readAsText(file);
            }
        }

        function clearTxtFile() {
            document.getElementById('txt-file-input').value = '';
            document.getElementById('txt-file-info').style.display = 'none';
            document.getElementById('quiz-text').value = '';
            document.getElementById('quiz-preview').classList.add('hidden');
        }

        function saveOpenAiKey() {
            const key = document.getElementById('openai-api-key-input').value.trim();
            const proxyUrl = document.getElementById('openai-proxy-url-input').value.trim();
            if (!key) return showAlert('Please enter an API key', 'warning');
            localStorage.setItem('medquiz_openai_key', key);
            localStorage.setItem('medquiz_proxy_url', proxyUrl);
            const status = document.getElementById('openai-key-status');
            status.style.display = 'block';
            status.style.background = '#d1fae5';
            status.style.color = '#065f46';
            status.textContent = '‚úÖ Settings saved successfully!';
            showAlert('AI Settings saved!', 'success');
            setTimeout(() => { status.style.display = 'none'; }, 3000);
        }

        function loadOpenAiKey() {
            const key = localStorage.getItem('medquiz_openai_key') || '';
            const proxyUrl = localStorage.getItem('medquiz_proxy_url') || '';
            const input = document.getElementById('openai-api-key-input');
            const proxyInput = document.getElementById('openai-proxy-url-input');
            if (input) input.value = key;
            if (proxyInput) proxyInput.value = proxyUrl;
        }

        async function extractTextFromPDF(file) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const pageText = content.items.map(item => item.str).join(' ');
                if (pageText.trim()) text += pageText + '\n';
            }
            return text;
        }

        async function extractTextFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
            return result.value;
        }

        async function extractTextFromPPTX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(arrayBuffer);
            let text = '';
            const slideFiles = Object.keys(zip.files).filter(name => name.match(/ppt\/slides\/slide\d+\.xml/)).sort();
            for (const slideName of slideFiles) {
                const xmlStr = await zip.files[slideName].async('string');
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlStr, 'text/xml');
                const textNodes = xmlDoc.getElementsByTagName('a:t');
                for (let i = 0; i < textNodes.length; i++) {
                    const t = textNodes[i].textContent;
                    if (t && t.trim()) text += t.trim() + ' ';
                }
                text += '\n';
            }
            return text;
        }

        function buildPrompt(text, numQuestions, language, existingQuestions) {
            const maxText = text.substring(0, 12000);
            let excludePrompt = '';
            if (existingQuestions && existingQuestions.length > 0) {
                const existing = existingQuestions.map(q => '- ' + q.question).join('\n');
                excludePrompt = '\n\nDo NOT repeat any of these existing questions:\n' + existing + '\n';
            }
            return `You are a medical education expert. Based ONLY on the following educational content, generate EXACTLY ${numQuestions} multiple-choice questions (MCQs).

ABSOLUTELY CRITICAL - QUESTION COUNT:
- You MUST generate EXACTLY ${numQuestions} questions. Not ${numQuestions - 1}, not ${numQuestions + 1}. EXACTLY ${numQuestions}.
- Count your questions carefully before responding. If you have fewer than ${numQuestions}, create more. If you have more, remove extras.
- This is the most important rule. The response MUST contain exactly ${numQuestions} question objects in the JSON array.

CRITICAL RULES:
- Use ONLY the information provided in the content below. Do NOT add external knowledge or information from outside this content.
- Every question, answer, and explanation must be directly based on what is written in the provided content.
- Do NOT use phrases like "According to the content", "Based on the passage", "As mentioned in the text", "According to the provided material" or any similar references to the source content in the questions. Write questions naturally as if they are standalone exam questions.
- Each question must have exactly 4 options (A, B, C, D)
- Only ONE correct answer per question
- Questions should test understanding of the provided material
- Include a brief explanation for the correct answer
- For each WRONG option, include a short explanation of why it is incorrect
- Questions should be in ${language}
- Make questions of varying difficulty (easy, medium, hard)
- Each question MUST be unique and cover a DIFFERENT topic or concept. Do NOT repeat or rephrase the same question.
- RANDOMIZE the position of the correct answer among A, B, C, D. Do NOT always place the correct answer in the same position.
- If the content seems short, create questions about fine details, definitions, comparisons, clinical applications, and mechanisms.

IMPORTANT: Respond ONLY with valid JSON. The response must be a JSON object with a "questions" array.

JSON FORMAT:
{"questions": [
  {
    "question": "What is...?",
    "options": ["option A", "option B", "option C", "option D"],
    "correctAnswer": 0,
    "explanation": "Because...",
    "wrongExplanations": {
      "1": "Why option B is wrong...",
      "2": "Why option C is wrong...",
      "3": "Why option D is wrong..."
    }
  }
]}

Where correctAnswer is the index (0=A, 1=B, 2=C, 3=D).
wrongExplanations keys are the indices of the wrong options (all options except correctAnswer).
${excludePrompt}
CONTENT:
${maxText}`;
        }

        function postProcessQuestions(questions) {
            const seen = new Set();
            const unique = [];
            for (const q of questions) {
                const key = q.question.trim().toLowerCase().substring(0, 100);
                if (seen.has(key)) continue;
                seen.add(key);
                const opts = q.options;
                const correctIdx = q.correctAnswer;
                const wrongExps = q.wrongExplanations || {};
                const indices = [0, 1, 2, 3];
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }
                const newOpts = indices.map(i => opts[i]);
                const newCorrect = indices.indexOf(correctIdx);
                const newWrong = {};
                for (let ni = 0; ni < indices.length; ni++) {
                    if (ni !== newCorrect) {
                        const oldKey = String(indices[ni]);
                        if (wrongExps[oldKey]) newWrong[String(ni)] = wrongExps[oldKey];
                    }
                }
                q.options = newOpts;
                q.correctAnswer = newCorrect;
                if (Object.keys(newWrong).length > 0) q.wrongExplanations = newWrong;
                unique.push(q);
            }
            return unique;
        }

        async function callOpenAI(text, numQuestions, language) {
            const apiKey = localStorage.getItem('medquiz_openai_key');
            if (!apiKey) {
                showAlert('Please set your OpenAI API key in AI Settings first!', 'warning');
                return { error: 'No OpenAI API key set. Click the üîë AI Settings button to add your key.' };
            }

            const proxyUrl = localStorage.getItem('medquiz_proxy_url') || '';
            const apiUrl = proxyUrl ? proxyUrl : '/api/generate-questions-proxy';

            let allQuestions = [];
            let remaining = numQuestions;
            let attempt = 0;
            const maxRetries = 4;

            while (remaining > 0 && attempt < maxRetries) {
                const batchSize = Math.min(15, remaining);
                attempt++;
                const prompt = buildPrompt(text, batchSize, language, allQuestions.length > 0 ? allQuestions : null);

                try {
                    const res = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + apiKey
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [
                                { role: 'system', content: 'You are a medical education expert. Generate MCQ questions and respond ONLY with a JSON object containing a "questions" array.' },
                                { role: 'user', content: prompt }
                            ],
                            response_format: { type: 'json_object' },
                            max_tokens: 16384
                        })
                    });

                    if (!res.ok) {
                        const errData = await res.json().catch(() => ({}));
                        const errMsg = errData.error?.message || `API error ${res.status}`;
                        if (attempt === 1) return { error: errMsg };
                        break;
                    }

                    const data = await res.json();
                    const responseText = data.choices?.[0]?.message?.content || '';

                    let parsed;
                    try { parsed = JSON.parse(responseText); } catch(e) { if (attempt === 1) return { error: 'Failed to parse AI response' }; break; }

                    let questionsList = null;
                    if (Array.isArray(parsed)) {
                        questionsList = parsed;
                    } else if (typeof parsed === 'object') {
                        for (const key of Object.keys(parsed)) {
                            if (Array.isArray(parsed[key]) && parsed[key].length > 0) {
                                questionsList = parsed[key];
                                break;
                            }
                        }
                    }

                    if (questionsList && questionsList.length > 0) {
                        const seen = new Set(allQuestions.map(q => q.question.trim().toLowerCase().substring(0, 100)));
                        for (const q of questionsList) {
                            if (q && q.question && q.options && Array.isArray(q.options) && q.options.length === 4) {
                                const key = q.question.trim().toLowerCase().substring(0, 100);
                                if (!seen.has(key) && remaining > 0) {
                                    seen.add(key);
                                    const vq = {
                                        question: q.question,
                                        options: q.options,
                                        correctAnswer: parseInt(q.correctAnswer ?? q.correct_answer ?? q.answer ?? 0),
                                        explanation: q.explanation || ''
                                    };
                                    if (q.wrongExplanations && typeof q.wrongExplanations === 'object') {
                                        vq.wrongExplanations = {};
                                        for (const [k, v] of Object.entries(q.wrongExplanations)) vq.wrongExplanations[String(k)] = String(v);
                                    }
                                    allQuestions.push(vq);
                                    remaining--;
                                }
                            }
                        }
                    } else {
                        if (attempt === 1) break;
                    }
                } catch (err) {
                    if (attempt === 1) return { error: 'Connection error: ' + err.message };
                    break;
                }
            }

            if (allQuestions.length > 0) {
                const final = postProcessQuestions(allQuestions.slice(0, numQuestions));
                return { questions: final };
            }
            return { error: 'Could not generate questions. Please check your API key and try again.' };
        }

        async function generateAiQuestions() {
            if (!aiSelectedFile) return showAlert('Please upload a file first', 'warning');

            const numQuestions = parseInt(document.getElementById('ai-num-questions').value) || 10;
            const language = document.getElementById('ai-language').value;

            document.getElementById('ai-generate-btn').style.display = 'none';
            document.getElementById('ai-loading').style.display = 'block';
            document.getElementById('ai-error').style.display = 'none';
            if (numQuestions > 15) {
                const batches = Math.ceil(numQuestions / 15);
                document.getElementById('ai-loading-text').textContent = `AI is generating ${numQuestions} questions in ${batches} batches...`;
                document.getElementById('ai-loading-sub').textContent = `This may take ${batches * 20}-${batches * 40} seconds. Please wait.`;
            } else {
                document.getElementById('ai-loading-text').textContent = 'AI is generating questions...';
                document.getElementById('ai-loading-sub').textContent = 'This may take 15-30 seconds';
            }

            try {
                const filename = aiSelectedFile.name.toLowerCase();
                let text = '';
                if (filename.endsWith('.pdf')) {
                    text = await extractTextFromPDF(aiSelectedFile);
                } else if (filename.endsWith('.docx')) {
                    text = await extractTextFromDOCX(aiSelectedFile);
                } else if (filename.endsWith('.pptx')) {
                    text = await extractTextFromPPTX(aiSelectedFile);
                } else {
                    document.getElementById('ai-loading').style.display = 'none';
                    document.getElementById('ai-generate-btn').style.display = 'block';
                    document.getElementById('ai-error').style.display = 'block';
                    document.getElementById('ai-error').textContent = 'Unsupported file type. Use PDF, Word (.docx), or PowerPoint (.pptx)';
                    return;
                }

                if (!text.trim()) {
                    document.getElementById('ai-loading').style.display = 'none';
                    document.getElementById('ai-generate-btn').style.display = 'block';
                    document.getElementById('ai-error').style.display = 'block';
                    document.getElementById('ai-error').textContent = 'Could not extract text from file. The file might be image-based or empty.';
                    return;
                }

                const data = await callOpenAI(text, numQuestions, language);

                document.getElementById('ai-loading').style.display = 'none';
                document.getElementById('ai-generate-btn').style.display = 'block';

                if (data.error) {
                    document.getElementById('ai-error').style.display = 'block';
                    let errMsg = data.error;
                    if (errMsg.includes('429') || errMsg.includes('quota')) {
                        errMsg = 'The free AI quota has been reached. Please wait 1-2 minutes and try again.';
                    }
                    document.getElementById('ai-error').textContent = errMsg;
                    return;
                }

                if (data.questions && data.questions.length > 0) {
                    aiGeneratedQuestions = data.questions;
                    showAiPreview();
                } else {
                    document.getElementById('ai-error').style.display = 'block';
                    document.getElementById('ai-error').textContent = 'AI could not generate questions from this file. Try a different file.';
                }
            } catch (err) {
                document.getElementById('ai-loading').style.display = 'none';
                document.getElementById('ai-generate-btn').style.display = 'block';
                document.getElementById('ai-error').style.display = 'block';
                document.getElementById('ai-error').textContent = 'Error: ' + err.message;
            }
        }

        function showAiPreview() {
            document.getElementById('ai-step-1').style.display = 'none';
            document.getElementById('ai-step-2').style.display = 'block';
            document.getElementById('ai-preview-count').textContent = aiGeneratedQuestions.length;

            const loc = currentPath.length > 0 ? currentPath[currentPath.length - 1].name : 'Home';
            document.getElementById('ai-quiz-loc').textContent = loc;

            if (currentPath.length >= 3 && !document.getElementById('ai-quiz-title').value.trim()) {
                document.getElementById('ai-quiz-title').value = getAutoPrefix();
            }

            let html = '';
            aiGeneratedQuestions.forEach((q, i) => {
                html += `<div style="background: #f8f9fa; border-radius: 12px; padding: 18px; margin-bottom: 12px; border-left: 4px solid #0077b6;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <strong style="color: #0077b6;">Q${i + 1}:</strong>
                        <button onclick="removeAiQuestion(${i})" style="background: none; border: none; cursor: pointer; color: #f44336; font-size: 1.1em;" title="Delete">üóëÔ∏è</button>
                    </div>
                    <p style="margin: 8px 0; color: #1a1a2e; font-size: 1em;">${q.question}</p>
                    <div style="margin-left: 10px;">
                        ${q.options.map((o, j) => `<div style="padding: 4px 0; ${j === q.correctAnswer ? 'color: #2e7d32; font-weight: bold;' : 'color: #333;'}">
                            ${String.fromCharCode(65 + j)}) ${o} ${j === q.correctAnswer ? '‚úÖ' : ''}
                            ${j !== q.correctAnswer && q.wrongExplanations && q.wrongExplanations[String(j)] ? `<div style="margin:4px 0 4px 20px;padding:5px 8px;background:#fef2f2;border-radius:5px;font-size:0.82em;color:#991b1b;border-left:3px solid #ef4444;">‚ùå ${q.wrongExplanations[String(j)]}</div>` : ''}
                        </div>`).join('')}
                    </div>
                    ${q.explanation ? `<div style="margin-top: 8px; padding: 8px 12px; background: #e3f2fd; border-radius: 8px; font-size: 0.9em; color: #333;">üí° ${q.explanation}</div>` : ''}
                </div>`;
            });
            document.getElementById('ai-preview-list').innerHTML = html;
        }

        function removeAiQuestion(index) {
            aiGeneratedQuestions.splice(index, 1);
            if (aiGeneratedQuestions.length === 0) {
                backToAiStep1();
            } else {
                showAiPreview();
            }
        }

        function regenerateAiQuestions() {
            document.getElementById('ai-step-1').style.display = 'block';
            document.getElementById('ai-step-2').style.display = 'none';
            generateAiQuestions();
        }

        function backToAiStep1() {
            document.getElementById('ai-step-1').style.display = 'block';
            document.getElementById('ai-step-2').style.display = 'none';
        }

        function saveAiQuiz() {
            const aiTitle = document.getElementById('ai-quiz-title').value.trim();
            const builderTitle = document.getElementById('quiz-title').value.trim();
            const title = aiTitle || builderTitle;
            if (!title) return showAlert('Enter quiz title (use the name builder above or type one)', 'warning');
            if (aiGeneratedQuestions.length === 0) return showAlert('No questions to save', 'warning');

            const folderId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;

            db.collection('quizzes').add({
                title: title,
                folderId: folderId,
                questionCount: aiGeneratedQuestions.length,
                createdAt: new Date(),
                tags: [],
                generatedByAI: true
            }).then(docRef => {
                let saved = 0;
                aiGeneratedQuestions.forEach((q, i) => {
                    const qData = {
                        question: q.question,
                        options: q.options,
                        correctAnswer: q.correctAnswer,
                        explanation: q.explanation || '',
                        order: i
                    };
                    if (q.wrongExplanations) qData.wrongExplanations = q.wrongExplanations;
                    db.collection('quizzes').doc(docRef.id).collection('questions').add(qData).then(() => {
                        saved++;
                        if (saved === aiGeneratedQuestions.length) {
                            closeAiModal();
                            clearAiFile();
                            aiGeneratedQuestions = [];
                            document.getElementById('ai-quiz-title').value = '';
                            loadFolderContent(folderId);
                            loadStats();
                            showAlert('Quiz saved successfully! (' + saved + ' questions)', 'success');
                        }
                    });
                });
            });
        }
    </script>

    <div id="custom-dialog-overlay" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <div class="custom-dialog-icon" id="custom-dialog-icon"></div>
            <div class="custom-dialog-title" id="custom-dialog-title"></div>
            <div class="custom-dialog-msg" id="custom-dialog-msg"></div>
            <div class="custom-dialog-buttons" id="custom-dialog-buttons"></div>
        </div>
    </div>

    <script>
        function showAlert(message, type) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('custom-dialog-overlay');
                const iconEl = document.getElementById('custom-dialog-icon');
                const titleEl = document.getElementById('custom-dialog-title');
                const msgEl = document.getElementById('custom-dialog-msg');
                const btnsEl = document.getElementById('custom-dialog-buttons');

                let icon = 'info';
                let title = 'Info';
                let btnClass = 'primary';

                if (type === 'success') { icon = '‚úÖ'; title = 'Done!'; btnClass = 'success'; }
                else if (type === 'error' || type === 'warning') { icon = '‚ö†Ô∏è'; title = 'Warning'; btnClass = 'danger'; }
                else { icon = '‚ÑπÔ∏è'; title = 'Notice'; btnClass = 'primary'; }

                iconEl.textContent = icon;
                titleEl.textContent = title;
                msgEl.textContent = message;
                btnsEl.innerHTML = `<button class="custom-dialog-btn ${btnClass}" onclick="closeDialog(true)">OK</button>`;
                overlay.classList.add('active');

                window._dialogResolve = resolve;
            });
        }

        function showConfirm(message, dangerText) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('custom-dialog-overlay');
                const iconEl = document.getElementById('custom-dialog-icon');
                const titleEl = document.getElementById('custom-dialog-title');
                const msgEl = document.getElementById('custom-dialog-msg');
                const btnsEl = document.getElementById('custom-dialog-buttons');

                iconEl.textContent = 'üóëÔ∏è';
                titleEl.textContent = 'Are you sure?';
                msgEl.textContent = message;
                btnsEl.innerHTML = `
                    <button class="custom-dialog-btn cancel" onclick="closeDialog(false)">Cancel</button>
                    <button class="custom-dialog-btn danger" onclick="closeDialog(true)">${dangerText || 'Delete'}</button>
                `;
                overlay.classList.add('active');

                window._dialogResolve = resolve;
            });
        }

        function closeDialog(result) {
            document.getElementById('custom-dialog-overlay').classList.remove('active');
            if (window._dialogResolve) {
                window._dialogResolve(result);
                window._dialogResolve = null;
            }
        }
    </script>
</body>
</html>
