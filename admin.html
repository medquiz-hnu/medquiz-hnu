<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - MedQuiz HNU</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            color: #667eea;
            font-weight: bold;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 10px 20px;
            background: #eee;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .folder-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .folder-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .folder-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .edit-btn, .delete-btn {
            position: absolute;
            top: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
        }

        .edit-btn {
            right: 40px;
            color: #667eea;
        }

        .delete-btn {
            right: 10px;
            color: #f44336;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-secondary {
            background: #eee;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .paste-area {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-family: monospace;
            resize: vertical;
        }

        .preview-section {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .question-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-right: 4px solid #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #667eea;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .notification-form {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .file-list {
            display: grid;
            gap: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚öôÔ∏è Admin Panel - MedQuiz HNU</h1>
            <p>Manage Content, Students, and Analytics</p>
            <div style="margin-top: 15px;">
                <a href="index.html" class="btn btn-secondary">üè† Student View</a>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-students">0</div>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-quizzes">0</div>
                <div class="stat-label">Total Quizzes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-questions">0</div>
                <div class="stat-label">Total Questions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="active-today">0</div>
                <div class="stat-label">Active Today</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('content')">üìÅ Content</button>
            <button class="nav-tab" onclick="showTab('students')">üë• Students</button>
            <button class="nav-tab" onclick="showTab('notifications')">üîî Notifications</button>
            <button class="nav-tab" onclick="showTab('files')">üìé Files</button>
        </div>

        <!-- Content Tab -->
        <div id="content-tab" class="section">
            <div id="content-breadcrumb" class="breadcrumb" style="margin-bottom: 20px;">
                <a onclick="loadContentHome()">üè† Root</a>
            </div>
            
            <div class="add-buttons" style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="openModal('folder-modal')">üìÅ Add Folder</button>
                <button class="btn btn-success" onclick="openModal('quiz-modal')">üìù Add Quiz</button>
            </div>

            <div id="content-area"></div>
        </div>

        <!-- Students Tab -->
        <div id="students-tab" class="section hidden">
            <h2>Student Analytics</h2>
            <input type="text" class="search-box" id="student-search" placeholder="üîç Search students..." onkeyup="searchStudents()">
            <div id="students-list"></div>
        </div>

        <!-- Notifications Tab -->
        <div id="notifications-tab" class="section hidden">
            <h2>Send Notification</h2>
            <div class="notification-form">
                <div class="form-group">
                    <label>Message</label>
                    <input type="text" id="notif-message" placeholder="Enter notification message">
                </div>
                <div class="form-group">
                    <label>Duration</label>
                    <select id="notif-duration">
                        <option value="1">1 Day</option>
                        <option value="3">3 Days</option>
                        <option value="7">1 Week</option>
                        <option value="30">1 Month</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="sendNotification()">Send Notification</button>
            </div>
            
            <h3>Active Notifications</h3>
            <div id="active-notifications"></div>
        </div>

        <!-- Files Tab -->
        <div id="files-tab" class="section hidden">
            <h2>File Manager</h2>
            <div class="upload-area" onclick="document.getElementById('file-upload').click()">
                <div style="font-size: 3em;">üìé</div>
                <h3>Upload PDF, PPT, Word</h3>
                <input type="file" id="file-upload" class="file-input" accept=".pdf,.ppt,.pptx,.doc,.docx" onchange="handleFileUpload(event)">
            </div>
            <div id="files-list"></div>
        </div>
    </div>

    <!-- Folder Modal -->
    <div id="folder-modal" class="modal">
        <div class="modal-content" style="position: relative;">
            <button class="close-btn" onclick="closeModal('folder-modal')">&times;</button>
            <h2>Add New Folder</h2>
            <div class="form-group">
                <label>Folder Name</label>
                <input type="text" id="folder-name" placeholder="e.g., Year 1, Semester 1">
            </div>
            <button class="btn btn-primary" onclick="createFolder()">Create Folder</button>
        </div>
    </div>

    <!-- Edit Folder Modal -->
    <div id="edit-folder-modal" class="modal">
        <div class="modal-content" style="position: relative;">
            <button class="close-btn" onclick="closeModal('edit-folder-modal')">&times;</button>
            <h2>Edit Folder</h2>
            <div class="form-group">
                <label>New Name</label>
                <input type="text" id="edit-folder-name">
            </div>
            <button class="btn btn-primary" onclick="updateFolder()">Update</button>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="modal">
        <div class="modal-content" style="position: relative;">
            <button class="close-btn" onclick="closeModal('quiz-modal')">&times;</button>
            <h2>Add New Quiz</h2>
            
            <div class="form-group">
                <label>Quiz Title</label>
                <input type="text" id="quiz-title" placeholder="e.g., Quiz 1: Cell Biology">
            </div>

            <div class="nav-tabs" style="margin: 20px 0;">
                <button class="nav-tab active" onclick="showQuizTab('upload')">üìÅ Upload File</button>
                <button class="nav-tab" onclick="showQuizTab('paste')">üìù Paste Text</button>
            </div>

            <div id="quiz-upload-tab">
                <div class="upload-area" onclick="document.getElementById('quiz-file').click()">
                    <div style="font-size: 2em;">üìÑ</div>
                    <p>Click to upload .txt file</p>
                    <input type="file" id="quiz-file" class="file-input" accept=".txt" onchange="handleQuizFile(event)">
                </div>
            </div>

            <div id="quiz-paste-tab" class="hidden">
                <textarea class="paste-area" id="quiz-paste" placeholder="Paste questions here..."></textarea>
                <button class="btn btn-primary" onclick="parsePastedText()">Parse Questions</button>
            </div>

            <div id="quiz-preview" class="preview-section hidden">
                <h3>Preview (<span id="preview-count">0</span> questions)</h3>
                <div id="preview-list"></div>
                <button class="btn btn-success" onclick="saveQuiz()">Save Quiz</button>
            </div>
        </div>
    </div>

    <!-- Edit Quiz Modal -->
    <div id="edit-quiz-modal" class="modal">
        <div class="modal-content" style="position: relative; max-width: 1000px;">
            <button class="close-btn" onclick="closeModal('edit-quiz-modal')">&times;</button>
            <h2>Edit Quiz</h2>
            <div class="form-group">
                <label>Quiz Title</label>
                <input type="text" id="edit-quiz-title">
            </div>
            <div id="edit-questions-list"></div>
            <button class="btn btn-primary" onclick="updateQuiz()">Save Changes</button>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div id="student-modal" class="modal">
        <div class="modal-content" style="position: relative;">
            <button class="close-btn" onclick="closeModal('student-modal')">&times;</button>
            <h2>Student Details</h2>
            <div id="student-details"></div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB001YxSS9iQ6PArK1VHf0lIlpLyP1Rqew",
            authDomain: "medquiz-hnu.firebaseapp.com",
            projectId: "medquiz-hnu",
            storageBucket: "medquiz-hnu.firebasestorage.app",
            messagingSenderId: "862221476635",
            appId: "1:862221476635:web:369ca0e1f3b22b3eac29be",
            measurementId: "G-4T9XPB89N7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentPath = [];
        let currentQuestions = [];
        let editingQuizId = null;
        let editingFolderId = null;

        // Initialize
        window.onload = function() {
            loadStats();
            loadContentHome();
            loadStudents();
            loadNotifications();
            loadFiles();
        };

        // Stats
        function loadStats() {
            db.collection('users').get().then(snap => {
                document.getElementById('total-students').textContent = snap.size;
            });

            db.collection('quizzes').get().then(snap => {
                document.getElementById('total-quizzes').textContent = snap.size;
            });

            db.collectionGroup('questions').get().then(snap => {
                document.getElementById('total-questions').textContent = snap.size;
            });

            // Active today (users created today)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            db.collection('users').where('createdAt', '>=', today).get().then(snap => {
                document.getElementById('active-today').textContent = snap.size;
            });
        }

        // Tab Navigation
        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#content-tab, #students-tab, #notifications-tab, #files-tab').forEach(t => t.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.remove('hidden');
        }

        // Content Management
        function loadContentHome() {
            currentPath = [];
            updateContentBreadcrumb();
            
            db.collection('folders').where('parentId', '==', null).get().then(snapshot => {
                renderContent(snapshot, 'folders');
            });
        }

        function openContentFolder(folderId, folderName) {
            currentPath.push({ id: folderId, name: folderName, type: 'folder' });
            loadCurrentContent();
        }

        function loadCurrentContent() {
            updateContentBreadcrumb();
            const current = currentPath[currentPath.length - 1];
            
            db.collection('folders').where('parentId', '==', current.id).get().then(foldersSnap => {
                db.collection('quizzes').where('folderId', '==', current.id).get().then(quizzesSnap => {
                    let html = '<div class="folders-grid">';
                    
                    foldersSnap.forEach(doc => {
                        const folder = doc.data();
                        html += `
                            <div class="folder-card">
                                <button class="edit-btn" onclick="event.stopPropagation(); editFolder('${doc.id}', '${folder.name}')">‚úèÔ∏è</button>
                                <button class="delete-btn" onclick="event.stopPropagation(); deleteFolder('${doc.id}')">üóëÔ∏è</button>
                                <div class="folder-icon" onclick="openContentFolder('${doc.id}', '${folder.name}')">üìÅ</div>
                                <div class="folder-name" onclick="openContentFolder('${doc.id}', '${folder.name}')">${folder.name}</div>
                            </div>
                        `;
                    });
                    
                    quizzesSnap.forEach(doc => {
                        const quiz = doc.data();
                        html += `
                            <div class="folder-card">
                                <button class="edit-btn" onclick="event.stopPropagation(); editQuiz('${doc.id}')">‚úèÔ∏è</button>
                                <button class="delete-btn" onclick="event.stopPropagation(); deleteQuiz('${doc.id}')">üóëÔ∏è</button>
                                <div class="folder-icon" style="color: #667eea;">üìù</div>
                                <div class="folder-name">${quiz.title}</div>
                                <div style="color: #666; font-size: 0.9em;">${quiz.questionCount || 0} questions</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    document.getElementById('content-area').innerHTML = html;
                });
            });
        }

        function updateContentBreadcrumb() {
            let html = '<a onclick="loadContentHome()">üè† Root</a>';
            currentPath.forEach((item, index) => {
                html += ' > ';
                if (index === currentPath.length - 1) {
                    html += `<strong>${item.name}</strong>`;
                } else {
                    html += `<a onclick="navigateContentTo(${index})">${item.name}</a>`;
                }
            });
            document.getElementById('content-breadcrumb').innerHTML = html;
        }

        function navigateContentTo(index) {
            currentPath = currentPath.slice(0, index + 1);
            loadCurrentContent();
        }

        // Folder CRUD
        function createFolder() {
            const name = document.getElementById('folder-name').value.trim();
            if (!name) return alert('Please enter folder name');
            
            const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : null;
            
            db.collection('folders').add({
                name: name,
                parentId: parentId,
                createdAt: new Date()
            }).then(() => {
                closeModal('folder-modal');
                document.getElementById('folder-name').value = '';
                if (currentPath.length === 0) loadContentHome();
                else loadCurrentContent();
            });
        }

        function editFolder(id, name) {
            editingFolderId = id;
            document.getElementById('edit-folder-name').value = name;
            openModal('edit-folder-modal');
        }

        function updateFolder() {
            const name = document.getElementById('edit-folder-name').value.trim();
            if (!name) return;
            
            db.collection('folders').doc(editingFolderId).update({ name }).then(() => {
                closeModal('edit-folder-modal');
                if (currentPath.length === 0) loadContentHome();
                else loadCurrentContent();
            });
        }

        function deleteFolder(id) {
            if (!confirm('Delete this folder and all its contents?')) return;
            
            // Delete subfolders recursively
            db.collection('folders').where('parentId', '==', id).get().then(snap => {
                snap.forEach(doc => deleteFolder(doc.id));
            });
            
            // Delete quizzes
            db.collection('quizzes').where('folderId', '==', id).get().then(snap => {
                snap.forEach(doc => deleteQuiz(doc.id));
            });
            
            db.collection('folders').doc(id).delete();
            setTimeout(() => {
                if (currentPath.length === 0) loadContentHome();
                else loadCurrentContent();
            }, 500);
        }

        // Quiz CRUD
        function showQuizTab(tab) {
            document.querySelectorAll('#quiz-modal .nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('quiz-upload-tab').classList.add('hidden');
            document.getElementById('quiz-paste-tab').classList.add('hidden');
            document.getElementById(tab + '-tab').classList.remove('hidden');
        }

        function handleQuizFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                parseQuestions(e.target.result);
            };
            reader.readAsText(file);
        }

        function parsePastedText() {
            const text = document.getElementById('quiz-paste').value;
            if (!text.trim()) return alert('Please paste some text');
            parseQuestions(text);
        }

        function parseQuestions(text) {
            currentQuestions = [];
            const blocks = text.split(/\n\s*\n/);
            
            blocks.forEach(block => {
                const lines = block.trim().split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length < 6) return;
                
                const qMatch = lines[0].match(/^Question:\s*(.+)/i);
                if (!qMatch) return;
                
                const question = qMatch[1];
                const options = [];
                
                for (let i = 1; i <= 4; i++) {
                    const match = lines[i].match(/^[A-D]\)\s*(.+)/i);
                    if (match) options.push(match[1]);
                }
                
                if (options.length !== 4) return;
                
                const correctMatch = lines.find(l => l.match(/^Correct:\s*([A-D])/i));
                const correct = correctMatch ? correctMatch.match(/^Correct:\s*([A-D])/i)[1].toUpperCase() : 'A';
                
                const expMatch = lines.find(l => l.match(/^Explanation:\s*(.+)/i));
                const explanation = expMatch ? expMatch.match(/^Explanation:\s*(.+)/i)[1] : '';
                
                currentQuestions.push({
                    question, options, correctAnswer: correct.charCodeAt(0) - 65, explanation
                });
            });
            
            showQuizPreview();
        }

        function showQuizPreview() {
            document.getElementById('quiz-preview').classList.remove('hidden');
            document.getElementById('preview-count').textContent = currentQuestions.length;
            
            document.getElementById('preview-list').innerHTML = currentQuestions.map((q, i) => `
                <div class="question-preview">
                    <strong>Q${i+1}:</strong> ${q.question}<br>
                    ${q.options.map((opt, idx) => `
                        <span style="${idx === q.correctAnswer ? 'color: #4caf50; font-weight: bold;' : ''}">
                            ${String.fromCharCode(65+idx)}) ${opt}
                        </span>
                    `).join('<br>')}
                </div>
            `).join('');
        }

        function saveQuiz() {
            const title = document.getElementById('quiz-title').value.trim();
            if (!title) return alert('Please enter quiz title');
            if (currentQuestions.length === 0) return alert('No questions to save');
            
            const folderId = currentPath[currentPath.length - 1].id;
            
            db.collection('quizzes').add({
                title: title,
                folderId: folderId,
                questionCount: currentQuestions.length,
                createdAt: new Date()
            }).then(docRef => {
                let saved = 0;
                currentQuestions.forEach((q, index) => {
                    db.collection('quizzes').doc(docRef.id).collection('questions').add({
                        ...q,
                        order: index,
                        createdAt: new Date()
                    }).then(() => {
                        saved++;
                        if (saved === currentQuestions.length) {
                            closeModal('quiz-modal');
                            loadCurrentContent();
                        }
                    });
                });
            });
        }

        function editQuiz(id) {
            editingQuizId = id;
            db.collection('quizzes').doc(id).get().then(doc => {
                const quiz = doc.data();
                document.getElementById('edit-quiz-title').value = quiz.title;
                
                db.collection('quizzes').doc(id).collection('questions').orderBy('order').get().then(qSnap => {
                    let html = '';
                    qSnap.forEach((qDoc, index) => {
                        const q = qDoc.data();
                        html += `
                            <div class="question-preview" style="margin-bottom: 15px;">
                                <div class="form-group">
                                    <label>Question ${index + 1}</label>
                                    <input type="text" id="edit-q-${qDoc.id}" value="${q.question}" style="margin-bottom: 10px;">
                                    ${q.options.map((opt, i) => `
                                        <input type="text" id="edit-opt-${qDoc.id}-${i}" value="${opt}" style="margin: 5px 0;">
                                    `).join('')}
                                    <select id="edit-correct-${qDoc.id}">
                                        ${[0,1,2,3].map(i => `<option value="${i}" ${i === q.correctAnswer ? 'selected' : ''}>${String.fromCharCode(65+i)}</option>`).join('')}
                                    </select>
                                    <button class="btn btn-danger" onclick="deleteQuestion('${qDoc.id}')">Delete Question</button>
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('edit-questions-list').innerHTML = html;
                    openModal('edit-quiz-modal');
                });
            });
        }

        function updateQuiz() {
            const title = document.getElementById('edit-quiz-title').value;
            db.collection('quizzes').doc(editingQuizId).update({ title });
            
            // Update questions (simplified - in production, track changes)
            closeModal('edit-quiz-modal');
            loadCurrentContent();
        }

        function deleteQuestion(qid) {
            db.collection('quizzes').doc(editingQuizId).collection('questions').doc(qid).delete();
            event.target.closest('.question-preview').remove();
        }

        function deleteQuiz(id) {
            if (!confirm('Delete this quiz?')) return;
            
            db.collection('quizzes').doc(id).collection('questions').get().then(snap => {
                snap.forEach(doc => doc.ref.delete());
            });
            
            db.collection('quizzes').doc(id).delete();
            setTimeout(loadCurrentContent, 500);
        }

        // Students
        function loadStudents() {
            db.collection('users').get().then(snapshot => {
                renderStudents(snapshot.docs);
            });
        }

        function renderStudents(docs) {
            let html = '<table><tr><th>Username</th><th>Quizzes Taken</th><th>Average Score</th><th>Actions</th></tr>';
            
            docs.forEach(doc => {
                const user = doc.data();
                const history = user.history || [];
                const avg = history.length > 0 
                    ? Math.round(history.reduce((a, b) => a + b.percent, 0) / history.length) 
                    : 0;
                
                html += `
                    <tr>
                        <td>${user.username}</td>
                        <td>${history.length}</td>
                        <td>${avg}%</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewStudent('${doc.id}')">View</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</table>';
            document.getElementById('students-list').innerHTML = html;
        }

        function searchStudents() {
            const query = document.getElementById('student-search').value.toLowerCase();
            db.collection('users').get().then(snapshot => {
                const filtered = snapshot.docs.filter(d => d.data().username.toLowerCase().includes(query));
                renderStudents(filtered);
            });
        }

        function viewStudent(id) {
            db.collection('users').doc(id).get().then(doc => {
                const user = doc.data();
                const history = user.history || [];
                
                let html = `
                    <h3>${user.username}</h3>
                    <p>Joined: ${user.createdAt ? user.createdAt.toDate().toLocaleDateString() : 'Unknown'}</p>
                    <h4>Quiz History:</h4>
                `;
                
                if (history.length === 0) {
                    html += '<p>No quizzes taken yet.</p>';
                } else {
                    html += '<table><tr><th>Quiz</th><th>Score</th><th>Date</th></tr>';
                    history.slice().reverse().forEach(h => {
                        const date = h.date.toDate ? h.date.toDate().toLocaleDateString() : new Date(h.date).toLocaleDateString();
                        html += `<tr><td>${h.quizName}</td><td>${h.score}/${h.total} (${h.percent}%)</td><td>${date}</td></tr>`;
                    });
                    html += '</table>';
                }
                
                document.getElementById('student-details').innerHTML = html;
                openModal('student-modal');
            });
        }

        // Notifications
        function sendNotification() {
            const message = document.getElementById('notif-message').value.trim();
            const duration = parseInt(document.getElementById('notif-duration').value);
            
            if (!message) return alert('Please enter message');
            
            const expiry = new Date();
            expiry.setDate(expiry.getDate() + duration);
            
            db.collection('notifications').add({
                message: message,
                createdAt: new Date(),
                expiry: expiry,
                active: true
            }).then(() => {
                alert('Notification sent!');
                document.getElementById('notif-message').value = '';
                loadNotifications();
            });
        }

        function loadNotifications() {
            db.collection('notifications').where('active', '==', true).get().then(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const notif = doc.data();
                    const expiry = notif.expiry.toDate().toLocaleDateString();
                    html += `
                        <div style="padding: 15px; background: #e3f2fd; border-radius: 10px; margin-bottom: 10px;">
                            <strong>${notif.message}</strong><br>
                            <small>Expires: ${expiry}</small>
                            <button class="btn btn-danger" style="float: right;" onclick="deleteNotification('${doc.id}')">Delete</button>
                        </div>
                    `;
                });
                document.getElementById('active-notifications').innerHTML = html || '<p>No active notifications</p>';
            });
        }

        function deleteNotification(id) {
            db.collection('notifications').doc(id).update({ active: false });
            loadNotifications();
        }

        // Files
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // In production, upload to Firebase Storage
            // For now, we'll store metadata in Firestore
            db.collection('files').add({
                name: file.name,
                type: file.type,
                size: file.size,
                uploadedAt: new Date(),
                url: '#' // Placeholder - would be actual download URL
            }).then(() => {
                alert('File uploaded successfully!');
                loadFiles();
            });
        }

        function loadFiles() {
            db.collection('files').orderBy('uploadedAt', 'desc').get().then(snapshot => {
                let html = '<div class="file-list">';
                snapshot.forEach(doc => {
                    const file = doc.data();
                    html += `
                        <div class="file-item">
                            <div>
                                <strong>${file.name}</strong><br>
                                <small>${(file.size / 1024).toFixed(2)} KB ‚Ä¢ ${file.uploadedAt.toDate().toLocaleDateString()}</small>
                            </div>
                            <div>
                                <button class="btn btn-primary" onclick="viewFile('${doc.id}')">View</button>
                                <button class="btn btn-secondary" onclick="downloadFile('${doc.id}')">Download</button>
                                <button class="btn btn-danger" onclick="deleteFile('${doc.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('files-list').innerHTML = html || '<p>No files uploaded yet</p>';
            });
        }

        function viewFile(id) {
            alert('File viewer would open here');
        }

        function downloadFile(id) {
            alert('Download would start here');
        }

        function deleteFile(id) {
            if (!confirm('Delete this file?')) return;
            db.collection('files').doc(id).delete();
            loadFiles();
        }

        // Modal Helpers
        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>