<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedQuiz HNU - Student</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; transition: background 0.4s; color: #1a1a2e; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); transition: background 0.4s, color 0.4s; }
        .header h1 { color: #667eea; font-size: 2.5em; }
        .section { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); transition: background 0.4s, color 0.4s; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; transition: color 0.4s; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; transition: background 0.4s, color 0.4s, border-color 0.4s; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .btn { padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 1em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transition: transform 0.3s; margin: 5px; }
        .btn:hover { transform: scale(1.05); }
        .btn-secondary { background: #eee; color: #333; }
        .folders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .folder-card { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; animation: fadeInUp 0.4s ease; }
        .folder-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .quiz-card { background: white; border-radius: 15px; padding: 20px; border-left: 5px solid #667eea; cursor: pointer; transition: all 0.3s; position: relative; animation: fadeInUp 0.4s ease; }
        .quiz-card:hover { box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .file-card { background: #e8f5e9; border-radius: 15px; padding: 20px; border-left: 5px solid #4caf50; cursor: pointer; transition: all 0.3s; position: relative; animation: fadeInUp 0.4s ease; }
        .file-card:hover { box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .folder-icon { font-size: 3em; margin-bottom: 10px; }
        .favorite-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5em; cursor: pointer; z-index: 10; transition: transform 0.2s; }
        .favorite-btn:hover { transform: scale(1.3); }
        .complete-btn { position: absolute; top: 10px; left: 10px; background: none; border: none; font-size: 1.3em; cursor: pointer; z-index: 10; transition: transform 0.2s; opacity: 0.7; }
        .complete-btn:hover { transform: scale(1.3); opacity: 1; }
        .complete-btn.done { opacity: 1; }
        .hidden { display: none !important; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; flex-wrap: wrap; transition: border-color 0.4s; }
        .nav-tab { padding: 10px 20px; background: none; border: none; border-radius: 20px; cursor: pointer; color: #444; transition: all 0.3s; }
        .nav-tab:hover { background: rgba(102,126,234,0.1); }
        .nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .breadcrumb { background: white; border-radius: 10px; padding: 15px 20px; margin-bottom: 20px; transition: background 0.4s; }
        .breadcrumb a { color: #667eea; text-decoration: none; cursor: pointer; }
        .question-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 20px; border-right: 5px solid #667eea; animation: fadeInUp 0.3s ease; transition: background 0.4s; }
        .option { background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; margin: 10px 0; cursor: pointer; transition: all 0.3s; }
        .option:hover { border-color: #667eea; background: #f0f4ff; transform: translateX(5px); }
        .option.selected { border-color: #667eea; background: #e8eaf6; }
        .option.correct { border-color: #4caf50; background: #e8f5e9; }
        .option.wrong { border-color: #f44336; background: #ffebee; }
        .timer { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); font-size: 1.2em; font-weight: bold; z-index: 1000; transition: background 0.4s, color 0.4s; }
        .result-container { text-align: center; padding: 50px; }
        .result-score { font-size: 4em; color: #667eea; font-weight: bold; }
        .mistake-review { background: #fff3e0; border-left: 5px solid #ff9800; padding: 15px; margin-bottom: 15px; border-radius: 10px; transition: background 0.4s; }
        .progress-bar-container { width: 100%; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 20px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s ease; }
        .question-number { display: inline-block; width: 30px; height: 30px; border-radius: 50%; background: #e0e0e0; text-align: center; line-height: 30px; margin: 5px; cursor: pointer; transition: all 0.3s; font-size: 0.85em; }
        .question-number:hover { transform: scale(1.15); }
        .question-number.answered { background: #90a4ae; color: white; }
        .question-number.correct { background: #4caf50; color: white; }
        .question-number.wrong { background: #f44336; color: white; }
        .question-number.current { box-shadow: 0 0 0 3px #667eea; }
        .question-number.flagged { background: #ff9800; color: white; animation: pulse 2s infinite; }
        .question-number.answered.flagged { background: #ff9800; color: white; }
        .question-number.correct.flagged { background: #4caf50; color: white; animation: none; }
        .question-number.wrong.flagged { background: #f44336; color: white; animation: none; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .question-nav { display: flex; flex-wrap: wrap; justify-content: center; margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 10px; transition: background 0.4s; }

        body.dark-mode { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        body.dark-mode .header, body.dark-mode .section, body.dark-mode .breadcrumb { background: #1e293b; color: #e2e8f0; }
        body.dark-mode .header h1 { color: #818cf8; }
        body.dark-mode .header p { color: #94a3b8; }
        body.dark-mode .form-group label { color: #cbd5e1; }
        body.dark-mode .form-group input { background: #334155; color: #e2e8f0; border-color: #475569; }
        body.dark-mode .nav-tabs { border-color: #334155; }
        body.dark-mode .nav-tab { color: #94a3b8; }
        body.dark-mode .nav-tab:hover { background: rgba(129,140,248,0.15); }
        body.dark-mode .btn-secondary { background: #334155; color: #e2e8f0; }
        body.dark-mode .folder-card { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: #e2e8f0; }
        body.dark-mode .quiz-card { background: #1e293b; color: #e2e8f0; border-left-color: #818cf8; }
        body.dark-mode .file-card { background: #1e293b; color: #e2e8f0; border-left-color: #4ade80; }
        body.dark-mode .question-card { background: #1e293b; color: #e2e8f0; border-right-color: #818cf8; }
        body.dark-mode .option { background: #334155; color: #e2e8f0; border-color: #475569; }
        body.dark-mode .option:hover { background: #3b4f6b; border-color: #818cf8; }
        body.dark-mode .option.selected { background: #2a2a4a; border-color: #818cf8; color: #e2e8f0; }
        body.dark-mode .option.correct { background: #1a3a2a; border-color: #4ade80; color: #d1fae5; }
        body.dark-mode .option.wrong { background: #3a1a1a; border-color: #f87171; color: #fecaca; }
        body.dark-mode .timer { background: #1e293b; color: #e2e8f0; }
        body.dark-mode .question-nav { background: #334155; }
        body.dark-mode .question-number { background: #475569; color: #cbd5e1; }
        body.dark-mode .question-number.answered { background: #607d8b; }
        body.dark-mode .question-number.correct { background: #2e7d32; }
        body.dark-mode .question-number.wrong { background: #c62828; }
        body.dark-mode .mistake-review { background: #332b1a; color: #e2e8f0; }
        body.dark-mode .breadcrumb a { color: #818cf8; }
        body.dark-mode .result-score { color: #818cf8; }

        body.dark-mode h3, body.dark-mode h4 { color: #e2e8f0 !important; }
        body.dark-mode p { color: #cbd5e1; }
        body.dark-mode .section div { color: inherit; }
        body.dark-mode #search-input { background: #334155 !important; color: #e2e8f0 !important; border-color: #475569 !important; }
        body.dark-mode #search-input::placeholder { color: #64748b; }
        body.dark-mode #search-results { background: #1e293b !important; border: 1px solid #334155; }
        body.dark-mode #search-results div { color: #e2e8f0; }
        body.dark-mode #search-results div:hover { background: #334155 !important; }
        body.dark-mode #search-clear-btn { background: #475569 !important; color: #cbd5e1 !important; }
        body.dark-mode #question-counter { background: #1e293b !important; color: #e2e8f0 !important; }
        body.dark-mode .result-container { color: #e2e8f0; }
        body.dark-mode .result-container p, body.dark-mode .result-container div { color: #cbd5e1; }

        body.dark-mode [style*="background: white"], body.dark-mode [style*="background:white"] { background: #1e293b !important; color: #e2e8f0 !important; }
        body.dark-mode [style*="background: #fff"], body.dark-mode [style*="background:#fff"] { background: #1e293b !important; color: #e2e8f0 !important; }
        body.dark-mode [style*="background: #f8f9fa"], body.dark-mode [style*="background:#f8f9fa"] { background: #1e293b !important; }
        body.dark-mode [style*="background: #f5f5f5"], body.dark-mode [style*="background:#f5f5f5"] { background: #334155 !important; }
        body.dark-mode [style*="background: #eee"], body.dark-mode [style*="background:#eee"] { background: #334155 !important; color: #e2e8f0 !important; }
        body.dark-mode [style*="background: #e8eaf6"], body.dark-mode [style*="background:#e8eaf6"] { background: #2d2b55 !important; color: #a5b4fc !important; }
        body.dark-mode [style*="background: #e8f5e9"], body.dark-mode [style*="background:#e8f5e9"] { background: #1a3a2a !important; color: #86efac !important; }
        body.dark-mode [style*="background: #fff3e0"], body.dark-mode [style*="background:#fff3e0"] { background: #332b1a !important; color: #e2e8f0 !important; }
        body.dark-mode [style*="background: #fff8e1"], body.dark-mode [style*="background:#fff8e1"] { background: #332b1a !important; color: #e2e8f0 !important; }
        body.dark-mode [style*="background: #ffebee"], body.dark-mode [style*="background:#ffebee"] { background: #3a1a1a !important; color: #fecaca !important; }

        body.dark-mode [style*="color: #333"], body.dark-mode [style*="color:#333"] { color: #e2e8f0 !important; }
        body.dark-mode [style*="color: #444"], body.dark-mode [style*="color:#444"] { color: #e2e8f0 !important; }
        body.dark-mode [style*="color: #555"], body.dark-mode [style*="color:#555"] { color: #cbd5e1 !important; }
        body.dark-mode [style*="color: #666"], body.dark-mode [style*="color:#666"] { color: #94a3b8 !important; }
        body.dark-mode [style*="color: #777"], body.dark-mode [style*="color:#777"] { color: #94a3b8 !important; }
        body.dark-mode [style*="color: #999"], body.dark-mode [style*="color:#999"] { color: #64748b !important; }
        body.dark-mode [style*="color: #667eea"], body.dark-mode [style*="color:#667eea"] { color: #818cf8 !important; }

        body.dark-mode [id*="-modal"] > div { background: #1e293b !important; color: #e2e8f0 !important; }
        body.dark-mode [id*="-modal"] h2 { color: #818cf8 !important; }
        body.dark-mode [id*="-modal"] p { color: #cbd5e1 !important; }
        body.dark-mode [id*="-modal"] input { background: #334155 !important; color: #e2e8f0 !important; border-color: #475569 !important; }
        body.dark-mode [id*="-modal"] label { color: #cbd5e1 !important; }

        body.dark-mode .progress-bar-container { background: #475569; }
        body.dark-mode [style*="background: #e0e0e0"], body.dark-mode [style*="background:#e0e0e0"] { background: #475569 !important; }
        body.dark-mode [style*="border-color: #e0e0e0"], body.dark-mode [style*="border-color:#e0e0e0"] { border-color: #475569 !important; }

        body.dark-mode #tag-filter { color: #e2e8f0; }
        body.dark-mode #tag-filter span { color: #94a3b8 !important; }
        body.dark-mode #tag-filter button { border-color: #475569 !important; }
        body.dark-mode #tag-filter button:not([style*="background: #667eea"]):not([style*="background:#667eea"]) { background: #334155 !important; color: #cbd5e1 !important; }

        body.dark-mode .folder-count { color: #64748b !important; }
        body.dark-mode .explanation { color: #cbd5e1 !important; }

        body.dark-mode [style*="background: #fff9c4"], body.dark-mode [style*="background:#fff9c4"] { background: #2a2a1a !important; color: #e2e8f0 !important; }
        body.dark-mode [style*="background: #e3f2fd"], body.dark-mode [style*="background:#e3f2fd"] { background: #1a2a3a !important; color: #e2e8f0 !important; }
        body.dark-mode [style*="background: #bbdefb"], body.dark-mode [style*="background:#bbdefb"] { background: #1a3050 !important; }
        body.dark-mode [style*="background: #c8e6c9"], body.dark-mode [style*="background:#c8e6c9"] { background: #1a3a2a !important; }
        body.dark-mode .result-container .mistake-review { background: #332b1a !important; color: #e2e8f0 !important; }
        body.dark-mode .result-container .mistake-review div { color: #e2e8f0 !important; }
        body.dark-mode select { background: #334155 !important; color: #e2e8f0 !important; border-color: #475569 !important; }

        /* Responsive - Mobile */
        @media (max-width: 480px) {
            body { padding: 8px; }
            .header { padding: 15px; border-radius: 15px; }
            .header h1 { font-size: 1.5em; }
            .section { padding: 15px; border-radius: 15px; }
            .btn { padding: 10px 18px; font-size: 0.9em; }
            .nav-tabs { gap: 5px; }
            .nav-tab { padding: 8px 12px; font-size: 0.85em; }
            .folders-grid { grid-template-columns: 1fr; gap: 12px; }
            .folder-card, .quiz-card, .file-card { padding: 15px; border-radius: 12px; }
            .folder-icon { font-size: 2em; margin-bottom: 5px; }
            .question-card { padding: 15px; }
            .option { padding: 12px; margin: 8px 0; }
            .result-score { font-size: 2.5em; }
            .result-container { padding: 20px; }
            .timer { top: 10px; right: 10px; padding: 10px 15px; font-size: 1em; }
            .breadcrumb { padding: 10px 15px; }
            .favorite-btn { font-size: 1.2em; }
            .complete-btn { font-size: 1.1em; }
            .question-nav { padding: 10px; }
            .question-number { width: 26px; height: 26px; line-height: 26px; font-size: 0.75em; margin: 3px; }
            .mistake-review { padding: 12px; }
            .progress-bar-container { margin: 10px 0; }
            .form-group input { padding: 10px; font-size: 0.95em; }
            #search-input { font-size: 0.95em !important; padding: 12px 15px 12px 40px !important; }
            #search-input + span { left: 12px !important; font-size: 1.1em !important; }
            #quick-stats { grid-template-columns: repeat(2, 1fr) !important; gap: 8px !important; }
            .modal-content, [id*="-modal"] > div { width: 95% !important; padding: 20px !important; border-radius: 15px !important; max-height: 85vh !important; }
        }

        /* Responsive - Tablet */
        @media (min-width: 481px) and (max-width: 1024px) {
            body { padding: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 2em; }
            .section { padding: 20px; }
            .folders-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
            .folder-card, .quiz-card, .file-card { padding: 18px; }
            .result-score { font-size: 3em; }
            .nav-tab { padding: 8px 16px; font-size: 0.9em; }
            .question-card { padding: 20px; }
            .modal-content, [id*="-modal"] > div { width: 85% !important; }
        }
.toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; align-items: center; }
.toast { padding: 16px 28px; border-radius: 12px; color: white; font-weight: 600; font-size: 1em; box-shadow: 0 8px 30px rgba(0,0,0,0.2); animation: toastIn 0.4s ease, toastOut 0.4s ease 2.6s forwards; max-width: 90vw; text-align: center; }
.toast.success { background: linear-gradient(135deg, #4caf50, #2e7d32); }
.toast.error { background: linear-gradient(135deg, #f44336, #c62828); }
.toast.warning { background: linear-gradient(135deg, #ff9800, #e65100); }
.toast.info { background: linear-gradient(135deg, #667eea, #764ba2); }
@keyframes toastIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }
.confirm-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease; }
.confirm-box { background: white; border-radius: 16px; padding: 30px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: scaleIn 0.25s ease; }
.confirm-box .confirm-icon { font-size: 3em; margin-bottom: 15px; }
.confirm-box .confirm-title { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; color: #333; }
.confirm-box .confirm-msg { color: #666; margin-bottom: 25px; font-size: 0.95em; line-height: 1.5; }
.confirm-box .confirm-btns { display: flex; gap: 12px; justify-content: center; }
.confirm-box .confirm-btns button { padding: 12px 28px; border: none; border-radius: 10px; font-weight: 600; font-size: 1em; cursor: pointer; transition: transform 0.15s, opacity 0.15s; }
.confirm-box .confirm-btns button:hover { transform: scale(1.03); }
.confirm-box .btn-cancel { background: #e0e0e0; color: #333; }
.confirm-box .btn-danger { background: linear-gradient(135deg, #f44336, #c62828); color: white; }
.confirm-box .btn-confirm { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
body.dark-mode .confirm-box { background: #1e293b; }
body.dark-mode .confirm-box .confirm-title { color: #e2e8f0; }
body.dark-mode .confirm-box .confirm-msg { color: #94a3b8; }
body.dark-mode .confirm-box .btn-cancel { background: #475569; color: #e2e8f0; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
body.theme-ramadan { background: linear-gradient(135deg, #1a472a 0%, #2d1b69 100%); }
body.theme-ramadan .header { background: linear-gradient(135deg, #1a472a 0%, #0d2818 100%); color: #f0e6d3; }
body.theme-ramadan .header h1 { color: #d4af37; }
body.theme-ramadan .header p { color: #c9b99a; }
body.theme-ramadan .section { background: linear-gradient(135deg, #1e3a2f 0%, #1a1a2e 100%); color: #f0e6d3; }
body.theme-ramadan .btn { background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%); color: #1a1a2e; }
body.theme-ramadan .folder-card { background: linear-gradient(135deg, #2d4a3e 0%, #1a3028 100%); color: #f0e6d3; }
body.theme-ramadan .quiz-card { background: linear-gradient(135deg, #2d4a3e 0%, #1a3028 100%); color: #f0e6d3; border-left-color: #d4af37; }
body.theme-ramadan .file-card { background: linear-gradient(135deg, #2d4a3e 0%, #1a3028 100%); color: #f0e6d3; border-left-color: #d4af37; }
body.theme-ramadan .form-group label { color: #c9b99a; }
body.theme-ramadan .form-group input { background: #1a3028; color: #f0e6d3; border-color: #d4af37; }
body.theme-ramadan .nav-tab { color: #c9b99a; }
body.theme-ramadan .nav-tab.active { background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%); color: #1a1a2e; }
body.theme-ramadan .breadcrumb { background: #1a3028; }
body.theme-ramadan .breadcrumb a { color: #d4af37; }
body.theme-ramadan .question-card { background: #1e3a2f; color: #f0e6d3; border-right-color: #d4af37; }
body.theme-ramadan .option { background: #2d4a3e; color: #f0e6d3; border-color: #3d5a4e; }
body.theme-ramadan .option:hover { border-color: #d4af37; background: #3d5a4e; }
body.theme-ramadan .timer { background: #1e3a2f; color: #d4af37; }
body.theme-ramadan .question-nav { background: #1a3028; }
body.theme-ramadan .question-number { background: #2d4a3e; color: #c9b99a; }
body.theme-ramadan .result-score { color: #d4af37; }
body.theme-ramadan .mistake-review { background: #2d3a1a; color: #f0e6d3; }
body.theme-ramadan .btn-secondary { background: #2d4a3e; color: #f0e6d3; }
body.theme-christmas { background: linear-gradient(135deg, #1b4332 0%, #8b0000 100%); }
body.theme-christmas .header { background: linear-gradient(135deg, #8b0000 0%, #5c0000 100%); color: #fff; }
body.theme-christmas .header h1 { color: #ffd700; }
body.theme-christmas .header p { color: #ffcccb; }
body.theme-christmas .section { background: linear-gradient(135deg, #2d5a3e 0%, #1b4332 100%); color: #fff; }
body.theme-christmas .btn { background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%); color: #fff; }
body.theme-christmas .folder-card { background: linear-gradient(135deg, #2d5a3e 0%, #1b4332 100%); color: #fff; }
body.theme-christmas .quiz-card { background: linear-gradient(135deg, #5c0000 0%, #3a0000 100%); color: #fff; border-left-color: #ffd700; }
body.theme-christmas .file-card { background: linear-gradient(135deg, #5c0000 0%, #3a0000 100%); color: #fff; border-left-color: #ffd700; }
body.theme-christmas .form-group label { color: #ffcccb; }
body.theme-christmas .form-group input { background: #1b4332; color: #fff; border-color: #ffd700; }
body.theme-christmas .nav-tab { color: #ffcccb; }
body.theme-christmas .nav-tab.active { background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%); color: #fff; }
body.theme-christmas .breadcrumb { background: #1b4332; }
body.theme-christmas .breadcrumb a { color: #ffd700; }
body.theme-christmas .question-card { background: #2d5a3e; color: #fff; border-right-color: #ffd700; }
body.theme-christmas .option { background: #1b4332; color: #fff; border-color: #2d5a3e; }
body.theme-christmas .option:hover { border-color: #ffd700; background: #2d5a3e; }
body.theme-christmas .timer { background: #5c0000; color: #ffd700; }
body.theme-christmas .question-nav { background: #1b4332; }
body.theme-christmas .question-number { background: #2d5a3e; color: #ffcccb; }
body.theme-christmas .result-score { color: #ffd700; }
body.theme-christmas .mistake-review { background: #3a2a00; color: #fff; }
body.theme-christmas .btn-secondary { background: #1b4332; color: #fff; }
body.theme-eid { background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%); }
body.theme-eid .header { background: linear-gradient(135deg, #283593 0%, #1a237e 100%); color: #fff; }
body.theme-eid .header h1 { color: #ffd54f; }
body.theme-eid .header p { color: #b3e5fc; }
body.theme-eid .section { background: linear-gradient(135deg, #283593 0%, #1a237e 100%); color: #fff; }
body.theme-eid .btn { background: linear-gradient(135deg, #ffd54f 0%, #ffb300 100%); color: #1a237e; }
body.theme-eid .folder-card { background: linear-gradient(135deg, #303f9f 0%, #283593 100%); color: #fff; }
body.theme-eid .quiz-card { background: linear-gradient(135deg, #4a148c 0%, #311b92 100%); color: #fff; border-left-color: #ffd54f; }
body.theme-eid .file-card { background: linear-gradient(135deg, #4a148c 0%, #311b92 100%); color: #fff; border-left-color: #ffd54f; }
body.theme-eid .form-group label { color: #b3e5fc; }
body.theme-eid .form-group input { background: #1a237e; color: #fff; border-color: #ffd54f; }
body.theme-eid .nav-tab { color: #b3e5fc; }
body.theme-eid .nav-tab.active { background: linear-gradient(135deg, #ffd54f 0%, #ffb300 100%); color: #1a237e; }
body.theme-eid .breadcrumb { background: #283593; }
body.theme-eid .breadcrumb a { color: #ffd54f; }
body.theme-eid .question-card { background: #283593; color: #fff; border-right-color: #ffd54f; }
body.theme-eid .option { background: #1a237e; color: #fff; border-color: #303f9f; }
body.theme-eid .option:hover { border-color: #ffd54f; background: #303f9f; }
body.theme-eid .timer { background: #283593; color: #ffd54f; }
body.theme-eid .question-nav { background: #283593; }
body.theme-eid .question-number { background: #303f9f; color: #b3e5fc; }
body.theme-eid .result-score { color: #ffd54f; }
body.theme-eid .mistake-review { background: #4a3800; color: #fff; }
body.theme-eid .btn-secondary { background: #303f9f; color: #fff; }

/* Ramadan Lanterns Decoration */
.ramadan-lanterns { display: none; position: fixed; top: 0; left: 0; width: 100%; z-index: 900; pointer-events: none; height: 120px; overflow: hidden; }
@media (max-width: 480px) {
    .ramadan-lanterns { height: 80px; }
    .lantern-body { width: 20px; height: 30px; }
    .lantern-body::before { width: 10px; height: 6px; }
    .lantern-body::after { width: 3px; height: 6px; }
    .christmas-snowman { font-size: 2.5em; bottom: 10px; right: 10px; }
    .eid-sheep { font-size: 2em; }
}
body.theme-ramadan .ramadan-lanterns { display: block; }
.lantern { position: absolute; top: -5px; animation: swingLantern 3s ease-in-out infinite; transform-origin: top center; }
.lantern-rope { width: 2px; background: #d4af37; margin: 0 auto; }
.lantern-body { width: 30px; height: 45px; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; position: relative; margin: 0 auto; box-shadow: 0 0 15px rgba(212,175,55,0.5); }
.lantern-body::before { content: ''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%); width: 14px; height: 8px; background: #b8860b; border-radius: 3px 3px 0 0; }
.lantern-body::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 4px; height: 8px; background: #b8860b; border-radius: 0 0 2px 2px; }
.lantern-glow { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); width: 40px; height: 20px; background: radial-gradient(ellipse, rgba(255,200,50,0.3), transparent); border-radius: 50%; }
.lantern:nth-child(1) { left: 3%; }
.lantern:nth-child(1) .lantern-rope { height: 25px; }
.lantern:nth-child(1) .lantern-body { background: linear-gradient(180deg, #d4af37, #8b6914); }
.lantern:nth-child(2) { left: 15%; animation-delay: 0.5s; }
.lantern:nth-child(2) .lantern-rope { height: 35px; }
.lantern:nth-child(2) .lantern-body { background: linear-gradient(180deg, #c41e3a, #8b0000); }
.lantern:nth-child(3) { left: 28%; animation-delay: 1s; }
.lantern:nth-child(3) .lantern-rope { height: 20px; }
.lantern:nth-child(3) .lantern-body { background: linear-gradient(180deg, #1e8449, #0d5a2e); }
.lantern:nth-child(4) { left: 40%; animation-delay: 0.3s; }
.lantern:nth-child(4) .lantern-rope { height: 30px; }
.lantern:nth-child(4) .lantern-body { background: linear-gradient(180deg, #d4af37, #8b6914); }
.lantern:nth-child(5) { left: 52%; animation-delay: 0.8s; }
.lantern:nth-child(5) .lantern-rope { height: 40px; }
.lantern:nth-child(5) .lantern-body { background: linear-gradient(180deg, #c41e3a, #8b0000); }
.lantern:nth-child(6) { left: 65%; animation-delay: 1.2s; }
.lantern:nth-child(6) .lantern-rope { height: 22px; }
.lantern:nth-child(6) .lantern-body { background: linear-gradient(180deg, #1e8449, #0d5a2e); }
.lantern:nth-child(7) { left: 78%; animation-delay: 0.6s; }
.lantern:nth-child(7) .lantern-rope { height: 32px; }
.lantern:nth-child(7) .lantern-body { background: linear-gradient(180deg, #d4af37, #8b6914); }
.lantern:nth-child(8) { left: 90%; animation-delay: 0.9s; }
.lantern:nth-child(8) .lantern-rope { height: 28px; }
.lantern:nth-child(8) .lantern-body { background: linear-gradient(180deg, #c41e3a, #8b0000); }
@keyframes swingLantern {
    0%, 100% { transform: rotate(-5deg); }
    50% { transform: rotate(5deg); }
}

/* Christmas Snowfall & Theme */
.snowfall-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; overflow: hidden; }
body.theme-christmas .snowfall-container { display: block; }
.snowflake { position: absolute; top: -10px; color: white; font-size: 1em; opacity: 0.8; animation: snowFall linear infinite; }
@keyframes snowFall {
    0% { transform: translateY(-10px) rotate(0deg); opacity: 0.8; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0.3; }
}
.christmas-snowman { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 800; font-size: 4em; opacity: 0.7; pointer-events: none; animation: snowmanBob 3s ease-in-out infinite; }
body.theme-christmas .christmas-snowman { display: block; }
@keyframes snowmanBob {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

/* Eid Sheep Decoration */
.eid-sheep-container { display: none; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 800; pointer-events: none; height: 100px; }
body.theme-eid .eid-sheep-container { display: block; }
.eid-sheep { position: absolute; bottom: 10px; font-size: 3em; animation: sheepWalk 20s linear infinite; opacity: 0.6; }
.eid-sheep:nth-child(1) { animation-delay: 0s; bottom: 15px; font-size: 2.5em; }
.eid-sheep:nth-child(2) { animation-delay: 5s; bottom: 25px; font-size: 3em; }
.eid-sheep:nth-child(3) { animation-delay: 10s; bottom: 10px; font-size: 2em; }
@keyframes sheepWalk {
    0% { left: -80px; }
    100% { left: calc(100% + 80px); }
}
.eid-stars { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
body.theme-eid .eid-stars { display: block; }
.eid-star { position: absolute; color: #ffd54f; animation: twinkleStar 2s ease-in-out infinite; }
@keyframes twinkleStar {
    0%, 100% { opacity: 0.3; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.2); }
}

/* Hide dark mode button when theme is active */
body.theme-ramadan #dark-mode-btn,
body.theme-christmas #dark-mode-btn,
body.theme-eid #dark-mode-btn { display: none !important; }
    </style>
<base target="_blank">
</head>
<body>
    <!-- Ramadan Lanterns -->
    <div class="ramadan-lanterns" id="ramadan-lanterns">
        <div class="lantern"><div class="lantern-rope"></div><div class="lantern-body"></div><div class="lantern-glow"></div></div>
        <div class="lantern"><div class="lantern-rope"></div><div class="lantern-body"></div><div class="lantern-glow"></div></div>
        <div class="lantern"><div class="lantern-rope"></div><div class="lantern-body"></div><div class="lantern-glow"></div></div>
        <div class="lantern"><div class="lantern-rope"></div><div class="lantern-body"></div><div class="lantern-glow"></div></div>
        <div class="lantern"><div class="lantern-rope"></div><div class="lantern-body"></div><div class="lantern-glow"></div></div>
        <div class="lantern"><div class="lantern-rope"></div><div class="lantern-body"></div><div class="lantern-glow"></div></div>
        <div class="lantern"><div class="lantern-rope"></div><div class="lantern-body"></div><div class="lantern-glow"></div></div>
        <div class="lantern"><div class="lantern-rope"></div><div class="lantern-body"></div><div class="lantern-glow"></div></div>
    </div>

    <!-- Christmas Snowfall -->
    <div class="snowfall-container" id="snowfall-container"></div>
    <div class="christmas-snowman">‚õÑ</div>

    <!-- Eid Decorations -->
    <div class="eid-stars" id="eid-stars"></div>
    <div class="eid-sheep-container" id="eid-sheep-container">
        <div class="eid-sheep">üêë</div>
        <div class="eid-sheep">üêè</div>
        <div class="eid-sheep">üêë</div>
    </div>

    <div class="toast-container" id="toast-container"></div>
    <div class="container">
        <!-- Login -->
        <div id="login-screen" class="section">
            <div class="header"><h1>ü©∫ MedQuiz HNU</h1><p>Medical Quiz Platform</p></div>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('login', event)">Login</button>
                <button class="nav-tab" onclick="showTab('signup', event)">Sign Up</button>
            </div>
            <div id="login-form">
                <div class="form-group"><label>First Name</label><input type="text" id="login-firstname" placeholder="Enter first name"></div>
                <div class="form-group"><label>Last Name</label><input type="text" id="login-lastname" placeholder="Enter last name"></div>
                <div class="form-group"><label>PIN (6 digits)</label><input type="password" id="login-pin" placeholder="Enter PIN" maxlength="6" inputmode="numeric"></div>
                <button class="btn" onclick="login()">Login</button>
            </div>
            <div id="signup-form" class="hidden">
                <div class="form-group"><label>First Name</label><input type="text" id="signup-firstname" placeholder="Enter first name"></div>
                <div class="form-group"><label>Last Name</label><input type="text" id="signup-lastname" placeholder="Enter last name"></div>
                <div class="form-group"><label>PIN (6 digits)</label><input type="password" id="signup-pin" placeholder="Choose 6-digit PIN" maxlength="6" inputmode="numeric"></div>
                <div class="form-group"><label>Confirm PIN</label><input type="password" id="signup-pin-confirm" placeholder="Confirm PIN" maxlength="6" inputmode="numeric"></div>
                <button class="btn" onclick="signup()">Sign Up</button>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden">
            <div id="notifications-bar" style="display: none; background: #ff9800; color: white; padding: 15px; text-align: center; border-radius: 10px; margin-bottom: 15px; position: relative;">
                <span id="notification-text"></span>
                <button onclick="closeNotification()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: white; font-size: 1.2em; cursor: pointer;">‚úï</button>
            </div>
            <div class="header">
                <h1>ü©∫ MedQuiz HNU</h1>
                <p>Welcome, <span id="user-name"></span>!</p>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="toggleDarkMode()" id="dark-mode-btn" style="font-size: 1.1em; padding: 10px 20px;">üåô</button>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>

                </div>
            </div>

            <div id="quick-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 20px; animation: fadeInUp 0.5s ease;"></div>
            <div class="breadcrumb" id="breadcrumb"><a onclick="goHome()">üè† Home</a></div>

            <div style="position: relative; margin-bottom: 20px;">
                <div style="position: relative;">
                    <input type="text" id="search-input" placeholder="Search quizzes, files, folders..." oninput="handleSearch()" onfocus="document.getElementById('search-results').style.display='block'" style="width: 100%; padding: 15px 20px 15px 50px; border: 2px solid #e0e0e0; border-radius: 15px; font-size: 1.05em; background: white; box-shadow: 0 3px 15px rgba(0,0,0,0.08); outline: none; transition: all 0.3s;">
                    <span style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); font-size: 1.3em;">üîç</span>
                    <button id="search-clear-btn" onclick="clearSearch()" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: #eee; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 0.9em; cursor: pointer; display: none; align-items: center; justify-content: center; color: #666;">‚úï</button>
                </div>
                <div id="search-results" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); margin-top: 5px; max-height: 400px; overflow-y: auto; z-index: 500;"></div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showMainTab('browse', event)">üìö Browse</button>
                <button class="nav-tab" onclick="showMainTab('favorites', event)">‚≠ê Favorites</button>
                <button class="nav-tab" onclick="showMainTab('bookmarks', event)">üîñ Bookmarks</button>
                <button class="nav-tab" onclick="showMainTab('mistakes', event)">‚ùå Mistakes</button>
                <button class="nav-tab" onclick="showMainTab('history', event)">üìä History</button>
                <button class="nav-tab" onclick="showMainTab('tasks', event)">‚úÖ Tasks</button>
                <button class="nav-tab" onclick="showRandomQuizBuilder()" style="background: linear-gradient(135deg, #ff9800, #f44336); color: white; border-radius: 20px;">üé≤ Random Quiz</button>
            </div>
            <div id="browse-tab" class="section">
                <div id="browse-content"></div>
            </div>
            <div id="favorites-tab" class="section hidden"><h2>‚≠ê My Favorites</h2><div id="favorites-content"></div></div>
            <div id="bookmarks-tab" class="section hidden"><h2>üîñ My Bookmarks</h2><div id="bookmarks-content"></div></div>
            <div id="mistakes-tab" class="section hidden"><h2>‚ùå My Mistakes</h2><div id="mistakes-content"></div></div>
            <div id="history-tab" class="section hidden"><h2>üìä My History</h2><div id="history-content"></div></div>
            <div id="tasks-tab" class="section hidden"><h2>‚úÖ My Tasks</h2><div id="tasks-content"></div></div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <div class="timer" id="timer">‚è±Ô∏è 30:00</div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <span id="question-counter" style="background: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9em; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"></span>
                <span id="answered-counter" style="background: #4caf50; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9em;"></span>
            </div>
            <div class="progress-bar-container"><div class="progress-bar" id="progress-bar" style="width: 0%"></div></div>
            <div class="question-nav" id="question-nav"></div>
            <div class="section">
                <h2 id="quiz-title"></h2>
                <div id="questions-container"></div>
                <div style="text-align: center; margin-top: 30px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="previousQuestion()">Previous</button>
                    <button class="btn" onclick="nextQuestion()">Next</button>
                    <button class="btn" style="background: #ff9800;" onclick="showReviewBeforeSubmit()">Review & Finish</button>
                </div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden">
            <div class="section result-container">
                <h2>üéâ Quiz Completed!</h2>
                <div class="result-score" id="final-score"></div>
                <p id="result-message"></p>
                <div id="mistakes-review" class="hidden" style="margin: 30px 0; text-align: left;">
                    <h3>‚ùå Wrong Answers:</h3>
                    <div id="mistakes-list"></div>
                </div>
                <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                    <button class="btn" onclick="retryMistakes()" id="retry-mistakes-btn" style="background: #ff9800; display: none;">üîÑ Retry Mistakes Only</button>
                    <button class="btn btn-secondary" onclick="goHome()">Back to Home</button>
                </div>
            </div>
        </div>
    </div>

<div style="text-align: center; padding: 20px 10px; margin-top: 30px; color: rgba(255,255,255,0.7); font-size: 0.85em;">
    Designed by ŸÖÿ≠ŸÖÿØ ÿ≥ÿßŸÖÿ≠ ÿßÿ≠ŸÖÿØ ÿ≠ÿ≥ŸÜ
</div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB001YxSS9iQ6PArK1VHf0lIlpLyP1Rqew",
            authDomain: "medquiz-hnu.firebaseapp.com",
            projectId: "medquiz-hnu",
            storageBucket: "medquiz-hnu.firebasestorage.app",
            messagingSenderId: "862221476635",
            appId: "1:862221476635:web:369ca0e1f3b22b3eac29be"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 3000);
}

function showConfirm(title, message, onConfirm, icon = '‚ö†Ô∏è', confirmText = 'Delete', isDanger = true) {
    const overlay = document.createElement('div');
    overlay.className = 'confirm-overlay';
    overlay.innerHTML = `
        <div class="confirm-box">
            <div class="confirm-icon">${icon}</div>
            <div class="confirm-title">${title}</div>
            <div class="confirm-msg">${message}</div>
            <div class="confirm-btns">
                <button class="btn-cancel" id="confirm-cancel-btn">Cancel</button>
                <button class="${isDanger ? 'btn-danger' : 'btn-confirm'}" id="confirm-ok-btn">${confirmText}</button>
            </div>
        </div>`;
    document.body.appendChild(overlay);
    overlay.querySelector('#confirm-cancel-btn').onclick = () => overlay.remove();
    overlay.querySelector('#confirm-ok-btn').onclick = () => { overlay.remove(); onConfirm(); };
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
}

function loadTheme() {
    db.collection('settings').doc('theme').get().then(doc => {
        document.body.classList.remove('theme-ramadan', 'theme-christmas', 'theme-eid', 'dark-mode');
        const theme = (doc.exists && doc.data().active) ? doc.data().active : 'default';
        if (theme !== 'default') {
            document.body.classList.add('theme-' + theme);
        }
        initThemeDecorations(theme);
        if (theme === 'default') {
            const dmBtn = document.getElementById('dark-mode-btn');
            if (dmBtn) dmBtn.style.display = '';
            if (localStorage.getItem('medquiz_darkmode') === 'on') {
                document.body.classList.add('dark-mode');
                if (dmBtn) dmBtn.textContent = '‚òÄÔ∏è';
            }
        }
    }).catch(() => {});
}

function initThemeDecorations(theme) {
    const snowContainer = document.getElementById('snowfall-container');
    const eidStars = document.getElementById('eid-stars');
    snowContainer.innerHTML = '';
    eidStars.innerHTML = '';

    if (theme === 'christmas') {
        for (let i = 0; i < 50; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = '‚ùÑ';
            flake.style.left = Math.random() * 100 + '%';
            flake.style.fontSize = (Math.random() * 1.2 + 0.5) + 'em';
            flake.style.opacity = Math.random() * 0.6 + 0.2;
            flake.style.animationDuration = (Math.random() * 5 + 5) + 's';
            flake.style.animationDelay = (Math.random() * 10) + 's';
            snowContainer.appendChild(flake);
        }
    }

    if (theme === 'eid') {
        for (let i = 0; i < 20; i++) {
            const star = document.createElement('div');
            star.className = 'eid-star';
            star.textContent = '‚ú®';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 60 + '%';
            star.style.fontSize = (Math.random() * 1.2 + 0.6) + 'em';
            star.style.animationDelay = (Math.random() * 3) + 's';
            eidStars.appendChild(star);
        }
    }
}

        let currentUser = null;
        let currentPath = [];
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let correctCount = 0;
        let quizMistakes = [];
        let flaggedQuestions = [];
        let timerInterval;
        let timeRemaining = 1800;
        let currentQuizId = null;
        let currentQuizTitle = '';
        let quizStartTime = null;

        function getFileIcon(name) {
            const n = name.toLowerCase();
            if (n.includes('pdf')) return 'üìï';
            if (n.includes('word') || n.includes('doc')) return 'üìò';
            if (n.includes('video') || n.includes('mp4')) return 'üé¨';
            if (n.includes('ppt')) return 'üìä';
            if (n.includes('exam') || n.includes('quiz')) return 'üìù';
            return 'üìù';
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('medquiz_darkmode', isDark ? 'on' : 'off');
            document.getElementById('dark-mode-btn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            refreshCurrentView();
        }

        function refreshCurrentView() {
            if (!currentUser) return;
            const browseTab = document.getElementById('browse-tab');
            const favTab = document.getElementById('favorites-tab');
            const mistakesTab = document.getElementById('mistakes-tab');
            const historyTab = document.getElementById('history-tab');
            if (browseTab && !browseTab.classList.contains('hidden')) {
                if (currentPath.length === 0) loadHome();
                else loadCurrentFolder();
            }
            if (favTab && !favTab.classList.contains('hidden')) loadFavorites();
            if (mistakesTab && !mistakesTab.classList.contains('hidden')) loadMistakes();
            if (historyTab && !historyTab.classList.contains('hidden')) loadHistory();
            loadQuickStats();
        }

        (function() {
            if (localStorage.getItem('medquiz_darkmode') === 'on') {
                document.body.classList.add('dark-mode');
                setTimeout(() => {
                    const btn = document.getElementById('dark-mode-btn');
                    if (btn) btn.textContent = '‚òÄÔ∏è';
                }, 0);
            }
        })();

        function loadQuickStats() {
            const history = currentUser.history || [];
            const statsDiv = document.getElementById('quick-stats');
            if (history.length === 0) {
                statsDiv.innerHTML = '';
                return;
            }
            let totalCorrect = 0, totalQ = 0, best = 0;
            history.forEach(h => { totalCorrect += h.score || 0; totalQ += h.total || 0; if (h.percent > best) best = h.percent; });
            const avg = totalQ > 0 ? Math.round((totalCorrect / totalQ) * 100) : 0;
            statsDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 12px; padding: 15px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold;">${history.length}</div><div style="font-size: 0.75em; opacity: 0.9;">Quizzes</div></div>
                <div style="background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; border-radius: 12px; padding: 15px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold;">${avg}%</div><div style="font-size: 0.75em; opacity: 0.9;">Average</div></div>
                <div style="background: linear-gradient(135deg, #ff9800, #e65100); color: white; border-radius: 12px; padding: 15px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold;">${best}%</div><div style="font-size: 0.75em; opacity: 0.9;">Best</div></div>
            `;
        }

        let currentSortMode = 'custom';

        let searchTimeout = null;
        let searchCache = { folders: [], quizzes: [], files: [] };
        let searchLoaded = false;

        function loadSearchData() {
            if (searchLoaded) return Promise.resolve();
            return Promise.all([
                db.collection('folders').get(),
                db.collection('quizzes').get(),
                db.collection('files').get()
            ]).then(([foldersSnap, quizzesSnap, filesSnap]) => {
                searchCache.folders = [];
                searchCache.quizzes = [];
                searchCache.files = [];
                foldersSnap.forEach(doc => searchCache.folders.push({ id: doc.id, ...doc.data() }));
                quizzesSnap.forEach(doc => searchCache.quizzes.push({ id: doc.id, ...doc.data() }));
                filesSnap.forEach(doc => searchCache.files.push({ id: doc.id, ...doc.data() }));
                searchLoaded = true;
            });
        }

        function handleSearch() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            const clearBtn = document.getElementById('search-clear-btn');
            const resultsDiv = document.getElementById('search-results');

            if (query.length > 0) {
                clearBtn.style.display = 'flex';
            } else {
                clearBtn.style.display = 'none';
                resultsDiv.style.display = 'none';
                return;
            }

            if (query.length < 2) {
                resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Type at least 2 characters...</div>';
                resultsDiv.style.display = 'block';
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Searching...</div>';
                resultsDiv.style.display = 'block';
                loadSearchData().then(() => performSearch(query));
            }, 300);
        }

        function performSearch(query) {
            const resultsDiv = document.getElementById('search-results');
            let html = '';
            let totalResults = 0;

            const matchedFolders = searchCache.folders.filter(f => f.name && f.name.toLowerCase().includes(query));
            const matchedQuizzes = searchCache.quizzes.filter(q => q.title && q.title.toLowerCase().includes(query));
            const matchedFiles = searchCache.files.filter(f => f.name && f.name.toLowerCase().includes(query));

            const isDk = document.body.classList.contains('dark-mode');
            const srBg = isDk ? '#1e293b' : 'white';
            const srHover = isDk ? '#334155' : '#f0f4ff';
            const srBorder = isDk ? '#334155' : '#f5f5f5';
            const srHeadBorder = isDk ? '#334155' : '#f0f0f0';
            const srTitle = isDk ? '#e2e8f0' : '#333';
            const srSub = isDk ? '#64748b' : '#999';
            const srHeadColor = isDk ? '#818cf8' : '#667eea';

            if (matchedFolders.length > 0) {
                html += `<div style="padding: 10px 20px; font-size: 0.8em; color: ${srHeadColor}; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid ${srHeadBorder};">Folders</div>`;
                matchedFolders.forEach(f => {
                    totalResults++;
                    html += `<div onclick="searchGoToFolder('${f.id}', '${f.name.replace(/'/g, "\\'")}')" style="padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid ${srBorder}; transition: background 0.2s;" onmouseover="this.style.background='${srHover}'" onmouseout="this.style.background='transparent'">
                        <span style="font-size: 1.5em;">üìÅ</span>
                        <div>
                            <div style="font-weight: 600; color: ${srTitle};">${highlightMatch(f.name, query)}</div>
                            <div style="font-size: 0.8em; color: ${srSub};">Folder</div>
                        </div>
                    </div>`;
                });
            }

            if (matchedQuizzes.length > 0) {
                html += `<div style="padding: 10px 20px; font-size: 0.8em; color: ${srHeadColor}; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid ${srHeadBorder};">Quizzes</div>`;
                matchedQuizzes.forEach(q => {
                    totalResults++;
                    html += `<div onclick="clearSearch(); showExamModeSelection('${q.id}', '${q.title.replace(/'/g, "\\'")}')" style="padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid ${srBorder}; transition: background 0.2s;" onmouseover="this.style.background='${srHover}'" onmouseout="this.style.background='transparent'">
                        <span style="font-size: 1.5em;">üìù</span>
                        <div>
                            <div style="font-weight: 600; color: ${srTitle};">${highlightMatch(q.title, query)}</div>
                            <div style="font-size: 0.8em; color: ${srSub};">${q.questionCount || 0} questions</div>
                        </div>
                    </div>`;
                });
            }

            if (matchedFiles.length > 0) {
                html += `<div style="padding: 10px 20px; font-size: 0.8em; color: ${srHeadColor}; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid ${srHeadBorder};">Files</div>`;
                matchedFiles.forEach(f => {
                    totalResults++;
                    const icon = getFileIcon(f.name);
                    html += `<div onclick="clearSearch(); viewFile('${f.url}', '${f.name.replace(/'/g, "\\'")}')" style="padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid ${srBorder}; transition: background 0.2s;" onmouseover="this.style.background='${srHover}'" onmouseout="this.style.background='transparent'">
                        <span style="font-size: 1.5em;">${icon}</span>
                        <div>
                            <div style="font-weight: 600; color: ${srTitle};">${highlightMatch(f.name, query)}</div>
                            <div style="font-size: 0.8em; color: ${srSub};">${f.size ? (f.size/1024).toFixed(1) + ' KB' : 'Google Drive'}</div>
                        </div>
                    </div>`;
                });
            }

            if (totalResults === 0) {
                html = '<div style="padding: 30px; text-align: center; color: #666;"><div style="font-size: 2em; margin-bottom: 10px;">üòï</div>No results found</div>';
            } else {
                html = '<div style="padding: 10px 20px; font-size: 0.85em; color: #666; border-bottom: 1px solid #eee;">' + totalResults + ' result' + (totalResults > 1 ? 's' : '') + ' found</div>' + html;
            }

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function highlightMatch(text, query) {
            const idx = text.toLowerCase().indexOf(query);
            if (idx === -1) return text;
            return text.substring(0, idx) + '<span style="background: #fff176; padding: 1px 3px; border-radius: 3px;">' + text.substring(idx, idx + query.length) + '</span>' + text.substring(idx + query.length);
        }

        function searchGoToFolder(folderId, folderName) {
            clearSearch();
            currentPath = [{ id: folderId, name: folderName, type: 'folder' }];
            showMainTab('browse');
            loadCurrentFolder();
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('search-clear-btn').style.display = 'none';
            searchLoaded = false;
        }

        document.addEventListener('click', function(e) {
            const searchArea = document.getElementById('search-input');
            const resultsArea = document.getElementById('search-results');
            if (searchArea && resultsArea && !searchArea.contains(e.target) && !resultsArea.contains(e.target)) {
                resultsArea.style.display = 'none';
            }
        });

        async function hashPin(pin) {
            const salt = 'MedQuizHNU2024SecureSalt';
            const data = new TextEncoder().encode(pin + salt);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        window.onload = function() {
            const saved = localStorage.getItem('medquiz_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                showMainApp();
                setTimeout(() => {
                    if (restoreQuizState()) {
                        document.getElementById('main-app').classList.add('hidden');
                        document.getElementById('quiz-screen').classList.remove('hidden');
                        const modeLabel = examMode === 'timed' ? ` (Timed - ${examDuration} min)` : examMode === 'practice' ? ' (Practice)' : ' (Exam)';
                        document.getElementById('quiz-title').textContent = currentQuizTitle + modeLabel;
                        if (examMode === 'timed' && timeRemaining > 0) {
                            startTimer(timeRemaining);
                        } else if (examMode !== 'timed') {
                            document.getElementById('timer').style.display = 'none';
                        }
                        showQuestion(currentQuestionIndex);
                    }
                }, 100);
            }
        };

        function showTab(tab, e) {
            document.querySelectorAll('#login-screen .nav-tab').forEach(t => t.classList.remove('active'));
            if (e && e.target) { e.target.classList.add('active'); }
            if (tab === 'login') {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('signup-form').classList.add('hidden');
            } else {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
            }
        }

        async function signup() {
            const firstName = document.getElementById('signup-firstname').value.trim();
            const lastName = document.getElementById('signup-lastname').value.trim();
            const pin = document.getElementById('signup-pin').value;
            const confirm = document.getElementById('signup-pin-confirm').value;

            if (!firstName || !lastName) { showToast('Enter first and last name', 'warning'); return; }
            if (pin.length !== 6 || !/^\d{6}$/.test(pin)) { showToast('PIN must be exactly 6 digits', 'warning'); return; }
            if (pin !== confirm) { showToast('PINs do not match', 'error'); return; }

            const username = (firstName + ' ' + lastName).toLowerCase();
            const hashed = await hashPin(pin);
            db.collection('users').doc(username).get().then(doc => {
                if (doc.exists) { showToast('This name is already registered', 'error'); }
                else {
                    db.collection('users').doc(username).set({
                        username: username,
                        firstName: firstName,
                        lastName: lastName,
                        pinHash: hashed,
                        createdAt: new Date(),
                        favorites: [],
                        folderFavorites: [],
                        fileFavorites: [],
                        history: [],
                        completedItems: []
                    }).then(() => {
                        showToast('Account created successfully! Please login.', 'success');
                        showTab('login');
                    });
                }
            });
        }

        async function login() {
            const firstName = document.getElementById('login-firstname').value.trim();
            const lastName = document.getElementById('login-lastname').value.trim();
            const pin = document.getElementById('login-pin').value;

            if (!firstName || !lastName) { showToast('Enter first and last name', 'warning'); return; }
            if (pin.length !== 6 || !/^\d{6}$/.test(pin)) { showToast('Enter a valid 6-digit PIN', 'warning'); return; }

            const username = (firstName + ' ' + lastName).toLowerCase();
            const hashed = await hashPin(pin);
            db.collection('users').doc(username).get().then(doc => {
                if (doc.exists && doc.data().pinHash === hashed) {
                    currentUser = { id: username, ...doc.data() };
                    localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
                    db.collection('users').doc(username).update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showMainApp();
                } else { showToast('Invalid name or PIN', 'error'); }
            });
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('medquiz_user');
            location.reload();
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.username;
            loadUserNotifications();
            loadQuickStats();
            loadHome();
            // Update activity every 2 minutes
            setInterval(() => {
                if (currentUser) {
                    db.collection('users').doc(currentUser.id).update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }, 120000);
            loadTheme();
        }

        function showMainTab(tab, e) {
            document.querySelectorAll('#main-app .nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#browse-tab, #favorites-tab, #bookmarks-tab, #mistakes-tab, #history-tab, #tasks-tab').forEach(t => t.classList.add('hidden'));
            if (e && e.target) { e.target.classList.add('active'); }
            document.getElementById(tab + '-tab').classList.remove('hidden');
            if (tab === 'favorites') loadFavorites();
            if (tab === 'bookmarks') loadBookmarks();
            if (tab === 'mistakes') loadMistakes();
            if (tab === 'history') loadHistory();
            if (tab === 'tasks') loadTasks();
        }

        function loadHome() {
            currentPath = [];
            updateBreadcrumb();

            let allFolders = [];
            let allFiles = [];
            let allLinks = [];
            let recentQuizzes = [];
            let recentFiles = [];

            db.collection('folders').where('parentId', '==', null).get().then(folders => {
                folders.forEach(doc => allFolders.push({ id: doc.id, ...doc.data() }));
                return db.collection('files').where('folderId', '==', null).get();
            }).then(files => {
                files.forEach(doc => allFiles.push({ id: doc.id, ...doc.data() }));
                return db.collection('links').where('folderId', '==', null).get().catch(() => ({ forEach: () => {} }));
            }).then(links => {
                links.forEach(doc => allLinks.push({ id: doc.id, ...doc.data() }));
                return db.collection('quizzes').orderBy('createdAt', 'desc').limit(5).get().catch(() => db.collection('quizzes').limit(5).get());
            }).then(quizzes => {
                quizzes.forEach(doc => recentQuizzes.push({ id: doc.id, ...doc.data() }));
                return db.collection('files').orderBy('createdAt', 'desc').limit(5).get().catch(() => db.collection('files').limit(5).get());
            }).then(files => {
                files.forEach(doc => {
                    if (!recentFiles.find(f => f.id === doc.id)) recentFiles.push({ id: doc.id, ...doc.data() });
                });
                renderHome(allFolders, allFiles, recentQuizzes, recentFiles, allLinks);
            }).catch(err => {
                console.error('Error loading home:', err);
                renderHome(allFolders, allFiles, [], [], []);
            });
        }

        function getTimestamp(item) {
            if (item.createdAt && item.createdAt.toDate) return item.createdAt.toDate().getTime();
            if (item.createdAt) return new Date(item.createdAt).getTime();
            return 0;
        }

        function renderHome(folders, files, recentQuizzes, recentFiles, links) {
            links = links || [];
            if (currentSortMode === 'name') {
                folders.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                files.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            } else if (currentSortMode === 'date') {
                folders.sort((a, b) => getTimestamp(b) - getTimestamp(a));
                files.sort((a, b) => getTimestamp(b) - getTimestamp(a));
            } else {
                const orderSort = (a, b) => {
                    const oa = a.displayOrder !== undefined ? a.displayOrder : 9999;
                    const ob = b.displayOrder !== undefined ? b.displayOrder : 9999;
                    return oa - ob;
                };
                folders.sort(orderSort);
                files.sort(orderSort);
            }

            if (activeTagFilter) {
                recentQuizzes = recentQuizzes.filter(q => (q.tags || []).includes(activeTagFilter));
            }

            let html = '';

            if (recentQuizzes.length > 0 || recentFiles.length > 0) {
                html += `<div style="margin-bottom: 25px; animation: fadeInUp 0.4s ease;">`;
                html += `<h3 style="margin-bottom: 15px; color: #667eea;">üÜï Recently Added</h3>`;
                html += `<div style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px;">`;
                recentQuizzes.forEach(q => {
                    const isDark = document.body.classList.contains('dark-mode');
                    const qBg = isDark ? 'linear-gradient(135deg, #1e3a5f, #1e293b)' : 'linear-gradient(135deg, #e3f2fd, #bbdefb)';
                    const qColor = isDark ? '#e2e8f0' : '#333';
                    const qSubColor = isDark ? '#94a3b8' : '#666';
                    html += `<div onclick="showExamModeSelection('${q.id}', '${q.title.replace(/'/g, "\\'")}')" style="min-width: 180px; background: ${qBg}; border-radius: 12px; padding: 15px; cursor: pointer; text-align: center; flex-shrink: 0; transition: transform 0.2s; color: ${qColor};" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-size: 1.5em;">üìù</div>
                        <div style="font-weight: 600; font-size: 0.85em; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${q.title}</div>
                        <div style="font-size: 0.75em; color: ${qSubColor};">${q.questionCount || 0} Q</div>
                    </div>`;
                });
                recentFiles.forEach(f => {
                    const icon = getFileIcon(f.name);
                    const isDark = document.body.classList.contains('dark-mode');
                    const fBg = isDark ? 'linear-gradient(135deg, #1a3a2a, #1e293b)' : 'linear-gradient(135deg, #e8f5e9, #c8e6c9)';
                    const fColor = isDark ? '#e2e8f0' : '#333';
                    html += `<div onclick="viewFile('${f.url}', '${f.name.replace(/'/g, "\\'")}')" style="min-width: 180px; background: ${fBg}; border-radius: 12px; padding: 15px; cursor: pointer; text-align: center; flex-shrink: 0; transition: transform 0.2s; color: ${fColor};" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-size: 1.5em;">${icon}</div>
                        <div style="font-weight: 600; font-size: 0.85em; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                    </div>`;
                });
                html += `</div></div>`;
            }

            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #333;">üìÇ Content</h3>
                <select onchange="currentSortMode=this.value; loadHome();" style="padding: 8px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 0.9em; cursor: pointer;">
                    <option value="custom" ${currentSortMode==='custom'?'selected':''}>Sort: Custom</option>
                    <option value="name" ${currentSortMode==='name'?'selected':''}>Sort: A-Z</option>
                    <option value="date" ${currentSortMode==='date'?'selected':''}>Sort: Newest</option>
                </select>
            </div>`;

            html += '<div class="folders-grid">';
            let hasContent = false;

            folders.forEach(folder => {
                hasContent = true;
                const isFav = (currentUser.folderFavorites || []).includes(folder.id);
                const isDone = (currentUser.completedItems || []).includes(folder.id);
                html += `<div class="folder-card" onclick="openFolder('${folder.id}', '${folder.name.replace(/'/g, "\\'")}')">
                    <button class="complete-btn ${isDone?'done':''}" onclick="event.stopPropagation(); toggleComplete('${folder.id}','folder')">${isDone ? '‚úÖ' : '‚¨ú'}</button>
                    <button class="favorite-btn" onclick="event.stopPropagation(); toggleFolderFav('${folder.id}')">${isFav ? '‚≠ê' : '‚òÜ'}</button>
                    <div class="folder-icon">üìÅ</div>
                    <div class="folder-name">${folder.name}</div>
                    <div class="folder-count" id="fc-${folder.id}" style="font-size: 0.8em; color: #666; margin-top: 5px;"></div>
                </div>`;
                loadFolderCount(folder.id);
            });

            files.forEach(file => {
                hasContent = true;
                const icon = getFileIcon(file.name);
                const isFileFav = (currentUser.fileFavorites || []).includes(file.id);
                const isDone = (currentUser.completedItems || []).includes(file.id);
                html += `<div class="file-card" style="position: relative;">
                    <button class="complete-btn ${isDone?'done':''}" onclick="event.stopPropagation(); toggleComplete('${file.id}','file')">${isDone ? '‚úÖ' : '‚¨ú'}</button>
                    <button class="favorite-btn" onclick="event.stopPropagation(); toggleFileFav('${file.id}')">${isFileFav ? '‚≠ê' : '‚òÜ'}</button>
                    <div class="file-card-content" onclick="viewFile('${file.url}', '${file.name.replace(/'/g, "\\'")}')">
                        <div class="folder-icon">${icon}</div>
                        <h4>${file.name}</h4>
                        <p>${file.size ? (file.size/1024).toFixed(1) + ' KB' : 'Google Drive'}</p>
                    </div>
                </div>`;
            });

            links.forEach(link => {
                hasContent = true;
                html += `<div class="file-card" onclick="window.open('${link.url}', '_blank')" style="cursor: pointer;">
                    <div class="folder-icon">üîó</div>
                    <h4>${link.name}</h4>
                    <p>Link</p>
                </div>`;
            });

            if (!hasContent) {
                html += '<p style="grid-column: 1/-1; text-align: center; color: #666;">No content yet</p>';
            }
            html += '</div>';
            document.getElementById('browse-content').innerHTML = html;
            loadTagFilter();
        }

        function loadFolderCount(folderId) {
            let count = 0;
            Promise.all([
                db.collection('folders').where('parentId', '==', folderId).get(),
                db.collection('quizzes').where('folderId', '==', folderId).get(),
                db.collection('files').where('folderId', '==', folderId).get()
            ]).then(([f, q, fi]) => {
                count = f.size + q.size + fi.size;
                const el = document.getElementById('fc-' + folderId);
                if (el) el.textContent = count + ' item' + (count !== 1 ? 's' : '');
            });
        }

        function openFolder(id, name) {
            currentPath.push({ id: id, name: name, type: 'folder' });
            loadCurrentFolder();
        }

        function loadCurrentFolder() {
            updateBreadcrumb();
            const current = currentPath[currentPath.length - 1];
            let cFolders = [], cQuizzes = [], cFiles = [], cLinks = [];

            db.collection('folders').where('parentId', '==', current.id).get().then(folders => {
                folders.forEach(doc => cFolders.push({ id: doc.id, ...doc.data() }));
                return db.collection('quizzes').where('folderId', '==', current.id).get();
            }).then(quizzes => {
                quizzes.forEach(doc => cQuizzes.push({ id: doc.id, ...doc.data() }));
                return db.collection('files').where('folderId', '==', current.id).get();
            }).then(files => {
                files.forEach(doc => cFiles.push({ id: doc.id, ...doc.data() }));
                return db.collection('links').where('folderId', '==', current.id).get().catch(() => ({ forEach: () => {} }));
            }).then(links => {
                links.forEach(doc => cLinks.push({ id: doc.id, ...doc.data() }));

                const orderSort = (a, b) => {
                    const oa = a.displayOrder !== undefined ? a.displayOrder : 9999;
                    const ob = b.displayOrder !== undefined ? b.displayOrder : 9999;
                    return oa - ob;
                };
                if (currentSortMode === 'name') {
                    cFolders.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    cQuizzes.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                    cFiles.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                } else if (currentSortMode === 'date') {
                    cFolders.sort((a, b) => getTimestamp(b) - getTimestamp(a));
                    cQuizzes.sort((a, b) => getTimestamp(b) - getTimestamp(a));
                    cFiles.sort((a, b) => getTimestamp(b) - getTimestamp(a));
                } else {
                    cFolders.sort(orderSort);
                    cQuizzes.sort(orderSort);
                    cFiles.sort(orderSort);
                }

                if (activeTagFilter) {
                    cQuizzes = cQuizzes.filter(q => (q.tags || []).includes(activeTagFilter));
                }

                let html = '';
                html += `<div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
                    <select onchange="currentSortMode=this.value; loadCurrentFolder();" style="padding: 8px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 0.9em; cursor: pointer;">
                        <option value="custom" ${currentSortMode==='custom'?'selected':''}>Sort: Custom</option>
                        <option value="name" ${currentSortMode==='name'?'selected':''}>Sort: A-Z</option>
                        <option value="date" ${currentSortMode==='date'?'selected':''}>Sort: Newest</option>
                    </select>
                </div>`;
                html += '<div class="folders-grid">';
                let hasContent = false;

                cFolders.forEach(folder => {
                    hasContent = true;
                    const isFav = (currentUser.folderFavorites || []).includes(folder.id);
                    const isDone = (currentUser.completedItems || []).includes(folder.id);
                    html += `<div class="folder-card" onclick="openFolder('${folder.id}', '${folder.name.replace(/'/g, "\\'")}')">
                        <button class="complete-btn ${isDone?'done':''}" onclick="event.stopPropagation(); toggleComplete('${folder.id}','folder')">${isDone ? '‚úÖ' : '‚¨ú'}</button>
                        <button class="favorite-btn" onclick="event.stopPropagation(); toggleFolderFav('${folder.id}')">${isFav ? '‚≠ê' : '‚òÜ'}</button>
                        <div class="folder-icon">üìÅ</div>
                        <div class="folder-name">${folder.name}</div>
                        <div class="folder-count" id="fc-${folder.id}" style="font-size: 0.8em; color: #666; margin-top: 5px;"></div>
                    </div>`;
                    loadFolderCount(folder.id);
                });

                const isDkF = document.body.classList.contains('dark-mode');
                const tagBgF = isDkF ? '#2d2b55' : '#e8eaf6';
                const tagColorF = isDkF ? '#a5b4fc' : '#667eea';
                const fcColor = isDkF ? '#64748b' : '#999';
                const emptyColor = isDkF ? '#64748b' : '#999';

                cQuizzes.forEach(quiz => {
                    hasContent = true;
                    const isFav = (currentUser.favorites || []).includes(quiz.id);
                    const isDone = (currentUser.completedItems || []).includes(quiz.id);
                    const tagsHtml = (quiz.tags || []).map(t => `<span style="display:inline-block;background:${tagBgF};color:${tagColorF};padding:2px 8px;border-radius:10px;font-size:0.75em;margin:2px;">${t}</span>`).join('');
                    html += `<div class="quiz-card" onclick="showExamModeSelection('${quiz.id}', '${quiz.title.replace(/'/g, "\\'")}')">
                        <button class="complete-btn ${isDone?'done':''}" onclick="event.stopPropagation(); toggleComplete('${quiz.id}','quiz')">${isDone ? '‚úÖ' : '‚¨ú'}</button>
                        <button class="favorite-btn" onclick="event.stopPropagation(); toggleQuizFav('${quiz.id}')">${isFav ? '‚≠ê' : '‚òÜ'}</button>
                        <h3>üìù ${quiz.title}</h3>
                        <p>${quiz.questionCount || 0} questions</p>
                        ${tagsHtml ? '<div style="margin-top:5px;">'+tagsHtml+'</div>' : ''}
                    </div>`;
                });

                cFiles.forEach(file => {
                    hasContent = true;
                    const isFileFav = (currentUser.fileFavorites || []).includes(file.id);
                    const isDone = (currentUser.completedItems || []).includes(file.id);
                    const icon = getFileIcon(file.name);
                    html += `<div class="file-card">
                        <button class="complete-btn ${isDone?'done':''}" onclick="event.stopPropagation(); toggleComplete('${file.id}','file')">${isDone ? '‚úÖ' : '‚¨ú'}</button>
                        <button class="favorite-btn" onclick="event.stopPropagation(); toggleFileFav('${file.id}')">${isFileFav ? '‚≠ê' : '‚òÜ'}</button>
                        <div class="file-card-content" onclick="viewFile('${file.url}', '${file.name.replace(/'/g, "\\'")}')">
                            <div class="folder-icon">${icon}</div>
                            <h4>${file.name}</h4>
                            <p>${file.size ? (file.size/1024).toFixed(1) + ' KB' : 'Google Drive'}</p>
                        </div>
                    </div>`;
                });

                cLinks.forEach(link => {
                    hasContent = true;
                    html += `<div class="file-card" onclick="window.open('${link.url}', '_blank')" style="cursor: pointer;">
                        <div class="folder-icon">üîó</div>
                        <h4>${link.name}</h4>
                        <p>Link</p>
                    </div>`;
                });

                if (!hasContent) {
                    html += '<p style="grid-column: 1/-1; text-align: center; color: #666;">This folder is empty</p>';
                }
                html += '</div>';
                document.getElementById('browse-content').innerHTML = html;
                loadTagFilter();
            }).catch(err => {
                console.error('Error loading folder:', err);
            });
        }

        function updateBreadcrumb() {
            let html = '<a onclick="goHome()">üè† Home</a>';
            currentPath.forEach((item, i) => {
                html += ' > ';
                if (i === currentPath.length - 1) html += `<strong>${item.name}</strong>`;
                else html += `<a onclick="navigateTo(${i})">${item.name}</a>`;
            });
            document.getElementById('breadcrumb').innerHTML = html;
        }

        function navigateTo(index) {
            currentPath = currentPath.slice(0, index + 1);
            loadCurrentFolder();
        }

        function goHome() {
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            clearInterval(timerInterval);
            clearQuizState();
            document.getElementById('timer').style.display = 'block';
            loadHome();
            loadQuickStats();
        }

        function toggleFolderFav(folderId) {
            let favs = currentUser.folderFavorites || [];
            const idx = favs.indexOf(folderId);
            if (idx > -1) favs.splice(idx, 1);
            else favs.push(folderId);
            currentUser.folderFavorites = favs;
            localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
            db.collection('users').doc(currentUser.id).update({ folderFavorites: favs });
            if (currentPath.length === 0) loadHome();
            else loadCurrentFolder();
        }

        function toggleQuizFav(quizId) {
            let favs = currentUser.favorites || [];
            const idx = favs.indexOf(quizId);
            if (idx > -1) favs.splice(idx, 1);
            else favs.push(quizId);
            currentUser.favorites = favs;
            localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
            db.collection('users').doc(currentUser.id).update({ favorites: favs });
            loadCurrentFolder();
        }

        function toggleFileFav(fileId) {
            console.log('Toggling file fav:', fileId);
            let favs = currentUser.fileFavorites || [];
            console.log('Current favs:', favs);
            const idx = favs.indexOf(fileId);
            if (idx > -1) {
                favs.splice(idx, 1);
                console.log('Removed from favs');
            } else {
                favs.push(fileId);
                console.log('Added to favs');
            }
            currentUser.fileFavorites = favs;
            localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
            db.collection('users').doc(currentUser.id).update({ fileFavorites: favs })
                .then(() => console.log('Saved to Firestore'))
                .catch(err => console.error('Error saving:', err));
            if (currentPath.length === 0) loadHome();
            else loadCurrentFolder();
        }

        function toggleComplete(itemId, type) {
            let items = currentUser.completedItems || [];
            const idx = items.indexOf(itemId);
            if (idx > -1) items.splice(idx, 1);
            else items.push(itemId);
            currentUser.completedItems = items;
            localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
            db.collection('users').doc(currentUser.id).update({ completedItems: items });
            refreshCurrentView();
            findAndCheckParent(itemId, type);
        }

        function refreshCurrentView() {
            const tasksTab = document.getElementById('tasks-tab');
            if (tasksTab && !tasksTab.classList.contains('hidden')) {
                loadTasks();
            } else {
                if (currentPath.length === 0) loadHome();
                else loadCurrentFolder();
            }
        }

        function findAndCheckParent(itemId, type) {
            const collection = type === 'folder' ? 'folders' : (type === 'quiz' ? 'quizzes' : 'files');
            db.collection(collection).doc(itemId).get().then(doc => {
                if (!doc.exists) return;
                const data = doc.data();
                const parentId = data.parentId || data.folderId;
                if (!parentId) return;
                checkAutoCompleteFolder(parentId);
            });
        }

        function checkAutoCompleteFolder(parentId) {
            const items = currentUser.completedItems || [];
            Promise.all([
                db.collection('folders').where('parentId', '==', parentId).get(),
                db.collection('quizzes').where('folderId', '==', parentId).get(),
                db.collection('files').where('folderId', '==', parentId).get()
            ]).then(([fSnap, qSnap, fiSnap]) => {
                const childIds = [];
                fSnap.forEach(d => childIds.push(d.id));
                qSnap.forEach(d => childIds.push(d.id));
                fiSnap.forEach(d => childIds.push(d.id));
                if (childIds.length === 0) return;
                const allDone = childIds.every(id => items.includes(id));
                const parentDone = items.includes(parentId);
                let changed = false;
                if (allDone && !parentDone) {
                    items.push(parentId);
                    changed = true;
                } else if (!allDone && parentDone) {
                    items.splice(items.indexOf(parentId), 1);
                    changed = true;
                }
                if (changed) {
                    currentUser.completedItems = items;
                    localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
                    db.collection('users').doc(currentUser.id).update({ completedItems: items });
                    refreshCurrentView();
                }
            });
        }

        let taskFilter = 'all';
        let taskSearchQuery = '';
        let expandedTaskFolders = new Set();

        function toggleTaskFolder(folderId) {
            if (expandedTaskFolders.has(folderId)) {
                expandedTaskFolders.delete(folderId);
            } else {
                expandedTaskFolders.add(folderId);
            }
            loadTasks();
        }

        function loadTasks() {
            const dk = document.body.classList.contains('dark-mode');
            const cardBg = dk ? '#1e293b' : 'white';
            const cardColor = dk ? '#e2e8f0' : '#333';
            const subColor = dk ? '#94a3b8' : '#666';
            const borderColor = dk ? '#334155' : '#eee';
            const inputBg = dk ? '#334155' : '#f5f5f5';
            const inputColor = dk ? '#e2e8f0' : '#333';
            const filterBtnBg = dk ? '#334155' : '#eee';
            const filterBtnColor = dk ? '#e2e8f0' : '#333';
            const hoverBg = dk ? '#253348' : '#f8f9fa';
            const items = currentUser.completedItems || [];

            let allFolders = [], allQuizzes = [], allFiles = [];
            Promise.all([
                db.collection('folders').get(),
                db.collection('quizzes').get(),
                db.collection('files').get()
            ]).then(([fSnap, qSnap, fiSnap]) => {
                fSnap.forEach(d => allFolders.push({ id: d.id, ...d.data() }));
                qSnap.forEach(d => allQuizzes.push({ id: d.id, ...d.data() }));
                fiSnap.forEach(d => allFiles.push({ id: d.id, ...d.data() }));

                const totalAll = allFolders.length + allQuizzes.length + allFiles.length;
                const doneAll = [...allFolders, ...allQuizzes, ...allFiles].filter(x => items.includes(x.id)).length;
                const pct = totalAll > 0 ? Math.round((doneAll / totalAll) * 100) : 0;

                const sq = taskSearchQuery.toLowerCase().trim();

                function countFolderChildren(folderId) {
                    let total = 0, done = 0;
                    const cq = allQuizzes.filter(q => q.folderId === folderId);
                    const cf = allFiles.filter(f => f.folderId === folderId);
                    const csf = allFolders.filter(f => f.parentId === folderId);
                    total += cq.length + cf.length + csf.length;
                    done += cq.filter(q => items.includes(q.id)).length;
                    done += cf.filter(f => items.includes(f.id)).length;
                    done += csf.filter(f => items.includes(f.id)).length;
                    csf.forEach(sf => {
                        const sub = countFolderChildren(sf.id);
                        total += sub.total;
                        done += sub.done;
                    });
                    return { total, done };
                }

                function folderMatchesSearch(folderId, folderName) {
                    if (!sq) return true;
                    if (folderName.toLowerCase().includes(sq)) return true;
                    const cq = allQuizzes.filter(q => q.folderId === folderId);
                    const cf = allFiles.filter(f => f.folderId === folderId);
                    const csf = allFolders.filter(f => f.parentId === folderId);
                    if (cq.some(q => (q.title || q.name || '').toLowerCase().includes(sq))) return true;
                    if (cf.some(f => (f.name || '').toLowerCase().includes(sq))) return true;
                    for (const sf of csf) {
                        if (folderMatchesSearch(sf.id, sf.name)) return true;
                    }
                    return false;
                }

                function renderTreeItem(item, type, icon, depth) {
                    const name = type === 'quiz' ? (item.title || item.name) : item.name;
                    if (sq && !name.toLowerCase().includes(sq)) return '';
                    const done = items.includes(item.id);
                    const indent = depth * 24;
                    return `<div style="display:flex;align-items:center;gap:10px;padding:10px 12px 10px ${16 + indent}px;border-bottom:1px solid ${borderColor};${done ? 'opacity:0.65;' : ''}transition:background 0.15s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='transparent'">
                        <div style="width:24px;"></div>
                        <button onclick="toggleComplete('${item.id}','${type}')" style="background:none;border:none;font-size:1.15em;cursor:pointer;padding:0;line-height:1;">${done ? '‚úÖ' : '‚¨ú'}</button>
                        <span style="font-size:1em;">${icon}</span>
                        <span style="flex:1;color:${done ? subColor : cardColor};${done ? 'text-decoration:line-through;' : ''}font-size:0.9em;">${name}</span>
                    </div>`;
                }

                function renderTreeFolder(folder, depth) {
                    if (!folderMatchesSearch(folder.id, folder.name)) return '';

                    const isExpanded = expandedTaskFolders.has(folder.id) || !!sq;
                    const folderDone = items.includes(folder.id);
                    const { total: childTotal, done: childDone } = countFolderChildren(folder.id);
                    const childPct = childTotal > 0 ? Math.round((childDone / childTotal) * 100) : 0;
                    const indent = depth * 24;
                    const arrow = childTotal > 0 ? (isExpanded ? '‚ñº' : '‚ñ∂') : '';
                    const arrowColor = dk ? '#94a3b8' : '#999';

                    let h = '';
                    h += `<div style="border-bottom:1px solid ${borderColor};transition:background 0.15s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='transparent'">`;
                    h += `<div style="display:flex;align-items:center;gap:10px;padding:12px 12px 12px ${16 + indent}px;">`;

                    h += `<button onclick="toggleTaskFolder('${folder.id}')" style="background:none;border:none;font-size:0.75em;cursor:pointer;padding:0;width:24px;text-align:center;color:${arrowColor};line-height:1;">${arrow}</button>`;
                    h += `<button onclick="toggleComplete('${folder.id}','folder')" style="background:none;border:none;font-size:1.15em;cursor:pointer;padding:0;line-height:1;">${folderDone ? '‚úÖ' : '‚¨ú'}</button>`;
                    h += `<span style="font-size:1.1em;">üìÅ</span>`;
                    h += `<div style="flex:1;min-width:0;">
                        <div style="font-weight:600;color:${cardColor};font-size:0.95em;${folderDone ? 'text-decoration:line-through;opacity:0.65;' : ''}">${folder.name}</div>
                        <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
                            <div style="flex:1;max-width:120px;height:4px;background:${dk ? '#475569' : '#e0e0e0'};border-radius:2px;overflow:hidden;">
                                <div style="height:100%;width:${childPct}%;background:${childPct === 100 ? '#4caf50' : '#667eea'};border-radius:2px;transition:width 0.3s;"></div>
                            </div>
                            <span style="font-size:0.75em;color:${subColor};">${childDone}/${childTotal}</span>
                        </div>
                    </div>`;

                    if (childTotal > 0) {
                        if (childDone < childTotal) {
                            h += `<button onclick="event.stopPropagation(); markAllFolderDone('${folder.id}')" style="padding:4px 10px;border-radius:12px;border:1px solid #4caf50;background:${dk ? '#1a3a2a' : '#e8f5e9'};color:#4caf50;cursor:pointer;font-size:0.75em;white-space:nowrap;">Mark All ‚úì</button>`;
                        } else {
                            h += `<button onclick="event.stopPropagation(); unmarkAllFolderDone('${folder.id}')" style="padding:4px 10px;border-radius:12px;border:1px solid #ef5350;background:${dk ? '#3a1a1a' : '#ffebee'};color:#ef5350;cursor:pointer;font-size:0.75em;white-space:nowrap;">Unmark All ‚úó</button>`;
                        }
                    }
                    h += `</div></div>`;

                    if (isExpanded) {
                        const childFolders = allFolders.filter(f => f.parentId === folder.id);
                        const childQuizzes = allQuizzes.filter(q => q.folderId === folder.id);
                        const childFiles = allFiles.filter(f => f.folderId === folder.id);

                        childFolders.forEach(cf => { h += renderTreeFolder(cf, depth + 1); });

                        if (taskFilter === 'all' || taskFilter === 'quizzes') {
                            childQuizzes.forEach(q => { h += renderTreeItem(q, 'quiz', 'üìù', depth + 1); });
                        }
                        if (taskFilter === 'all' || taskFilter === 'files') {
                            childFiles.forEach(f => { h += renderTreeItem(f, 'file', getFileIcon(f.name), depth + 1); });
                        }
                    }

                    return h;
                }

                let html = '';

                html += `<div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 2em; font-weight: bold;">${pct}%</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">Overall Progress</div>
                    <div style="height: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; margin-top: 10px; overflow: hidden;">
                        <div style="height: 100%; width: ${pct}%; background: white; border-radius: 4px; transition: width 0.5s;"></div>
                    </div>
                    <div style="font-size: 0.85em; margin-top: 8px; opacity: 0.8;">${doneAll} of ${totalAll} items completed</div>
                </div>`;

                html += `<div style="margin-bottom:15px;">
                    <input type="text" id="task-search-input" placeholder="Search tasks..." value="${taskSearchQuery}" oninput="taskSearchQuery=this.value; loadTasks();" style="width:100%;padding:12px 15px;border:2px solid ${borderColor};border-radius:12px;font-size:1em;background:${inputBg};color:${inputColor};box-sizing:border-box;margin-bottom:10px;">
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        ${['all','folders','quizzes','files','done'].map(f => {
                            const active = taskFilter === f;
                            const label = f === 'all' ? 'All' : f === 'folders' ? 'üìÅ Folders' : f === 'quizzes' ? 'üìù Quizzes' : f === 'files' ? 'üìÑ Files' : '‚úÖ Done';
                            return `<button onclick="taskFilter='${f}'; loadTasks();" style="padding:6px 16px;border-radius:20px;border:2px solid ${active ? (f === 'done' ? '#4caf50' : '#667eea') : borderColor};background:${active ? (f === 'done' ? '#4caf50' : '#667eea') : filterBtnBg};color:${active ? 'white' : filterBtnColor};cursor:pointer;font-size:0.85em;transition:all 0.2s;">${label}</button>`;
                        }).join('')}
                    </div>
                </div>`;

                if (taskFilter === 'done') {
                    const completedFolders = allFolders.filter(f => items.includes(f.id));
                    const completedQuizzes = allQuizzes.filter(q => items.includes(q.id));
                    const completedFiles = allFiles.filter(f => items.includes(f.id));
                    let doneHtml = '';

                    function renderDoneItem(item, type, icon) {
                        const name = type === 'quiz' ? (item.title || item.name) : item.name;
                        if (sq && !name.toLowerCase().includes(sq)) return '';
                        return `<div style="display:flex;align-items:center;gap:10px;padding:12px 15px;border-bottom:1px solid ${borderColor};transition:background 0.15s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='transparent'">
                            <button onclick="toggleComplete('${item.id}','${type}')" style="background:none;border:none;font-size:1.15em;cursor:pointer;padding:0;line-height:1;">‚úÖ</button>
                            <span style="font-size:1em;">${icon}</span>
                            <span style="flex:1;color:${cardColor};font-size:0.9em;">${name}</span>
                            <span style="font-size:0.75em;color:${subColor};padding:2px 8px;background:${dk ? '#334155' : '#f0f0f0'};border-radius:10px;">${type === 'folder' ? 'Folder' : type === 'quiz' ? 'Quiz' : 'File'}</span>
                        </div>`;
                    }

                    completedFolders.forEach(f => { doneHtml += renderDoneItem(f, 'folder', 'üìÅ'); });
                    completedQuizzes.forEach(q => { doneHtml += renderDoneItem(q, 'quiz', 'üìù'); });
                    completedFiles.forEach(f => { doneHtml += renderDoneItem(f, 'file', getFileIcon(f.name)); });

                    html += `<div style="background:${cardBg};border-radius:15px;box-shadow:0 2px 12px rgba(0,0,0,0.06);overflow:hidden;">`;
                    if (doneHtml) {
                        html += doneHtml;
                    } else {
                        html += `<div style="text-align:center;padding:30px;color:${subColor};"><div style="font-size:2em;margin-bottom:10px;">‚úÖ</div><p>No completed items yet.</p></div>`;
                    }
                    html += `</div>`;
                } else if (sq) {
                    let flatResults = '';

                    function collectSearchResults(folderId, path) {
                        const folder = allFolders.find(f => f.id === folderId);
                        const folderPath = path ? path + ' > ' + (folder ? folder.name : '') : (folder ? folder.name : '');
                        const cq = allQuizzes.filter(q => q.folderId === folderId);
                        const cf = allFiles.filter(f => f.folderId === folderId);
                        const csf = allFolders.filter(f => f.parentId === folderId);

                        if (folder && folder.name.toLowerCase().includes(sq) && (taskFilter === 'all' || taskFilter === 'folders')) {
                            const done = items.includes(folder.id);
                            flatResults += `<div style="display:flex;align-items:center;gap:10px;padding:12px 15px;border-bottom:1px solid ${borderColor};${done ? 'opacity:0.65;' : ''}transition:background 0.15s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='transparent'">
                                <button onclick="toggleComplete('${folder.id}','folder')" style="background:none;border:none;font-size:1.15em;cursor:pointer;padding:0;line-height:1;">${done ? '‚úÖ' : '‚¨ú'}</button>
                                <span style="font-size:1em;">üìÅ</span>
                                <span style="flex:1;color:${done ? subColor : cardColor};${done ? 'text-decoration:line-through;' : ''}font-size:0.9em;">${folder.name}</span>
                                ${path ? `<span style="font-size:0.7em;color:${subColor};max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${path}</span>` : ''}
                            </div>`;
                        }

                        if (taskFilter === 'all' || taskFilter === 'quizzes') {
                            cq.forEach(q => {
                                const name = q.title || q.name;
                                if (name && name.toLowerCase().includes(sq)) {
                                    const done = items.includes(q.id);
                                    flatResults += `<div style="display:flex;align-items:center;gap:10px;padding:12px 15px;border-bottom:1px solid ${borderColor};${done ? 'opacity:0.65;' : ''}transition:background 0.15s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='transparent'">
                                        <button onclick="toggleComplete('${q.id}','quiz')" style="background:none;border:none;font-size:1.15em;cursor:pointer;padding:0;line-height:1;">${done ? '‚úÖ' : '‚¨ú'}</button>
                                        <span style="font-size:1em;">üìù</span>
                                        <span style="flex:1;color:${done ? subColor : cardColor};${done ? 'text-decoration:line-through;' : ''}font-size:0.9em;">${name}</span>
                                        ${folderPath ? `<span style="font-size:0.7em;color:${subColor};max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${folderPath}</span>` : ''}
                                    </div>`;
                                }
                            });
                        }

                        if (taskFilter === 'all' || taskFilter === 'files') {
                            cf.forEach(f => {
                                if (f.name && f.name.toLowerCase().includes(sq)) {
                                    const done = items.includes(f.id);
                                    flatResults += `<div style="display:flex;align-items:center;gap:10px;padding:12px 15px;border-bottom:1px solid ${borderColor};${done ? 'opacity:0.65;' : ''}transition:background 0.15s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='transparent'">
                                        <button onclick="toggleComplete('${f.id}','file')" style="background:none;border:none;font-size:1.15em;cursor:pointer;padding:0;line-height:1;">${done ? '‚úÖ' : '‚¨ú'}</button>
                                        <span style="font-size:1em;">${getFileIcon(f.name)}</span>
                                        <span style="flex:1;color:${done ? subColor : cardColor};${done ? 'text-decoration:line-through;' : ''}font-size:0.9em;">${f.name}</span>
                                        ${folderPath ? `<span style="font-size:0.7em;color:${subColor};max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${folderPath}</span>` : ''}
                                    </div>`;
                                }
                            });
                        }

                        csf.forEach(sf => collectSearchResults(sf.id, folderPath));
                    }

                    const rootQuizzes = allQuizzes.filter(q => !q.folderId);
                    const rootFiles = allFiles.filter(f => !f.folderId);

                    if (taskFilter === 'all' || taskFilter === 'quizzes') {
                        rootQuizzes.forEach(q => {
                            const name = q.title || q.name;
                            if (name && name.toLowerCase().includes(sq)) {
                                const done = items.includes(q.id);
                                flatResults += `<div style="display:flex;align-items:center;gap:10px;padding:12px 15px;border-bottom:1px solid ${borderColor};${done ? 'opacity:0.65;' : ''}transition:background 0.15s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='transparent'">
                                    <button onclick="toggleComplete('${q.id}','quiz')" style="background:none;border:none;font-size:1.15em;cursor:pointer;padding:0;line-height:1;">${done ? '‚úÖ' : '‚¨ú'}</button>
                                    <span style="font-size:1em;">üìù</span>
                                    <span style="flex:1;color:${done ? subColor : cardColor};${done ? 'text-decoration:line-through;' : ''}font-size:0.9em;">${name}</span>
                                </div>`;
                            }
                        });
                    }
                    if (taskFilter === 'all' || taskFilter === 'files') {
                        rootFiles.forEach(f => {
                            if (f.name && f.name.toLowerCase().includes(sq)) {
                                const done = items.includes(f.id);
                                flatResults += `<div style="display:flex;align-items:center;gap:10px;padding:12px 15px;border-bottom:1px solid ${borderColor};${done ? 'opacity:0.65;' : ''}transition:background 0.15s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='transparent'">
                                    <button onclick="toggleComplete('${f.id}','file')" style="background:none;border:none;font-size:1.15em;cursor:pointer;padding:0;line-height:1;">${done ? '‚úÖ' : '‚¨ú'}</button>
                                    <span style="font-size:1em;">${getFileIcon(f.name)}</span>
                                    <span style="flex:1;color:${done ? subColor : cardColor};${done ? 'text-decoration:line-through;' : ''}font-size:0.9em;">${f.name}</span>
                                </div>`;
                            }
                        });
                    }

                    const rootFoldersForSearch = allFolders.filter(f => !f.parentId);
                    rootFoldersForSearch.forEach(rf => collectSearchResults(rf.id, ''));

                    html += `<div style="background:${cardBg};border-radius:15px;box-shadow:0 2px 12px rgba(0,0,0,0.06);overflow:hidden;">`;
                    if (flatResults) {
                        html += flatResults;
                    } else {
                        html += `<div style="text-align:center;padding:30px;color:${subColor};"><div style="font-size:2em;margin-bottom:10px;">üîç</div><p>No results found.</p></div>`;
                    }
                    html += `</div>`;
                } else {
                    html += `<div style="background:${cardBg};border-radius:15px;box-shadow:0 2px 12px rgba(0,0,0,0.06);overflow:hidden;">`;

                    const rootFolders = allFolders.filter(f => !f.parentId);
                    const rootQuizzes = allQuizzes.filter(q => !q.folderId);
                    const rootFiles = allFiles.filter(f => !f.folderId);
                    let hasContent = false;

                    rootFolders.forEach(folder => {
                        const rendered = renderTreeFolder(folder, 0);
                        if (rendered) { html += rendered; hasContent = true; }
                    });

                    if (taskFilter === 'all' || taskFilter === 'quizzes') {
                        rootQuizzes.forEach(q => {
                            const rendered = renderTreeItem(q, 'quiz', 'üìù', 0);
                            if (rendered) { html += rendered; hasContent = true; }
                        });
                    }
                    if (taskFilter === 'all' || taskFilter === 'files') {
                        rootFiles.forEach(f => {
                            const rendered = renderTreeItem(f, 'file', getFileIcon(f.name), 0);
                            if (rendered) { html += rendered; hasContent = true; }
                        });
                    }

                    if (!hasContent) {
                        html += `<div style="text-align:center;padding:30px;color:${subColor};"><div style="font-size:2em;margin-bottom:10px;">üìã</div><p>No content yet.</p></div>`;
                    }

                    html += `</div>`;
                }

                document.getElementById('tasks-content').innerHTML = html;
                const searchInput = document.getElementById('task-search-input');
                if (searchInput) { searchInput.focus(); searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length); }
            });
        }

        function autoCompleteQuiz(quizId) {
            let items = currentUser.completedItems || [];
            if (!items.includes(quizId)) {
                items.push(quizId);
                currentUser.completedItems = items;
                localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
                db.collection('users').doc(currentUser.id).update({ completedItems: items });
                findAndCheckParent(quizId, 'quiz');
            }
        }

        function markAllFolderDone(folderId) {
            let items = currentUser.completedItems || [];
            markFolderRecursive(folderId, items).then(() => {
                currentUser.completedItems = items;
                localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
                db.collection('users').doc(currentUser.id).update({ completedItems: items });
                refreshCurrentView();
            });
        }

        function markFolderRecursive(folderId, items) {
            return Promise.all([
                db.collection('folders').where('parentId', '==', folderId).get(),
                db.collection('quizzes').where('folderId', '==', folderId).get(),
                db.collection('files').where('folderId', '==', folderId).get()
            ]).then(([fSnap, qSnap, fiSnap]) => {
                qSnap.forEach(d => { if (!items.includes(d.id)) items.push(d.id); });
                fiSnap.forEach(d => { if (!items.includes(d.id)) items.push(d.id); });
                const subFolderPromises = [];
                fSnap.forEach(d => {
                    if (!items.includes(d.id)) items.push(d.id);
                    subFolderPromises.push(markFolderRecursive(d.id, items));
                });
                if (!items.includes(folderId)) items.push(folderId);
                return Promise.all(subFolderPromises);
            });
        }

        function unmarkAllFolderDone(folderId) {
            let items = currentUser.completedItems || [];
            unmarkFolderRecursive(folderId, items).then(() => {
                currentUser.completedItems = items;
                localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
                db.collection('users').doc(currentUser.id).update({ completedItems: items });
                refreshCurrentView();
            });
        }

        function unmarkFolderRecursive(folderId, items) {
            return Promise.all([
                db.collection('folders').where('parentId', '==', folderId).get(),
                db.collection('quizzes').where('folderId', '==', folderId).get(),
                db.collection('files').where('folderId', '==', folderId).get()
            ]).then(([fSnap, qSnap, fiSnap]) => {
                qSnap.forEach(d => { const idx = items.indexOf(d.id); if (idx > -1) items.splice(idx, 1); });
                fiSnap.forEach(d => { const idx = items.indexOf(d.id); if (idx > -1) items.splice(idx, 1); });
                const subFolderPromises = [];
                fSnap.forEach(d => {
                    const idx = items.indexOf(d.id); if (idx > -1) items.splice(idx, 1);
                    subFolderPromises.push(unmarkFolderRecursive(d.id, items));
                });
                const fidx = items.indexOf(folderId); if (fidx > -1) items.splice(fidx, 1);
                return Promise.all(subFolderPromises);
            });
        }

        function loadFavorites() {
            const quizFavs = currentUser.favorites || [];
            const folderFavs = currentUser.folderFavorites || [];
            const fileFavs = currentUser.fileFavorites || [];

            if (quizFavs.length === 0 && folderFavs.length === 0 && fileFavs.length === 0) {
                document.getElementById('favorites-content').innerHTML = '<p>No favorites</p>';
                return;
            }

            let html = '<div class="folders-grid">';
            let count = 0;
            const total = quizFavs.length + folderFavs.length + fileFavs.length;

            folderFavs.forEach(fid => {
                db.collection('folders').doc(fid).get().then(doc => {
                    if (doc.exists) {
                        const f = doc.data();
                        html += `<div class="folder-card" style="background: #fff9c4;" onclick="openFavFolder('${fid}', '${f.name}')">
                            <button class="favorite-btn" onclick="event.stopPropagation(); toggleFolderFav('${fid}'); setTimeout(loadFavorites, 300);">‚≠ê</button>
                            <div class="folder-icon">üìÅ</div>
                            <div class="folder-name">${f.name}</div>
                        </div>`;
                    }
                    count++;
                    if (count === total) finishFavHtml(html);
                });
            });

            quizFavs.forEach(qid => {
                db.collection('quizzes').doc(qid).get().then(doc => {
                    if (doc.exists) {
                        const q = doc.data();
                        html += `<div class="quiz-card" onclick="showExamModeSelection('${qid}', '${q.title}')">
                            <button class="favorite-btn" onclick="event.stopPropagation(); toggleQuizFav('${qid}'); setTimeout(loadFavorites, 300);">‚≠ê</button>
                            <h3>üìù ${q.title}</h3>
                            <p>${q.questionCount || 0} questions</p>
                        </div>`;
                    }
                    count++;
                    if (count === total) finishFavHtml(html);
                });
            });

            fileFavs.forEach(fid => {
                db.collection('files').doc(fid).get().then(doc => {
                    if (doc.exists) {
                        const f = doc.data();
                        const icon = getFileIcon(f.name);
                        html += `<div class="file-card" style="background: #fff9c4; position: relative;">
                            <button class="favorite-btn" onclick="event.stopPropagation(); toggleFileFav('${fid}'); setTimeout(loadFavorites, 300);">‚≠ê</button>
                            <div class="file-card-content" onclick="viewFile('${f.url}', '${f.name}')" style="cursor: pointer; padding-top: 10px;">
                                <div class="folder-icon">${icon}</div>
                                <h4>${f.name}</h4>
                                <p>${f.size ? (f.size/1024).toFixed(1) + ' KB' : 'Google Drive'}</p>
                            </div>
                        </div>`;
                    }
                    count++;
                    if (count === total) finishFavHtml(html);
                });
            });
        }

        function finishFavHtml(html) {
            html += '</div>';
            document.getElementById('favorites-content').innerHTML = html;
        }

        function openFavFolder(id, name) {
            currentPath = [{ id: id, name: name, type: 'folder' }];
            showMainTab('browse');
            loadCurrentFolder();
        }

        function viewFile(url, name) {
            console.log('Opening file:', name, 'URL:', url);
            if (!url) {
                showToast('File URL not available', 'error');
                return;
            }
            window.open(url, '_blank');
        }

        // Exam mode selection
        let examMode = 'practice'; // 'practice', 'untimed' or 'timed'
        let examDuration = 30; // minutes

        function showExamModeSelection(quizId, title) {
            console.log('Showing exam mode selection for:', title);
            currentQuizId = quizId;
            currentQuizTitle = title;

            let modalHtml = `
                <div id="exam-mode-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; text-align: center; position: relative;">
                        <button onclick="document.getElementById('exam-mode-modal').remove()" style="position: absolute; top: 15px; right: 15px; background: #f44336; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">‚úï</button>
                        <h2 style="color: #667eea; margin-bottom: 20px;">üìù ${title}</h2>
                        <p style="margin-bottom: 30px; color: #444;">Choose mode:</p>

                        <button onclick="selectExamMode('practice', '${quizId}', '${title}')" style="display: block; width: 100%; padding: 20px; margin: 10px 0; border: 2px solid #4caf50; border-radius: 15px; background: white; cursor: pointer; font-size: 1.1em; transition: all 0.3s;">
                            <div style="font-size: 2em; margin-bottom: 10px;">üìñ</div>
                            <strong>Practice Mode</strong>
                            <div style="color: #444; font-size: 0.9em;">See answers immediately after each question</div>
                        </button>

                        <button onclick="selectExamMode('untimed', '${quizId}', '${title}')" style="display: block; width: 100%; padding: 20px; margin: 10px 0; border: 2px solid #667eea; border-radius: 15px; background: white; cursor: pointer; font-size: 1.1em; transition: all 0.3s;">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚è±Ô∏è</div>
                            <strong>Exam - No Time Limit</strong>
                            <div style="color: #444; font-size: 0.9em;">Answers shown after submission</div>
                        </button>

                        <button onclick="showTimeSelectionForQuiz('${quizId}', '${title}')" style="display: block; width: 100%; padding: 20px; margin: 10px 0; border: 2px solid #764ba2; border-radius: 15px; background: white; cursor: pointer; font-size: 1.1em; transition: all 0.3s;">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚è∞</div>
                            <strong>Exam - Timed</strong>
                            <div style="color: #444; font-size: 0.9em;">Set time limit, answers shown after submission</div>
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function showTimeSelectionForQuiz(quizId, title) {
            db.collection('quizzes').doc(quizId).get().then(doc => {
                const qCount = doc.exists ? (doc.data().questionCount || 0) : 0;
                showTimeSelection(quizId, title, qCount);
            }).catch(() => {
                showTimeSelection(quizId, title, 0);
            });
        }

        function showTimeSelection(quizId, title, questionCount) {
            document.getElementById('exam-mode-modal').remove();

            const suggestedMinutes = questionCount ? Math.ceil(questionCount * 70 / 60) : 30;
            const isDkT = document.body.classList.contains('dark-mode');
            const tBg = isDkT ? '#1e293b' : 'white';
            const tColor = isDkT ? '#e2e8f0' : '#333';
            const tSub = isDkT ? '#94a3b8' : '#666';
            const tInputBg = isDkT ? '#334155' : 'white';
            const tBorder = isDkT ? '#475569' : '#667eea';
            const tBtnBg = isDkT ? '#334155' : '#eee';
            const tSuggestBg = isDkT ? '#1a2a3a' : '#e3f2fd';

            let timeModal = `
                <div id="time-selection-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: ${tBg}; color: ${tColor}; border-radius: 20px; padding: 40px; max-width: 400px; width: 90%; text-align: center; position: relative;">
                        <button onclick="document.getElementById('time-selection-modal').remove()" style="position: absolute; top: 15px; right: 15px; background: #f44336; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">‚úï</button>
                        <h2 style="color: #818cf8; margin-bottom: 20px;">‚è∞ Set Time Limit</h2>

                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: ${tColor};">Duration (minutes):</label>
                            <input type="number" id="exam-duration" min="1" value="${suggestedMinutes}" style="width: 100%; padding: 15px; border: 2px solid ${tBorder}; border-radius: 10px; font-size: 1.4em; text-align: center; background: ${tInputBg}; color: ${tColor};">
                            ${questionCount ? `<div style="margin-top: 10px; padding: 10px; background: ${tSuggestBg}; border-radius: 8px; font-size: 0.85em; color: ${tSub};">
                                üí° Suggested: <strong style="color:#818cf8;">${suggestedMinutes} minutes</strong> (1 min 10 sec √ó ${questionCount} questions)
                            </div>` : ''}
                        </div>

                        <button onclick="selectExamMode('timed', '${quizId}', '${title}')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 25px; font-size: 1.1em; cursor: pointer; margin-top: 10px;">
                            Start Exam
                        </button>

                        <button onclick="document.getElementById('time-selection-modal').remove(); showExamModeSelection('${quizId}', '${title}')" style="width: 100%; padding: 15px; background: ${tBtnBg}; color: ${tColor}; border: none; border-radius: 25px; font-size: 1em; cursor: pointer; margin-top: 10px;">
                            Back
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', timeModal);
        }

        function selectExamMode(mode, quizId, title) {
            console.log('Selected exam mode:', mode);
            examMode = mode;
            if (mode === 'timed') {
                const durationInput = document.getElementById('exam-duration');
                if (durationInput) {
                    const val = parseInt(durationInput.value);
                    examDuration = val > 0 ? val : 30;
                }
            }

            // Remove modals
            const modal1 = document.getElementById('exam-mode-modal');
            const modal2 = document.getElementById('time-selection-modal');
            if (modal1) modal1.remove();
            if (modal2) modal2.remove();

            // Start the quiz
            startQuiz(quizId, title);
        }

        function startQuiz(quizId, title) {
            currentQuizId = quizId;
            currentQuizTitle = title;
            db.collection('quizzes').doc(quizId).collection('questions').get().then(snapshot => {
                currentQuestions = [];
                snapshot.forEach(doc => currentQuestions.push(doc.data()));
                if (currentQuestions.length === 0) { showToast('No questions found in this quiz', 'warning'); return; }
                currentQuestions.sort(() => Math.random() - 0.5);
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('quiz-screen').classList.remove('hidden');
                const modeLabel = examMode === 'timed' ? ` (Timed - ${examDuration} min)` : examMode === 'practice' ? ' (Practice)' : ' (Exam)';
                document.getElementById('quiz-title').textContent = title + modeLabel;
                currentQuestionIndex = 0;
                userAnswers = {};
                correctCount = 0;
                quizMistakes = [];
                flaggedQuestions = [];
                quizStartTime = Date.now();

                if (examMode === 'timed') {
                    startTimer(examDuration * 60);
                } else {
                    // Hide timer for untimed exam
                    document.getElementById('timer').style.display = 'none';
                }

                showQuestion(0);
                saveQuizState();
            });
        }

        function showQuestion(index) {
            const q = currentQuestions[index];
            const isFlagged = flaggedQuestions.includes(index);
            const dk = document.body.classList.contains('dark-mode');
            const flagBtnBg = isFlagged ? '#ff9800' : (dk ? '#475569' : '#e0e0e0');
            const isBookmarked = isQuestionBookmarked(q);
            const bookmarkBtnBg = isBookmarked ? '#667eea' : (dk ? '#475569' : '#e0e0e0');
            const bookmarkIcon = isBookmarked ? 'üîñ' : 'üè∑Ô∏è';
            let html = `<div class="question-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; flex: 1;">Q${index+1}: ${q.question}</h3>
                    <div style="display: flex; gap: 8px; flex-shrink: 0;">
                        <button onclick="toggleBookmark(${index})" style="background: ${bookmarkBtnBg}; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2em; transition: all 0.3s;" title="${isBookmarked ? 'Remove bookmark' : 'Bookmark this question'}">
                            ${bookmarkIcon}
                        </button>
                        <button onclick="toggleFlag(${index})" style="background: ${flagBtnBg}; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2em; transition: all 0.3s;" title="Flag for review">
                            üö©
                        </button>
                    </div>
                </div>`;
            q.options.forEach((opt, i) => {
                const answered = userAnswers[index] !== undefined;
                const isCorrect = i === q.correctAnswer;
                const isSelected = userAnswers[index] === i;
                let cls = 'option';
                if (answered && examMode === 'practice') {
                    if (isCorrect) cls += ' correct';
                    else if (isSelected) cls += ' wrong';
                } else if (answered && examMode !== 'practice') {
                    if (isSelected) cls += ' selected';
                }
                html += `<div class="${cls}" onclick="selectAnswer(${index}, ${i}, ${q.correctAnswer})">${String.fromCharCode(65+i)}) ${opt}`;
                if (answered && examMode === 'practice' && !isCorrect && q.wrongExplanations) {
                    const wrongExp = q.wrongExplanations[String(i)];
                    if (wrongExp) {
                        const wExpBg = dk ? '#2a1a1a' : '#fef2f2';
                        const wExpColor = dk ? '#fca5a5' : '#991b1b';
                        html += `<div style="margin-top:6px;padding:8px 10px;background:${wExpBg};border-radius:6px;font-size:0.85em;color:${wExpColor};border-left:3px solid #ef4444;">‚ùå ${wrongExp}</div>`;
                    }
                }
                html += `</div>`;
            });
            if (userAnswers[index] !== undefined && examMode === 'practice') {
                const expBg = dk ? '#1a2a3a' : '#e3f2fd';
                const expColor = dk ? '#e2e8f0' : 'inherit';
                html += `<div style="margin-top: 15px; padding: 15px; background: ${expBg}; border-radius: 10px; color: ${expColor}; border-left: 4px solid #818cf8;"><strong>üí° Explanation:</strong> ${q.explanation || 'None'}</div>`;
            }
            html += '</div>';
            document.getElementById('questions-container').innerHTML = html;
            const answeredProgress = currentQuestions.length > 0 ? (Object.keys(userAnswers).length / currentQuestions.length * 100) : 0;
            document.getElementById('progress-bar').style.width = answeredProgress + '%';

            const answeredCount = Object.keys(userAnswers).length;
            const remaining = currentQuestions.length - answeredCount;
            document.getElementById('question-counter').textContent = `Q ${index+1} / ${currentQuestions.length}`;
            document.getElementById('answered-counter').textContent = `${answeredCount} answered | ${remaining} remaining`;

            let nav = '';
            for (let i = 0; i < currentQuestions.length; i++) {
                nav += buildQuestionNavItem(i, i === index);
            }
            document.getElementById('question-nav').innerHTML = nav;
        }

        function buildQuestionNavItem(i, isCurrent) {
            let cls = 'question-number';
            const isAnswered = userAnswers[i] !== undefined;
            const isFlagged = flaggedQuestions.includes(i);

            if (examMode === 'practice') {
                if (isAnswered) {
                    const isCorrect = userAnswers[i] === currentQuestions[i].correctAnswer;
                    cls += isCorrect ? ' correct' : ' wrong';
                } else if (isFlagged) {
                    cls += ' flagged';
                }
            } else {
                if (isAnswered) {
                    cls += ' answered';
                } else if (isFlagged) {
                    cls += ' flagged';
                }
            }

            if (isCurrent) cls += ' current';
            const flagIcon = isFlagged ? 'üö© ' : '';
            return `<span class="${cls}" onclick="jumpTo(${i})" title="${flagIcon}Q${i+1}">${i+1}</span>`;
        }

        function jumpTo(index) { currentQuestionIndex = index; showQuestion(index); }

        function toggleFlag(index) {
            const idx = flaggedQuestions.indexOf(index);
            if (idx > -1) {
                flaggedQuestions.splice(idx, 1);
            } else {
                flaggedQuestions.push(index);
            }
            showQuestion(index);
            saveQuizState();
            updateQuestionNav();
        }

        function updateQuestionNav() {
            let nav = '';
            for (let i = 0; i < currentQuestions.length; i++) {
                nav += buildQuestionNavItem(i, false);
            }
            document.getElementById('question-nav').innerHTML = nav;
        }

function saveQuizState() {
    const state = {
        quizId: currentQuizId,
        quizTitle: currentQuizTitle,
        questions: currentQuestions,
        questionIndex: currentQuestionIndex,
        userAnswers: userAnswers,
        correctCount: correctCount,
        quizMistakes: quizMistakes,
        flaggedQuestions: flaggedQuestions,
        examMode: examMode,
        examDuration: examDuration,
        quizStartTime: quizStartTime,
        timeRemaining: timeRemaining
    };
    sessionStorage.setItem('medquiz_exam_state', JSON.stringify(state));
}

function restoreQuizState() {
    const saved = sessionStorage.getItem('medquiz_exam_state');
    if (!saved) return false;
    try {
        const state = JSON.parse(saved);
        if (!state.quizId || !state.questions || state.questions.length === 0) return false;
        currentQuizId = state.quizId;
        currentQuizTitle = state.quizTitle;
        currentQuestions = state.questions;
        currentQuestionIndex = state.questionIndex || 0;
        userAnswers = state.userAnswers || {};
        correctCount = state.correctCount || 0;
        quizMistakes = state.quizMistakes || [];
        flaggedQuestions = state.flaggedQuestions || [];
        examMode = state.examMode || 'practice';
        examDuration = state.examDuration || 30;
        quizStartTime = state.quizStartTime;
        timeRemaining = state.timeRemaining || 1800;
        return true;
    } catch (e) { return false; }
}

function clearQuizState() {
    sessionStorage.removeItem('medquiz_exam_state');
}

        function nextQuestion() { if (currentQuestionIndex < currentQuestions.length - 1) { currentQuestionIndex++; showQuestion(currentQuestionIndex); } }
        function previousQuestion() { if (currentQuestionIndex > 0) { currentQuestionIndex--; showQuestion(currentQuestionIndex); } }

        function selectAnswer(qIdx, selected, correct) {
            if (userAnswers[qIdx] !== undefined) return;
            userAnswers[qIdx] = selected;
            if (selected === correct) correctCount++;
            else {
                const wrongExp = currentQuestions[qIdx].wrongExplanations ? currentQuestions[qIdx].wrongExplanations[String(selected)] : null;
                quizMistakes.push({
                    question: currentQuestions[qIdx].question,
                    yourAnswer: currentQuestions[qIdx].options[selected],
                    correctAnswer: currentQuestions[qIdx].options[correct],
                    correctAnswerIndex: correct,
                    options: currentQuestions[qIdx].options,
                    explanation: currentQuestions[qIdx].explanation,
                    wrongExplanations: currentQuestions[qIdx].wrongExplanations || {},
                    wrongReason: wrongExp
                });
            }
            showQuestion(qIdx);
            saveQuizState();
        }

        function startTimer(durationSeconds) {
            timeRemaining = durationSeconds || 1800;
            document.getElementById('timer').style.display = 'block';
            updateTimer();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimer();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    showToast('‚è∞ Time is up!', 'warning');
                    finishQuiz();
                }
            }, 1000);
        }

        function updateTimer() {
            const m = Math.floor(timeRemaining / 60);
            const s = timeRemaining % 60;
            document.getElementById('timer').textContent = `‚è±Ô∏è ${m}:${s.toString().padStart(2,'0')}`;
        }

        function showReviewBeforeSubmit() {
            const total = currentQuestions.length;
            const answered = Object.keys(userAnswers).length;
            const unanswered = total - answered;
            const flagged = flaggedQuestions.length;
            const dk = document.body.classList.contains('dark-mode');
            const modalBg = dk ? '#1e293b' : 'white';
            const modalColor = dk ? '#e2e8f0' : '#333';
            const subColor = dk ? '#94a3b8' : '#666';
            const answeredBg = dk ? '#1a3a2a' : '#e8f5e9';
            const unansweredBg = unanswered > 0 ? (dk ? '#3a1a1a' : '#ffebee') : answeredBg;
            const flaggedBg = flagged > 0 ? (dk ? '#332b1a' : '#fff3e0') : (dk ? '#334155' : '#f5f5f5');
            const unansweredListBg = dk ? '#332b1a' : '#fff3e0';
            const flaggedListBg = dk ? '#332b1a' : '#fff8e1';
            const btnBg = dk ? '#334155' : '#eee';

            let html = `
                <div id="review-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: ${modalBg}; color: ${modalColor}; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; text-align: center; position: relative; max-height: 80vh; overflow-y: auto;">
                        <button onclick="document.getElementById('review-modal').remove()" style="position: absolute; top: 15px; right: 15px; background: #f44336; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; justify-content: center;">‚úï</button>
                        <h2 style="color: #818cf8; margin-bottom: 20px;">üìã Review Before Submit</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <div style="background: ${answeredBg}; padding: 15px; border-radius: 12px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #4caf50;">${answered}</div>
                                <div style="font-size: 0.8em; color: ${subColor};">Answered</div>
                            </div>
                            <div style="background: ${unansweredBg}; padding: 15px; border-radius: 12px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: ${unanswered > 0 ? '#f44336' : '#4caf50'};">${unanswered}</div>
                                <div style="font-size: 0.8em; color: ${subColor};">Unanswered</div>
                            </div>
                            <div style="background: ${flaggedBg}; padding: 15px; border-radius: 12px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: ${flagged > 0 ? '#ff9800' : (dk ? '#64748b' : '#999')};">${flagged}</div>
                                <div style="font-size: 0.8em; color: ${subColor};">Flagged</div>
                            </div>
                        </div>`;

            if (unanswered > 0) {
                html += `<div style="background: ${unansweredListBg}; padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: left;">
                    <strong style="color: #e65100;">Unanswered:</strong> `;
                for (let i = 0; i < total; i++) {
                    if (userAnswers[i] === undefined) {
                        html += `<span onclick="document.getElementById('review-modal').remove(); jumpTo(${i})" style="display: inline-block; background: #f44336; color: white; width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; margin: 3px; cursor: pointer; font-size: 0.85em;">${i+1}</span>`;
                    }
                }
                html += `</div>`;
            }

            if (flagged > 0) {
                html += `<div style="background: ${flaggedListBg}; padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: left;">
                    <strong style="color: #f57f17;">Flagged:</strong> `;
                flaggedQuestions.forEach(i => {
                    html += `<span onclick="document.getElementById('review-modal').remove(); jumpTo(${i})" style="display: inline-block; background: #ff9800; color: white; width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; margin: 3px; cursor: pointer; font-size: 0.85em;">${i+1}</span>`;
                });
                html += `</div>`;
            }

            html += `<div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="document.getElementById('review-modal').remove()" style="padding: 12px 25px; background: ${btnBg}; color: ${modalColor}; border: none; border-radius: 25px; cursor: pointer; font-size: 1em;">Continue Quiz</button>
                        <button onclick="document.getElementById('review-modal').remove(); finishQuiz()" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 1em;">Submit Quiz</button>
                    </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        let retryQuestions = [];

        function retryMistakes() {
            if (quizMistakes.length === 0) return;
            retryQuestions = quizMistakes.map(m => {
                return currentQuestions.find(q => q.question === m.question);
            }).filter(q => q);

            if (retryQuestions.length === 0) return;

            currentQuestions = retryQuestions;
            currentQuestions.sort(() => Math.random() - 0.5);
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('quiz-title').textContent = currentQuizTitle + ' (Retry Mistakes)';
            currentQuestionIndex = 0;
            userAnswers = {};
            correctCount = 0;
            quizMistakes = [];
            flaggedQuestions = [];
            quizStartTime = Date.now();

            if (examMode === 'timed') {
                startTimer(examDuration * 60);
            } else {
                document.getElementById('timer').style.display = 'none';
            }
            showQuestion(0);
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            clearQuizState();
            const total = currentQuestions.length;
            const pct = Math.round((correctCount / total) * 100);
            const durationSec = quizStartTime ? Math.round((Date.now() - quizStartTime) / 1000) : 0;
            const history = currentUser.history || [];
            const entry = { quizName: currentQuizTitle, score: correctCount, total: total, percent: pct, date: new Date(), mistakes: quizMistakes, duration: durationSec };
            if (currentQuizId === 'random') {
                const breakdown = {};
                currentQuestions.forEach((q, idx) => {
                    const srcName = q._sourceQuizName || 'Unknown';
                    if (!breakdown[srcName]) breakdown[srcName] = { total: 0, correct: 0 };
                    breakdown[srcName].total++;
                    if (userAnswers[idx] !== undefined && userAnswers[idx] === Number(q.correctAnswer)) {
                        breakdown[srcName].correct++;
                    }
                });
                entry.quizBreakdown = breakdown;
                entry.isRandom = true;
            }
            history.push(entry);
            currentUser.history = history;
            localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
            db.collection('users').doc(currentUser.id).update({ history });
            if (currentQuizId && currentQuizId !== 'random') {
                autoCompleteQuiz(currentQuizId);
            }
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').textContent = `${correctCount}/${total}`;
            document.getElementById('result-message').textContent = pct >= 90 ? 'Excellent!' : pct >= 70 ? 'Very Good!' : pct >= 50 ? 'Good!' : 'Keep Practicing!';
            const retryBtn = document.getElementById('retry-mistakes-btn');
            if (quizMistakes.length > 0) {
                document.getElementById('mistakes-review').classList.remove('hidden');
                retryBtn.style.display = 'inline-block';
                let html = '';
                const isDkR = document.body.classList.contains('dark-mode');
                const rExpBg = isDkR ? '#1a2a3a' : '#e3f2fd';
                const rExpColor = isDkR ? '#e2e8f0' : 'inherit';
                const rWrong = isDkR ? '#f87171' : '#f44336';
                const rCorrect = isDkR ? '#4ade80' : '#4caf50';
                quizMistakes.forEach((m, i) => {
                    html += `<div class="mistake-review"><strong>Q${i+1}:</strong> ${m.question}<br><span style="color:${rWrong};">Your: ${m.yourAnswer}</span>`;
                    if (m.wrongReason) html += `<div style="margin-top:6px;padding:8px 10px;background:${isDkR ? '#2a1a1a' : '#fef2f2'};border-radius:6px;font-size:0.85em;color:${isDkR ? '#fca5a5' : '#991b1b'};border-left:3px solid #ef4444;">‚ùå ${m.wrongReason}</div>`;
                    html += `<br><span style="color:${rCorrect};">Correct: ${m.correctAnswer}</span>`;
                    if (m.explanation) html += `<div style="margin-top:8px;padding:10px;background:${rExpBg};border-radius:8px;border-left:4px solid #818cf8;font-size:0.9em;color:${rExpColor};"><strong>üí°</strong> ${m.explanation}</div>`;
                    html += `</div>`;
                });
                document.getElementById('mistakes-list').innerHTML = html;
            } else {
                retryBtn.style.display = 'none';
                document.getElementById('mistakes-review').classList.add('hidden');
            }
        }

        function loadMistakes() {
            const history = currentUser.history || [];
            if (history.length === 0) { 
                document.getElementById('mistakes-content').innerHTML = '<p>No mistakes!</p>'; 
                return; 
            }

            let html = '';
            const isDkM = document.body.classList.contains('dark-mode');
            const mCardBg = isDkM ? '#1e293b' : 'white';
            const mSubColor = isDkM ? '#94a3b8' : '#666';
            const mBorderColor = isDkM ? '#334155' : '#eee';
            const mExpBg = isDkM ? '#1a2a3a' : '#e3f2fd';
            const mExpColor = isDkM ? '#e2e8f0' : 'inherit';
            const mWrongColor = isDkM ? '#f87171' : '#f44336';
            const mCorrectColor = isDkM ? '#4ade80' : '#4caf50';
            let hasMistakes = false;

            history.slice().reverse().forEach((h, revIdx) => {
                const realIdx = history.length - 1 - revIdx;
                if (h.mistakes && h.mistakes.length > 0) {
                    hasMistakes = true;
                    const date = h.date.toDate ? h.date.toDate().toLocaleDateString() : new Date(h.date).toLocaleDateString();
                    html += `<div style="background: ${mCardBg}; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">`;
                    html += `<h3 style="color: #818cf8; margin: 0;">üìù ${h.quizName}</h3>`;
                    html += `<button onclick="deleteExamMistakes(${realIdx})" style="background: #f44336; color: white; border: none; border-radius: 10px; padding: 6px 14px; font-size: 0.85em; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 8px rgba(244,67,54,0.3);">‚úï Delete All</button>`;
                    html += `</div>`;
                    html += `<p style="color: ${mSubColor}; margin-bottom: 15px;">üìÖ ${date} | Score: ${h.score}/${h.total} (${h.percent}%)</p>`;
                    html += `<div style="border-top: 2px solid ${mBorderColor}; padding-top: 15px;">`;
                    h.mistakes.forEach((m, i) => {
                        html += `<div class="mistake-review" style="margin-bottom: 10px; position: relative; padding-right: 40px;">`;
                        html += `<button onclick="deleteMistake(${realIdx}, ${i})" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 1em; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">‚úï</button>`;
                        html += `<strong>Q${i+1}:</strong> ${m.question}<br>`;
                        html += `<span style="color: ${mWrongColor};">Your Answer: ${m.yourAnswer}</span>`;
                        if (m.wrongReason) {
                            html += `<div style="margin-top:6px;padding:8px 10px;background:${isDkM ? '#2a1a1a' : '#fef2f2'};border-radius:6px;font-size:0.85em;color:${isDkM ? '#fca5a5' : '#991b1b'};border-left:3px solid #ef4444;">‚ùå ${m.wrongReason}</div>`;
                        }
                        html += `<br><span style="color: ${mCorrectColor};">Correct Answer: ${m.correctAnswer}</span>`;
                        if (m.explanation) {
                            html += `<div style="margin-top: 10px; padding: 10px; background: ${mExpBg}; border-radius: 8px; border-left: 4px solid #818cf8; color: ${mExpColor};"><strong>üí° Explanation:</strong> ${m.explanation}</div>`;
                        }
                        html += `</div>`;
                    });
                    html += `</div></div>`;
                }
            });

            if (!hasMistakes) {
                document.getElementById('mistakes-content').innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 3em; margin-bottom: 10px;">‚úÖ</div><p>No mistakes! Great job!</p></div>';
            } else {
                const actionBtns = `<div style="text-align: center; margin-bottom: 20px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="quizOnMistakes()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 12px; padding: 12px 28px; font-size: 1em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102,126,234,0.3);">üìù Quiz on My Mistakes</button>
                    <button onclick="clearAllMistakes()" style="background: linear-gradient(135deg, #f44336, #c62828); color: white; border: none; border-radius: 12px; padding: 12px 28px; font-size: 1em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(244,67,54,0.3);">üóëÔ∏è Clear All Mistakes</button>
                </div>`;
                document.getElementById('mistakes-content').innerHTML = actionBtns + html;
            }
        }

        function deleteMistake(historyIdx, mistakeIdx) {
            showConfirm('Delete Mistake', 'Are you sure you want to delete this mistake?', () => {
                let history = currentUser.history || [];
                if (history[historyIdx] && history[historyIdx].mistakes) {
                    history[historyIdx].mistakes.splice(mistakeIdx, 1);
                    currentUser.history = history;
                    localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
                    db.collection('users').doc(currentUser.id).update({ history: history });
                    showToast('Mistake deleted', 'success');
                    loadMistakes();
                }
            }, 'üóëÔ∏è');
        }

        function deleteExamMistakes(historyIdx) {
            const history = currentUser.history || [];
            const entry = history[historyIdx];
            if (!entry) return;
            const count = entry.mistakes ? entry.mistakes.length : 0;
            showConfirm('Delete Exam Mistakes', `Delete all ${count} mistake(s) from "${entry.quizName}"?`, () => {
                history[historyIdx].mistakes = [];
                currentUser.history = history;
                localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
                db.collection('users').doc(currentUser.id).update({ history: history });
                showToast('All mistakes from this exam deleted', 'success');
                loadMistakes();
            }, 'üóëÔ∏è');
        }

        function clearAllMistakes() {
            showConfirm('Clear All Mistakes', 'Are you sure you want to delete ALL your mistakes? This cannot be undone.', () => {
                let history = currentUser.history || [];
                history.forEach(h => { h.mistakes = []; });
                currentUser.history = history;
                localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
                db.collection('users').doc(currentUser.id).update({ history: history });
                showToast('All mistakes cleared', 'success');
                loadMistakes();
            }, '‚ö†Ô∏è');
        }

        function quizOnMistakes() {
            const history = currentUser.history || [];
            const allMistakes = [];
            const seen = new Set();
            history.forEach(h => {
                if (h.mistakes && h.mistakes.length > 0) {
                    h.mistakes.forEach(m => {
                        const key = (m.question || '').substring(0, 100);
                        if (!seen.has(key)) {
                            seen.add(key);
                            if (m.options && m.options.length === 4 && m.options.some(o => o)) {
                                let correctIdx = 0;
                                if (typeof m.correctAnswerIndex === 'number') {
                                    correctIdx = m.correctAnswerIndex;
                                } else if (m.correctAnswer) {
                                    const foundIdx = m.options.findIndex(o => o === m.correctAnswer);
                                    if (foundIdx >= 0) correctIdx = foundIdx;
                                }
                                allMistakes.push({
                                    question: m.question || 'Unknown question',
                                    options: m.options,
                                    correctAnswer: correctIdx,
                                    explanation: m.explanation || '',
                                    wrongExplanations: m.wrongExplanations || {}
                                });
                            }
                        }
                    });
                }
            });
            if (allMistakes.length === 0) {
                showToast('No valid mistakes to quiz on. Take some quizzes first and new mistakes will be available!', 'warning');
                return;
            }
            currentQuizId = 'mistakes_quiz';
            currentQuizTitle = 'Quiz on My Mistakes';
            currentQuestions = allMistakes;
            currentQuestions.sort(() => Math.random() - 0.5);
            examMode = 'practice';
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('quiz-title').textContent = 'Quiz on My Mistakes (' + allMistakes.length + ' questions) (Practice)';
            currentQuestionIndex = 0;
            userAnswers = {};
            correctCount = 0;
            quizMistakes = [];
            flaggedQuestions = [];
            quizStartTime = Date.now();
            document.getElementById('timer').style.display = 'none';
            showQuestion(0);
        }

        function isQuestionBookmarked(q) {
            if (!currentUser || !currentUser.bookmarks) return false;
            return currentUser.bookmarks.some(b => b.question === q.question);
        }

        function toggleBookmark(index) {
            const q = currentQuestions[index];
            if (!currentUser) return;
            if (!currentUser.bookmarks) currentUser.bookmarks = [];
            const existingIdx = currentUser.bookmarks.findIndex(b => b.question === q.question);
            if (existingIdx >= 0) {
                currentUser.bookmarks.splice(existingIdx, 1);
                showToast('Bookmark removed', 'info');
            } else {
                currentUser.bookmarks.push({
                    question: q.question,
                    options: q.options,
                    correctAnswer: q.correctAnswer,
                    correctAnswerIndex: q.correctAnswer,
                    explanation: q.explanation || '',
                    wrongExplanations: q.wrongExplanations || {},
                    quizName: currentQuizTitle || 'Unknown Quiz',
                    quizId: currentQuizId || '',
                    savedAt: new Date().toISOString()
                });
                showToast('Question bookmarked!', 'success');
            }
            db.collection('users').doc(currentUser.id).update({ bookmarks: currentUser.bookmarks });
            showQuestion(index);
        }

        function loadBookmarks() {
            const container = document.getElementById('bookmarks-content');
            const dk = document.body.classList.contains('dark-mode');
            if (!currentUser || !currentUser.bookmarks || currentUser.bookmarks.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;"><div style="font-size:3em;margin-bottom:15px;">üîñ</div><p style="font-size:1.1em;">No bookmarks yet!</p><p style="font-size:0.9em;">Bookmark questions during quizzes to review them later.</p></div>';
                return;
            }
            const bookmarks = currentUser.bookmarks;
            const labels = ['A','B','C','D'];
            let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
                <p style="color:#666;margin:0;">${bookmarks.length} bookmarked question${bookmarks.length > 1 ? 's' : ''}</p>
                <div style="display:flex;gap:10px;">
                    <button onclick="quizOnBookmarks()" class="btn btn-primary" style="padding:10px 20px;font-size:0.95em;">üìù Quiz on Bookmarks</button>
                    <button onclick="clearAllBookmarks()" class="btn btn-danger" style="padding:10px 20px;font-size:0.95em;">üóëÔ∏è Clear All</button>
                </div>
            </div>`;
            bookmarks.forEach((b, idx) => {
                const cardBg = dk ? '#1e293b' : '#f8f9ff';
                const borderColor = dk ? '#334155' : '#e0e5ff';
                const textColor = dk ? '#e2e8f0' : '#333';
                const subColor = dk ? '#94a3b8' : '#666';
                html += `<div style="background:${cardBg};border:2px solid ${borderColor};border-radius:15px;padding:20px;margin-bottom:15px;position:relative;">
                    <button onclick="removeBookmark(${idx})" style="position:absolute;top:10px;right:10px;background:#f44336;color:white;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;font-size:0.9em;display:flex;align-items:center;justify-content:center;" title="Remove bookmark">‚úï</button>
                    <div style="font-size:0.8em;color:${subColor};margin-bottom:8px;">From: ${b.quizName || 'Unknown Quiz'}</div>
                    <h4 style="color:${textColor};margin-bottom:12px;padding-right:35px;">${b.question}</h4>`;
                if (b.options && b.options.length === 4) {
                    b.options.forEach((opt, j) => {
                        const isCorrect = j === b.correctAnswerIndex || j === b.correctAnswer;
                        const optBg = isCorrect ? (dk ? '#064e3b' : '#e8f5e9') : (dk ? '#1e293b' : 'white');
                        const optBorder = isCorrect ? '#4caf50' : (dk ? '#475569' : '#e0e0e0');
                        const optColor = isCorrect ? '#4caf50' : textColor;
                        html += `<div style="padding:10px 15px;margin-bottom:6px;border-radius:10px;background:${optBg};border:1.5px solid ${optBorder};color:${optColor};font-size:0.95em;">
                            <strong>${labels[j]})</strong> ${opt} ${isCorrect ? '‚úÖ' : ''}
                        </div>`;
                    });
                }
                if (b.explanation) {
                    const expBg = dk ? '#1a2a3a' : '#e3f2fd';
                    html += `<div style="margin-top:10px;padding:12px;background:${expBg};border-radius:10px;border-left:4px solid #818cf8;font-size:0.9em;color:${textColor};">üí° ${b.explanation}</div>`;
                }
                html += `</div>`;
            });
            container.innerHTML = html;
        }

        function removeBookmark(idx) {
            if (!currentUser || !currentUser.bookmarks) return;
            currentUser.bookmarks.splice(idx, 1);
            db.collection('users').doc(currentUser.id).update({ bookmarks: currentUser.bookmarks });
            showToast('Bookmark removed', 'info');
            loadBookmarks();
        }

        function clearAllBookmarks() {
            showConfirm('Are you sure you want to clear all bookmarks?', () => {
                currentUser.bookmarks = [];
                db.collection('users').doc(currentUser.id).update({ bookmarks: [] });
                showToast('All bookmarks cleared', 'info');
                loadBookmarks();
            }, 'üîñ');
        }

        function quizOnBookmarks() {
            if (!currentUser || !currentUser.bookmarks || currentUser.bookmarks.length === 0) {
                showToast('No bookmarks to quiz on!', 'warning');
                return;
            }
            const questions = currentUser.bookmarks.filter(b => b.options && b.options.length === 4 && b.options.some(o => o)).map(b => ({
                question: b.question,
                options: b.options,
                correctAnswer: typeof b.correctAnswerIndex === 'number' ? b.correctAnswerIndex : (b.correctAnswer || 0),
                explanation: b.explanation || '',
                wrongExplanations: b.wrongExplanations || {}
            }));
            if (questions.length === 0) {
                showToast('No valid bookmarked questions to quiz on!', 'warning');
                return;
            }
            currentQuizId = 'bookmarks_quiz';
            currentQuizTitle = 'Quiz on Bookmarks';
            currentQuestions = questions;
            currentQuestions.sort(() => Math.random() - 0.5);
            examMode = 'practice';
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('quiz-title').textContent = 'Quiz on Bookmarks (' + questions.length + ' questions) (Practice)';
            currentQuestionIndex = 0;
            userAnswers = {};
            correctCount = 0;
            quizMistakes = [];
            flaggedQuestions = [];
            quizStartTime = Date.now();
            document.getElementById('timer').style.display = 'none';
            showQuestion(0);
        }

        function loadUserNotifications() {
            db.collection('notifications').where('active', '==', true).get().then(snap => {
                const now = new Date();
                let messages = [];
                const userId = currentUser ? currentUser.id : null;
                snap.forEach(doc => {
                    const n = doc.data();
                    const expiry = n.expiry.toDate ? n.expiry.toDate() : new Date(n.expiry);
                    if (expiry <= now) return;
                    const target = n.targetType || 'all';
                    const targetUsers = n.targetUsers || [];
                    if (target === 'all' || (userId && targetUsers.includes(userId))) {
                        messages.push(n.message);
                    }
                });
                if (messages.length > 0) {
                    document.getElementById('notification-text').textContent = 'üîî ' + messages.join(' | ');
                    document.getElementById('notifications-bar').style.display = 'block';
                } else {
                    document.getElementById('notifications-bar').style.display = 'none';
                }
            });
        }

        function closeNotification() {
            document.getElementById('notifications-bar').style.display = 'none';
        }

        function loadHistory() {
            const history = currentUser.history || [];
            const historyStats = currentUser.historyStats || { totalQuizzes: 0, totalCorrect: 0, totalQuestions: 0, bestScore: 0 };
            if (history.length === 0 && historyStats.totalQuizzes === 0) { 
                document.getElementById('history-content').innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 3em; margin-bottom: 10px;">üìä</div><p>No history yet. Start a quiz to see your results here!</p></div>'; 
                return; 
            }

            let totalQuizzes = (historyStats.totalQuizzes || 0) + history.length;
            let totalCorrect = historyStats.totalCorrect || 0;
            let totalQuestions = historyStats.totalQuestions || 0;
            let bestScore = historyStats.bestScore || 0;
            history.forEach(h => {
                totalCorrect += h.score || 0;
                totalQuestions += h.total || 0;
                if (h.percent > bestScore) bestScore = h.percent;
            });
            const avgScore = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;

            let html = '';
            html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 25px;">`;
            html += `<div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold;">${totalQuizzes}</div><div style="font-size: 0.85em; opacity: 0.9;">Quizzes Taken</div></div>`;
            html += `<div style="background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold;">${avgScore}%</div><div style="font-size: 0.85em; opacity: 0.9;">Average Score</div></div>`;
            html += `<div style="background: linear-gradient(135deg, #ff9800, #e65100); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold;">${bestScore}%</div><div style="font-size: 0.85em; opacity: 0.9;">Best Score</div></div>`;
            html += `<div style="background: linear-gradient(135deg, #2196f3, #0d47a1); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold;">${totalCorrect}/${totalQuestions}</div><div style="font-size: 0.85em; opacity: 0.9;">Total Correct</div></div>`;
            html += `</div>`;

            if (history.length > 0) {
                html += `<div style="text-align: center; margin-bottom: 20px;">
                    <button onclick="clearAllHistory()" style="background: linear-gradient(135deg, #f44336, #c62828); color: white; border: none; border-radius: 12px; padding: 12px 28px; font-size: 1em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(244,67,54,0.3);">üóëÔ∏è Clear All History</button>
                </div>`;
            }

            const isDkH = document.body.classList.contains('dark-mode');

            history.slice().reverse().forEach((h, i) => {
                const d = h.date.toDate ? h.date.toDate().toLocaleDateString() : new Date(h.date).toLocaleDateString();
                const time = h.date.toDate ? h.date.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : new Date(h.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const pct = h.percent || 0;
                let scoreColor = '#4caf50';
                let scoreBg = isDkH ? '#1a3a2a' : '#e8f5e9';
                let scoreEmoji = 'üéâ';
                if (pct < 50) { scoreColor = '#f44336'; scoreBg = isDkH ? '#3a1a1a' : '#ffebee'; scoreEmoji = 'üòî'; }
                else if (pct < 70) { scoreColor = '#ff9800'; scoreBg = isDkH ? '#332b1a' : '#fff3e0'; scoreEmoji = 'ü§î'; }
                else if (pct < 90) { scoreColor = '#2196f3'; scoreBg = isDkH ? '#1a2a3a' : '#e3f2fd'; scoreEmoji = 'üëç'; }

                const hCardBg = isDkH ? '#1e293b' : 'white';
                const hTitleColor = isDkH ? '#e2e8f0' : '#333';
                const hSubColor = isDkH ? '#94a3b8' : '#999';
                const hBarBg = isDkH ? '#475569' : '#eee';
                const hPctColor = isDkH ? '#94a3b8' : '#666';

                const dur = h.duration ? (h.duration >= 60 ? Math.floor(h.duration/60) + 'm ' + (h.duration%60) + 's' : h.duration + 's') : '';
                const hTimestamp = h.date.toDate ? h.date.toDate().getTime() : new Date(h.date).getTime();
                const histId = 'hist-' + hTimestamp + '-' + i;

                const realHistIdx = history.length - 1 - i;

                if (h.isRandom && h.quizBreakdown) {
                    html += `<div style="background: ${hCardBg}; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 3px 15px rgba(0,0,0,0.08); border-right: 5px solid ${scoreColor}; overflow: hidden; position: relative;">`;
                    html += `<button onclick="event.stopPropagation(); deleteHistoryEntry(${realHistIdx})" style="position: absolute; top: 12px; right: 12px; background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1em; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(244,67,54,0.3); z-index: 5;">‚úï</button>`;
                    html += `<div onclick="document.getElementById('${histId}').style.display = document.getElementById('${histId}').style.display === 'none' ? 'block' : 'none'" style="padding: 20px; padding-right: 50px; cursor: pointer; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">`;
                    html += `<div style="font-size: 2em;">üé≤</div>`;
                    html += `<div style="flex: 1; min-width: 150px;">
                        <div style="font-weight: bold; font-size: 1.1em; color: ${hTitleColor}; margin-bottom: 5px;">${h.quizName}</div>
                        <div style="color: ${hSubColor}; font-size: 0.85em;">üìÖ ${d} - ${time}</div>
                        ${dur ? `<div style="margin-top:5px;display:inline-block;background:${isDkH ? '#1a2a3a' : '#e3f2fd'};color:${isDkH ? '#93c5fd' : '#1565c0'};padding:3px 10px;border-radius:10px;font-size:0.85em;font-weight:600;">‚è±Ô∏è ${dur}</div>` : ''}
                        <div style="margin-top:5px;color:#818cf8;font-size:0.85em;">Tap to see breakdown ‚ñº</div>
                    </div>`;
                    html += `<div style="text-align: center; min-width: 100px;">
                        <div style="background: ${scoreBg}; color: ${scoreColor}; font-weight: bold; font-size: 1.4em; padding: 10px 20px; border-radius: 12px;">${h.score}/${h.total}</div>
                        <div style="margin-top: 5px; font-size: 0.85em; color: ${hPctColor};">${pct}%</div>
                    </div>`;
                    html += `<div style="width: 100%; margin-top: 5px;">
                        <div style="height: 6px; background: ${hBarBg}; border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${pct}%; background: ${scoreColor}; border-radius: 3px; transition: width 0.5s;"></div>
                        </div>
                    </div>`;
                    html += `</div>`;

                    html += `<div id="${histId}" style="display:none;padding:0 20px 20px;border-top:2px solid ${isDkH ? '#334155' : '#eee'};">`;
                    html += `<div style="padding-top:15px;font-weight:bold;color:${hTitleColor};margin-bottom:12px;font-size:1em;">üìä Per-Quiz Breakdown:</div>`;
                    const bd = h.quizBreakdown;
                    Object.keys(bd).forEach(qName => {
                        const qd = bd[qName];
                        const qPct = Math.round((qd.correct / qd.total) * 100);
                        let qColor, qBg, feedback;
                        if (qPct >= 90) {
                            qColor = '#4caf50'; qBg = isDkH ? '#1a3a2a' : '#e8f5e9';
                            feedback = 'You are confident in this! üí™';
                        } else if (qPct >= 70) {
                            qColor = '#2196f3'; qBg = isDkH ? '#1a2a3a' : '#e3f2fd';
                            feedback = 'You are strong here! üëç';
                        } else if (qPct >= 50) {
                            qColor = '#ff9800'; qBg = isDkH ? '#332b1a' : '#fff3e0';
                            feedback = 'Needs some review üìñ';
                        } else {
                            qColor = '#f44336'; qBg = isDkH ? '#3a1a1a' : '#ffebee';
                            feedback = 'Review this lecture! ‚ö†Ô∏è';
                        }
                        html += `<div style="background:${qBg};border-radius:12px;padding:12px 15px;margin-bottom:8px;border-left:4px solid ${qColor};">`;
                        html += `<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:5px;">`;
                        html += `<div style="font-weight:600;color:${hTitleColor};font-size:0.95em;">${qName}</div>`;
                        html += `<div style="font-weight:bold;color:${qColor};font-size:1.1em;">${qd.correct}/${qd.total} (${qPct}%)</div>`;
                        html += `</div>`;
                        html += `<div style="margin-top:6px;height:5px;background:${hBarBg};border-radius:3px;overflow:hidden;">
                            <div style="height:100%;width:${qPct}%;background:${qColor};border-radius:3px;"></div>
                        </div>`;
                        html += `<div style="margin-top:6px;font-size:0.85em;color:${qColor};font-weight:600;">${feedback}</div>`;
                        html += `</div>`;
                    });
                    html += `</div></div>`;
                } else {
                    html += `<div style="background: ${hCardBg}; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 3px 15px rgba(0,0,0,0.08); border-right: 5px solid ${scoreColor}; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; position: relative;">`;
                    html += `<button onclick="deleteHistoryEntry(${realHistIdx})" style="position: absolute; top: 12px; right: 12px; background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1em; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(244,67,54,0.3); z-index: 5;">‚úï</button>`;
                    html += `<div style="font-size: 2em;">${scoreEmoji}</div>`;
                    html += `<div style="flex: 1; min-width: 150px; padding-right: 30px;">
                        <div style="font-weight: bold; font-size: 1.1em; color: ${hTitleColor}; margin-bottom: 5px;">${h.quizName}</div>
                        <div style="color: ${hSubColor}; font-size: 0.85em;">üìÖ ${d} - ${time}</div>
                        ${dur ? `<div style="margin-top:5px;display:inline-block;background:${isDkH ? '#1a2a3a' : '#e3f2fd'};color:${isDkH ? '#93c5fd' : '#1565c0'};padding:3px 10px;border-radius:10px;font-size:0.85em;font-weight:600;">‚è±Ô∏è ${dur}</div>` : ''}
                    </div>`;
                    html += `<div style="text-align: center; min-width: 100px;">
                        <div style="background: ${scoreBg}; color: ${scoreColor}; font-weight: bold; font-size: 1.4em; padding: 10px 20px; border-radius: 12px;">${h.score}/${h.total}</div>
                        <div style="margin-top: 5px; font-size: 0.85em; color: ${hPctColor};">${pct}%</div>
                    </div>`;
                    html += `<div style="width: 100%; margin-top: 5px;">
                        <div style="height: 6px; background: ${hBarBg}; border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${pct}%; background: ${scoreColor}; border-radius: 3px; transition: width 0.5s;"></div>
                        </div>
                    </div>`;
                    html += `</div>`;
                }
            });

            document.getElementById('history-content').innerHTML = html;
        }

        function computeHistoryStats() {
            const history = currentUser.history || [];
            const saved = currentUser.historyStats || { totalQuizzes: 0, totalCorrect: 0, totalQuestions: 0, bestScore: 0 };
            let totalQuizzes = (saved.totalQuizzes || 0) + history.length;
            let totalCorrect = saved.totalCorrect || 0;
            let totalQuestions = saved.totalQuestions || 0;
            let bestScore = saved.bestScore || 0;
            history.forEach(h => {
                totalCorrect += h.score || 0;
                totalQuestions += h.total || 0;
                if ((h.percent || 0) > bestScore) bestScore = h.percent;
            });
            return { totalQuizzes, totalCorrect, totalQuestions, bestScore };
        }

        function snapshotAndRemoveHistory(indicesToRemove) {
            const history = currentUser.history || [];
            const fullStats = computeHistoryStats();
            indicesToRemove.sort((a, b) => b - a);
            indicesToRemove.forEach(idx => history.splice(idx, 1));
            currentUser.history = history;
            currentUser.historyStats = {
                totalQuizzes: fullStats.totalQuizzes - history.length,
                totalCorrect: fullStats.totalCorrect - history.reduce((s, h) => s + (h.score || 0), 0),
                totalQuestions: fullStats.totalQuestions - history.reduce((s, h) => s + (h.total || 0), 0),
                bestScore: fullStats.bestScore
            };
            localStorage.setItem('medquiz_user', JSON.stringify(currentUser));
            db.collection('users').doc(currentUser.id).update({ history: currentUser.history, historyStats: currentUser.historyStats });
        }

        function deleteHistoryEntry(idx) {
            const history = currentUser.history || [];
            const entry = history[idx];
            if (!entry) return;
            showConfirm('Delete History Entry', `Remove "${entry.quizName}" from your history? Your overall statistics will be preserved.`, () => {
                snapshotAndRemoveHistory([idx]);
                showToast('History entry removed', 'success');
                loadHistory();
                loadQuickStats();
            }, 'üóëÔ∏è');
        }

        function clearAllHistory() {
            showConfirm('Clear All History', 'Remove all entries from your history list? Your overall statistics will be preserved at the top.', () => {
                const indices = currentUser.history.map((_, i) => i);
                snapshotAndRemoveHistory(indices);
                showToast('All history cleared', 'success');
                loadHistory();
                loadQuickStats();
            }, '‚ö†Ô∏è');
        }

        let activeTagFilter = null;

        function loadTagFilter() {
            const existing = document.getElementById('tag-filter');
            if (existing) existing.remove();

            db.collection('quizzes').get().then(snap => {
                const allTags = new Set();
                snap.forEach(doc => {
                    const tags = doc.data().tags || [];
                    tags.forEach(t => allTags.add(t));
                });
                return allTags;
            }).then(tags => {
                if (tags.size === 0) return;
                let tagHtml = '<div id="tag-filter" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;align-items:center;">';
                tagHtml += '<span style="font-size:0.9em;color:#444;margin-right:5px;">Filter:</span>';
                tagHtml += `<button onclick="filterByTag(null)" style="padding:5px 14px;border-radius:15px;border:2px solid ${!activeTagFilter ? '#667eea' : '#e0e0e0'};background:${!activeTagFilter ? '#667eea' : 'white'};color:${!activeTagFilter ? 'white' : '#333'};cursor:pointer;font-size:0.85em;transition:all 0.2s;">All</button>`;
                tags.forEach(tag => {
                    const isActive = activeTagFilter === tag;
                    tagHtml += `<button onclick="filterByTag('${tag}')" style="padding:5px 14px;border-radius:15px;border:2px solid ${isActive ? '#667eea' : '#e0e0e0'};background:${isActive ? '#667eea' : 'white'};color:${isActive ? 'white' : '#333'};cursor:pointer;font-size:0.85em;transition:all 0.2s;">${tag}</button>`;
                });
                tagHtml += '</div>';
                const browseContent = document.getElementById('browse-content');
                if (browseContent) browseContent.insertAdjacentHTML('afterbegin', tagHtml);
            });
        }

        function filterByTag(tag) {
            activeTagFilter = tag;
            if (currentPath.length === 0) loadHome();
            else loadCurrentFolder();
        }

        let allQuizzesForRandom = [];
        let allFoldersForRandom = [];
        let folderChildrenMap = {};
        let folderQuizMap = {};
        let selectedQuizIds = new Set();
        let randomBrowsePath = [];
        let randomSearchQuery = '';
        let randomSearchFilter = 'all';

        function getDescendantQuizIds(folderId, visited) {
            if (!visited) visited = new Set();
            if (visited.has(folderId)) return [];
            visited.add(folderId);
            let ids = [...(folderQuizMap[folderId] || [])];
            const children = folderChildrenMap[folderId] || [];
            children.forEach(childId => {
                ids = ids.concat(getDescendantQuizIds(childId, visited));
            });
            return ids;
        }

        function getDescendantQuizCount(folderId) {
            return getDescendantQuizIds(folderId).length;
        }

        function getFolderSelectionState(folderId) {
            const allIds = getDescendantQuizIds(folderId);
            if (allIds.length === 0) return 'none';
            const selectedCount = allIds.filter(id => selectedQuizIds.has(id)).length;
            if (selectedCount === allIds.length) return 'all';
            if (selectedCount > 0) return 'partial';
            return 'none';
        }

        function showRandomQuizBuilder() {
            const dk = document.body.classList.contains('dark-mode');
            const bg = dk ? '#1e293b' : 'white';
            const color = dk ? '#e2e8f0' : '#333';
            const sub = dk ? '#94a3b8' : '#666';
            const muted = dk ? '#64748b' : '#999';
            const inputBg = dk ? '#334155' : 'white';
            const fieldBg = dk ? '#334155' : '#f5f5f5';
            const btnBg = dk ? '#334155' : '#eee';
            const border = dk ? '#475569' : '#e0e0e0';

            selectedQuizIds = new Set();
            randomBrowsePath = [];
            randomSearchQuery = '';
            randomSearchFilter = 'all';

            let html = `
                <div id="random-quiz-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;display:flex;justify-content:center;align-items:center;">
                    <div style="background:${bg};color:${color};border-radius:20px;padding:30px;max-width:600px;width:90%;position:relative;max-height:85vh;overflow-y:auto;">
                        <button onclick="document.getElementById('random-quiz-modal').remove()" style="position:absolute;top:15px;right:15px;background:#f44336;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:1.1em;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
                        <h2 style="color:#818cf8;margin-bottom:5px;">üé≤ Random Quiz Builder</h2>
                        <p style="color:${sub};margin-bottom:15px;font-size:0.9em;">Browse folders or search to select quizzes</p>

                        <div style="display:flex;gap:6px;margin-bottom:10px;">
                            <button id="rsf-all" onclick="setRandomSearchFilter('all')" style="flex:1;padding:8px 12px;border:2px solid #818cf8;border-radius:10px;font-size:0.85em;cursor:pointer;font-weight:600;background:#818cf8;color:white;transition:all 0.2s;">All</button>
                            <button id="rsf-folders" onclick="setRandomSearchFilter('folders')" style="flex:1;padding:8px 12px;border:2px solid ${border};border-radius:10px;font-size:0.85em;cursor:pointer;font-weight:600;background:${inputBg};color:${sub};transition:all 0.2s;">üìÅ Folders</button>
                            <button id="rsf-quizzes" onclick="setRandomSearchFilter('quizzes')" style="flex:1;padding:8px 12px;border:2px solid ${border};border-radius:10px;font-size:0.85em;cursor:pointer;font-weight:600;background:${inputBg};color:${sub};transition:all 0.2s;">üìù Quizzes</button>
                        </div>
                        <div style="position:relative;margin-bottom:15px;">
                            <input type="text" id="random-search" placeholder="üîç Search all..." oninput="onRandomSearch(this.value)" style="width:100%;padding:12px 15px;border:2px solid ${border};border-radius:12px;font-size:0.95em;background:${inputBg};color:${color};box-sizing:border-box;">
                        </div>

                        <div id="random-search-results" style="display:none;margin-bottom:15px;max-height:200px;overflow-y:auto;"></div>

                        <div id="random-breadcrumb" style="margin-bottom:10px;font-size:0.85em;"></div>

                        <div id="random-browser" style="margin-bottom:15px;max-height:300px;overflow-y:auto;">
                            <div style="text-align:center;color:${muted};padding:20px;">Loading...</div>
                        </div>

                        <div id="random-selection-summary" style="background:${fieldBg};padding:12px 15px;border-radius:12px;margin-bottom:15px;font-size:0.9em;color:${sub};"></div>

                        <div style="background:${fieldBg};padding:15px;border-radius:12px;margin-bottom:20px;">
                            <label style="font-weight:bold;color:${sub};display:block;margin-bottom:8px;">Number of Questions:</label>
                            <input type="number" id="random-q-count" min="1" value="10" style="width:100%;padding:12px;border:2px solid ${border};border-radius:10px;font-size:1.1em;background:${inputBg};color:${color};box-sizing:border-box;">
                            <div id="random-q-info" style="color:${muted};font-size:0.85em;margin-top:5px;"></div>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button onclick="document.getElementById('random-quiz-modal').remove()" style="flex:1;padding:12px;background:${btnBg};color:${color};border:none;border-radius:25px;cursor:pointer;font-size:1em;">Cancel</button>
                            <button onclick="startRandomQuiz()" style="flex:1;padding:12px;background:linear-gradient(135deg,#ff9800,#f44336);color:white;border:none;border-radius:25px;cursor:pointer;font-size:1em;">Start Quiz</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            loadRandomData();
        }

        function loadRandomData() {
            Promise.all([
                db.collection('quizzes').get(),
                db.collection('folders').get()
            ]).then(([quizSnap, folderSnap]) => {
                allQuizzesForRandom = [];
                quizSnap.forEach(doc => allQuizzesForRandom.push({ id: doc.id, ...doc.data() }));

                allFoldersForRandom = [];
                folderChildrenMap = {};
                folderQuizMap = {};
                folderSnap.forEach(doc => {
                    const f = { id: doc.id, ...doc.data() };
                    allFoldersForRandom.push(f);
                    folderQuizMap[doc.id] = allQuizzesForRandom.filter(q => q.folderId === doc.id).map(q => q.id);
                });

                allFoldersForRandom.forEach(f => {
                    const parentId = f.parentId || '_root';
                    if (!folderChildrenMap[parentId]) folderChildrenMap[parentId] = [];
                    folderChildrenMap[parentId].push(f.id);
                });

                renderRandomBrowser();
            }).catch(() => {
                const browser = document.getElementById('random-browser');
                if (browser) browser.innerHTML = '<p style="text-align:center;color:#f44336;">Error loading data</p>';
            });
        }

        function renderRandomBrowser() {
            const dk = document.body.classList.contains('dark-mode');
            const folderBg = dk ? '#1e3a5f' : '#e3f2fd';
            const folderHover = dk ? '#2a4a6f' : '#bbdefb';
            const selectedBg = dk ? '#1a4a2a' : '#c8e6c9';
            const partialBg = dk ? '#2a3a5f' : '#d1d5ff';
            const itemBg = dk ? '#334155' : '#f8f9fa';
            const itemHover = dk ? '#3b4f6b' : '#e3f2fd';
            const muted = dk ? '#64748b' : '#999';
            const color = dk ? '#e2e8f0' : '#333';
            const tagBg = dk ? '#2d2b55' : '#e8eaf6';
            const tagColor = dk ? '#a5b4fc' : '#667eea';
            const selectAllBg = dk ? '#2d3a5f' : '#e8eaf6';

            const currentFolderId = randomBrowsePath.length > 0 ? randomBrowsePath[randomBrowsePath.length - 1].id : null;

            let breadHtml = `<span onclick="randomNavigateTo(-1)" style="cursor:pointer;color:#818cf8;font-weight:600;">üè† All</span>`;
            randomBrowsePath.forEach((item, i) => {
                breadHtml += ` <span style="color:${muted};"> ‚Ä∫ </span> <span onclick="randomNavigateTo(${i})" style="cursor:pointer;color:#818cf8;font-weight:600;">${item.name}</span>`;
            });
            document.getElementById('random-breadcrumb').innerHTML = breadHtml;

            const childFolderIds = folderChildrenMap[currentFolderId || '_root'] || [];
            const childFolders = allFoldersForRandom.filter(f => childFolderIds.includes(f.id));
            const directQuizIds = currentFolderId ? (folderQuizMap[currentFolderId] || []) : allQuizzesForRandom.filter(q => !q.folderId).map(q => q.id);
            const directQuizzes = allQuizzesForRandom.filter(q => directQuizIds.includes(q.id));

            let html = '';

            if (currentFolderId) {
                const allDescendantIds = getDescendantQuizIds(currentFolderId);
                const allSelected = allDescendantIds.length > 0 && allDescendantIds.every(id => selectedQuizIds.has(id));
                html += `<div onclick="toggleFolderAll('${currentFolderId}')" style="display:flex;align-items:center;gap:10px;padding:12px 15px;background:${selectAllBg};border-radius:12px;margin-bottom:12px;cursor:pointer;border:2px solid ${allSelected ? '#4caf50' : 'transparent'};transition:all 0.2s;">
                    <span style="font-size:1.3em;">${allSelected ? '‚úÖ' : '‚òëÔ∏è'}</span>
                    <div>
                        <div style="font-weight:700;color:${color};">Select All in This Folder</div>
                        <div style="font-size:0.8em;color:${muted};">${allDescendantIds.length} quizzes (including sub-folders)</div>
                    </div>
                </div>`;
            }

            const foldersWithQuizzes = childFolders.filter(f => getDescendantQuizCount(f.id) > 0);
            if (foldersWithQuizzes.length > 0) {
                html += `<div style="font-size:0.8em;color:${muted};font-weight:600;margin-bottom:8px;text-transform:uppercase;">üìÇ Folders</div>`;
                foldersWithQuizzes.forEach(f => {
                    const totalQ = getDescendantQuizCount(f.id);
                    const state = getFolderSelectionState(f.id);
                    let bg = folderBg, borderStyle = 'none';
                    if (state === 'all') { bg = selectedBg; borderStyle = '3px solid #4caf50'; }
                    else if (state === 'partial') { bg = partialBg; borderStyle = '3px solid #667eea'; }
                    const hasChildren = (folderChildrenMap[f.id] || []).length > 0;

                    html += `<div style="display:flex;align-items:center;gap:10px;padding:12px 15px;background:${bg};border-radius:12px;margin-bottom:8px;cursor:pointer;border-left:${borderStyle};transition:all 0.2s;" onmouseover="this.style.background='${folderHover}'" onmouseout="this.style.background='${bg}'">
                        <span onclick="event.stopPropagation();toggleFolderAll('${f.id}')" style="font-size:1.3em;cursor:pointer;" title="Select/deselect all">${state === 'all' ? '‚úÖ' : state === 'partial' ? 'üî≤' : '‚¨ú'}</span>
                        <div onclick="randomDrillInto('${f.id}','${f.name.replace(/'/g, "\\'")}')" style="flex:1;">
                            <div style="font-weight:600;color:${color};">üìÅ ${f.name}</div>
                            <div style="font-size:0.8em;color:${muted};">${totalQ} quiz${totalQ !== 1 ? 'zes' : ''} ${hasChildren ? '‚Ä¢ has sub-folders' : ''}</div>
                        </div>
                        <span onclick="randomDrillInto('${f.id}','${f.name.replace(/'/g, "\\'")}')" style="color:${muted};font-size:1.2em;">‚Ä∫</span>
                    </div>`;
                });
            }

            if (directQuizzes.length > 0) {
                html += `<div style="font-size:0.8em;color:${muted};font-weight:600;margin:12px 0 8px;text-transform:uppercase;">üìù Quizzes</div>`;
                directQuizzes.forEach(q => {
                    const isSelected = selectedQuizIds.has(q.id);
                    const tagsHtml = (q.tags || []).map(t => `<span style="display:inline-block;background:${tagBg};color:${tagColor};padding:1px 6px;border-radius:8px;font-size:0.7em;">${t}</span>`).join(' ');
                    html += `<div onclick="toggleRandomQuiz('${q.id}')" style="display:flex;align-items:center;gap:12px;padding:12px;background:${isSelected ? (dk ? '#1a4a2a' : '#e8f5e9') : itemBg};border-radius:10px;margin-bottom:8px;cursor:pointer;transition:all 0.2s;border-left:${isSelected ? '3px solid #4caf50' : 'none'};" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                        <span style="font-size:1.2em;">${isSelected ? '‚úÖ' : '‚¨ú'}</span>
                        <div style="flex:1;">
                            <div style="font-weight:600;font-size:0.95em;color:${color};">${q.title}</div>
                            <div style="font-size:0.8em;color:${muted};">${q.questionCount || 0} questions ${tagsHtml}</div>
                        </div>
                    </div>`;
                });
            }

            if (foldersWithQuizzes.length === 0 && directQuizzes.length === 0) {
                html += `<p style="text-align:center;color:${muted};padding:20px;">No content here</p>`;
            }

            document.getElementById('random-browser').innerHTML = html;
            updateRandomSelectionSummary();
        }

        function toggleRandomQuiz(quizId) {
            if (selectedQuizIds.has(quizId)) selectedQuizIds.delete(quizId);
            else selectedQuizIds.add(quizId);
            renderRandomBrowser();
        }

        function toggleFolderAll(folderId) {
            const allIds = getDescendantQuizIds(folderId);
            const allSelected = allIds.every(id => selectedQuizIds.has(id));
            if (allSelected) {
                allIds.forEach(id => selectedQuizIds.delete(id));
            } else {
                allIds.forEach(id => selectedQuizIds.add(id));
            }
            renderRandomBrowser();
        }

        function randomDrillInto(folderId, folderName) {
            randomBrowsePath.push({ id: folderId, name: folderName });
            renderRandomBrowser();
        }

        function randomNavigateTo(index) {
            if (index < 0) randomBrowsePath = [];
            else randomBrowsePath = randomBrowsePath.slice(0, index + 1);
            renderRandomBrowser();
        }

        function setRandomSearchFilter(filter) {
            randomSearchFilter = filter;
            const dk = document.body.classList.contains('dark-mode');
            const activeBg = '#818cf8';
            const activeColor = 'white';
            const activeBorder = '#818cf8';
            const inactiveBg = dk ? '#1e293b' : '#fff';
            const inactiveColor = dk ? '#94a3b8' : '#666';
            const inactiveBorder = dk ? '#475569' : '#e0e0e0';

            ['all', 'folders', 'quizzes'].forEach(f => {
                const btn = document.getElementById('rsf-' + f);
                if (btn) {
                    const isActive = f === filter;
                    btn.style.background = isActive ? activeBg : inactiveBg;
                    btn.style.color = isActive ? activeColor : inactiveColor;
                    btn.style.borderColor = isActive ? activeBorder : inactiveBorder;
                }
            });

            const searchInput = document.getElementById('random-search');
            if (searchInput) {
                const placeholders = { all: 'üîç Search all...', folders: 'üîç Search folders...', quizzes: 'üîç Search quizzes...' };
                searchInput.placeholder = placeholders[filter];
                if (searchInput.value.trim().length >= 2) {
                    onRandomSearch(searchInput.value);
                }
            }
        }

        let randomSearchTimeout = null;
        function onRandomSearch(query) {
            clearTimeout(randomSearchTimeout);
            randomSearchQuery = query.trim();
            if (randomSearchQuery.length < 2) {
                document.getElementById('random-search-results').style.display = 'none';
                return;
            }
            randomSearchTimeout = setTimeout(() => {
                const dk = document.body.classList.contains('dark-mode');
                const resBg = dk ? '#334155' : '#f8f9fa';
                const resHover = dk ? '#3b4f6b' : '#e3f2fd';
                const color = dk ? '#e2e8f0' : '#333';
                const muted = dk ? '#64748b' : '#999';
                const q = randomSearchQuery.toLowerCase();

                const matchedFolders = randomSearchFilter !== 'quizzes' ? allFoldersForRandom.filter(f => f.name.toLowerCase().includes(q) && getDescendantQuizCount(f.id) > 0) : [];
                const matchedQuizzes = randomSearchFilter !== 'folders' ? allQuizzesForRandom.filter(qz => qz.title.toLowerCase().includes(q)) : [];

                let html = '';
                if (matchedFolders.length === 0 && matchedQuizzes.length === 0) {
                    html = `<div style="padding:15px;text-align:center;color:${muted};">No results</div>`;
                }

                matchedFolders.forEach(f => {
                    const totalQ = getDescendantQuizCount(f.id);
                    const state = getFolderSelectionState(f.id);
                    html += `<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:${resBg};border-radius:10px;margin-bottom:6px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='${resHover}'" onmouseout="this.style.background='${resBg}'">
                        <span onclick="event.stopPropagation();toggleFolderAll('${f.id}');onRandomSearch(randomSearchQuery);" style="font-size:1.1em;cursor:pointer;">${state === 'all' ? '‚úÖ' : state === 'partial' ? 'üî≤' : '‚¨ú'}</span>
                        <div onclick="document.getElementById('random-search').value='';document.getElementById('random-search-results').style.display='none';randomBrowsePath=[];randomDrillInto('${f.id}','${f.name.replace(/'/g, "\\'")}')" style="flex:1;">
                            <div style="font-weight:600;color:${color};">üìÅ ${f.name}</div>
                            <div style="font-size:0.8em;color:${muted};">${totalQ} quizzes</div>
                        </div>
                    </div>`;
                });

                matchedQuizzes.forEach(qz => {
                    const isSelected = selectedQuizIds.has(qz.id);
                    html += `<div onclick="toggleRandomQuiz('${qz.id}');onRandomSearch(randomSearchQuery);" style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:${resBg};border-radius:10px;margin-bottom:6px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='${resHover}'" onmouseout="this.style.background='${resBg}'">
                        <span style="font-size:1.1em;">${isSelected ? '‚úÖ' : '‚¨ú'}</span>
                        <div style="flex:1;">
                            <div style="font-weight:600;color:${color};">üìù ${qz.title}</div>
                            <div style="font-size:0.8em;color:${muted};">${qz.questionCount || 0} questions</div>
                        </div>
                    </div>`;
                });

                const container = document.getElementById('random-search-results');
                container.innerHTML = html;
                container.style.display = 'block';
            }, 300);
        }

        function updateRandomSelectionSummary() {
            const totalQuizzes = selectedQuizIds.size;
            let totalQuestions = 0;
            selectedQuizIds.forEach(id => {
                const q = allQuizzesForRandom.find(qz => qz.id === id);
                if (q) totalQuestions += (q.questionCount || 0);
            });
            const summary = document.getElementById('random-selection-summary');
            const info = document.getElementById('random-q-info');
            if (summary) {
                if (totalQuizzes === 0) {
                    summary.innerHTML = '‚ö†Ô∏è No quizzes selected yet';
                } else {
                    summary.innerHTML = `‚úÖ <strong>${totalQuizzes}</strong> quiz${totalQuizzes > 1 ? 'zes' : ''} selected ‚Ä¢ <strong>${totalQuestions}</strong> questions available`;
                }
            }
            if (info) {
                info.textContent = totalQuizzes === 0 ? 'Select quizzes above first' : `${totalQuestions} questions available`;
            }
        }

        function startRandomQuiz() {
            if (selectedQuizIds.size === 0) { showToast('Please select at least one quiz', 'warning'); return; }

            const requestedCount = parseInt(document.getElementById('random-q-count').value) || 10;
            const selectedIds = Array.from(selectedQuizIds);

            let allQuestions = [];
            let loaded = 0;

            selectedIds.forEach(qid => {
                const quizDoc = allQuizzesForRandom.find(q => q.id === qid);
                const quizName = quizDoc ? (quizDoc.title || quizDoc.name || 'Unknown Quiz') : 'Unknown Quiz';
                db.collection('quizzes').doc(qid).collection('questions').get().then(snap => {
                    snap.forEach(doc => {
                        const qData = doc.data();
                        qData._sourceQuizId = qid;
                        qData._sourceQuizName = quizName;
                        allQuestions.push(qData);
                    });
                    loaded++;
                    if (loaded === selectedIds.length) {
                        if (allQuestions.length === 0) { showToast('No questions found in selected quizzes', 'warning'); return; }
                        if (requestedCount > allQuestions.length) {
                            showToast(`Only ${allQuestions.length} questions available. Will use all of them.`, 'info');
                        }

                        allQuestions.sort(() => Math.random() - 0.5);
                        const finalQuestions = allQuestions.slice(0, Math.min(requestedCount, allQuestions.length));

                        document.getElementById('random-quiz-modal').remove();

                        currentQuizId = 'random';
                        currentQuizTitle = 'Random Quiz';
                        showExamModeSelectionForRandom(finalQuestions, selectedIds.length);
                    }
                });
            });
        }
        let pendingRandomQuestions = [];

        function showExamModeSelectionForRandom(questions, quizCount) {
            pendingRandomQuestions = questions;
            const isDkE = document.body.classList.contains('dark-mode');
            const eBg = isDkE ? '#1e293b' : 'white';
            const eColor = isDkE ? '#e2e8f0' : '#333';
            const eSub = isDkE ? '#94a3b8' : '#666';
            const eBtnBg = isDkE ? '#334155' : 'white';

            let modalHtml = `
                <div id="exam-mode-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;display:flex;justify-content:center;align-items:center;">
                    <div style="background:${eBg};color:${eColor};border-radius:20px;padding:40px;max-width:500px;width:90%;text-align:center;position:relative;">
                        <button onclick="document.getElementById('exam-mode-modal').remove()" style="position:absolute;top:15px;right:15px;background:#f44336;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:1.1em;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
                        <h2 style="color:#818cf8;margin-bottom:20px;">üé≤ Random Quiz (${questions.length} Q)</h2>
                        <p style="margin-bottom:30px;color:${eSub};">Choose mode:</p>

                        <button onclick="document.getElementById('exam-mode-modal').remove(); launchRandomQuiz('practice')" style="display:block;width:100%;padding:20px;margin:10px 0;border:2px solid #4caf50;border-radius:15px;background:${eBtnBg};color:${eColor};cursor:pointer;font-size:1.1em;transition:all 0.3s;">
                            <div style="font-size:2em;margin-bottom:10px;">üìñ</div>
                            <strong>Practice Mode</strong>
                            <div style="color:${eSub};font-size:0.9em;">See answers immediately</div>
                        </button>

                        <button onclick="document.getElementById('exam-mode-modal').remove(); launchRandomQuiz('untimed')" style="display:block;width:100%;padding:20px;margin:10px 0;border:2px solid #667eea;border-radius:15px;background:${eBtnBg};color:${eColor};cursor:pointer;font-size:1.1em;transition:all 0.3s;">
                            <div style="font-size:2em;margin-bottom:10px;">‚è±Ô∏è</div>
                            <strong>Exam - No Time Limit</strong>
                            <div style="color:${eSub};font-size:0.9em;">Answers after submission</div>
                        </button>

                        <button onclick="showRandomTimedSelection(${questions.length})" style="display:block;width:100%;padding:20px;margin:10px 0;border:2px solid #764ba2;border-radius:15px;background:${eBtnBg};color:${eColor};cursor:pointer;font-size:1.1em;transition:all 0.3s;">
                            <div style="font-size:2em;margin-bottom:10px;">‚è∞</div>
                            <strong>Exam - Timed</strong>
                            <div style="color:${eSub};font-size:0.9em;">Set time limit, answers after submission</div>
                        </button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function showRandomTimedSelection(questionCount) {
            document.getElementById('exam-mode-modal').remove();

            const suggestedMinutes = Math.ceil(questionCount * 70 / 60);
            const isDkT = document.body.classList.contains('dark-mode');
            const tBg = isDkT ? '#1e293b' : 'white';
            const tColor = isDkT ? '#e2e8f0' : '#333';
            const tSub = isDkT ? '#94a3b8' : '#666';
            const tInputBg = isDkT ? '#334155' : 'white';
            const tBorder = isDkT ? '#475569' : '#667eea';
            const tBtnBg = isDkT ? '#334155' : '#eee';
            const tSuggestBg = isDkT ? '#1a2a3a' : '#e3f2fd';

            let timeModal = `
                <div id="random-time-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;display:flex;justify-content:center;align-items:center;">
                    <div style="background:${tBg};color:${tColor};border-radius:20px;padding:40px;max-width:400px;width:90%;text-align:center;position:relative;">
                        <button onclick="document.getElementById('random-time-modal').remove()" style="position:absolute;top:15px;right:15px;background:#f44336;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:1.1em;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
                        <h2 style="color:#818cf8;margin-bottom:20px;">‚è∞ Set Time Limit</h2>
                        <div style="margin:20px 0;">
                            <label style="display:block;margin-bottom:10px;font-weight:bold;color:${tColor};">Duration (minutes):</label>
                            <input type="number" id="random-exam-duration" min="1" value="${suggestedMinutes}" style="width:100%;padding:15px;border:2px solid ${tBorder};border-radius:10px;font-size:1.4em;text-align:center;background:${tInputBg};color:${tColor};">
                            <div style="margin-top:10px;padding:10px;background:${tSuggestBg};border-radius:8px;font-size:0.85em;color:${tSub};">
                                üí° Suggested: <strong style="color:#818cf8;">${suggestedMinutes} minutes</strong> (1 min 10 sec √ó ${questionCount} questions)
                            </div>
                        </div>
                        <button onclick="launchRandomQuizTimed()" style="width:100%;padding:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:25px;font-size:1.1em;cursor:pointer;margin-top:10px;">Start Exam</button>
                        <button onclick="document.getElementById('random-time-modal').remove(); showExamModeSelectionForRandom(pendingRandomQuestions, 0)" style="width:100%;padding:15px;background:${tBtnBg};color:${tColor};border:none;border-radius:25px;font-size:1em;cursor:pointer;margin-top:10px;">Back</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', timeModal);
        }

        function launchRandomQuizTimed() {
            const durationInput = document.getElementById('random-exam-duration');
            const val = parseInt(durationInput.value);
            examDuration = val > 0 ? val : 30;
            document.getElementById('random-time-modal').remove();
            launchRandomQuiz('timed');
        }

        function launchRandomQuiz(mode) {
            examMode = mode;
            currentQuestions = pendingRandomQuestions;
            currentQuizId = 'random';
            currentQuizTitle = 'Random Quiz';
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            const modeLabel = mode === 'practice' ? '(Practice)' : mode === 'timed' ? '(Timed)' : '(Exam)';
            document.getElementById('quiz-title').textContent = `Random Quiz ${modeLabel} - ${currentQuestions.length} Questions`;
            currentQuestionIndex = 0;
            userAnswers = {};
            correctCount = 0;
            quizMistakes = [];
            flaggedQuestions = [];
            quizStartTime = Date.now();

            if (mode === 'timed') {
                startTimer(examDuration * 60);
            } else {
                document.getElementById('timer').style.display = 'none';
            }
            showQuestion(0);
        }
    </script>
</body>
</html>
