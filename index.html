<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedQuiz HNU - Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', sans-serif; }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .dark-mode .glass-card {
            background: rgba(30, 30, 46, 0.95);
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .folder-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .folder-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .hidden { display: none !important; }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .timer-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .timer-warning {
            color: #ef4444;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .calc-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        #calculator {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 280px;
            z-index: 1000;
        }
        
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body class="p-4">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="glass-card p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-stethoscope text-6xl text-indigo-600 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">MedQuiz HNU</h1>
                <p class="text-gray-600 mt-2">Medical Quiz Platform</p>
            </div>
            
            <form id="authForm" onsubmit="event.preventDefault(); handleAuth();" class="space-y-4">
                <div class="flex justify-center space-x-4 mb-6">
                    <button type="button" onclick="switchAuthMode('login')" id="loginTab" class="px-6 py-2 rounded-full btn-primary text-white">Login</button>
                    <button type="button" onclick="switchAuthMode('signup')" id="signupTab" class="px-6 py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">Sign Up</button>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                    <input type="text" id="authUsername" placeholder="Enter username" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">PIN (4 digits)</label>
                    <input type="password" id="authPin" placeholder="Enter 4-digit PIN" maxlength="4" pattern="\d{4}" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 text-center tracking-widest">
                </div>
                
                <button type="submit" id="authBtn" class="w-full py-3 rounded-lg btn-primary text-white font-semibold flex items-center justify-center gap-2">
                    <span id="authBtnText">Login</span>
                </button>
                
                <div id="authError" class="text-red-500 text-center hidden bg-red-50 p-3 rounded-lg text-sm"></div>
                
                <div id="authSuccess" class="text-green-600 text-center hidden bg-green-50 p-3 rounded-lg text-sm"></div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden max-w-6xl mx-auto">
        <!-- Header -->
        <div class="glass-card p-6 mb-6">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <i class="fas fa-stethoscope text-4xl text-indigo-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">MedQuiz HNU</h1>
                        <p class="text-gray-600 dark:text-gray-300">Welcome, <span id="userName">Student</span>!</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="toggleDarkMode()" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 transition">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline"></i>
                    </button>
                    
                    <button onclick="logout()" class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Breadcrumb -->
        <div class="glass-card p-4 mb-4 flex items-center gap-2 text-sm flex-wrap">
            <button onclick="navigateToRoot()" class="text-indigo-600 hover:underline font-medium"><i class="fas fa-home mr-1"></i>Home</button>
            <span id="breadcrumb"></span>
        </div>

        <!-- Navigation Tabs -->
        <div class="glass-card p-4 mb-6">
            <div class="flex gap-6 border-b border-gray-200 dark:border-gray-700 overflow-x-auto">
                <button onclick="switchTab('browse')" id="tab-browse" class="tab-active pb-3 px-2 whitespace-nowrap font-medium text-indigo-600 border-b-2 border-indigo-600">
                    <i class="fas fa-folder-open mr-2"></i>Browse
                </button>
                <button onclick="switchTab('favorites')" id="tab-favorites" class="pb-3 px-2 text-gray-600 dark:text-gray-400 whitespace-nowrap hover:text-indigo-600">
                    <i class="fas fa-star mr-2"></i>Favorites
                </button>
                <button onclick="switchTab('mistakes')" id="tab-mistakes" class="pb-3 px-2 text-gray-600 dark:text-gray-400 whitespace-nowrap hover:text-indigo-600">
                    <i class="fas fa-times-circle mr-2 text-red-500"></i>My Mistakes
                </button>
                <button onclick="switchTab('history')" id="tab-history" class="pb-3 px-2 text-gray-600 dark:text-gray-400 whitespace-nowrap hover:text-indigo-600">
                    <i class="fas fa-history mr-2"></i>History
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="glass-card p-4 mb-6">
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Search folders, quizzes, files..." 
                    class="w-full pl-12 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white focus:outline-none focus:border-indigo-500">
            </div>
        </div>

        <!-- Content Area -->
        <div id="contentArea" class="glass-card p-6 min-h-[400px]">
            <div class="flex justify-center items-center h-64">
                <div class="loading-spinner mr-2"></div>
                <span class="text-gray-600">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Quiz Interface -->
    <div id="quizInterface" class="hidden max-w-4xl mx-auto">
        <div class="glass-card p-6 mb-4">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <h2 id="quizTitle" class="text-2xl font-bold"></h2>
                <div class="flex items-center gap-4">
                    <div id="timer" class="timer-display bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded-lg">
                        <i class="fas fa-clock mr-2"></i><span id="timeRemaining">30:00</span>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        Question <span id="currentQNum">1</span> of <span id="totalQNum">0</span>
                    </div>
                </div>
            </div>
            
            <div class="w-full bg-gray-200 rounded-full h-2 mt-4">
                <div id="quizProgress" class="bg-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
            </div>
        </div>

        <div class="glass-card p-6 mb-4" id="questionCard">
            <div class="flex justify-between items-start mb-4">
                <div class="flex gap-2">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-400">
                        <i class="far fa-bookmark text-xl"></i>
                    </button>
                    <button onclick="toggleFlag()" id="flagBtn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-400">
                        <i class="far fa-flag text-xl"></i>
                    </button>
                </div>
                <div class="text-sm text-gray-500">
                    <i class="fas fa-bookmark mr-1 text-yellow-500"></i><span id="bookmarkCount">0</span> bookmarked
                </div>
            </div>
            
            <div id="questionText" class="text-lg mb-6 font-medium leading-relaxed"></div>
            
            <div id="optionsContainer" class="space-y-3">
                <!-- Options loaded dynamically -->
            </div>
            
            <div id="explanationBox" class="hidden mt-6 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg border-l-4 border-blue-500">
                <h4 class="font-bold mb-2"><i class="fas fa-info-circle mr-2"></i>Explanation</h4>
                <p id="explanationText"></p>
            </div>
        </div>

        <div class="glass-card p-4 flex justify-between items-center flex-wrap gap-4">
            <button onclick="previousQuestion()" id="prevBtn" class="px-6 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 transition disabled:opacity-50">
                <i class="fas fa-chevron-left mr-2"></i>Previous
            </button>
            
            <div class="flex gap-2">
                <button onclick="saveProgress()" class="px-4 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 transition">
                    <i class="fas fa-save mr-2"></i>Save
                </button>
                <button onclick="submitQuiz()" class="px-6 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition">
                    <i class="fas fa-check mr-2"></i>Submit
                </button>
            </div>
            
            <button onclick="nextQuestion()" id="nextBtn" class="px-6 py-2 rounded-lg btn-primary text-white transition">
                Next<i class="fas fa-chevron-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="glass-card p-8 w-full max-w-2xl text-center">
            <div class="mb-6">
                <div class="text-6xl mb-4" id="resultEmoji">ðŸŽ‰</div>
                <h2 class="text-3xl font-bold mb-2">Quiz Completed!</h2>
                <p class="text-gray-600 dark:text-gray-400">Here's how you performed</p>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <div class="text-2xl font-bold text-indigo-600" id="scorePercent">0%</div>
                    <div class="text-sm text-gray-600">Score</div>
                </div>
                <div class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" id="correctCount">0</div>
                    <div class="text-sm text-gray-600">Correct</div>
                </div>
                <div class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <div class="text-2xl font-bold text-red-600" id="wrongCount">0</div>
                    <div class="text-sm text-gray-600">Wrong</div>
                </div>
            </div>
            
            <div id="mistakesReview" class="text-left mb-6 max-h-64 overflow-y-auto"></div>
            
            <div class="flex justify-center gap-4 flex-wrap">
                <button onclick="returnToBrowse()" class="px-6 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 transition">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Browse
                </button>
                <button onclick="retakeQuiz()" class="px-6 py-3 rounded-lg btn-primary text-white">
                    <i class="fas fa-redo mr-2"></i>Retake Quiz
                </button>
            </div>
        </div>
    </div>

    <!-- File Viewer Modal -->
    <div id="fileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
                <h3 id="fileTitle" class="text-xl font-bold truncate"></h3>
                <div class="flex gap-2">
                    <a id="downloadBtn" class="px-4 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 transition flex items-center gap-2" download>
                        <i class="fas fa-download"></i>Download
                    </a>
                    <button onclick="closeFileModal()" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="fileViewer" class="flex-1 overflow-auto p-4 bg-gray-100 dark:bg-gray-900">
                <!-- File content -->
            </div>
        </div>
    </div>

    <!-- Calculator -->
    <div class="zoom-controls">
        <button onclick="adjustFontSize(-1)" class="w-10 h-10 rounded-full bg-white dark:bg-gray-800 shadow-lg flex items-center justify-center hover:bg-gray-100 transition" title="Decrease font">
            <i class="fas fa-minus text-sm"></i>
        </button>
        <button onclick="adjustFontSize(1)" class="w-10 h-10 rounded-full bg-white dark:bg-gray-800 shadow-lg flex items-center justify-center hover:bg-gray-100 transition" title="Increase font">
            <i class="fas fa-plus text-sm"></i>
        </button>
    </div>

    <button onclick="toggleCalculator()" class="calc-btn" title="Calculator">
        <i class="fas fa-calculator"></i>
    </button>

    <div id="calculator" class="hidden glass-card p-4">
        <div class="flex justify-between items-center mb-3">
            <span class="font-bold">Calculator</span>
            <button onclick="toggleCalculator()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <input type="text" id="calcDisplay" readonly class="w-full p-3 mb-3 text-right text-xl bg-gray-100 dark:bg-gray-800 rounded border-none">
        <div class="grid grid-cols-4 gap-2">
            <button onclick="calcInput('C')" class="p-3 rounded bg-red-100 text-red-600 hover:bg-red-200 font-bold">C</button>
            <button onclick="calcInput('/')" class="p-3 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300">Ã·</button>
            <button onclick="calcInput('*')" class="p-3 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300">Ã—</button>
            <button onclick="calcInput('-')" class="p-3 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300">âˆ’</button>
            <button onclick="calcInput('7')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">7</button>
            <button onclick="calcInput('8')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">8</button>
            <button onclick="calcInput('9')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">9</button>
            <button onclick="calcInput('+')" class="p-3 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300">+</button>
            <button onclick="calcInput('4')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">4</button>
            <button onclick="calcInput('5')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">5</button>
            <button onclick="calcInput('6')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">6</button>
            <button onclick="calcInput('=')" class="p-3 rounded btn-primary text-white row-span-2 font-bold">=</button>
            <button onclick="calcInput('1')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">1</button>
            <button onclick="calcInput('2')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">2</button>
            <button onclick="calcInput('3')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">3</button>
            <button onclick="calcInput('0')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 col-span-2">0</button>
            <button onclick="calcInput('.')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">.</button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB001YxSS9iQ6PArK1VHf0lIlpLyP1Rqew",
            authDomain: "medquiz-hnu.firebaseapp.com",
            projectId: "medquiz-hnu",
            storageBucket: "medquiz-hnu.firebasestorage.app",
            messagingSenderId: "862221476635",
            appId: "1:862221476635:web:369ca0e1f3b22b3eac29be",
            measurementId: "G-4T9XPB89N7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global State
        let currentUser = null;
        let currentPath = [];
        let currentQuiz = null;
        let quizState = {
            questions: [],
            currentIndex: 0,
            answers: {},
            bookmarks: new Set(),
            flagged: new Set(),
            timerInterval: null,
            timeRemaining: 1800
        };
        let fontSize = 16;
        let currentTab = 'browse';
        let authMode = 'login';

        // ==================== AUTH FUNCTIONS ====================

        function switchAuthMode(mode) {
            authMode = mode;
            document.getElementById('loginTab').className = mode === 'login' ? 
                'px-6 py-2 rounded-full btn-primary text-white' : 'px-6 py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300';
            document.getElementById('signupTab').className = mode === 'signup' ? 
                'px-6 py-2 rounded-full btn-primary text-white' : 'px-6 py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300';
            document.getElementById('authBtnText').textContent = mode === 'login' ? 'Login' : 'Sign Up';
            
            // Clear messages
            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authSuccess').classList.add('hidden');
        }

        async function handleAuth() {
            const username = document.getElementById('authUsername').value.trim().toLowerCase();
            const pin = document.getElementById('authPin').value;
            const btn = document.getElementById('authBtn');
            const errorDiv = document.getElementById('authError');
            const successDiv = document.getElementById('authSuccess');
            
            // Reset messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validation
            if (!username || username.length < 3) {
                showAuthError('Username must be at least 3 characters');
                return;
            }
            if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                showAuthError('PIN must be exactly 4 digits');
                return;
            }
            
            // Show loading
            btn.disabled = true;
            const originalText = document.getElementById('authBtnText').textContent;
            document.getElementById('authBtnText').innerHTML = '<span class="loading-spinner"></span> Please wait...';
            
            try {
                if (authMode === 'login') {
                    await loginUser(username, pin);
                } else {
                    await signupUser(username, pin);
                }
            } catch (error) {
                console.error('Auth error:', error);
                showAuthError('Connection error. Please try again.');
            } finally {
                btn.disabled = false;
                document.getElementById('authBtnText').textContent = originalText;
            }
        }

        async function loginUser(username, pin) {
            try {
                // Check if user exists
                const userDoc = await db.collection('students').doc(username).get();
                
                if (!userDoc.exists) {
                    showAuthError('User not found. Please sign up first.');
                    return;
                }
                
                const userData = userDoc.data();
                
                // Verify PIN (in production, use proper hashing)
                if (userData.pin !== pin) {
                    showAuthError('Incorrect PIN. Please try again.');
                    return;
                }
                
                // Success
                currentUser = {
                    username: username,
                    data: userData
                };
                
                // Update last login
                await db.collection('students').doc(username).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                enterApp();
                
            } catch (error) {
                console.error('Login error:', error);
                showAuthError('Login failed. Please try again.');
            }
        }

        async function signupUser(username, pin) {
            try {
                // Check if username already exists
                const existingDoc = await db.collection('students').doc(username).get();
                
                if (existingDoc.exists) {
                    showAuthError('Username already taken. Please choose another.');
                    return;
                }
                
                // Create new user
                await db.collection('students').doc(username).set({
                    username: username,
                    pin: pin, // In production, hash this!
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    favorites: [],
                    mistakes: [],
                    history: []
                });
                
                // Success
                currentUser = {
                    username: username,
                    data: {
                        username: username,
                        favorites: [],
                        mistakes: [],
                        history: []
                    }
                };
                
                showAuthSuccess('Account created successfully! Logging in...');
                
                setTimeout(() => {
                    enterApp();
                }, 1500);
                
            } catch (error) {
                console.error('Signup error:', error);
                showAuthError('Failed to create account. Please try again.');
            }
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function showAuthSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
        }

        function enterApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.username;
            
            // Clear form
            document.getElementById('authUsername').value = '';
            document.getElementById('authPin').value = '';
            
            navigateToRoot();
        }

        function logout() {
            currentUser = null;
            currentPath = [];
            if (quizState.timerInterval) {
                clearInterval(quizState.timerInterval);
            }
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('quizInterface').classList.add('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Reset auth form
            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authSuccess').classList.add('hidden');
        }

        // ==================== NAVIGATION ====================

        function navigateToRoot() {
            currentPath = [];
            updateBreadcrumb();
            loadContent();
        }

        function navigateToFolder(folderId, folderName) {
            currentPath.push({ id: folderId, name: folderName });
            updateBreadcrumb();
            loadContent();
        }

        function navigateUp(index) {
            currentPath = currentPath.slice(0, index + 1);
            updateBreadcrumb();
            loadContent();
        }

        function updateBreadcrumb() {
            let html = '';
            currentPath.forEach((folder, index) => {
                html += ` <span class="text-gray-400">/</span> 
                    <button onclick="navigateUp(${index})" class="text-indigo-600 hover:underline font-medium">${folder.name}</button>`;
            });
            document.getElementById('breadcrumb').innerHTML = html;
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Update UI
            ['browse', 'favorites', 'mistakes', 'history'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === tab) {
                    btn.className = 'pb-3 px-2 whitespace-nowrap font-medium text-indigo-600 border-b-2 border-indigo-600';
                } else {
                    btn.className = 'pb-3 px-2 text-gray-600 dark:text-gray-400 whitespace-nowrap hover:text-indigo-600';
                }
            });
            
            loadContent();
        }

        // ==================== CONTENT LOADING ====================

        async function loadContent() {
            const container = document.getElementById('contentArea');
            container.innerHTML = '<div class="flex justify-center items-center h-64"><div class="loading-spinner mr-2"></div><span>Loading...</span></div>';
            
            try {
                if (currentTab === 'browse') {
                    await loadBrowseContent(container);
                } else if (currentTab === 'favorites') {
                    await loadFavorites(container);
                } else if (currentTab === 'mistakes') {
                    await loadMistakes(container);
                } else if (currentTab === 'history') {
                    await loadHistory(container);
                }
            } catch (error) {
                console.error('Error loading content:', error);
                container.innerHTML = `<div class="text-center text-red-500 p-8">Error: ${error.message}</div>`;
            }
        }

        async function loadBrowseContent(container) {
            try {
                let query = db.collection('folders');
                
                if (currentPath.length === 0) {
                    query = query.where('parentId', '==', null);
                } else {
                    query = query.where('parentId', '==', currentPath[currentPath.length - 1].id);
                }
                
                const snapshot = await query.get();
                
                if (snapshot.empty && currentPath.length > 0) {
                    await loadFolderContents(container);
                    return;
                }
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 fade-in">';
                
                snapshot.forEach(doc => {
                    const folder = doc.data();
                    html += `
                        <div onclick="navigateToFolder('${doc.id}', '${folder.name}')" 
                            class="folder-card glass-card p-6 cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/20 border-2 border-transparent hover:border-indigo-200 dark:hover:border-indigo-800">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-folder text-3xl text-indigo-600"></i>
                                </div>
                                <div class="min-w-0">
                                    <h3 class="font-bold text-lg truncate">${folder.name}</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${folder.description || 'Click to open'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                throw error;
            }
        }

        async function loadFolderContents(container) {
            const currentFolderId = currentPath[currentPath.length - 1].id;
            
            try {
                // Get quizzes and files in parallel
                const [quizzesSnap, filesSnap] = await Promise.all([
                    db.collection('quizzes').where('folderId', '==', currentFolderId).get(),
                    db.collection('files').where('folderId', '==', currentFolderId).get()
                ]);
                
                let html = '<div class="space-y-6 fade-in">';
                
                // Quizzes Section
                if (!quizzesSnap.empty) {
                    html += '<div><h3 class="text-xl font-bold mb-4 flex items-center text-green-600"><i class="fas fa-question-circle mr-2"></i>Quizzes</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                    
                    quizzesSnap.forEach(doc => {
                        const quiz = doc.data();
                        html += `
                            <div onclick="startQuiz('${doc.id}')" 
                                class="folder-card glass-card p-5 cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 border-l-4 border-green-500">
                                <div class="flex justify-between items-start">
                                    <div class="min-w-0">
                                        <h4 class="font-bold text-lg truncate">${quiz.title}</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${quiz.questionCount || 0} questions â€¢ ${quiz.duration || 30} mins</p>
                                    </div>
                                    <i class="fas fa-play-circle text-3xl text-green-500 flex-shrink-0"></i>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
                
                // Files Section
                if (!filesSnap.empty) {
                    html += '<div><h3 class="text-xl font-bold mb-4 flex items-center text-orange-600"><i class="fas fa-file mr-2"></i>Files</h3><div class="space-y-2">';
                    
                    filesSnap.forEach(doc => {
                        const file = doc.data();
                        const icon = getFileIcon(file.type);
                        html += `
                            <div onclick="viewFile('${doc.id}', '${escapeHtml(file.name)}', '${file.url}', '${file.type}')" 
                                class="flex items-center gap-4 p-4 rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition border border-gray-200 dark:border-gray-700">
                                <i class="${icon} text-2xl text-orange-500 flex-shrink-0"></i>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-medium truncate">${file.name}</h4>
                                    <p class="text-sm text-gray-500">${file.size || 'Unknown size'}</p>
                                </div>
                                <i class="fas fa-chevron-right text-gray-400 flex-shrink-0"></i>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
                
                if (quizzesSnap.empty && filesSnap.empty) {
                    html += '<div class="text-center text-gray-500 py-12"><i class="fas fa-folder-open text-5xl mb-4 text-gray-300"></i><p class="text-lg">This folder is empty</p></div>';
                }
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                throw error;
            }
        }

        function getFileIcon(type) {
            if (!type) return 'fas fa-file';
            if (type.includes('pdf')) return 'fas fa-file-pdf text-red-500';
            if (type.includes('word') || type.includes('document')) return 'fas fa-file-word text-blue-500';
            if (type.includes('powerpoint') || type.includes('presentation')) return 'fas fa-file-powerpoint text-orange-500';
            if (type.includes('image')) return 'fas fa-file-image text-purple-500';
            return 'fas fa-file text-gray-500';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== QUIZ FUNCTIONS ====================

        async function startQuiz(quizId) {
            try {
                const quizDoc = await db.collection('quizzes').doc(quizId).get();
                if (!quizDoc.exists) {
                    alert('Quiz not found!');
                    return;
                }
                
                const quizData = quizDoc.data();
                const questionsSnapshot = await db.collection('quizzes').doc(quizId).collection('questions').get();
                
                if (questionsSnapshot.empty) {
                    alert('No questions found in this quiz!');
                    return;
                }
                
                currentQuiz = { id: quizId, ...quizData };
                quizState.questions = [];
                quizState.answers = {};
                quizState.bookmarks.clear();
                quizState.flagged.clear();
                quizState.currentIndex = 0;
                quizState.timeRemaining = (quizData.duration || 30) * 60;
                
                questionsSnapshot.forEach(doc => {
                    quizState.questions.push({ id: doc.id, ...doc.data() });
                });
                
                // Shuffle questions if enabled
                if (quizData.shuffle !== false) {
                    quizState.questions.sort(() => Math.random() - 0.5);
                }
                
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('quizInterface').classList.remove('hidden');
                document.getElementById('quizTitle').textContent = quizData.title;
                document.getElementById('totalQNum').textContent = quizState.questions.length;
                
                startTimer();
                displayQuestion();
                
            } catch (error) {
                console.error('Error starting quiz:', error);
                alert('Error starting quiz. Please try again.');
            }
        }

        function startTimer() {
            updateTimerDisplay();
            quizState.timerInterval = setInterval(() => {
                quizState.timeRemaining--;
                updateTimerDisplay();
                
                if (quizState.timeRemaining <= 0) {
                    submitQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(quizState.timeRemaining / 60);
            const seconds = quizState.timeRemaining % 60;
            const display = document.getElementById('timeRemaining');
            display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerDiv = document.getElementById('timer');
            if (quizState.timeRemaining < 300) {
                timerDiv.classList.add('timer-warning');
            } else {
                timerDiv.classList.remove('timer-warning');
            }
        }

        function displayQuestion() {
            const q = quizState.questions[quizState.currentIndex];
            
            document.getElementById('currentQNum').textContent = quizState.currentIndex + 1;
            document.getElementById('questionText').innerHTML = escapeHtml(q.text);
            document.getElementById('bookmarkCount').textContent = quizState.bookmarks.size;
            
            // Update progress
            const progress = ((quizState.currentIndex + 1) / quizState.questions.length) * 100;
            document.getElementById('quizProgress').style.width = `${progress}%`;
            
            // Update bookmark/flag buttons
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const flagBtn = document.getElementById('flagBtn');
            
            bookmarkBtn.innerHTML = `<i class="${quizState.bookmarks.has(q.id) ? 'fas text-yellow-500' : 'far text-gray-400'} fa-bookmark text-xl"></i>`;
            flagBtn.innerHTML = `<i class="${quizState.flagged.has(q.id) ? 'fas text-red-500' : 'far text-gray-400'} fa-flag text-xl"></i>`;
            
            // Generate options
            let optionsHtml = '';
            const labels = ['A', 'B', 'C', 'D', 'E'];
            
            q.options.forEach((opt, idx) => {
                if (!opt) return;
                const isSelected = quizState.answers[q.id] === idx;
                optionsHtml += `
                    <div onclick="selectAnswer(${idx})" 
                        class="p-4 rounded-lg border-2 cursor-pointer transition ${isSelected ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30' : 'border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800'}">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full ${isSelected ? 'bg-indigo-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'} flex items-center justify-center font-bold text-sm">
                                ${labels[idx]}
                            </div>
                            <span class="flex-1">${escapeHtml(opt)}</span>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('optionsContainer').innerHTML = optionsHtml;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = quizState.currentIndex === 0;
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.innerHTML = quizState.currentIndex === quizState.questions.length - 1 ? 
                'Finish<i class="fas fa-check ml-2"></i>' : 'Next<i class="fas fa-chevron-right ml-2"></i>';
        }

        function selectAnswer(index) {
            const q = quizState.questions[quizState.currentIndex];
            quizState.answers[q.id] = index;
            displayQuestion();
        }

        function previousQuestion() {
            if (quizState.currentIndex > 0) {
                quizState.currentIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (quizState.currentIndex < quizState.questions.length - 1) {
                quizState.currentIndex++;
                displayQuestion();
            } else {
                submitQuiz();
            }
        }

        function toggleBookmark() {
            const q = quizState.questions[quizState.currentIndex];
            if (quizState.bookmarks.has(q.id)) {
                quizState.bookmarks.delete(q.id);
            } else {
                quizState.bookmarks.add(q.id);
            }
            displayQuestion();
        }

        function toggleFlag() {
            const q = quizState.questions[quizState.currentIndex];
            if (quizState.flagged.has(q.id)) {
                quizState.flagged.delete(q.id);
            } else {
                quizState.flagged.add(q.id);
            }
            displayQuestion();
        }

        async function saveProgress() {
            if (!currentUser) return;
            
            try {
                await db.collection('students').doc(currentUser.username).collection('savedProgress').doc(currentQuiz.id).set({
                    quizId: currentQuiz.id,
                    answers: quizState.answers,
                    bookmarks: Array.from(quizState.bookmarks),
                    flagged: Array.from(quizState.flagged),
                    currentIndex: quizState.currentIndex,
                    timeRemaining: quizState.timeRemaining,
                    savedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Progress saved!', 'success');
            } catch (error) {
                showNotification('Failed to save progress', 'error');
            }
        }

        async function submitQuiz() {
            clearInterval(quizState.timerInterval);
            
            let correct = 0;
            let wrong = 0;
            const mistakes = [];
            
            quizState.questions.forEach(q => {
                const userAnswer = quizState.answers[q.id];
                if (userAnswer === q.correctAnswer) {
                    correct++;
                } else {
                    wrong++;
                    mistakes.push({
                        question: q.text,
                        yourAnswer: userAnswer !== undefined ? q.options[userAnswer] : 'Not answered',
                        correctAnswer: q.options[q.correctAnswer],
                        explanation: q.explanation || 'No explanation provided'
                    });
                }
            });
            
            const score = Math.round((correct / quizState.questions.length) * 100);
            
            // Save to history
            try {
                await db.collection('students').doc(currentUser.username).collection('history').add({
                    quizId: currentQuiz.id,
                    quizTitle: currentQuiz.title,
                    score: score,
                    correct: correct,
                    wrong: wrong,
                    total: quizState.questions.length,
                    completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    timeSpent: ((currentQuiz.duration || 30) * 60) - quizState.timeRemaining
                });
                
                // Save mistakes
                if (mistakes.length > 0) {
                    const userRef = db.collection('students').doc(currentUser.username);
                    const existingMistakes = currentUser.data.mistakes || [];
                    const newMistakes = [...existingMistakes, ...mistakes].slice(-20); // Keep last 20
                    await userRef.update({ mistakes: newMistakes });
                    currentUser.data.mistakes = newMistakes;
                }
            } catch (error) {
                console.error('Error saving results:', error);
            }
            
            showResults(score, correct, wrong, mistakes);
        }

        function showResults(score, correct, wrong, mistakes) {
            document.getElementById('quizInterface').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            document.getElementById('scorePercent').textContent = `${score}%`;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
            
            const emoji = score >= 80 ? 'ðŸŽ‰' : score >= 60 ? 'ðŸ˜Š' : score >= 40 ? 'ðŸ˜' : 'ðŸ˜¢';
            document.getElementById('resultEmoji').textContent = emoji;
            
            let mistakesHtml = '';
            if (mistakes.length > 0) {
                mistakesHtml = '<h4 class="font-bold mb-3">Review Mistakes:</h4>';
                mistakes.forEach((m, idx) => {
                    mistakesHtml += `
                        <div class="mb-4 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border-l-4 border-red-500">
                            <p class="font-medium mb-2">${idx + 1}. ${escapeHtml(m.question)}</p>
                            <p class="text-sm text-red-600 dark:text-red-400">Your answer: ${escapeHtml(m.yourAnswer)}</p>
                            <p class="text-sm text-green-600 dark:text-green-400">Correct answer: ${escapeHtml(m.correctAnswer)}</p>
                            ${m.explanation ? `<p class="text-sm text-gray-600 mt-2"><i class="fas fa-info-circle mr-1"></i>${escapeHtml(m.explanation)}</p>` : ''}
                        </div>
                    `;
                });
            } else {
                mistakesHtml = '<div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg text-center"><i class="fas fa-check-circle text-green-500 text-3xl mb-2"></i><p class="font-bold">Perfect score! No mistakes!</p></div>';
            }
            
            document.getElementById('mistakesReview').innerHTML = mistakesHtml;
        }

        function returnToBrowse() {
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadContent();
        }

        function retakeQuiz() {
            startQuiz(currentQuiz.id);
            document.getElementById('resultsScreen').classList.add('hidden');
        }

        // ==================== OTHER TABS ====================

        async function loadFavorites(container) {
            const favorites = currentUser.data.favorites || [];
            
            if (favorites.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12"><i class="fas fa-star text-5xl mb-4 text-gray-300"></i><p class="text-lg">No favorites yet</p><p class="text-sm text-gray-400">Bookmark questions during quizzes to see them here</p></div>';
                return;
            }
            
            container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mr-2"></div>Loading...</div>';
        }

        async function loadMistakes(container) {
            const mistakes = currentUser.data.mistakes || [];
            
            if (mistakes.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12"><i class="fas fa-check-circle text-5xl mb-4 text-green-300"></i><p class="text-lg">No mistakes recorded!</p><p class="text-sm text-gray-400">Great job! Keep it up!</p></div>';
                return;
            }
            
            let html = '<div class="space-y-4 fade-in">';
            mistakes.slice().reverse().forEach((m, idx) => {
                html += `
                    <div class="glass-card p-4 border-l-4 border-red-500">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm text-gray-500">Mistake #${mistakes.length - idx}</span>
                        </div>
                        <p class="font-medium mb-2">${escapeHtml(m.question)}</p>
                        <p class="text-sm text-red-600 dark:text-red-400 mb-1"><i class="fas fa-times mr-1"></i>Your answer: ${escapeHtml(m.yourAnswer)}</p>
                        <p class="text-sm text-green-600 dark:text-green-400"><i class="fas fa-check mr-1"></i>Correct: ${escapeHtml(m.correctAnswer)}</p>
                        ${m.explanation ? `<p class="text-sm text-gray-600 mt-2 bg-gray-50 dark:bg-gray-800 p-2 rounded">${escapeHtml(m.explanation)}</p>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        async function loadHistory(container) {
            try {
                const historySnapshot = await db.collection('students')
                    .doc(currentUser.username)
                    .collection('history')
                    .orderBy('completedAt', 'desc')
                    .get();
                
                if (historySnapshot.empty) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-12"><i class="fas fa-history text-5xl mb-4 text-gray-300"></i><p class="text-lg">No history yet</p><p class="text-sm text-gray-400">Take some quizzes to see your progress</p></div>';
                    return;
                }
                
                let html = '<div class="space-y-4 fade-in">';
                historySnapshot.forEach(doc => {
                    const h = doc.data();
                    const date = h.completedAt ? new Date(h.completedAt.toDate()).toLocaleDateString() : 'Unknown';
                    const scoreColor = h.score >= 80 ? 'text-green-600 bg-green-100 dark:bg-green-900/30' : 
                                      h.score >= 60 ? 'text-yellow-600 bg-yellow-100 dark:bg-yellow-900/30' : 
                                      'text-red-600 bg-red-100 dark:bg-red-900/30';
                    
                    html += `
                        <div class="glass-card p-4 flex justify-between items-center hover:shadow-lg transition">
                            <div class="min-w-0 flex-1">
                                <h4 class="font-bold truncate">${h.quizTitle}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${date}</p>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-2xl font-bold ${scoreColor.split(' ')[0]} px-3 py-1 rounded-full">${h.score}%</div>
                                <div class="text-sm text-gray-500 mt-1">${h.correct}/${h.total} correct</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `<div class="text-center text-red-500 py-8">Error loading history: ${error.message}</div>`;
            }
        }

        // ==================== SEARCH & FILES ====================

        async function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!query) {
                loadContent();
                return;
            }
            
            const container = document.getElementById('contentArea');
            container.innerHTML = '<div class="flex justify-center p-8"><div class="loading-spinner mr-2"></div>Searching...</div>';
            
            try {
                // Search folders
                const foldersSnapshot = await db.collection('folders').get();
                const matchingFolders = [];
                foldersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.name.toLowerCase().includes(query)) {
                        matchingFolders.push({ id: doc.id, ...data });
                    }
                });
                
                // Search quizzes
                const quizzesSnapshot = await db.collection('quizzes').get();
                const matchingQuizzes = [];
                quizzesSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.title.toLowerCase().includes(query)) {
                        matchingQuizzes.push({ id: doc.id, ...data });
                    }
                });
                
                let html = '<div class="space-y-6 fade-in">';
                
                if (matchingFolders.length > 0) {
                    html += '<div><h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-folder text-indigo-600 mr-2"></i>Folders</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                    matchingFolders.forEach(folder => {
                        html += `
                            <div onclick="navigateToFolder('${folder.id}', '${escapeHtml(folder.name)}')" 
                                class="folder-card glass-card p-4 cursor-pointer hover:bg-indigo-50">
                                <i class="fas fa-folder text-2xl text-indigo-600 mr-3"></i>
                                <span class="font-medium">${escapeHtml(folder.name)}</span>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }
                
                if (matchingQuizzes.length > 0) {
                    html += '<div><h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-question-circle text-green-600 mr-2"></i>Quizzes</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                    matchingQuizzes.forEach(quiz => {
                        html += `
                            <div onclick="startQuiz('${quiz.id}')" 
                                class="folder-card glass-card p-4 cursor-pointer border-l-4 border-green-500 hover:bg-green-50">
                                <i class="fas fa-play-circle text-2xl text-green-600 mr-3"></i>
                                <span class="font-medium">${escapeHtml(quiz.title)}</span>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }
                
                if (matchingFolders.length === 0 && matchingQuizzes.length === 0) {
                    html += '<div class="text-center text-gray-500 py-12"><i class="fas fa-search text-5xl mb-4 text-gray-300"></i><p class="text-lg">No results found</p><p class="text-sm text-gray-400">Try different keywords</p></div>';
                }
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `<div class="text-center text-red-500 py-8">Search error: ${error.message}</div>`;
            }
        }

        function viewFile(id, name, url, type) {
            document.getElementById('fileTitle').textContent = name;
            document.getElementById('downloadBtn').href = url;
            
            const viewer = document.getElementById('fileViewer');
            
            if (type && type.includes('pdf')) {
                viewer.innerHTML = `<iframe src="${url}" class="w-full h-full min-h-[600px]" frameborder="0"></iframe>`;
            } else if (type && type.includes('image')) {
                viewer.innerHTML = `<img src="${url}" class="max-w-full mx-auto rounded shadow-lg" style="max-height: 80vh;">`;
            } else {
                viewer.innerHTML = `
                    <div class="text-center p-8">
                        <i class="fas fa-file text-6xl text-gray-400 mb-4"></i>
                        <p class="text-lg mb-4">Preview not available for this file type</p>
                        <a href="${url}" download class="inline-block px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            <i class="fas fa-download mr-2"></i>Download File
                        </a>
                    </div>
                `;
            }
            
            document.getElementById('fileModal').classList.remove('hidden');
        }

        function closeFileModal() {
            document.getElementById('fileModal').classList.add('hidden');
            document.getElementById('fileViewer').innerHTML = '';
        }

        // ==================== UTILITIES ====================

        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            const colors = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            notif.className = `fixed top-4 right-4 ${colors} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in flex items-center gap-2 max-w-sm`;
            notif.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.opacity = '0';
                notif.style.transform = 'translateY(-20px)';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        function adjustFontSize(delta) {
            fontSize += delta;
            if (fontSize < 12) fontSize = 12;
            if (fontSize > 24) fontSize = 24;
            document.body.style.fontSize = `${fontSize}px`;
            localStorage.setItem('fontSize', fontSize);
        }

        // Restore font size
        const savedFontSize = localStorage.getItem('fontSize');
        if (savedFontSize) {
            fontSize = parseInt(savedFontSize);
            document.body.style.fontSize = `${fontSize}px`;
        }

        let calcExpression = '';
        function toggleCalculator() {
            document.getElementById('calculator').classList.toggle('hidden');
        }

        function calcInput(val) {
            const display = document.getElementById('calcDisplay');
            
            if (val === 'C') {
                calcExpression = '';
                display.value = '';
            } else if (val === '=') {
                try {
                    calcExpression = eval(calcExpression).toString();
                    display.value = calcExpression;
                } catch {
                    display.value = 'Error';
                    calcExpression = '';
                }
            } else {
                calcExpression += val;
                display.value = calcExpression;
            }
        }

        // Close modals on outside click
        window.onclick = function(event) {
            const fileModal = document.getElementById('fileModal');
            if (event.target === fileModal) {
                closeFileModal();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFileModal();
            }
        });
    </script>
</body>
</html>
