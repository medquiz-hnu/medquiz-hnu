<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedQuiz HNU - Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-auth.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-firestore.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-storage.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .dark-mode .glass-card {
            background: rgba(30, 30, 46, 0.95);
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .folder-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .folder-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .quiz-option {
            transition: all 0.2s ease;
        }
        
        .quiz-option:hover {
            background-color: #f3f4f6;
        }
        
        .dark-mode .quiz-option:hover {
            background-color: #2d2d44;
        }
        
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .hidden { display: none !important; }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .bookmark-btn {
            transition: all 0.2s ease;
        }
        
        .bookmark-btn.active {
            color: #fbbf24;
        }
        
        .flag-btn.active {
            color: #ef4444;
        }
        
        #calculator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 280px;
            z-index: 1000;
        }
        
        .calc-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .file-item {
            transition: all 0.2s ease;
        }
        
        .file-item:hover {
            background-color: #f3f4f6;
        }
        
        .dark-mode .file-item:hover {
            background-color: #2d2d44;
        }
        
        .tab-active {
            border-bottom: 3px solid #667eea;
            color: #667eea;
            font-weight: 600;
        }
        
        .dark-mode .tab-active {
            border-bottom-color: #a78bfa;
            color: #a78bfa;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .timer-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .timer-warning {
            color: #ef4444;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="p-4">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="glass-card p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-stethoscope text-6xl text-indigo-600 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">MedQuiz HNU</h1>
                <p class="text-gray-600 mt-2">Medical Quiz Platform</p>
            </div>
            
            <div class="space-y-4">
                <div class="flex justify-center space-x-4 mb-6">
                    <button onclick="switchAuthMode('login')" id="loginTab" class="px-6 py-2 rounded-full btn-primary text-white">Login</button>
                    <button onclick="switchAuthMode('signup')" id="signupTab" class="px-6 py-2 rounded-full bg-gray-200 text-gray-700">Sign Up</button>
                </div>
                
                <input type="text" id="authUsername" placeholder="Username" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-indigo-500">
                <input type="password" id="authPin" placeholder="PIN (4 digits)" maxlength="4" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-indigo-500">
                
                <button onclick="handleAuth()" class="w-full py-3 rounded-lg btn-primary text-white font-semibold">
                    <span id="authBtnText">Login</span>
                </button>
                
                <div id="authError" class="text-red-500 text-center hidden"></div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden max-w-6xl mx-auto">
        <!-- Header -->
        <div class="glass-card p-6 mb-6">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <i class="fas fa-stethoscope text-4xl text-indigo-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">MedQuiz HNU</h1>
                        <p class="text-gray-600 dark:text-gray-300">Welcome, <span id="userName">Student</span>!</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="toggleDarkMode()" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 transition">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline"></i>
                        <span class="ml-2 dark:hidden">Dark Mode</span>
                        <span class="ml-2 hidden dark:inline">Light Mode</span>
                    </button>
                    
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 transition relative">
                            <i class="fas fa-bell"></i>
                            <span id="notifBadge" class="notification-badge hidden">0</span>
                        </button>
                        <div id="notificationsPanel" class="hidden absolute right-0 mt-2 w-80 glass-card p-4 z-50 max-h-96 overflow-y-auto">
                            <h3 class="font-bold mb-3">Notifications</h3>
                            <div id="notificationsList"></div>
                        </div>
                    </div>
                    
                    <button onclick="logout()" class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Breadcrumb -->
        <div class="glass-card p-4 mb-4 flex items-center gap-2 text-sm">
            <button onclick="navigateToRoot()" class="text-indigo-600 hover:underline"><i class="fas fa-home"></i> Home</button>
            <span id="breadcrumb"></span>
        </div>

        <!-- Navigation Tabs -->
        <div class="glass-card p-4 mb-6">
            <div class="flex gap-6 border-b border-gray-200 dark:border-gray-700 overflow-x-auto">
                <button onclick="switchTab('browse')" id="tab-browse" class="tab-active pb-3 px-2 whitespace-nowrap">
                    <i class="fas fa-folder-open mr-2"></i>Browse
                </button>
                <button onclick="switchTab('favorites')" id="tab-favorites" class="pb-3 px-2 text-gray-600 dark:text-gray-400 whitespace-nowrap">
                    <i class="fas fa-star mr-2"></i>Favorites
                </button>
                <button onclick="switchTab('mistakes')" id="tab-mistakes" class="pb-3 px-2 text-gray-600 dark:text-gray-400 whitespace-nowrap">
                    <i class="fas fa-times-circle mr-2 text-red-500"></i>My Mistakes
                </button>
                <button onclick="switchTab('history')" id="tab-history" class="pb-3 px-2 text-gray-600 dark:text-gray-400 whitespace-nowrap">
                    <i class="fas fa-history mr-2"></i>History
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="glass-card p-4 mb-6">
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Search folders, quizzes, files..." 
                    class="w-full pl-12 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white focus:outline-none focus:border-indigo-500">
            </div>
        </div>

        <!-- Content Area -->
        <div id="contentArea" class="glass-card p-6 min-h-[400px]">
            <!-- Dynamic content loaded here -->
        </div>
    </div>

    <!-- Quiz Interface -->
    <div id="quizInterface" class="hidden max-w-4xl mx-auto">
        <div class="glass-card p-6 mb-4">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <h2 id="quizTitle" class="text-2xl font-bold"></h2>
                <div class="flex items-center gap-4">
                    <div id="timer" class="timer-display bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded-lg">
                        <i class="fas fa-clock mr-2"></i><span id="timeRemaining">30:00</span>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        Question <span id="currentQNum">1</span> of <span id="totalQNum">0</span>
                    </div>
                </div>
            </div>
            
            <div class="progress-bar mt-4">
                <div id="quizProgress" class="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <div class="glass-card p-6 mb-4" id="questionCard">
            <div class="flex justify-between items-start mb-4">
                <div class="flex gap-2">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="bookmark-btn p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="far fa-bookmark text-xl"></i>
                    </button>
                    <button onclick="toggleFlag()" id="flagBtn" class="flag-btn p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600">
                        <i class="far fa-flag text-xl"></i>
                    </button>
                </div>
                <div class="text-sm text-gray-500">
                    <i class="fas fa-bookmark mr-1"></i><span id="bookmarkCount">0</span> bookmarked
                </div>
            </div>
            
            <div id="questionText" class="text-lg mb-6 font-medium"></div>
            
            <div id="optionsContainer" class="space-y-3">
                <!-- Options loaded dynamically -->
            </div>
            
            <div id="explanationBox" class="hidden mt-6 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg border-l-4 border-blue-500">
                <h4 class="font-bold mb-2"><i class="fas fa-info-circle mr-2"></i>Explanation</h4>
                <p id="explanationText"></p>
            </div>
        </div>

        <div class="glass-card p-4 flex justify-between items-center">
            <button onclick="previousQuestion()" id="prevBtn" class="px-6 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 transition disabled:opacity-50">
                <i class="fas fa-chevron-left mr-2"></i>Previous
            </button>
            
            <div class="flex gap-2">
                <button onclick="saveProgress()" class="px-4 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 transition">
                    <i class="fas fa-save mr-2"></i>Save
                </button>
                <button onclick="submitQuiz()" class="px-6 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition">
                    <i class="fas fa-check mr-2"></i>Submit
                </button>
            </div>
            
            <button onclick="nextQuestion()" id="nextBtn" class="px-6 py-2 rounded-lg btn-primary text-white transition">
                Next<i class="fas fa-chevron-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" class="hidden min-h-screen flex items-center justify-center">
        <div class="glass-card p-8 w-full max-w-2xl text-center">
            <div class="mb-6">
                <div class="text-6xl mb-4" id="resultEmoji">ðŸŽ‰</div>
                <h2 class="text-3xl font-bold mb-2">Quiz Completed!</h2>
                <p class="text-gray-600 dark:text-gray-400">Here's how you performed</p>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <div class="text-2xl font-bold text-indigo-600" id="scorePercent">0%</div>
                    <div class="text-sm text-gray-600">Score</div>
                </div>
                <div class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" id="correctCount">0</div>
                    <div class="text-sm text-gray-600">Correct</div>
                </div>
                <div class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <div class="text-2xl font-bold text-red-600" id="wrongCount">0</div>
                    <div class="text-sm text-gray-600">Wrong</div>
                </div>
            </div>
            
            <div id="mistakesReview" class="text-left mb-6 max-h-64 overflow-y-auto"></div>
            
            <div class="flex justify-center gap-4">
                <button onclick="returnToBrowse()" class="px-6 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 transition">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Browse
                </button>
                <button onclick="retakeQuiz()" class="px-6 py-3 rounded-lg btn-primary text-white">
                    <i class="fas fa-redo mr-2"></i>Retake Quiz
                </button>
            </div>
        </div>
    </div>

    <!-- File Viewer Modal -->
    <div id="fileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
                <h3 id="fileTitle" class="text-xl font-bold"></h3>
                <div class="flex gap-2">
                    <a id="downloadBtn" class="px-4 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 transition" download>
                        <i class="fas fa-download mr-2"></i>Download
                    </a>
                    <button onclick="closeFileModal()" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="fileViewer" class="flex-1 overflow-auto p-4 bg-gray-100 dark:bg-gray-900">
                <!-- File content -->
            </div>
        </div>
    </div>

    <!-- Calculator -->
    <div class="zoom-controls flex gap-2">
        <button onclick="adjustFontSize(-1)" class="w-10 h-10 rounded-full bg-white dark:bg-gray-800 shadow-lg flex items-center justify-center hover:bg-gray-100">
            <i class="fas fa-minus"></i>
        </button>
        <button onclick="adjustFontSize(1)" class="w-10 h-10 rounded-full bg-white dark:bg-gray-800 shadow-lg flex items-center justify-center hover:bg-gray-100">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <button onclick="toggleCalculator()" class="calc-btn">
        <i class="fas fa-calculator"></i>
    </button>

    <div id="calculator" class="hidden glass-card p-4">
        <div class="flex justify-between items-center mb-3">
            <span class="font-bold">Calculator</span>
            <button onclick="toggleCalculator()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <input type="text" id="calcDisplay" readonly class="w-full p-3 mb-3 text-right text-xl bg-gray-100 dark:bg-gray-800 rounded">
        <div class="grid grid-cols-4 gap-2">
            <button onclick="calcInput('C')" class="p-3 rounded bg-red-100 text-red-600 hover:bg-red-200">C</button>
            <button onclick="calcInput('/')" class="p-3 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300">Ã·</button>
            <button onclick="calcInput('*')" class="p-3 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300">Ã—</button>
            <button onclick="calcInput('-')" class="p-3 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300">-</button>
            <button onclick="calcInput('7')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">7</button>
            <button onclick="calcInput('8')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">8</button>
            <button onclick="calcInput('9')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">9</button>
            <button onclick="calcInput('+')" class="p-3 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300">+</button>
            <button onclick="calcInput('4')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">4</button>
            <button onclick="calcInput('5')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">5</button>
            <button onclick="calcInput('6')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">6</button>
            <button onclick="calcInput('=')" class="p-3 rounded bg-indigo-500 text-white hover:bg-indigo-600 row-span-2">=</button>
            <button onclick="calcInput('1')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">1</button>
            <button onclick="calcInput('2')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">2</button>
            <button onclick="calcInput('3')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">3</button>
            <button onclick="calcInput('0')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 col-span-2">0</button>
            <button onclick="calcInput('.')" class="p-3 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">.</button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB001YxSS9iQ6PArK1VHf0lIlpLyP1Rqew",
            authDomain: "medquiz-hnu.firebaseapp.com",
            projectId: "medquiz-hnu",
            storageBucket: "medquiz-hnu.firebasestorage.app",
            messagingSenderId: "862221476635",
            appId: "1:862221476635:web:369ca0e1f3b22b3eac29be",
            measurementId: "G-4T9XPB89N7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global State
        let currentUser = null;
        let currentPath = [];
        let currentFolder = null;
        let currentQuiz = null;
        let quizState = {
            questions: [],
            currentIndex: 0,
            answers: {},
            bookmarks: new Set(),
            flagged: new Set(),
            startTime: null,
            timerInterval: null,
            timeRemaining: 1800 // 30 minutes in seconds
        };
        let fontSize = 16;
        let currentTab = 'browse';

        // Auth Functions
        function switchAuthMode(mode) {
            document.getElementById('loginTab').className = mode === 'login' ? 
                'px-6 py-2 rounded-full btn-primary text-white' : 'px-6 py-2 rounded-full bg-gray-200 text-gray-700';
            document.getElementById('signupTab').className = mode === 'signup' ? 
                'px-6 py-2 rounded-full btn-primary text-white' : 'px-6 py-2 rounded-full bg-gray-200 text-gray-700';
            document.getElementById('authBtnText').textContent = mode === 'login' ? 'Login' : 'Sign Up';
            document.getElementById('authError').classList.add('hidden');
        }

        async function handleAuth() {
            const username = document.getElementById('authUsername').value.trim().toLowerCase();
            const pin = document.getElementById('authPin').value;
            const mode = document.getElementById('authBtnText').textContent === 'Login' ? 'login' : 'signup';
            
            if (!username || !pin || pin.length !== 4) {
                showAuthError('Please enter valid username and 4-digit PIN');
                return;
            }

            try {
                const email = `${username}@medquiz.hnu`;
                
                if (mode === 'login') {
                    await auth.signInWithEmailAndPassword(email, pin);
                } else {
                    await auth.createUserWithEmailAndPassword(email, pin);
                    await db.collection('students').doc(username).set({
                        username: username,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        favorites: [],
                        mistakes: [],
                        history: []
                    });
                }
            } catch (error) {
                showAuthError(error.message);
            }
        }

        function showAuthError(msg) {
            const errDiv = document.getElementById('authError');
            errDiv.textContent = msg;
            errDiv.classList.remove('hidden');
        }

        function logout() {
            auth.signOut();
        }

        // Auth State Listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const username = user.email.split('@')[0];
                currentUser = { uid: user.uid, username: username };
                
                const studentDoc = await db.collection('students').doc(username).get();
                if (studentDoc.exists) {
                    currentUser.data = studentDoc.data();
                }
                
                document.getElementById('userName').textContent = username;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                loadNotifications();
                navigateToRoot();
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('quizInterface').classList.add('hidden');
                document.getElementById('resultsScreen').classList.add('hidden');
            }
        });

        // Navigation Functions
        function navigateToRoot() {
            currentPath = [];
            currentFolder = null;
            updateBreadcrumb();
            loadContent();
        }

        function navigateToFolder(folderId, folderName) {
            currentPath.push({ id: folderId, name: folderName });
            updateBreadcrumb();
            loadContent();
        }

        function navigateUp(index) {
            currentPath = currentPath.slice(0, index + 1);
            updateBreadcrumb();
            loadContent();
        }

        function updateBreadcrumb() {
            let html = '';
            currentPath.forEach((folder, index) => {
                html += ` <span class="text-gray-400">></span> 
                    <button onclick="navigateUp(${index})" class="text-indigo-600 hover:underline">${folder.name}</button>`;
            });
            document.getElementById('breadcrumb').innerHTML = html;
        }

        // Tab Functions
        function switchTab(tab) {
            currentTab = tab;
            
            // Update UI
            ['browse', 'favorites', 'mistakes', 'history'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === tab) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('text-gray-600', 'dark:text-gray-400');
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('text-gray-600', 'dark:text-gray-400');
                }
            });
            
            loadContent();
        }

        // Content Loading
        async function loadContent() {
            const container = document.getElementById('contentArea');
            container.innerHTML = '<div class="flex justify-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-indigo-600"></i></div>';
            
            try {
                if (currentTab === 'browse') {
                    await loadBrowseContent(container);
                } else if (currentTab === 'favorites') {
                    await loadFavorites(container);
                } else if (currentTab === 'mistakes') {
                    await loadMistakes(container);
                } else if (currentTab === 'history') {
                    await loadHistory(container);
                }
            } catch (error) {
                container.innerHTML = `<div class="text-center text-red-500 p-8">Error loading content: ${error.message}</div>`;
            }
        }

        async function loadBrowseContent(container) {
            let query = db.collection('folders');
            
            if (currentPath.length === 0) {
                query = query.where('parentId', '==', null);
            } else {
                query = query.where('parentId', '==', currentPath[currentPath.length - 1].id);
            }
            
            const snapshot = await query.get();
            
            if (snapshot.empty && currentPath.length > 0) {
                // Check for quizzes and files in current folder
                await loadFolderContents(container);
                return;
            }
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 fade-in">';
            
            snapshot.forEach(doc => {
                const folder = doc.data();
                html += `
                    <div onclick="navigateToFolder('${doc.id}', '${folder.name}')" 
                        class="folder-card glass-card p-6 cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/20">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center">
                                <i class="fas fa-folder text-3xl text-indigo-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg">${folder.name}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${folder.description || 'Click to open'}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function loadFolderContents(container) {
            const currentFolderId = currentPath[currentPath.length - 1].id;
            
            // Get quizzes
            const quizzesSnapshot = await db.collection('quizzes')
                .where('folderId', '==', currentFolderId)
                .get();
            
            // Get files
            const filesSnapshot = await db.collection('files')
                .where('folderId', '==', currentFolderId)
                .get();
            
            let html = '<div class="space-y-6 fade-in">';
            
            // Quizzes Section
            if (!quizzesSnapshot.empty) {
                html += '<div><h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-question-circle mr-2 text-indigo-600"></i>Quizzes</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                
                quizzesSnapshot.forEach(doc => {
                    const quiz = doc.data();
                    html += `
                        <div onclick="startQuiz('${doc.id}')" 
                            class="folder-card glass-card p-5 cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 border-l-4 border-green-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-lg">${quiz.title}</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${quiz.questionCount || 0} questions â€¢ ${quiz.duration || 30} mins</p>
                                </div>
                                <i class="fas fa-play-circle text-3xl text-green-500"></i>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            // Files Section
            if (!filesSnapshot.empty) {
                html += '<div><h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-file mr-2 text-orange-600"></i>Files</h3><div class="space-y-2">';
                
                filesSnapshot.forEach(doc => {
                    const file = doc.data();
                    const icon = getFileIcon(file.type);
                    html += `
                        <div onclick="viewFile('${doc.id}', '${file.name}', '${file.url}', '${file.type}')" 
                            class="file-item flex items-center gap-4 p-4 rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-800">
                            <i class="${icon} text-2xl text-orange-500"></i>
                            <div class="flex-1">
                                <h4 class="font-medium">${file.name}</h4>
                                <p class="text-sm text-gray-500">${file.size || 'Unknown size'}</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            if (quizzesSnapshot.empty && filesSnapshot.empty) {
                html += '<div class="text-center text-gray-500 py-12"><i class="fas fa-folder-open text-5xl mb-4"></i><p>This folder is empty</p></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function getFileIcon(type) {
            if (type.includes('pdf')) return 'fas fa-file-pdf';
            if (type.includes('word') || type.includes('document')) return 'fas fa-file-word';
            if (type.includes('powerpoint') || type.includes('presentation')) return 'fas fa-file-powerpoint';
            if (type.includes('image')) return 'fas fa-file-image';
            return 'fas fa-file';
        }

        // Quiz Functions
        async function startQuiz(quizId) {
            const quizDoc = await db.collection('quizzes').doc(quizId).get();
            if (!quizDoc.exists) return;
            
            const quizData = quizDoc.data();
            const questionsSnapshot = await db.collection('quizzes').doc(quizId).collection('questions').get();
            
            if (questionsSnapshot.empty) {
                alert('No questions found in this quiz!');
                return;
            }
            
            currentQuiz = { id: quizId, ...quizData };
            quizState.questions = [];
            quizState.answers = {};
            quizState.bookmarks = new Set();
            quizState.flagged = new Set();
            quizState.currentIndex = 0;
            quizState.timeRemaining = (quizData.duration || 30) * 60;
            quizState.startTime = new Date();
            
            questionsSnapshot.forEach(doc => {
                quizState.questions.push({ id: doc.id, ...doc.data() });
            });
            
            // Shuffle questions
            quizState.questions.sort(() => Math.random() - 0.5);
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('quizInterface').classList.remove('hidden');
            document.getElementById('quizTitle').textContent = quizData.title;
            document.getElementById('totalQNum').textContent = quizState.questions.length;
            
            startTimer();
            displayQuestion();
        }

        function startTimer() {
            updateTimerDisplay();
            quizState.timerInterval = setInterval(() => {
                quizState.timeRemaining--;
                updateTimerDisplay();
                
                if (quizState.timeRemaining <= 0) {
                    submitQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(quizState.timeRemaining / 60);
            const seconds = quizState.timeRemaining % 60;
            const display = document.getElementById('timeRemaining');
            display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (quizState.timeRemaining < 300) { // Less than 5 minutes
                display.parentElement.classList.add('timer-warning');
            }
        }

        function displayQuestion() {
            const q = quizState.questions[quizState.currentIndex];
            
            document.getElementById('currentQNum').textContent = quizState.currentIndex + 1;
            document.getElementById('questionText').innerHTML = q.text;
            document.getElementById('bookmarkCount').textContent = quizState.bookmarks.size;
            
            // Update progress
            const progress = ((quizState.currentIndex + 1) / quizState.questions.length) * 100;
            document.getElementById('quizProgress').style.width = `${progress}%`;
            
            // Update bookmark/flag buttons
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const flagBtn = document.getElementById('flagBtn');
            
            bookmarkBtn.className = `bookmark-btn p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 ${quizState.bookmarks.has(q.id) ? 'active' : ''}`;
            flagBtn.className = `flag-btn p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 ${quizState.flagged.has(q.id) ? 'active' : ''}`;
            
            // Generate options
            let optionsHtml = '';
            const options = ['A', 'B', 'C', 'D', 'E'].slice(0, q.options.length);
            
            options.forEach((opt, idx) => {
                const isSelected = quizState.answers[q.id] === idx;
                optionsHtml += `
                    <div onclick="selectAnswer(${idx})" 
                        class="quiz-option p-4 rounded-lg border-2 cursor-pointer ${isSelected ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30' : 'border-gray-200 dark:border-gray-700'}">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full ${isSelected ? 'bg-indigo-500 text-white' : 'bg-gray-200 dark:bg-gray-700'} flex items-center justify-center font-bold">
                                ${opt}
                            </div>
                            <span>${q.options[idx]}</span>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('optionsContainer').innerHTML = optionsHtml;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = quizState.currentIndex === 0;
            document.getElementById('nextBtn').innerHTML = quizState.currentIndex === quizState.questions.length - 1 ? 
                'Finish<i class="fas fa-check ml-2"></i>' : 'Next<i class="fas fa-chevron-right ml-2"></i>';
        }

        function selectAnswer(index) {
            const q = quizState.questions[quizState.currentIndex];
            quizState.answers[q.id] = index;
            displayQuestion();
        }

        function previousQuestion() {
            if (quizState.currentIndex > 0) {
                quizState.currentIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (quizState.currentIndex < quizState.questions.length - 1) {
                quizState.currentIndex++;
                displayQuestion();
            } else {
                submitQuiz();
            }
        }

        function toggleBookmark() {
            const q = quizState.questions[quizState.currentIndex];
            if (quizState.bookmarks.has(q.id)) {
                quizState.bookmarks.delete(q.id);
            } else {
                quizState.bookmarks.add(q.id);
            }
            displayQuestion();
        }

        function toggleFlag() {
            const q = quizState.questions[quizState.currentIndex];
            if (quizState.flagged.has(q.id)) {
                quizState.flagged.delete(q.id);
            } else {
                quizState.flagged.add(q.id);
            }
            displayQuestion();
        }

        async function saveProgress() {
            if (!currentUser) return;
            
            await db.collection('students').doc(currentUser.username).collection('savedProgress').doc(currentQuiz.id).set({
                quizId: currentQuiz.id,
                answers: quizState.answers,
                bookmarks: Array.from(quizState.bookmarks),
                flagged: Array.from(quizState.flagged),
                currentIndex: quizState.currentIndex,
                timeRemaining: quizState.timeRemaining,
                savedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showNotification('Progress saved successfully!', 'success');
        }

        async function submitQuiz() {
            clearInterval(quizState.timerInterval);
            
            let correct = 0;
            let wrong = 0;
            const mistakes = [];
            
            quizState.questions.forEach(q => {
                const userAnswer = quizState.answers[q.id];
                if (userAnswer === q.correctAnswer) {
                    correct++;
                } else {
                    wrong++;
                    mistakes.push({
                        question: q.text,
                        yourAnswer: userAnswer !== undefined ? q.options[userAnswer] : 'Not answered',
                        correctAnswer: q.options[q.correctAnswer],
                        explanation: q.explanation || 'No explanation provided'
                    });
                }
            });
            
            const score = Math.round((correct / quizState.questions.length) * 100);
            
            // Save to history
            await db.collection('students').doc(currentUser.username).collection('history').add({
                quizId: currentQuiz.id,
                quizTitle: currentQuiz.title,
                score: score,
                correct: correct,
                wrong: wrong,
                total: quizState.questions.length,
                completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                timeSpent: (currentQuiz.duration * 60) - quizState.timeRemaining
            });
            
            // Save mistakes
            if (mistakes.length > 0) {
                const userRef = db.collection('students').doc(currentUser.username);
                const existingMistakes = currentUser.data.mistakes || [];
                await userRef.update({
                    mistakes: [...existingMistakes, ...mistakes.slice(0, 10)] // Keep last 10 mistakes
                });
            }
            
            // Show results
            showResults(score, correct, wrong, mistakes);
        }

        function showResults(score, correct, wrong, mistakes) {
            document.getElementById('quizInterface').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            document.getElementById('scorePercent').textContent = `${score}%`;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
            
            const emoji = score >= 80 ? 'ðŸŽ‰' : score >= 60 ? 'ðŸ˜Š' : score >= 40 ? 'ðŸ˜' : 'ðŸ˜¢';
            document.getElementById('resultEmoji').textContent = emoji;
            
            // Show mistakes review
            let mistakesHtml = '';
            if (mistakes.length > 0) {
                mistakesHtml = '<h4 class="font-bold mb-3">Review Mistakes:</h4>';
                mistakes.forEach((m, idx) => {
                    mistakesHtml += `
                        <div class="mb-4 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border-l-4 border-red-500">
                            <p class="font-medium mb-2">${idx + 1}. ${m.question}</p>
                            <p class="text-sm text-red-600 dark:text-red-400">Your answer: ${m.yourAnswer}</p>
                            <p class="text-sm text-green-600 dark:text-green-400">Correct answer: ${m.correctAnswer}</p>
                            <p class="text-sm text-gray-600 mt-2"><i class="fas fa-info-circle mr-1"></i>${m.explanation}</p>
                        </div>
                    `;
                });
            } else {
                mistakesHtml = '<div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg text-center"><i class="fas fa-check-circle text-green-500 text-3xl mb-2"></i><p>Perfect score! No mistakes!</p></div>';
            }
            
            document.getElementById('mistakesReview').innerHTML = mistakesHtml;
        }

        function returnToBrowse() {
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadContent();
        }

        function retakeQuiz() {
            startQuiz(currentQuiz.id);
            document.getElementById('resultsScreen').classList.add('hidden');
        }

        // Favorites, Mistakes, History
        async function loadFavorites(container) {
            const favorites = currentUser.data.favorites || [];
            
            if (favorites.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12"><i class="fas fa-star text-5xl mb-4 text-gray-300"></i><p>No favorites yet</p></div>';
                return;
            }
            
            let html = '<div class="space-y-4 fade-in">';
            // Implementation for displaying favorites
            html += '</div>';
            container.innerHTML = html;
        }

        async function loadMistakes(container) {
            const mistakes = currentUser.data.mistakes || [];
            
            if (mistakes.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12"><i class="fas fa-check-circle text-5xl mb-4 text-green-300"></i><p>No mistakes recorded! Great job!</p></div>';
                return;
            }
            
            let html = '<div class="space-y-4 fade-in">';
            mistakes.forEach((m, idx) => {
                html += `
                    <div class="glass-card p-4 border-l-4 border-red-500">
                        <p class="font-medium mb-2">${idx + 1}. ${m.question}</p>
                        <p class="text-sm text-red-600 dark:text-red-400">Your answer: ${m.yourAnswer}</p>
                        <p class="text-sm text-green-600 dark:text-green-400">Correct: ${m.correctAnswer}</p>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        async function loadHistory(container) {
            const historySnapshot = await db.collection('students')
                .doc(currentUser.username)
                .collection('history')
                .orderBy('completedAt', 'desc')
                .get();
            
            if (historySnapshot.empty) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12"><i class="fas fa-history text-5xl mb-4 text-gray-300"></i><p>No history yet</p></div>';
                return;
            }
            
            let html = '<div class="space-y-4 fade-in">';
            historySnapshot.forEach(doc => {
                const h = doc.data();
                const date = h.completedAt ? new Date(h.completedAt.toDate()).toLocaleDateString() : 'Unknown';
                const scoreColor = h.score >= 80 ? 'text-green-600' : h.score >= 60 ? 'text-yellow-600' : 'text-red-600';
                
                html += `
                    <div class="glass-card p-4 flex justify-between items-center">
                        <div>
                            <h4 class="font-bold">${h.quizTitle}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${date}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold ${scoreColor}">${h.score}%</div>
                            <div class="text-sm text-gray-500">${h.correct}/${h.total} correct</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Search Function
        async function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (!query) {
                loadContent();
                return;
            }
            
            const container = document.getElementById('contentArea');
            container.innerHTML = '<div class="flex justify-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-indigo-600"></i></div>';
            
            // Search folders
            const foldersSnapshot = await db.collection('folders')
                .where('name', '>=', query)
                .where('name', '<=', query + '\uf8ff')
                .get();
            
            // Search quizzes
            const quizzesSnapshot = await db.collection('quizzes')
                .where('title', '>=', query)
                .where('title', '<=', query + '\uf8ff')
                .get();
            
            let html = '<div class="space-y-6 fade-in">';
            
            if (!foldersSnapshot.empty) {
                html += '<div><h3 class="text-xl font-bold mb-4">Folders</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                foldersSnapshot.forEach(doc => {
                    const folder = doc.data();
                    html += `
                        <div onclick="navigateToFolder('${doc.id}', '${folder.name}')" 
                            class="folder-card glass-card p-4 cursor-pointer">
                            <i class="fas fa-folder text-2xl text-indigo-600 mr-3"></i>
                            <span class="font-medium">${folder.name}</span>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            if (!quizzesSnapshot.empty) {
                html += '<div><h3 class="text-xl font-bold mb-4">Quizzes</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                quizzesSnapshot.forEach(doc => {
                    const quiz = doc.data();
                    html += `
                        <div onclick="startQuiz('${doc.id}')" 
                            class="folder-card glass-card p-4 cursor-pointer border-l-4 border-green-500">
                            <i class="fas fa-question-circle text-2xl text-green-600 mr-3"></i>
                            <span class="font-medium">${quiz.title}</span>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            if (foldersSnapshot.empty && quizzesSnapshot.empty) {
                html += '<div class="text-center text-gray-500 py-12"><i class="fas fa-search text-5xl mb-4 text-gray-300"></i><p>No results found</p></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // File Viewer
        function viewFile(id, name, url, type) {
            document.getElementById('fileTitle').textContent = name;
            document.getElementById('downloadBtn').href = url;
            
            const viewer = document.getElementById('fileViewer');
            
            if (type.includes('pdf')) {
                viewer.innerHTML = `<iframe src="${url}" class="w-full h-full" frameborder="0"></iframe>`;
            } else if (type.includes('image')) {
                viewer.innerHTML = `<img src="${url}" class="max-w-full mx-auto" style="max-height: 100%;">`;
            } else {
                viewer.innerHTML = `<div class="text-center p-8"><i class="fas fa-file text-6xl text-gray-400 mb-4"></i><p>Preview not available for this file type</p><a href="${url}" download class="mt-4 inline-block px-6 py-3 bg-indigo-600 text-white rounded-lg">Download File</a></div>`;
            }
            
            document.getElementById('fileModal').classList.remove('hidden');
        }

        function closeFileModal() {
            document.getElementById('fileModal').classList.add('hidden');
        }

        // Notifications
        async function loadNotifications() {
            if (!currentUser) return;
            
            const notifSnapshot = await db.collection('notifications')
                .where('recipient', 'in', ['all', currentUser.username])
                .where('read', '==', false)
                .orderBy('timestamp', 'desc')
                .get();
            
            const badge = document.getElementById('notifBadge');
            if (notifSnapshot.empty) {
                badge.classList.add('hidden');
            } else {
                badge.textContent = notifSnapshot.size;
                badge.classList.remove('hidden');
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('hidden');
        }

        function showNotification(message, type = 'info') {
            // Implementation for showing toast notifications
        }

        // Dark Mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // Check saved dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        // Font Size
        function adjustFontSize(delta) {
            fontSize += delta;
            if (fontSize < 12) fontSize = 12;
            if (fontSize > 24) fontSize = 24;
            document.body.style.fontSize = `${fontSize}px`;
        }

        // Calculator
        function toggleCalculator() {
            document.getElementById('calculator').classList.toggle('hidden');
        }

        let calcExpression = '';
        function calcInput(val) {
            const display = document.getElementById('calcDisplay');
            
            if (val === 'C') {
                calcExpression = '';
                display.value = '';
            } else if (val === '=') {
                try {
                    calcExpression = eval(calcExpression).toString();
                    display.value = calcExpression;
                } catch {
                    display.value = 'Error';
                    calcExpression = '';
                }
            } else {
                calcExpression += val;
                display.value = calcExpression;
            }
        }

        // Close modals on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('fileModal');
            if (event.target === modal) {
                closeFileModal();
            }
        }
    </script>
</body>
</html>
